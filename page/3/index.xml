<?xml-stylesheet href="/rss.xsl" type="text/xsl"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Homepage ğŸŒˆ on Wangloo's BLOG</title><link>https://wangloo.github.io/</link><description>Recent content in Homepage ğŸŒˆ on Wangloo's BLOG</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>@2019 Notepadium.</copyright><lastBuildDate>Thu, 15 Sep 2022 15:14:05 +0800</lastBuildDate><atom:link href="https://wangloo.github.io/index.xml" rel="self" type="application/rss+xml"/><item><title>æ“ä½œç³»ç»Ÿâ€”â€”ä¸Šä¸‹æ–‡åˆ‡æ¢</title><link>https://wangloo.github.io/posts/os/context/</link><pubDate>Mon, 14 Nov 2022 22:13:06 +0800</pubDate><guid>https://wangloo.github.io/posts/os/context/</guid><description>Wangloo's BLOG https://wangloo.github.io/posts/os/context/ -&lt;p>æœ¬æ–‡åŸºäº&lt;strong>AArch64&lt;/strong>æ‰§è¡Œç¯å¢ƒ, ä»‹ç»ç°ä»£æ“ä½œç³»ç»Ÿä¸­ä¸Šä¸‹æ–‡åˆ‡æ¢çš„ç›¸å…³å†…å®¹.&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡">ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡ï¼Ÿ&lt;/h2>
&lt;p>ä¸Šä¸‹æ–‡åˆç§°â€œç°åœºâ€,&lt;/p>
&lt;h2 id="ä¸ºä»€ä¹ˆéœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢">ä¸ºä»€ä¹ˆéœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢?&lt;/h2>
&lt;p>(TODO: ä¸ºä»€ä¹ˆè¯´çº¿ç¨‹æ˜¯è°ƒåº¦çš„å•ä½?)&lt;/p>
&lt;p>ç°ä»£æ“ä½œç³»ç»Ÿä¸­åŒæ—¶å­˜åœ¨ç€æˆåƒä¸Šç™¾ä¸ªçº¿ç¨‹, ä½†æ˜¯ä¸€ä¸ªCPUåŒä¸€æ—¶åˆ»åªèƒ½è¿è¡Œä¸€ä¸ªçº¿ç¨‹, ä»–ä»¬æ˜¯è½®æµçš„å ç”¨CPU, ä¹Ÿå«å¹¶å‘æ‰§è¡Œ. (TODO: å¦‚ä½•æŸ¥çœ‹çº¿ç¨‹åˆ‡æ¢çš„é—´éš”?) çº¿ç¨‹é«˜é¢‘ç‡çš„åˆ‡æ¢, æ“ä½œç³»ç»Ÿæ˜¯å¦‚ä½•ä¿è¯åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ‰§è¡Œçš„çº¿ç¨‹æ—¶, å®ƒèƒ½å¤Ÿç»§ç»­ä¸Šæ¬¡çš„å·¥ä½œå‘¢?&lt;/p>
&lt;h3 id="ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡-1">ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡?&lt;/h3>
&lt;p>æˆ‘ä»¬æ­£åœ¨çœ‹ä¸€æœ¬ä¹¦çš„æ—¶å€™å¦‚æœè¢«å…¶ä»–çš„äº‹æƒ…æ‰“æ–­, è¿”å›æ—¶ä¸ºäº†èƒ½å¤Ÿä»ä¸Šæ¬¡è¢«æ‰“æ–­çš„ä½ç½®ç»§ç»­è¯», å°±è¦åœ¨è¢«æ‰“æ–­çš„æ—¶å€™è®°ä¸‹æ¥å½“å‰æ˜¯è¯»åˆ°äº†å“ªä¸ªç¬¬å‡ é¡µçš„ç¬¬å‡ è¡Œ.&lt;/p>
&lt;p>æ“ä½œç³»ç»Ÿå¯¹å¾…çº¿ç¨‹ä¹Ÿæ˜¯å¦‚æ­¤, éœ€è¦ä¿å­˜çš„ç”¨äºæ¢å¤çº¿ç¨‹æ‰§è¡Œçš„ä¿¡æ¯å°±ç§°ä¸ºçº¿ç¨‹çš„ä¸Šä¸‹æ–‡.&lt;/p>
&lt;p>é‚£ä¹ˆå¯¹äºçº¿ç¨‹æ¥è¯´éœ€è¦è®°ä¸‹çš„å†…å®¹æœ‰ä»€ä¹ˆå‘¢? å¯„å­˜å™¨å’Œæ ˆå³å¯. æ‹¿AArch64æ¶æ„æ¥è·ç¦», çº¿ç¨‹çš„ä¸Šä¸‹æ–‡å°±æ˜¯:&lt;/p>
&lt;ol>
&lt;li>é€šç”¨å¯„å­˜å™¨&lt;code>x0-x29&lt;/code>: å‡½æ•°è°ƒç”¨çš„å‚æ•°, æŸäº›è®¡ç®—è¿‡ç¨‹çš„ä¸­é—´å€¼, éƒ½è¦ç”¨åˆ°è¿™äº›å¯„å­˜å™¨. &lt;strong>çº¿ç¨‹çš„æ‰§è¡Œæµå¯èƒ½åœ¨ä»»ä½•æ—¶å€™è¢«æ‰“æ–­&lt;/strong>, å½“ç„¶è¿™äº›å†…å®¹ä¹Ÿä¸èƒ½ä¸¢.&lt;/li>
&lt;li>é€šç”¨å¯„å­˜å™¨&lt;code>lr(x30)&lt;/code>: &lt;code>lr&lt;/code> ä¿å­˜ç€è¿”å›åœ°å€, å³å½“å‰å‡½æ•°ç»“æŸä¹‹åè¯¥è¿”å›åˆ°å“ªæ‰§è¡Œ.&lt;/li>
&lt;li>æ ˆé¡¶æŒ‡é’ˆ &lt;code>sp&lt;/code>: æ ˆçš„é‡è¦æ€§æ— éœ€å¤šè¨€. ä½†æ˜¯éœ€è¦è¯´æ˜çš„æ˜¯æˆ‘ä»¬ä¿å­˜æ ˆçš„æ–¹å¼&lt;strong>å¹¶éå°†æ ˆä¸­çš„æ‰€æœ‰å†…å®¹ä¿å­˜, è€Œæ˜¯ä¿å­˜æ ˆçš„ä½ç½®&lt;/strong>å³å¯. å› ä¸ºæ“ä½œç³»ç»Ÿæœ‰åˆ«çš„æœºåˆ¶(TODO), èƒ½å¤Ÿä¿è¯å³ä¾¿çº¿ç¨‹ä¸åœ¨æ‰§è¡Œ, å±äºè¯¥çº¿ç¨‹çš„æ ˆä¹Ÿä¸ä¼šè¢«ç ´å.&lt;/li>
&lt;li>ç¨‹åºè®¡æ•°å™¨ &lt;code>pc&lt;/code>: è¢«æ‰“æ–­çš„çº¿ç¨‹å¦‚æœå†æ¬¡æ‰§è¡Œ, ä»å“ªé‡Œæ‰§è¡Œå‘¢? æ˜¾ç„¶æ˜¯è¢«æ‰“æ–­æŒ‡ä»¤çš„ä¸‹ä¸€æ¡(æˆ–è€…é‡æ–°æ‰§è¡Œå½“å‰). è¿™ä¸ªæŒ‡ä»¤çš„åœ°å€å½“ç„¶ä¹Ÿéœ€è¦è¢«ä¿å­˜å¥½.&lt;/li>
&lt;li>PSTATE: æƒ³ä¸€ä¸‹, æœ‰äº†ä»¥ä¸Šçš„å†…å®¹å°±èƒ½å¤Ÿä¿è¯çº¿ç¨‹å®Œæ•´çš„æ¢å¤ä¹‹å‰çš„ç¯å¢ƒå—? å…¶ä»–çš„ä¾‹å¦‚ä¸­æ–­æ˜¯å¼€è¿˜æ˜¯å…³, æœ‰å“ªäº›æ ‡å¿—ä½(NZCV)è¢«è®¾ç½®äº†. è¿™äº›ä¿¡æ¯åœ¨AArch64ä¸­æ˜¯ä¿å­˜åœ¨PSTATEçš„å„ä¸ªå­—æ®µä¸­.&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæœ‰ä¸€ä¸ªé€‚å½“çš„é€»è¾‘, åœ¨çº¿ç¨‹åˆ‡æ¢å‡ºå»çš„æ—¶å€™å°†ä¸Šä¸‹æ–‡ä¿å­˜èµ·æ¥, ç„¶åæ¢å¤æ–°çº¿ç¨‹çš„ä¸Šä¸‹æ–‡, æ˜¯ä¸æ˜¯çº¿ç¨‹åˆ‡æ¢è¿™ä»¶äº‹å°±èƒ½åšåˆ°äº†. å¦‚ä½•ç»„ç»‡è¿™ä¸ªä¿å­˜å’Œæ¢å¤çš„è¿‡ç¨‹åœ¨ä¸‹é¢ä¼šä»‹ç»åˆ°.&lt;/p>
&lt;h2 id="linux-å¦‚ä½•å¤„ç†ä¸Šä¸‹æ–‡åˆ‡æ¢">Linux å¦‚ä½•å¤„ç†ä¸Šä¸‹æ–‡åˆ‡æ¢&lt;/h2>
&lt;h2 id="å¦ä¸€ç§å¤„ç†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ€è·¯">å¦ä¸€ç§å¤„ç†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ€è·¯&lt;/h2>
&lt;h2 id="åç¨‹çš„ä¸Šä¸‹æ–‡">åç¨‹çš„ä¸Šä¸‹æ–‡&lt;/h2>
&lt;p>åç¨‹æ˜¯ç”¨æˆ·çº§åˆ«çš„çº¿ç¨‹,&lt;/p>
&lt;ul>
&lt;li>åç¨‹ä¹‹é—´çš„åˆ‡æ¢ä¸è¿›å…¥å†…æ ¸&lt;/li>
&lt;li>åˆ‡æ¢åç¨‹åªèƒ½æ˜¯æŸä¸ªåç¨‹&lt;strong>ä¸»åŠ¨æ”¾å¼ƒæ§åˆ¶æƒ&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>æˆ‘ä»¬åœ¨è¿™é‡Œè®¨è®ºä¸€ä¸‹åç¨‹åˆ‡æ¢æ—¶éœ€è¦ä¿å­˜çš„ä¸Šä¸‹æ–‡æ˜¯å¦ä¸çº¿ç¨‹æœ‰æ‰€ä¸åŒ.&lt;/p>
&lt;p>é¦–å…ˆ, PCä¸€å®šå±äº, è¿™ä¸ªæ¯‹åº¸ç½®ç–‘. å…¶æ¬¡æ˜¯æ ˆé¡¶æŒ‡é’ˆsp, &lt;strong>æ¯ä¸ªåç¨‹éƒ½æœ‰å•ç‹¬çš„æ ˆ&lt;/strong>, å¦‚æœä¸ä¿å­˜æ ˆçš„ä½ç½®, é‚£ä¹ˆåç¨‹å†…éƒ¨å®šä¹‰å±€éƒ¨å˜é‡å°±æ²¡æ³•è®¿é—®äº†(å±€éƒ¨å˜é‡çš„è®¿é—®æŒ‡ä»¤éƒ½æ˜¯ä»¥spä¸ºbaseçš„åç§»æ¥åšçš„).&lt;/p>
&lt;p>å¦å¤–, å…³äºé€šç”¨å¯„å­˜å™¨, ç”±äºåç¨‹çš„åˆ‡æ¢éœ€è¦ä¸»åŠ¨è°ƒç”¨æŸä¸ªå‡½æ•°(é€šå¸¸å«åš&lt;code>yield()&lt;/code>), åœ¨å‡½æ•°çš„æœ€åå°†PCè®¾ç½®ä¸ºæ–°åç¨‹çš„ä¸Šä¸‹æ–‡PC. ä¿å­˜å½“å‰åç¨‹ä¸Šä¸‹æ–‡çš„æ“ä½œä¹Ÿåœ¨è¿™ä¸ªå‡½æ•°ä¸­, è€Œå…¶å‚æ•°æˆ‘ä»¬å¹¶ä¸å…³å¿ƒ, å³&lt;code>x0&lt;/code>-&lt;code>x7&lt;/code>æ²¡å¿…è¦ä¿å­˜. åŒæ ·çš„, &lt;strong>caller-savedå¯„å­˜å™¨ä¹Ÿæ˜¯æ²¡å¿…è¦ä¿å­˜çš„&lt;/strong>, å› ä¸ºè¿™äº›å¯„å­˜å™¨ä½œä¸ºå‡½æ•°è°ƒç”¨ä½¿ç”¨çš„ä¸´æ—¶å˜é‡, å½“å†æ¬¡è¿”å›è¯¥åç¨‹æ—¶, PC=yield()è¿”å›åœ°å€, callerå¦‚æœå…³å¿ƒè¿™äº›å¯„å­˜å™¨åº”å½“è‡ªå·±æ‰§è¡Œä¿å­˜å’Œæ¢å¤. ä½†æ˜¯&lt;strong>callee-savedå¯„å­˜å™¨å¿…é¡»è¦ä¿å­˜åˆ°ä¸Šä¸‹æ–‡ä¸­&lt;/strong>, å› ä¸ºåœ¨yield()ä¸­, æˆ‘ä»¬å¦‚æœä¿®æ”¹äº†callee-savedå¯„å­˜å™¨, å°±éœ€è¦åœ¨è¿”å›æ—¶(ä¹Ÿå°±æ˜¯å†æ¬¡è°ƒåº¦åˆ°è¯¥åç¨‹æ—¶) æ¢å¤, è¿™æ˜¯calleeè¯¥åšçš„, ä¹Ÿå°±æ˜¯ä¸Šä¸‹æ–‡ä¸­åº”è¯¥æœ‰çš„å”¯ä¸€é€šç”¨å¯„å­˜å™¨ç»„.&lt;/p>
- https://wangloo.github.io/posts/os/context/ - @2019 Notepadium.</description></item><item><title>åŸºäºARM64å®ç°setjmp/longjmp</title><link>https://wangloo.github.io/posts/c/setjmp_and_longjmp/</link><pubDate>Tue, 01 Nov 2022 23:38:54 +0800</pubDate><guid>https://wangloo.github.io/posts/c/setjmp_and_longjmp/</guid><description>Wangloo's BLOG https://wangloo.github.io/posts/c/setjmp_and_longjmp/ -&lt;h2 id="ä»‹ç»">ä»‹ç»&lt;/h2>
&lt;p>setjmp() and longjmp() æ˜¯ä¸€å¯¹ç»„åˆä½¿ç”¨çš„å‡½æ•°, å¯ä»¥å®ç°&lt;strong>å…¨å±€çš„goto&lt;/strong>.&lt;/p>
&lt;p>setjmp() æ„é€ ä¸€ä¸ªè¿è¡Œç¯å¢ƒ, è°ƒç”¨longjmp() åˆ™å°†æ‰§è¡Œæµåˆ‡æ¢åˆ°è¯¥ç¯å¢ƒ.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">/* setjmp() ä¿å­˜å½“å‰çš„è¿è¡Œç¯å¢ƒ(ä¸Šä¸‹æ–‡)åˆ° env å‚æ•°ä¸­ */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">int&lt;/span> &lt;span style="color:#50fa7b">setjmp&lt;/span>(jmp_buf env);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">/* longjmp() å°†æ§åˆ¶æµåˆ‡æ¢åˆ° env æŒ‡å®šçš„è¿è¡Œç¯å¢ƒ */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">void&lt;/span> &lt;span style="color:#50fa7b">longjmp&lt;/span>(jmp_buf env, &lt;span style="color:#8be9fd">int&lt;/span> val);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ä½¿ç”¨æ–¹æ³•">ä½¿ç”¨æ–¹æ³•&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#include&lt;/span> &lt;span style="color:#ff79c6">&amp;lt;setjmp.h&amp;gt;&lt;/span>&lt;span style="color:#ff79c6">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#include&lt;/span> &lt;span style="color:#ff79c6">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span style="color:#ff79c6">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>jmp_buf e;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">void&lt;/span> &lt;span style="color:#50fa7b">foo&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> longjmp(e, &lt;span style="color:#bd93f9">1&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">int&lt;/span> &lt;span style="color:#50fa7b">main&lt;/span>(&lt;span style="color:#8be9fd">void&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">int&lt;/span> ret;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#6272a4">/* After calling longjmp(), the execution flow back to setjmp(),
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"> and setjmp() will return not 0. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ret &lt;span style="color:#ff79c6">=&lt;/span> setjmp(e);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">if&lt;/span> (ret &lt;span style="color:#ff79c6">==&lt;/span> &lt;span style="color:#bd93f9">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#f1fa8c">&amp;#34;Return from setjmp&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> foo();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#ff79c6">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#f1fa8c">&amp;#34;Return from longjmp&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">return&lt;/span> &lt;span style="color:#bd93f9">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åŸºäº-aarch64-çš„å®ç°">åŸºäº AArch64 çš„å®ç°&lt;/h2>
&lt;p>éœ€è¦ä¿å­˜çš„ä¸Šä¸‹æ–‡åŒ…æ‹¬&lt;/p>
&lt;ul>
&lt;li>&lt;strong>callee-saved é€šç”¨å¯„å­˜å™¨&lt;/strong>, å› ä¸ºå¯èƒ½ç¬¬ä¸€æ¬¡è°ƒç”¨ &lt;code>setjmp()&lt;/code> ä¹‹åçš„æ‰§è¡Œæµä¿®æ”¹äº†è¿™äº›å¯„å­˜å™¨, ä»ç¬¬äºŒæ¬¡å›åˆ° &lt;code>setjmp()&lt;/code> çš„è§’åº¦æ¥çœ‹, å°±æ˜¯æ‰§è¡Œsetjmp() ä¸­ç ´åçš„. caller-saved å¯„å­˜å™¨åˆ™ä¸å¿…, å› ä¸ºæœ¬æ¥å³ä¾¿çœ‹ä½œæ˜¯ &lt;code>setjmp()&lt;/code> ç ´åçš„, ä¹Ÿæ˜¯æ­£å¸¸çš„.&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-asm" data-lang="asm">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">.macro&lt;/span> func _name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">.global&lt;/span> \_name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">.type&lt;/span> \_name, %function
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>\&lt;span style="color:#8be9fd;font-style:italic">_name:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">.endm&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">.macro&lt;/span> endfunc _name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">.size&lt;/span> \_name, .-\_name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">.endm&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>/**
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">setjmp&lt;/span> (jmp_buf env)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> *
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">See&lt;/span> also:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">longjmp&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> *
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * @&lt;span style="color:#50fa7b">return&lt;/span> &lt;span style="color:#bd93f9">0&lt;/span> - if returns from direct call,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">nonzero&lt;/span> - if returns after longjmp.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> */
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">func&lt;/span> setjmp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">stp&lt;/span> x19, x20, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> stp x21, x22, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> stp x23, x24, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> stp x25, x26, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> stp x27, x28, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> stp x29, x18, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> mov x9, sp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">stp&lt;/span> lr, x9, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> mov x0, &lt;span style="color:#6272a4">#0
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ret
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">endfunc&lt;/span> setjmp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>/**
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">longjmp&lt;/span> (jmp_buf env, int val)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> *
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#8be9fd;font-style:italic">Note:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">if&lt;/span> val is not &lt;span style="color:#bd93f9">0&lt;/span>, then it would be returned from setjmp,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">otherwise&lt;/span> - &lt;span style="color:#bd93f9">1&lt;/span> would be returned.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> *
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">See&lt;/span> also:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">setjmp&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> */
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">func&lt;/span> longjmp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">ldp&lt;/span> x19, x20, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> ldp x21, x22, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> ldp x23, x24, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> ldp x25, x26, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> ldp x27, x28, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> ldp x29, x18, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> ldp lr, x9, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> mov sp, x9
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">mov&lt;/span> x0, x1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">cbnz&lt;/span> x0, &lt;span style="color:#bd93f9">1&lt;/span>f
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">add&lt;/span> x0, x0, &lt;span style="color:#6272a4">#1
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>&lt;span style="color:#bd93f9">1&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">ret&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">endfunc&lt;/span> longjmp
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="setjmp-å®ç°-try-catch">setjmp() å®ç° try-catch&lt;/h2>
- https://wangloo.github.io/posts/c/setjmp_and_longjmp/ - @2019 Notepadium.</description></item><item><title>Armv8 Kernel Monitor</title><link>https://wangloo.github.io/posts/os/monitor/</link><pubDate>Fri, 28 Oct 2022 22:56:19 +0800</pubDate><guid>https://wangloo.github.io/posts/os/monitor/</guid><description>Wangloo's BLOG https://wangloo.github.io/posts/os/monitor/ -&lt;p>Â &lt;/p>
&lt;h2 id="kernel-monitor-æ˜¯ä»€ä¹ˆ">Kernel Monitor æ˜¯ä»€ä¹ˆ&lt;/h2>
&lt;p>Kernel Monitor æ˜¯ä¸€ä¸ªé€‚é…æˆ‘ä»¬å¾®å†…æ ¸æ“ä½œç³»ç»Ÿçš„ Kernel è°ƒè¯•å’Œç›‘æ§ç³»ç»Ÿ. å®ƒèƒ½å®ç°å†…æ ¸çš„åŠ¨æ€è°ƒè¯•å’Œç›‘æ§. åŒæ—¶, å®ƒè¿˜æ¥ç®¡å†…æ ¸çš„åŒæ­¥å¼‚å¸¸å’Œç³»ç»Ÿé”™è¯¯, ä½¿å¼€å‘è€…èƒ½å¤Ÿäº†è§£å‘ç”Ÿå¼‚å¸¸æ—¶ç³»ç»Ÿçš„çŠ¶æ€.&lt;/p>
&lt;p>Kernel Monitor å…·æœ‰ä¸€å®šçš„å¯æ‰©å±•æ€§, ä¾‹å¦‚é€šè¿‡ç»Ÿè®¡å†…æ ¸ä¸­å­˜å‚¨çš„ TCB æ¥å®æ—¶ç›‘æ§ç³»ç»Ÿä¸­æ‰€æœ‰çº¿ç¨‹çš„çŠ¶æ€. å¯æ ¹æ®å¼€å‘è€…çš„éœ€æ±‚æ·»åŠ ç»Ÿè®¡çš„å¯¹è±¡, å¦‚ Endpoint, Capabilityç­‰.&lt;/p>
&lt;p>Â &lt;/p>
&lt;h2 id="kernel-monitor-æ€»ä½“è®¾è®¡">Kernel Monitor æ€»ä½“è®¾è®¡&lt;/h2>
&lt;p>Kernel Monitor ç³»ç»ŸåŒ…å« Clinet å’Œ Server ä¸¤ä¸ªéƒ¨åˆ†. ç®€å•æ¥è¯´, Client è´Ÿè´£å¤„ç†ç”¨æˆ·è¾“å…¥, å¹¶å°†è¾“å…¥è¿›è¡Œè§£æ, å°è£…ä¸º ä¸€ç³»åˆ—åŸºç¡€å‘½ä»¤. å‘é€ç»™ Server. Server è´Ÿè´£æ‰§è¡Œè¿™äº› åŸºç¡€çš„å‘½ä»¤, å¦‚è®¾ç½®æ–­ç‚¹, æŸ¥çœ‹æŸä¸ªåœ°å€çš„å€¼ç­‰.&lt;/p>
&lt;p>æ•´ä¸ªç³»ç»Ÿæœ‰&lt;em>ä¸¤ç§æ¶æ„&lt;/em>: æœ¬åœ° Monitor å’Œè¿œç¨‹ Monitor.&lt;/p>
&lt;p>æœ¬åœ°monitor å’Œè¿œç¨‹ monitor çš„åŒºåˆ«æ˜¯: &lt;strong>Monitor Client çš„ä½ç½®åœ¨å“ª, æ˜¯å¦ä¸ Server åœ¨åŒä¸€ä¸ªæœºå™¨ä¸Š&lt;/strong>.&lt;/p>
&lt;blockquote>
&lt;p>å…ˆè¯´ Monitor Server, å®ƒå¿…é¡»åµŒå…¥è¦è°ƒè¯•çš„ Kernel ä¸­, &lt;strong>ä½äºä¸€ä¸ªåœ°å€ç©ºé—´&lt;/strong>, æ–¹ä¾¿æ“ä½œ Kernel çš„å†…å­˜.&lt;/p>
&lt;/blockquote>
&lt;h3 id="æœ¬åœ°-monitor">æœ¬åœ° Monitor&lt;/h3>
&lt;p>åœ¨æœ¬åœ° Monitor ä¸­, client å’Œ sever éƒ½ä½äºç›®æ ‡æœº(Target)ä¸Š, ç›®æ ‡æœºé€šå¸¸æ˜¯å¼€å‘æ¿.&lt;/p>
&lt;p>å¯¹äº AArch64 ä½“ç³»ç»“æ„æ¥è¯´, æœ€å¤šæœ‰å››ä¸ªå¼‚å¸¸ç­‰çº§(EL0-EL3). &lt;!-- raw HTML omitted -->Client å¯ä»¥è¿è¡Œåœ¨EL2.&lt;!-- raw HTML omitted -->&lt;/p>
&lt;p>&lt;img src="./%E6%9C%AC%E5%9C%B0monitor.png" alt="image-20221029141414942">&lt;/p>
&lt;h3 id="è¿œç¨‹-monitor">è¿œç¨‹ Monitor&lt;/h3>
&lt;p>è¿œç¨‹ Monitor æ¶æ„åˆ™ä¸åŒ, &lt;!-- raw HTML omitted -->Clinet è¿è¡Œåœ¨å®¿ä¸»æœº(Host)ä¸Š&lt;!-- raw HTML omitted -->, é€šå¸¸æ˜¯Linux. å®ƒä¸ Server çš„é€šä¿¡æ˜¯é€šè¿‡ç½‘ç»œ/UARTå®ç°çš„.&lt;/p>
&lt;p>&lt;img src="./%E8%BF%9C%E7%A8%8Bmonitor.png" alt="image-20221029142002468">&lt;/p>
&lt;blockquote>
&lt;p>Monitor Client è¿è¡Œåœ¨æœ¬åœ°å’Œè¿œç¨‹å¯¹äºå®ç°çš„éš¾åº¦å’Œç”¨æˆ·ä½“éªŒæœ‰å½±å“.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å¦‚æœ Client å®ç°åœ¨æœ¬åœ°, åˆ™ Client æ— éœ€å®ç°ç½‘å£å’Œä¸²å£çš„é©±åŠ¨, ä½†Monitor è¾“å…¥è¾“å‡ºçš„ä¸²å£ä¸æ“ä½œç³»ç»Ÿæœ¬èº«çš„ä¸²å£ç›¸åŒ, ä¿¡æ¯å†—æ‚åœ¨ä¸€èµ·ä¸æ˜“æŸ¥çœ‹; åŒæ—¶, å¦‚æœ Client å®ç°åœ¨æœ¬åœ°, é‚£ä¹ˆå¯¹äºELFçš„è§£æéœ€è¦åœ¨æ— æ“ä½œç³»ç»Ÿæä¾›çš„åº“æ”¯æŒä¸‹å®Œæˆ, å¯èƒ½æ¯”è¾ƒå¤æ‚.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦‚æœ Client å®ç°åœ¨è¿œç¨‹, å³ä¸º Linux ä¸Šçš„ä¸€ä¸ªAPP. é‚£ä¹ˆå®ƒå’Œ Server çš„é€šä¿¡å°±éœ€è¦é€šè¿‡å¤–éƒ¨çš„ç½‘å£æˆ–è€…ä¸²å£(å¯¹äºæˆ‘ä»¬ä½¿ç”¨çš„64ä½å¼€å‘æ¿åªå¼•å‡ºäº†ä¸€ä¸ªä¸²å£, æ‰€ä»¥åªèƒ½ä½¿ç”¨ç½‘å£). éœ€è¦åœ¨ Server ä¸Šå®ç°ç½‘å£çš„é©±åŠ¨, è¿™éƒ¨åˆ†æ¯”è¾ƒå¤æ‚. ä½†æ˜¯å¥½å¤„æ˜¯ Client çš„å®ç°ç®€å•å¾ˆå¤š, å› ä¸ºæœ‰ Linux APP è¿è¡Œç¯å¢ƒçš„æ”¯æŒ. åŒæ—¶, è¿œç¨‹ Monitor æ¶æ„ä¸‹, Monitor å’Œ æ“ä½œç³»ç»Ÿè‡ªèº«çš„è¾“å…¥è¾“å‡ºåˆ†å¼€, ç”¨æˆ·å¯è¯»æ€§æ›´å¥½.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Server æ˜¯åµŒå…¥åˆ°Kernelçš„ä»£ç ä¸­, ä¸Clientè¿›è¡Œäº¤äº’. å®ƒæ˜¯æ•´ä¸ª Monitor ç³»ç»Ÿçš„åç«¯, è´Ÿè´£å®ç°åŸºç¡€çš„è°ƒè¯•æ“ä½œ. ä¾‹å¦‚, è®¾ç½®æ–­ç‚¹, å†…å­˜çš„è¯»å†™, å¯„å­˜å™¨çš„è¯»å†™ç­‰.&lt;/p>
&lt;ul>
&lt;li>ç”±äºServerä¸ Kernel ä½äºåŒä¸€ä¸ªåœ°å€ç©ºé—´, æ‰€ä»¥æŸ¥çœ‹/ä¿®æ”¹å†…å­˜çš„å€¼æ˜¯éå¸¸æ–¹ä¾¿çš„. å¯¹äºå¯„å­˜å™¨ä¹Ÿæ˜¯åŒç†.&lt;/li>
&lt;li>æ–­ç‚¹(Breakpoint), ç›‘è§†ç‚¹(Watchpoint), å•æ­¥æ‰§è¡Œ(Soft step)çš„å®ç°ä¾èµ–ä¸ ARMv8 æä¾›çš„çš„ &lt;a href="https://developer.arm.com/-/media/Arm%20Developer%20Community/PDF/Learn%20the%20Architecture/V8A%20Self-hosted%20debug.pdf?revision=5eff4cc6-b4ca-4017-a07d-2957307058cb">self-hosted debug&lt;/a> æ”¯æŒ.&lt;/li>
&lt;/ul>
&lt;p>åŒæ—¶, Server è¿˜è´Ÿè´£ç›‘è§†ç³»ç»Ÿä¸­æ‰€æœ‰çš„ åŒæ­¥å¼‚å¸¸å’Œç³»ç»Ÿé”™è¯¯. ä¸€æ—¦å‘ç”Ÿ, å¯åœ¨ Monitor ä¸­æŸ¥çœ‹æŸäº›å†…å­˜, å¯„å­˜å™¨çš„å€¼å®šä½é—®é¢˜å‘ç”Ÿçš„åŸå› .&lt;/p>
&lt;h3 id="monitor-client-è®¾è®¡">Monitor Client è®¾è®¡&lt;/h3>
&lt;p>Client çš„æ„æˆå¯åˆ†ä¸ºä¸‰ä¸ªæ¨¡å— :&lt;/p>
&lt;ul>
&lt;li>ç”¨æˆ·äº¤äº’æ¨¡å—&lt;/li>
&lt;li>ç¬¦å·å¤„ç†æ¨¡å—&lt;/li>
&lt;li>æ¶ˆæ¯æ”¶å‘æ¨¡å—&lt;/li>
&lt;/ul>
&lt;p>ç”¨æˆ·äº¤äº’æ¨¡å—è´Ÿè´£å¤„ç†ç”¨æˆ·çš„è¾“å…¥è¾“å‡º, è°ƒç”¨å…¶ä»–ä¸¤ä¸ªæ¨¡å—å®Œæˆè°ƒè¯•å‘½ä»¤.&lt;/p>
&lt;p>ç¬¦å·å¤„ç†æ¨¡å—è´Ÿè´£è§£æå¯æ‰§è¡Œæ–‡ä»¶(ELF), å¹¶å»ºç«‹é™æ€ç¬¦å·è¡¨, å­˜å‚¨ç¬¦å·å’Œåœ°å€çš„å¯¹åº”å…³ç³». å°†ç”¨æˆ·è¾“å…¥çš„ç¬¦å·è§£æä¸ºè™šæ‹Ÿåœ°å€, æˆ–è€…åå‘è§£æ.&lt;/p>
&lt;p>æ¶ˆæ¯æ”¶å‘æ¨¡å—è´Ÿè´£å¤„ç†ç”¨æˆ·çš„è¾“å…¥, å°†å…¶è½¬åŒ–ä¸ºåŸºç¡€, æ ‡å‡†çš„å‘½ä»¤, å‘é€ç»™Serveræ‰§è¡Œ. Client å’Œ Serverä¹‹é—´é€šä¿¡çš„æ•°æ®åŒ…åè®®å¯ä»¥ä½¿ç”¨ &lt;a href="https://sourceware.org/gdb/onlinedocs/gdb/Remote-Protocol.html">GDB Remote Serial Protocol&lt;/a> (ä»¥ä¸‹ç®€ç§°RSPåè®®), æˆ–è€…è‡ªå·±è§„å®šä¸€ä¸ªåè®®ä¹Ÿæ˜¯å¯è¡Œçš„.&lt;/p>
&lt;blockquote>
&lt;p>RSPåè®®æ”¯æŒä¸‰ç§åŸºç¡€å‘½ä»¤:&lt;/p>
&lt;ol>
&lt;li>å¯„å­˜å™¨ç›¸å…³&lt;/li>
&lt;li>å†…å­˜ç›¸å…³&lt;/li>
&lt;li>ç¨‹åºæ§åˆ¶å‘½ä»¤&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;h3 id="å¯ç”¨-monitor-æ—¶-kernel-å¯åŠ¨æµç¨‹">å¯ç”¨ Monitor æ—¶ Kernel å¯åŠ¨æµç¨‹&lt;/h3>
&lt;ol>
&lt;li>Kernel é¦–å…ˆåšå¿…è¦çš„åˆå§‹åŒ–, GIC, å¼‚å¸¸å‘é‡è¡¨, MMUç­‰.&lt;/li>
&lt;li>å°†æ§åˆ¶æƒäº¤ç»™ Monitor, ç­‰å¾…ç”¨æˆ·è¾“å…¥.&lt;/li>
&lt;/ol>
&lt;p>Â &lt;/p>
&lt;h2 id="kernel-debug-è¿‡ç¨‹ç¤ºä¾‹">Kernel debug è¿‡ç¨‹ç¤ºä¾‹&lt;/h2>
&lt;h3 id="ç¤ºä¾‹ä¸€-æŸ¥çœ‹å˜é‡-var-çš„å€¼">ç¤ºä¾‹ä¸€: æŸ¥çœ‹å˜é‡ &lt;code>var&lt;/code> çš„å€¼&lt;/h3>
&lt;ol>
&lt;li>ç”¨æˆ·è¾“å…¥ &lt;code>print var&lt;/code> æŒ‡ä»¤.&lt;/li>
&lt;li>ç”±ç¬¦å·å¤„ç†æ¨¡å—, å°†&lt;code>var&lt;/code>ç¬¦å·è½¬ä¸ºvar è™šæ‹Ÿåœ°å€.&lt;/li>
&lt;li>ç”±æ¶ˆæ¯æ”¶å‘æŒ‡ä»¤å°†è¯·æ±‚å°è£…ä¸ºRSPåè®®åŒ…æ ¼å¼, å¹¶å‘é€åˆ° Monitor Server.&lt;/li>
&lt;li>æ‰§è¡Œæµç¨‹äº¤ç»™ Monitor Server, å®ƒè®¿é—®è¯¥åœ°å€, å°†å†…å®¹å°è£…å‘å› Monitor Client.&lt;/li>
&lt;li>Client è¾“å‡º&lt;code>var&lt;/code>çš„å€¼, ç»§ç»­ç­‰å¾…ç”¨æˆ·è¾“å…¥&lt;/li>
&lt;/ol>
&lt;h3 id="ç¤ºä¾‹äºŒ-æ·»åŠ æ–­ç‚¹åˆ°-main-å‡½æ•°">ç¤ºä¾‹äºŒ: æ·»åŠ æ–­ç‚¹åˆ° &lt;code>main&lt;/code> å‡½æ•°&lt;/h3>
&lt;ol>
&lt;li>ç”¨æˆ·è¾“å…¥ &lt;code>break main&lt;/code> æŒ‡ä»¤&lt;/li>
&lt;li>ç”±ç¬¦å·å¤„ç†æ¨¡å—, è§£æå¾—åˆ° &lt;code>main&lt;/code> å‡½æ•°çš„åœ°å€.&lt;/li>
&lt;li>æ¶ˆæ¯æ”¶å‘æ¨¡å—å°†è¯·æ±‚å°è£…ä¸ºRSPåŒ…æ ¼å¼, å‘é€åˆ°Monitor Server.&lt;/li>
&lt;li>æ‰§è¡Œæµç¨‹äº¤ç»™ Server. å®ƒæ‰§è¡Œ &lt;em>breakpoint exception æŒ‡ä»¤&lt;/em>, å¹¶è®¾ç½®ç›¸å…³è½¯ä»¶æ–­ç‚¹ç›¸å…³å¯„å­˜å™¨&lt;/li>
&lt;li>æ‰§è¡Œæµäº¤ç»™ Kernel, ç›´åˆ°è¾¾åˆ°æ–­ç‚¹å¤„(å¯ä½¿ç”¨åœ°å€+ContextIDåŒé‡éªŒè¯), è§¦å‘Debugå¼‚å¸¸&lt;/li>
&lt;li>Debugå¼‚å¸¸å±äºåŒæ­¥å¼‚å¸¸, ç”± Monitor ç³»ç»Ÿæ¥ç®¡, å›åˆ° Client ç»§ç»­ç­‰å¾…ç”¨æˆ·è¾“å…¥&lt;/li>
&lt;/ol>
&lt;h3 id="ç¤ºä¾‹ä¸‰-å•æ­¥æ‰§è¡Œ">ç¤ºä¾‹ä¸‰: å•æ­¥æ‰§è¡Œ&lt;/h3>
&lt;ol>
&lt;li>ç”¨æˆ·è¾“å…¥ &lt;code>step&lt;/code> æŒ‡ä»¤&lt;/li>
&lt;li>æ¶ˆæ¯æ”¶å‘æ¨¡å—å°†è¯·æ±‚å°è£…ä¸ºRSPåŒ…æ ¼å¼, å‘é€åˆ° Monitor Server.&lt;/li>
&lt;li>æ‰§è¡Œæµç¨‹äº¤ç»™ Server, å¯ç”¨ software step. ç„¶æ‰§è¡Œä¸€æ¬¡å¼‚å¸¸è¿”å›, å›åˆ°Kernel ç»§ç»­æ‰§è¡Œ.&lt;/li>
&lt;li>å› ä¸ºå¯ç”¨äº† Software step, å›åˆ° Kernel æ‰§è¡Œå®Œä¸€æ¡æŒ‡ä»¤å, å°±ä¼šè§¦å‘ Debugå¼‚å¸¸&lt;/li>
&lt;li>Debug å¼‚å¸¸å±äºåŒæ­¥å¼‚å¸¸, ç”± Monitor ç³»ç»Ÿæ¥ç®¡, å›åˆ° Client ç»§ç»­ç­‰å¾…ç”¨æˆ·è¾“å…¥&lt;/li>
&lt;/ol>
&lt;p>Â &lt;/p>
&lt;h2 id="å…¶ä»–æ‹“å±•åŠŸèƒ½">å…¶ä»–æ‹“å±•åŠŸèƒ½&lt;/h2>
&lt;p>back trace&lt;/p>
&lt;p>æ€§èƒ½åˆ†æ&lt;/p>
- https://wangloo.github.io/posts/os/monitor/ - @2019 Notepadium.</description></item><item><title>ARMv8-A MMUä»‹ç»</title><link>https://wangloo.github.io/posts/armv8/mmu/</link><pubDate>Thu, 29 Sep 2022 08:01:33 +0800</pubDate><guid>https://wangloo.github.io/posts/armv8/mmu/</guid><description>Wangloo's BLOG https://wangloo.github.io/posts/armv8/mmu/ -&lt;h2 id="introduction">Introduction&lt;/h2>
&lt;p>MMU: ä¸“ç”¨äºå°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€. é€šå¸¸é…åˆåˆ†é¡µæœºåˆ¶æ¥å·¥ä½œ.&lt;/p>
&lt;p>é¡µè¡¨: é¡µè¡¨ä¸­çš„è¡¨é¡¹åŒ…å«æä¾›è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„.&lt;/p>
&lt;p>MMUå°±æ˜¯ç›´æ¥è®¿é—®é¡µè¡¨, å¹¶ä¸”é€šè¿‡å°†é¢‘ç¹ä½¿ç”¨çš„æ˜ å°„ç¼“å­˜åˆ°TLBä¸­.&lt;/p>
&lt;h3 id="mmu-çš„ç»“æ„">MMU çš„ç»“æ„&lt;/h3>
&lt;p>MMUæ˜¯ä¸€ç§ç¡¬ä»¶, å¯ä»¥é€šè¿‡åœ¨é€‚å½“çš„å®‰å…¨çŠ¶æ€ä¸‹å¯¹å…¶è¿›è¡Œé…ç½®. æ¯ä¸ªCoreéƒ½æœ‰è‡ªå·±çš„MMU, æ¯ä¸ªMMUåŒ…æ‹¬:&lt;/p>
&lt;ol>
&lt;li>ä¸€ä¸ªTLB, ç¼“å­˜æœ€è¿‘è®¿é—®çš„æ˜ å°„.&lt;/li>
&lt;li>ä¸€ä¸ªTable Walk Unit, ä»å†…å­˜ä¸­æŸ¥è¯¢é¡µè¡¨, å¾—åˆ°æœ€ç»ˆçš„è™šæ‹Ÿåœ°å€-ç‰©ç†åœ°å€çš„æ˜ å°„.&lt;/li>
&lt;/ol>
&lt;p>MMU æ§åˆ¶ç€æ•´ä¸ªç³»ç»Ÿçš„ç¼“å­˜ç­–ç•¥, å†…å­˜å±æ€§å’Œè®¿é—®æƒé™. MMUå¼€å¯å, è½¯ä»¶å‘å‡ºçš„æ‰€æœ‰å†…å­˜è®¿é—®éƒ½ä½¿ç”¨è™šæ‹Ÿåœ°å€, è¦æ±‚MMUä¸ºæ¯æ¬¡è®¿é—®è¿›è¡Œåœ°å€è½¬æ¢.&lt;/p>
&lt;h3 id="mmu-çš„é…ç½®">MMU çš„é…ç½®&lt;/h3>
&lt;p>åœ¨å¯ç”¨MMUå‰, å¿…é¡»å‘ŠçŸ¥å…¶é¡µè¡¨å­˜æ”¾çš„ä½ç½®.&lt;/p>
&lt;h3 id="mmu-åœ°å€è½¬æ¢çš„è¿‡ç¨‹">MMU åœ°å€è½¬æ¢çš„è¿‡ç¨‹&lt;/h3>
&lt;p>å¯¹äºæ¯ä¸ªè½¬æ¢è¯·æ±‚, MMUé¦–å…ˆæ£€æŸ¥TLBæ˜¯å¦å·²ç»å¯¹è¯¥åœ°å€ç¼“å­˜, å¦‚æœè¯¥åœ°å€æœªç¼“å­˜, åˆ™éœ€è¦éå†é¡µè¡¨.&lt;/p>
&lt;p>é¡µè¡¨éå†å•å…ƒåœ¨é¡µè¡¨ä¸­æœç´¢ç›¸å…³çš„æ˜ å°„è¡¨é¡¹.&lt;/p>
&lt;ul>
&lt;li>ä¸€æ—¦æ‰¾åˆ°æ˜ å°„, MMUå°±ä¼šæ£€æŸ¥æƒé™å’Œå±æ€§. å†³å®šå…è®¸æœ¬æ¬¡è®¿é—®, æˆ–è€…å‘å‡ºæ•…éšœä¿¡å·.&lt;/li>
&lt;li>è‹¥æœªæ‰¾åˆ°æ˜ å°„, åˆ™è§¦å‘ç¼ºé¡µå¼‚å¸¸.&lt;/li>
&lt;/ul>
&lt;h3 id="é¡µè¡¨çš„å·¥ä½œåŸç†">é¡µè¡¨çš„å·¥ä½œåŸç†&lt;/h3>
&lt;p>é¡µè¡¨çš„å·¥ä½œæ–¹å¼æ˜¯å°†è™šæ‹Ÿåœ°å€ç©ºé—´å’Œç‰©ç†åœ°å€ç©ºé—´åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„å—, ç§°ä¸ºé¡µé¢.&lt;/p>
&lt;p>é¡µè¡¨ä¸­çš„æ¯ä¸ªè¡¨é¡¹å¯¹åº”ç€ä¸€å—è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„å—, è¡¨é¡¹çš„å€¼å°±æ˜¯è¿™å—è™šæ‹Ÿåœ°å€ç©ºé—´å¯¹åº”çš„ç‰©ç†åœ°å€å—, ä»¥åŠè®¿é—®ç‰©ç†åœ°å€æ—¶è¦ä½¿ç”¨çš„å±æ€§.&lt;/p>
&lt;p>åœ¨æŸ¥è¡¨è¿‡ç¨‹ä¸­, å°†è™šæ‹Ÿåœ°å€åˆ†ä¸ºä¸¤éƒ¨åˆ†:&lt;/p>
&lt;ul>
&lt;li>é«˜é˜¶ä½ç”¨ä½œé¡µè¡¨çš„ç´¢å¼•. ç”¨æ¥æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†å—&lt;/li>
&lt;li>ä½åœ°å€æ˜¯å—å†…çš„åç§»é‡, ä¸ä¼šå› ä¸ºæ˜ å°„è€Œæ”¹å˜. é¡µè¡¨é¡¹ä¸­çš„ç‰©ç†åœ°å€ä¸è¯¥åç§»ç»„åˆå½¢æˆç”¨äºè®¿é—®å†…å­˜çš„ç‰©ç†åœ°å€.&lt;/li>
&lt;/ul>
&lt;h4 id="å¤šçº§é¡µè¡¨">å¤šçº§é¡µè¡¨&lt;/h4>
&lt;p>å®é™…å®ç°ä¸­, å¤šé‡‡ç”¨å¤šçº§é¡µè¡¨çš„æ–¹æ¡ˆ, å„çº§é¡µè¡¨è‡ªå®šå‘ä¸‹ç»„æˆæ ‘çš„å½¢å¼, åä½œå®ç°è™šæ‹Ÿåˆ°ç‰©ç†åœ°å€çš„è½¬æ¢.&lt;/p>
&lt;p>æ ‘ä¸­çš„åˆ†æ”¯æˆä¸ºé¡µç›®å½•, é¡µç›®å½•ä¸­çš„è¡¨é¡¹ä¸æ˜¯ç›´æ¥å­˜å‚¨ç›®æ ‡ç‰©ç†åœ°å€, è€Œæ˜¯ä¸‹ä¸€çº§é¡µè¡¨çš„åœ°å€; æœ€åä¸€çº§é¡µè¡¨çš„è¡¨é¡¹ä¸­ä¿å­˜ç€ç›®æ ‡ç‰©ç†åœ°å€.&lt;/p>
&lt;blockquote>
&lt;p>å¤šçº§é¡µè¡¨æ˜¯å‡å°é¡µè¡¨å ç”¨å­˜å‚¨ç©ºé—´è¿‡å¤§çš„æœ‰æ•ˆæ–¹æ¡ˆ.&lt;/p>
&lt;/blockquote>
&lt;p>é¡¶çº§é¡µè¡¨å°†åœ°å€ç©ºé—´åˆ’åˆ†ä¸ºå¤§å—, æ¯ä¸ªè¡¨é¡¹å¯ä»¥æŒ‡å‘å¤§å°ç›¸ç­‰çš„å†…å­˜å—. ä¹Ÿå¯ä»¥æŒ‡å‘å°†å—è¿›è¡Œå†æ¬¡ç»†åˆ†çš„ä¸‹ä¸€çº§é¡µè¡¨. æ”¯æŒå¤§å—çš„ä¼˜ç‚¹:&lt;/p>
&lt;ul>
&lt;li>å¤§çš„å†…å­˜å—éœ€è¦æŸ¥è¡¨çš„æ¬¡æ•°æ›´å°‘&lt;/li>
&lt;li>æå‡TLBçš„æ•ˆç‡, å› ä¸ºä¸€ä¸ªTLBè¡¨é¡¹è¦†ç›–æ›´å¤§çš„å†…å­˜åŒºåŸŸ.&lt;/li>
&lt;/ul>
&lt;p>å‡¡äº‹éƒ½æ˜¯æœ‰åˆ©æœ‰å¼Š, ä½¿ç”¨å¤§å—ä¹Ÿå¢åŠ äº†å†…å­˜æµªè´¹, å®é™…ä½¿ç”¨æ—¶éœ€è¦æ ¹æ®éœ€è¦æ¥æƒè¡¡.&lt;/p>
&lt;h2 id="å†…å­˜ç±»å‹">å†…å­˜ç±»å‹&lt;/h2>
&lt;h3 id="æ™®é€šç±»å‹å†…å­˜">æ™®é€šç±»å‹å†…å­˜&lt;/h3>
&lt;p>æ™®é€šç±»å‹çš„å†…å­˜æ˜¯å¼±ä¸€è‡´æ€§çš„(weakly ordered)å†…å­˜æ¨¡å‹, æ²¡æœ‰é¢å¤–çš„çº¦æŸ, å¯ä»¥æä¾›æœ€é«˜çš„å†…å­˜è®¿é—®æ€§èƒ½.&lt;/p>
&lt;p>é€šå¸¸ä»£ç æ®µ, æ•°æ®æ®µä»¥åŠå…¶ä»–æ•°æ®éƒ½æ”¾åœ¨æ™®é€šå†…å­˜ä¸­.&lt;/p>
&lt;p>æ™®é€šå†…å­˜å…è®¸å¤„ç†å™¨åšå¾ˆå¤šä¼˜åŒ–, å¦‚åˆ†æ”¯é¢„æµ‹, æ•°æ®é¢„å–, Cache lineé¢„å–, ä¹±åºæ‰§è¡Œç­‰.&lt;/p>
&lt;h3 id="è®¾å¤‡ç±»å‹å†…å­˜">è®¾å¤‡ç±»å‹å†…å­˜&lt;/h3>
&lt;p>CPUè®¿é—®è®¾å¤‡å†…å­˜ä¼šæœ‰å¾ˆå¤šé™åˆ¶, å¦‚ä¸èƒ½è¿›è¡Œæ•°æ®é¢„å–ç­‰. è®¾å¤‡ç±»å‹çš„å†…å­˜ä¸¥æ ¼æŒ‰ç…§æŒ‡ä»¤çš„é¡ºåºæ¥æ‰§è¡Œçš„.&lt;/p>
&lt;p>è®¾å¤‡ç±»å‹å†…å®¹é€šå¸¸ç•™ç»™è®¾å¤‡æ¥è®¿é—®, ä¾‹å¦‚ä¸­æ–­æ§åˆ¶å™¨(GIC), ä¸²å£, å®šæ—¶å™¨ç­‰.&lt;/p>
&lt;h2 id="ä¸¤å¥—é¡µè¡¨">ä¸¤å¥—é¡µè¡¨&lt;/h2>
&lt;ul>
&lt;li>å½“CPUè®¿é—®çš„åœ°å€å±äº&lt;em>ç”¨æˆ·ç©ºé—´&lt;/em>æ—¶, MMUä¼šè‡ªåŠ¨é€‰æ‹©&lt;strong>TTBR0&lt;/strong>æŒ‡å‘çš„é¡µè¡¨.&lt;/li>
&lt;li>å½“CPUè®¿é—®çš„åœ°å€å±äº&lt;em>å†…æ ¸ç©ºé—´&lt;/em>æ—¶. MMUä¼šè‡ªåŠ¨é€‰æ‹©&lt;strong>TTBR1&lt;/strong>æŒ‡å‘çš„é¡µè¡¨&lt;/li>
&lt;/ul>
&lt;p>EL2å’ŒEL3æ²¡æœ‰TTBR1, åªæœ‰TTBR0. ä¹Ÿå°±æ„å‘³ç€:&lt;/p>
&lt;p>â€¢ If EL2 is using AArch64, it can only use Virtual Addresses in the range 0x0 to 0x0000FFFF_FFFFFFFF.
â€¢ If EL3 is using AArch64, it can only use Virtual Addresses in the range 0x0 to 0x0000FFFF_FFFFFFFF.&lt;/p>
&lt;h2 id="è¶Šæƒ-è¶Šç•Œ">è¶Šæƒ, è¶Šç•Œ&lt;/h2>
&lt;p>åœ¨æœªä½¿ç”¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¹‹å‰, æ‰€æœ‰çš„ç”¨æˆ·ç¨‹åºéƒ½å¯ä»¥è®¿é—®å…¨éƒ¨çš„ç‰©ç†å†…å­˜, æ‰€ä»¥æ¶æ„ç¨‹åºå¯ä»¥ä¿®æ”¹å…¶ä»–ç¨‹åºçš„å†…å­˜æ•°æ®, è¿™ä½¿å¾—æ•´ä¸ªç³»ç»Ÿå¤„äºå±é™©çš„çŠ¶æ€. æ¯ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´éƒ½è¦å—åˆ°ä¿æŠ¤, ä»¥å…è¢«å…¶ä»–è¿›ç¨‹æœ‰æ„/æ— æ„çš„ç ´å.&lt;/p>
&lt;p>ç°ä»£æ“ä½œç³»ç»Ÿä¸­, æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´. åœ¨è¿›ç¨‹çš„è§’åº¦ä¸Š, å®ƒæ‹¥æœ‰æ•´ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´. ä¸åŒçš„è¿›ç¨‹å¯ä»¥åŒæ—¶ä½¿ç”¨ä¸€ä¸ªè™šæ‹Ÿåœ°å€, MMUé€šè¿‡é¡µè¡¨å°†å…¶æ˜ å°„åˆ°åˆé€‚çš„ç‰©ç†åœ°å€.&lt;/p>
&lt;h3 id="ä¸¤ä¸ªç‰©ç†åœ°å€ç©ºé—´">ä¸¤ä¸ªç‰©ç†åœ°å€ç©ºé—´&lt;/h3>
&lt;p>ARMv8 ä½“ç³»ç»“æ„å®šä¹‰ä¸¤ä¸ªç‰©ç†åœ°å€ç©ºé—´: secure address space å’Œ non-secure address space.&lt;/p>
&lt;p>ç†è®ºä¸Š, å®‰å…¨å’Œéå®‰å…¨çš„åœ°å€ç©ºé—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„, ç„¶è€Œç°å®ä¸­å¤§å¤šæ•°ç³»ç»Ÿéƒ½å°†å®‰å…¨å’Œéå®‰å…¨è§†ä¸ºè®¿é—®æ§åˆ¶çš„å±æ€§. æ­£å¸¸(éå®‰å…¨)ä¸–ç•Œåªèƒ½è®¿é—®éå®‰å…¨çš„ç‰©ç†å†…å­˜; è€Œå®‰å…¨ä¸–ç•Œå¯ä»¥è®¿é—®è¿™ä¸¤ä¸ªåœ°å€ç©ºé—´.&lt;/p>
&lt;h3 id="armv8-mmuæƒé™æ§åˆ¶">ARMv8 MMUæƒé™æ§åˆ¶&lt;/h3>
&lt;p>ç¨‹åºè¯·æ±‚æŸä¸ªåœ°å€æ—¶, MMUéœ€è¦è¿›è¡Œæƒé™æ£€æŸ¥. å¦‚æœè¯·æ±‚çš„åœ°å€æ˜¯æ•°æ®, åˆ™æ£€æŸ¥è¯»å†™æƒé™; å¦‚æœè¯·æ±‚çš„æ˜¯åœ°å€, åˆ™æ£€æŸ¥å…¶å¯æ‰§è¡Œæƒé™.&lt;/p>
&lt;p>ARMv8 é¡µè¡¨é¡¹çš„APå­—æ®µæ§åˆ¶è¯¥ä¸åŒå¼‚å¸¸ç­‰çº§ä¸‹, é¡µé¢çš„è¯»å†™æƒé™.&lt;/p>
&lt;p>[è¡¨æ ¼]&lt;/p>
&lt;p>ARMv8 é¡µè¡¨é¡¹çš„PNXå­—æ®µå’ŒXN/UXNå­—æ®µæ¥è®¾ç½®CPUæ˜¯å¦å¯¹è¿™ä¸ªé¡µé¢æœ‰æ‰§è¡Œæƒé™.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å½“ç³»ç»Ÿæœ‰ä¸¤å¥—é¡µè¡¨æ—¶, UXNæ˜¯ç”¨æ¥è®¾ç½®ç”¨æˆ·ç©ºé—´é¡µé¢æ˜¯å¦æœ‰å¯æ‰§è¡Œæƒé™; PXN ç”¨æ¥è®¾ç½®ç‰¹æƒç©ºé—´çš„é¡µé¢æ˜¯å¦æœ‰å¯æ‰§è¡Œæƒé™.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è‹¥ç³»ç»Ÿåªæœ‰ä¸€å¥—é¡µè¡¨, åˆ™é€šè¿‡XNå­—æ®µæ§åˆ¶&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="é¡µè¡¨çš„ç»“æ„">é¡µè¡¨çš„ç»“æ„&lt;/h2>
&lt;h3 id="åœ°å€å®½åº¦">åœ°å€å®½åº¦&lt;/h3>
&lt;p>48bit&lt;/p>
&lt;h3 id="é¡µé¢ç²’åº¦">é¡µé¢ç²’åº¦&lt;/h3>
&lt;p>é¡µé¢ç²’åº¦è¡¨ç¤ºä¸€æ¬¡æœ€å°åˆ†é…å†…å­˜å—çš„å¤§å°. AArch64æ”¯æŒä¸‰ç§é¡µçš„å¤§å°, 4KB, 16KB, 64KB. æ”¯æŒå“ªä¸€ç§æ˜¯ç”±å®ç°å®šä¹‰çš„ã€‚åˆ›å»ºé¡µè¡¨çš„ä»£ç èƒ½å¤Ÿè¯»å–ç³»ç»Ÿå¯„å­˜å™¨&lt;code>ID_AA64MMFR0_EL1&lt;/code>ï¼Œä»¥æ‰¾å‡ºå“ªäº›æ˜¯å—æ”¯æŒçš„å¤§å°ã€‚Cortex-A53å¤„ç†å™¨æ”¯æŒæ‰€æœ‰ä¸‰ç§å°ºå¯¸ï¼Œä½†æœ‰äº›å¤„ç†å™¨çš„æ—©æœŸç‰ˆæœ¬å¹¶éå¦‚æ­¤ï¼Œä¾‹å¦‚Cortex-A57ï¼Œå®ƒä¸æ”¯æŒ16Kç²’åº¦ã€‚&lt;/p>
&lt;h3 id="aarch64-é¡µè¡¨é¡¹ç»“æ„">AArch64 é¡µè¡¨é¡¹ç»“æ„&lt;/h3>
&lt;h4 id="æ— æ•ˆé¡µè¡¨é¡¹">æ— æ•ˆé¡µè¡¨é¡¹&lt;/h4>
&lt;h4 id="table">table&lt;/h4>
&lt;h4 id="block">block&lt;/h4>
&lt;h3 id="é¡µè¡¨ç»“æ„4kbé¡µé¢ä¸ºä¾‹">é¡µè¡¨ç»“æ„(4KBé¡µé¢ä¸ºä¾‹)&lt;/h3>
&lt;p>ä»¥4KBé¡µé¢ç²’åº¦, è™šæ‹Ÿåœ°å€å®½åº¦ä¸º 48ä½. ä½¿ç”¨4çº§é¡µè¡¨.&lt;/p>
&lt;p>48ä½åœ°å€æ¯å±‚è½¬æ¢æœ‰9ä¸ªåœ°å€ä½ï¼Œå³æ¯å±‚512ä¸ªæ¡ç›®ï¼Œæœ€å12ä½é€‰æ‹©4kBå†…çš„ä¸€ä¸ªå­—èŠ‚ï¼Œç›´æ¥æ¥è‡ªåŸå§‹åœ°å€&lt;/p>
&lt;h2 id="è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢è¿‡ç¨‹">è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢è¿‡ç¨‹&lt;/h2>
&lt;p>å½“å¤„ç†å™¨ä¸ºè·å–æŒ‡ä»¤æˆ–æ•°æ®è®¿é—®å‘å‡ºä¸€ä¸ª64ä½çš„è™šæ‹Ÿåœ°å€æ—¶ï¼ŒMMUç¡¬ä»¶å°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç›¸åº”çš„ç‰©ç†åœ°å€ã€‚å¯¹äºè™šæ‹Ÿåœ°å€ï¼Œå‰16ä½[63:47]å¿…é¡»å…¨éƒ¨ä¸º0æˆ–1ï¼Œå¦åˆ™åœ°å€å°†è§¦å‘æ•…éšœã€‚&lt;/p>
&lt;h3 id="non-secure-and-secure-access">Non-secure and secure access&lt;/h3>
&lt;p>ARMv8-Aæ¶æ„å®šä¹‰äº†ä¸¤ç§å®‰å…¨çŠ¶æ€:å®‰å…¨çš„å’Œéå®‰å…¨çš„ã€‚å®ƒè¿˜å®šä¹‰äº†ä¸¤ä¸ªç‰©ç†åœ°å€ç©ºé—´:å®‰å…¨çš„å’Œéå®‰å…¨çš„. æ­£å¸¸(éå®‰å…¨)ä¸–ç•Œåªèƒ½è®¿é—®éå®‰å…¨ç‰©ç†åœ°å€ç©ºé—´ã€‚å®‰å…¨ä¸–ç•Œå¯ä»¥è®¿é—®ä¸¤ä¸ªç‰©ç†åœ°å€ç©ºé—´ã€‚è¿™ä¹Ÿæ˜¯é€šè¿‡è½¬æ¢è¡¨æ¥æ§åˆ¶çš„ã€‚&lt;/p>
&lt;p>åœ¨éå®‰å…¨çŠ¶æ€ä¸‹ï¼Œè½¬æ¢è¡¨ä¸­çš„NSä½å’ŒNSTableä½å°†è¢«å¿½ç•¥ã€‚åªèƒ½è®¿é—®éå®‰å…¨å†…å­˜ã€‚åœ¨å®‰å…¨çŠ¶æ€ä¸‹ï¼ŒNSä½å’ŒNSTableä½æ§åˆ¶è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºå®‰å…¨ç‰©ç†åœ°å€è¿˜æ˜¯éå®‰å…¨ç‰©ç†åœ°å€ã€‚&lt;/p>
&lt;p>You can use SCR_EL3.SIF æ¥ç¦ç”¨å®‰å…¨ä¸–ç•Œè®¿é—®éå®‰å…¨åœ°å€.&lt;/p>
&lt;h2 id="ç›¸å…³çš„å¯„å­˜å™¨">ç›¸å…³çš„å¯„å­˜å™¨&lt;/h2>
&lt;p>ä¸åœ°å€è½¬æ¢ç›¸å…³çš„å¯„å­˜å™¨ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ª:&lt;/p>
&lt;ol>
&lt;li>è½¬æ¢æ§åˆ¶å¯„å­˜å™¨(TCR)&lt;/li>
&lt;li>ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨(SCTLR)&lt;/li>
&lt;li>é¡µè¡¨åŸºåœ°å€å¯„å­˜å™¨(TTBR)&lt;/li>
&lt;/ol>
&lt;h3 id="tcr">TCR&lt;/h3>
&lt;p>IPS: é…ç½®åœ°å€è½¬æ¢åè¾“å‡ºç‰©ç†åœ°å€çš„æœ€å¤§å€¼&lt;/p>
&lt;p>TxSz: é…ç½®è¾“å…¥åœ°å€çš„æœ€å¤§å€¼, å³è™šæ‹Ÿåœ°å€çš„å®½åº¦&lt;/p>
&lt;p>TG1: é…ç½®TTBR1é¡µè¡¨çš„é¡µé¢ç²’åº¦å¤§å°&lt;/p>
&lt;p>SHx: é…ç½®TTBRxç›¸å…³å†…å­˜çš„Cacheå…±äº«å±æ€§&lt;/p>
&lt;p>ORGNx:&lt;/p>
&lt;p>IRGNx:&lt;/p>
&lt;h3 id="sctlr">SCTLR&lt;/h3>
&lt;p>M: Disable/Enable MMUåœ°å€è½¬æ¢&lt;/p>
&lt;p>C: Disable/Enable Data Cache&lt;/p>
&lt;p>I: Disable/Enable Instruction Cache&lt;/p>
&lt;h3 id="ttbr">TTBR&lt;/h3>
&lt;p>å­˜å‚¨é¡µè¡¨çš„åŸºåœ°å€&lt;/p>
&lt;h2 id="aarch32-è™šæ‹Ÿå†…å­˜ç³»ç»Ÿ">AArch32 è™šæ‹Ÿå†…å­˜ç³»ç»Ÿ&lt;/h2>
&lt;p>ARMv8 AArch32 çš„è™šæ‹Ÿå†…å­˜ç³»ç»Ÿå‘åå…¼å®¹ARMv7, ä¸ARMv7çš„åŸºæœ¬ä¸€è‡´.&lt;/p>
- https://wangloo.github.io/posts/armv8/mmu/ - @2019 Notepadium.</description></item><item><title>AArch64/32 å¼‚å¸¸è¿”å›è¿‡ç¨‹</title><link>https://wangloo.github.io/posts/armv8/exception_return/</link><pubDate>Sat, 24 Sep 2022 21:19:01 +0800</pubDate><guid>https://wangloo.github.io/posts/armv8/exception_return/</guid><description>Wangloo's BLOG https://wangloo.github.io/posts/armv8/exception_return/ -&lt;h2 id="armv8-å¼‚å¸¸è¿”å›æŒ‡ä»¤">ARMv8 å¼‚å¸¸è¿”å›æŒ‡ä»¤&lt;/h2>
&lt;p>å½“å¼‚å¸¸å¤„ç†ç¨‹åºç»“æŸåï¼Œéœ€è¦æ‰§è¡Œ&lt;em>å¼‚å¸¸è¿”å›æŒ‡ä»¤&lt;/em>æ¢å¤è¿›å…¥å¼‚å¸¸ä¹‹å‰çš„çŠ¶æ€.&lt;/p>
&lt;p>å…·ä½“è¦åšçš„äº‹æƒ…åŒ…æ‹¬:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>æ¢å¤å‘ç”Ÿå¼‚å¸¸å‰çš„PC&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä»SPSRä¸­æ¢å¤PSTATEå¯„å­˜å™¨(ç°åœº)&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>å¼‚å¸¸è¿”å›çš„æŒ‡ä»¤æ ¹æ®å½“å‰&lt;strong>æ‰§è¡ŒçŠ¶æ€&lt;/strong>ä¸ºAArch32è¿˜æ˜¯AArch64æœ‰æ‰€ä¸åŒ.&lt;/p>
&lt;h3 id="aarch32">AArch32&lt;/h3>
&lt;p>AArch32çš„å¼‚å¸¸è¿”å›æŒ‡ä»¤åœ¨ä¸åŒçš„&lt;strong>æ¨¡å¼&lt;/strong>ä¸‹ä¹Ÿæœ‰æ‰€ä¸åŒ:&lt;/p>
&lt;p>&lt;strong>è‹¥å¼‚å¸¸æ˜¯åœ¨Hypæ¨¡å¼ä¸‹å¤„ç†:&lt;/strong> ä»…å¯æ‰§è¡Œ&lt;code>ERET&lt;/code>æŒ‡ä»¤ä»å¼‚å¸¸è¿”å›.&lt;/p>
&lt;p>&lt;strong>è‹¥å¼‚å¸¸æ˜¯åœ¨å…¶ä»–æ¨¡å¼ä¸‹å¤„ç†&lt;/strong>, AArch32æä¾›äº†ä»¥ä¸‹çš„å¼‚å¸¸è¿”å›æŒ‡ä»¤:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>ERET&lt;/code> æŒ‡ä»¤&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä½¿ç”¨å¸¦Såç¼€çš„æ•°æ®å¤„ç†æŒ‡ä»¤ç›´æ¥æ“ä½œPC(ä¾‹å¦‚, &lt;code>MOVS, PC, LR&lt;/code>), æ¢å¤PSTATE&lt;/p>
&lt;/li>
&lt;li>
&lt;p>RFE æŒ‡ä»¤: &lt;code>RFE &amp;lt;Rn&amp;gt;&lt;/code>. ä»åŸºå€å¯„å­˜å™¨&lt;!-- raw HTML omitted -->æŒ‡å‘çš„åœ°å€ä¾æ¬¡åŠ è½½PCå’ŒPSTATE&lt;/p>
&lt;/li>
&lt;li>
&lt;p>LDM æŒ‡ä»¤: &lt;code>LDM &amp;lt;Rn&amp;gt; {pc..}&lt;/code>. è‹¥ç›®æ ‡å¯„å­˜å™¨ä¸­åŒ…å«PC, åˆ™ä¼šåŒæ—¶æ¢å¤PSTATE&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="aarch64">AArch64&lt;/h3>
&lt;p>AArch64ä¸‹&lt;strong>ç»Ÿä¸€ä½¿ç”¨&lt;/strong> &lt;code>ERET&lt;/code> æŒ‡ä»¤è¿›è¡Œå¼‚å¸¸è¿”å›.&lt;/p>
&lt;h3 id="æŒ‡ä»¤æ ¼å¼åŠç”¨æ³•å‚è€ƒ">æŒ‡ä»¤æ ¼å¼åŠç”¨æ³•å‚è€ƒ&lt;/h3>
&lt;h4 id="eret">ERET&lt;/h4>
&lt;p>ERETæŒ‡ä»¤å®Œæˆäº†:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>ä»ELR_ELxä¸­æ¢å¤PCæŒ‡é’ˆ&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä»SPSR_ELxä¸­æ¢å¤PSTATEå¯„å­˜å™¨çš„çŠ¶æ€.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h4 id="ldmload-multiple">LDM(Load Multiple)&lt;/h4>
&lt;p>æ ¼å¼: &lt;code>LDM &amp;lt;Rn&amp;gt; {registers}&lt;/code>&lt;/p>
&lt;p>å«ä¹‰: ä»åŸºå€å¯„å­˜å™¨&lt;code>&amp;lt;Rn&amp;gt;&lt;/code>æŒ‡å‘çš„åœ°å€å¼€å§‹ä¾æ¬¡åŠ è½½å¤šä¸ªå¯„å­˜å™¨å€¼. è‹¥ç›®æ ‡å¯„å­˜å™¨ä¸­åŒ…å«PC, åˆ™åŒæ—¶æ¢å¤PSTATE.&lt;/p>
&lt;p>ä¾‹å¦‚: &lt;code>LDM &amp;lt;r0&amp;gt; {pc, r1}&lt;/code> ç­‰ä»·äº:&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-assembly" data-lang="assembly">pc = [r0]
r1 = [r0+4]
PSTATE = SPSR ;ä»…å½“ç›®æ ‡å¯„å­˜å™¨åŒ…å«PCæ—¶è‡ªåŠ¨å®Œæˆ
&lt;/code>&lt;/pre>&lt;h4 id="rfereturn-from-exception">RFE(Return From Exception)&lt;/h4>
&lt;p>æ ¼å¼: &lt;code>LDM &amp;lt;Rn&amp;gt; &lt;/code>&lt;/p>
&lt;p>å«ä¹‰: ä»åŸºå€å¯„å­˜å™¨&lt;code>&amp;lt;Rn&amp;gt;&lt;/code>æŒ‡å‘çš„åœ°å€ä¾æ¬¡åŠ è½½PCå’ŒPSTATE.&lt;/p>
&lt;p>ä¾‹å¦‚: &lt;code>RFE &amp;lt;r0&amp;gt;&lt;/code> ç­‰ä»·äº:&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-ass" data-lang="ass">pc = [r0]
PSTATE = [r0+4]
&lt;/code>&lt;/pre>- https://wangloo.github.io/posts/armv8/exception_return/ - @2019 Notepadium.</description></item><item><title>GNU Cå†…è”æ±‡ç¼–å­¦ä¹ ç¬”è®°</title><link>https://wangloo.github.io/posts/c/inline-asm/</link><pubDate>Sat, 24 Sep 2022 16:48:58 +0800</pubDate><guid>https://wangloo.github.io/posts/c/inline-asm/</guid><description>Wangloo's BLOG https://wangloo.github.io/posts/c/inline-asm/ -&lt;h2 id="è¯­å¥ç»“æ„">è¯­å¥ç»“æ„&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">asm&lt;/span> &lt;span style="color:#ff79c6">asm&lt;/span>&lt;span style="color:#ff79c6">-&lt;/span>qualifiers ( &lt;span style="color:#8be9fd;font-style:italic">AssemblerTemplate&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> : &lt;span style="color:#8be9fd;font-style:italic">OutputOperands&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> : &lt;span style="color:#8be9fd;font-style:italic">InputOperands&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> : &lt;span style="color:#8be9fd;font-style:italic">Clobbers&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> : GotoLabels)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &lt;code>asm&lt;/code> keyword is a GNU extension. å½“ä½¿ç”¨ç¼–è¯‘é€‰é¡¹ &lt;code>-ansi&lt;/code> æˆ– &lt;code>-std&lt;/code> æ—¶, ä½¿ç”¨ &lt;code>__asm__&lt;/code>ä»£æ›¿ &lt;code>asm&lt;/code>.&lt;/p>
&lt;h2 id="qualifiers">Qualifiers&lt;/h2>
&lt;ul>
&lt;li>volatile: é¿å…ç¼–è¯‘å™¨çš„è¿‡åˆ†ä¼˜åŒ–&lt;/li>
&lt;li>goto&lt;/li>
&lt;li>inline&lt;/li>
&lt;/ul>
&lt;h2 id="parameters">Parameters&lt;/h2>
&lt;p>&lt;em>AssemblerTemplate&lt;/em>: å­—ç¬¦ä¸², æ±‡ç¼–ä»£ç çš„æ¨¡æ¿&lt;/p>
&lt;p>&lt;em>OutputOperands&lt;/em>: è¾“å‡ºæ“ä½œæ•°; æŒ‡ä»¤å°†ä¼šä¿®æ”¹çš„å˜é‡é›†åˆ&lt;/p>
&lt;p>&lt;em>InputOperands&lt;/em>: è¾“å…¥æ“ä½œæ•°; æŒ‡ä»¤å°†è¯»å–çš„å˜é‡é›†åˆ&lt;/p>
&lt;p>&lt;em>Clobbers&lt;/em>: ???TODO&lt;/p>
&lt;p>&lt;em>GotoLabels&lt;/em>: ä»…å½“ qualifiers ä½¿ç”¨&lt;code>goto&lt;/code>æ—¶, å£°æ˜labelé›†åˆ.&lt;/p>
&lt;blockquote>
&lt;p>The total number of input + output + goto operands is limited to 30.&lt;/p>
&lt;/blockquote>
&lt;p>Â &lt;/p>
&lt;h3 id="param-1-assemblertemplate">Param #1: AssemblerTemplate&lt;/h3>
&lt;p>å¤šæ¡è¯­å¥å¯ä»¥æ”¾åœ¨ä¸€ä¸ªasmå­—ç¬¦ä¸²ä¸­, ä½†æ˜¯æ›´å¸¸è§çš„æ˜¯æ¯æ¡æ±‡ç¼–è¯­å¥ä½¿ç”¨ä¸€ä¸ªå­—ç¬¦ä¸², å¹¶åœ¨ç»“æŸæ—¶ä½¿ç”¨æ¢è¡Œç¬¦å’Œåˆ¶è¡¨ç¬¦(&lt;code>\n&lt;/code>, &lt;code>\t&lt;/code>)æ¥è¡¨ç¤ºæ¢è¡Œ.&lt;/p>
&lt;blockquote>
&lt;p>è²Œä¼¼å¯¹äº arm æ±‡ç¼–, åªç”¨ &lt;code>\n&lt;/code> ä¹ŸOK?&lt;/p>
&lt;/blockquote>
&lt;p>Â &lt;/p>
&lt;h3 id="param-2-outputoperands">Param #2: OutputOperands&lt;/h3>
&lt;p>å¤šä¸ª OutputOperands ä¹‹é—´ä½¿ç”¨&lt;code>,&lt;/code>éš”å¼€, æ¯ä¸ª OutputOperands çš„æ ¼å¼å¦‚ä¸‹:&lt;/p>
&lt;pre tabindex="0">&lt;code>[ [asmSymbolicName] ] constraint (cvariablename)
&lt;/code>&lt;/pre>&lt;p>&lt;em>asmSymbolicName&lt;/em>: æŒ‡å®šè¯¥æ“ä½œæ•°çš„åç§°&lt;/p>
&lt;p>&lt;em>constraint&lt;/em>: å¯¹è¯¥æ“ä½œæ•°çš„ä¸€äº›é™åˆ¶&lt;/p>
&lt;pre tabindex="0">&lt;code>// æè¿°æ“ä½œæ•°çš„æƒé™, è¾“å‡ºæ“ä½œæ•°çš„çº¦æŸå¿…é¡»ä»¥æ­¤å¼€å¤´
= å¿½ç•¥ç°æœ‰å€¼
+ è¯»å†™, å½“åŸå…ˆå€¼æœ‰æ„ä¹‰æ—¶ç”¨å®ƒ
&amp;amp; ç¦æ­¢ç¼–è¯‘å™¨å°†è¯¥æ“ä½œæ•°ä¸ä¸ç›¸å…³çš„è¾“å…¥æ“ä½œæ•°åˆ†é…åŒä¸€ä¸ªå¯„å­˜å™¨
// æè¿°è¾“å‡ºæ“ä½œæ•°æ‰€åœ¨ä½ç½®, å¦‚æœä½ ä¸çŸ¥é“, å¯ä»¥åŒæ—¶è®¾ç½®, ç¼–è¯‘å™¨ä¼šå¸®ä½ å†³å®š
r å¯„å­˜å™¨
m å†…å­˜
// æ¶æ„ç›¸å…³çš„
z AArch64ä¸­å­˜åœ¨. è¡¨è¾¾å¯ä»¥ä½¿ç”¨é›¶å¯„å­˜å™¨(XZR or WZR). Useful when combined
with `r` to represent an operand that can be either a general-purpose register
or the zero register.
&lt;/code>&lt;/pre>&lt;p>&lt;em>cvariablename&lt;/em>: è¾“å‡ºåˆ°çš„ C è¯­è¨€å˜é‡å&lt;/p>
&lt;p>Â &lt;/p>
&lt;h3 id="param-3-input-operands">Param #3: Input Operands&lt;/h3>
&lt;p>è¾“å…¥æ“ä½œæ•°çš„æ ¼å¼ä¸è¾“å‡ºæ“ä½œæ•°åŸºæœ¬ä¸€è‡´:&lt;/p>
&lt;pre tabindex="0">&lt;code>[ [asmSymbolicName] ] constraint (cexpression)
&lt;/code>&lt;/pre>&lt;blockquote>
&lt;p>å¯¹äºè¾“å…¥æ“ä½œæ•°, ä¸€èˆ¬æ²¡æœ‰åˆ«çš„é™åˆ¶, ä»…ä½¿ç”¨&lt;code>&amp;quot;r&amp;quot;(val)&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>Â &lt;/p>
&lt;h3 id="param-4-clobbers">Param #4: Clobbers&lt;/h3>
&lt;p>æ¯ä¸ª clobber éƒ½æ˜¯ç”¨åŒå¼•å·æ‹¬èµ·æ¥, å¹¶ç”¨é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²å¸¸é‡.&lt;/p>
&lt;p>å¸¸ç”¨çš„ clobber å‚æ•°:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&amp;ldquo;memory&amp;rdquo;&lt;br>
å‘Šè¯‰ç¼–è¯‘å™¨, è¿™æ®µå†…è”æ±‡ç¼–ä»£ç å¯¹è¾“å…¥å’Œè¾“å‡ºæ“ä½œæ•°ä¸­åˆ—å‡ºçš„é¡¹ä»¥å¤–çš„å†…å­˜è¯»å–æˆ–å†™å…¥æ“ä½œ(ä¾‹å¦‚ï¼Œè®¿é—®è¾“å…¥å‚æ•°ä¹‹ä¸€æŒ‡å‘çš„å†…å­˜). ä¸ºç¡®ä¿å†…å­˜åŒ…å«æ­£ç¡®çš„å€¼ï¼ŒGCCå¯èƒ½éœ€è¦åœ¨æ‰§è¡ŒASMä¹‹å‰å°†ç‰¹å®šå¯„å­˜å™¨å€¼åˆ·æ–°åˆ°å†…å­˜ã€‚æ­¤å¤–, é˜»æ­¢ç¼–è¯‘å™¨è¶Šè¿‡è¯¥ ASM è¯­å¥è¿›è¡Œ reorder, å½¢æˆé’ˆå¯¹ç¼–è¯‘å™¨çš„ memory barrier. æ³¨æ„, æ­¤ clobber ä¸ä¼šé˜»æ­¢å¤„ç†å™¨åœ¨ASMè¯­å¥ä¹‹åæ‰§è¡Œæ¨æµ‹æ€§è¯»å–ã€‚ä¸ºäº†é˜²æ­¢å‡ºç°è¿™ç§æƒ…å†µï¼Œæ‚¨éœ€è¦ç‰¹å®šäºå¤„ç†å™¨çš„é˜²æŠ¤æŒ‡ä»¤ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&amp;ldquo;cc&amp;rdquo;&lt;br>
This stands for &amp;ldquo;condition codes&amp;rdquo;. Since the add instruction will affect the carry flag amongst other things, we need to tell gcc about it. Otherwise it might want to split a test-and-branch around our code. If it did so, the branch might go the wrong way due to the condition codes being corrupted. Basically, any inline asm that does arithmetic should explicitly clobber the flags like this.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>Â &lt;/p>
&lt;h3 id="param-5-gotolabels">Param #5: GotoLabels&lt;/h3>
&lt;p>å°½é‡ä¸ä½¿ç”¨, å¯ä»¥åœ¨ASMçš„å†…éƒ¨ç›´æ¥å®šä¹‰ label&lt;/p>
&lt;p>TODO&lt;/p>
&lt;p>Â &lt;/p>
&lt;h2 id="æ ·ä¾‹">æ ·ä¾‹&lt;/h2>
&lt;h3 id="æœ€ç®€å•çš„æ¨¡æ¿">æœ€ç®€å•çš„æ¨¡æ¿&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">int&lt;/span> src &lt;span style="color:#ff79c6">=&lt;/span> &lt;span style="color:#bd93f9">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">int&lt;/span> dst;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">asm&lt;/span> (&lt;span style="color:#f1fa8c">&amp;#34;mov %1, %0&lt;/span>&lt;span style="color:#f1fa8c">\n\t&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f1fa8c">&amp;#34;add $1, %0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">:&lt;/span> &lt;span style="color:#f1fa8c">&amp;#34;=r&amp;#34;&lt;/span> (dst)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">:&lt;/span> &lt;span style="color:#f1fa8c">&amp;#34;r&amp;#34;&lt;/span> (src));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>printf(&lt;span style="color:#f1fa8c">&amp;#34;%d&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>, dst);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ“ä½œæ•°ä½¿ç”¨-asmsymbolicname">æ“ä½œæ•°ä½¿ç”¨ asmSymbolicName&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">uint32_t&lt;/span> c &lt;span style="color:#ff79c6">=&lt;/span> &lt;span style="color:#bd93f9">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">uint32_t&lt;/span> d;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">uint32_t&lt;/span> &lt;span style="color:#ff79c6">*&lt;/span>e &lt;span style="color:#ff79c6">=&lt;/span> &lt;span style="color:#ff79c6">&amp;amp;&lt;/span>c;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">asm&lt;/span> (&lt;span style="color:#f1fa8c">&amp;#34;mov %[e], %[d]&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">:&lt;/span> [d] &lt;span style="color:#f1fa8c">&amp;#34;=rm&amp;#34;&lt;/span> (d)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">:&lt;/span> [e] &lt;span style="color:#f1fa8c">&amp;#34;rm&amp;#34;&lt;/span> (&lt;span style="color:#ff79c6">*&lt;/span>e));
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å†…éƒ¨å®šä¹‰-label">å†…éƒ¨å®šä¹‰ label&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">long&lt;/span> temp;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">long&lt;/span> ret;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">asm&lt;/span> &lt;span style="color:#50fa7b">volatile&lt;/span>(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f1fa8c">&amp;#34;1: &lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f1fa8c">&amp;#34;ldxr %0, [%2]&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f1fa8c">&amp;#34;sub %0, %0, %3&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f1fa8c">&amp;#34;stxr %w1, %0, [%2]&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f1fa8c">&amp;#34;cbnz %w1, 1b&lt;/span>&lt;span style="color:#f1fa8c">\n\t&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">:&lt;/span> &lt;span style="color:#f1fa8c">&amp;#34;=&amp;amp;r&amp;#34;&lt;/span>(ret), &lt;span style="color:#f1fa8c">&amp;#34;=&amp;amp;r&amp;#34;&lt;/span>(temp)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">:&lt;/span> &lt;span style="color:#f1fa8c">&amp;#34;r&amp;#34;&lt;/span>(p), &lt;span style="color:#f1fa8c">&amp;#34;r&amp;#34;&lt;/span>(val)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">:&lt;/span> &lt;span style="color:#f1fa8c">&amp;#34;memory&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> );
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="reference">Reference&lt;/h2>
&lt;p>&lt;a href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#Extended-Asm">Extended Asm (Using the GNU Compiler Collection (GCC))&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://developer.arm.com/documentation/100067/0612/armclang-Inline-Assembler/Inline-assembly-constraint-strings/Constraint-codes-for-AArch64-state">AArch64 Constraint codes&lt;/a>&lt;/p>
- https://wangloo.github.io/posts/c/inline-asm/ - @2019 Notepadium.</description></item><item><title>GICv3 ä»‹ç»</title><link>https://wangloo.github.io/posts/armv8/gicv3/</link><pubDate>Sat, 10 Sep 2022 21:51:49 +0800</pubDate><guid>https://wangloo.github.io/posts/armv8/gicv3/</guid><description>Wangloo's BLOG https://wangloo.github.io/posts/armv8/gicv3/ -&lt;h1 id="gicv3generic-interrupt-controller---version-3">GICV3(Generic Interrupt Controller - version 3)&lt;/h1>
&lt;h2 id="å…³äºgic">å…³äºGIC&lt;/h2>
&lt;p>GICå³ä¸­æ–­æ§åˆ¶å™¨, è´Ÿè´£ç®¡ç†ä¸­æ–­çš„æ¥æ”¶, å±è”½, è·¯ç”±ç­‰ç›¸å…³ä»»åŠ¡, å¹¶å‘ç³»ç»Ÿç¨‹åºå‘˜æä¾›é…ç½®çš„æ¥å£.&lt;/p>
&lt;p>GICä¸å¼‚å¸¸æ¨¡å‹åä½œå®Œæˆä¸­æ–­çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ, GICä¸»è¦è´Ÿè´£&lt;code>ä¸­æ–­æº-äº§ç”ŸIRQ/FIQä¿¡å·&lt;/code>è¿™æ®µè·¯, å…³äºå¤„ç†IRQ/FIQåˆ™æ˜¯ç”±CPUå†…éƒ¨çš„&lt;em>å¼‚å¸¸æ¨¡å‹&lt;/em>æ¥å®Œæˆ.&lt;/p>
&lt;h2 id="å¯¹æ¯”-gicv2">å¯¹æ¯” GICv2&lt;/h2>
&lt;ul>
&lt;li>æ”¯æŒæ›´å¤šçš„å¤„ç†å™¨, ç”¨&lt;code>affinity routing&lt;/code> æ–¹æ¡ˆæ¥åšä¸­æ–­è·¯ç”±.&lt;/li>
&lt;li>æ”¯æŒä¸­æ–­åˆ†ç»„, ä¸ºäº†é…åˆARMv8çš„å¼‚å¸¸ç­‰çº§æ¨¡å‹&lt;/li>
&lt;li>æ–°å¢ä¸­æ–­ç±»å‹: SGI, è½¯ä»¶ç”Ÿæˆä¸­æ–­&lt;/li>
&lt;li>æ–°å¢ä¸­æ–­ç±»å‹: SPI, Shared Peripheral Interrupts&lt;/li>
&lt;li>å¯¹äºCPU interfaceçš„å¯„å­˜å™¨, å¯ç›´æ¥ä½¿ç”¨ç³»ç»Ÿå¯„å­˜å™¨æ¥å£(system register interface)æ¥è®¿é—®, æ¯”memory-mappedçš„æ–¹å¼å¿«.&lt;/li>
&lt;li>ITS, Interrupt Translation Service æš‚ä¸ä»‹ç»&lt;/li>
&lt;li>LPI, Locality-specific Peripheral Interrupts . æš‚ä¸ä»‹ç»&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>GICv3æ”¯æŒARMv8-Aæˆ–ARMv8-Rç³»åˆ—å¤„ç†å™¨, ä½†æ²¡æœ‰å¿…ç„¶çš„ç»‘å®šå…³ç³». ARMv8-Aä¹Ÿå¯ä»¥ä½¿ç”¨GICv2.&lt;/p>
&lt;/blockquote>
&lt;h2 id="ä¸­æ–­ç±»å‹">ä¸­æ–­ç±»å‹&lt;/h2>
&lt;h3 id="locality-specific-peripheral-interrupt-lpi">Locality-specific Peripheral Interrupt (LPI)&lt;/h3>
&lt;p>LPIs are always &lt;a href="https://en.wikipedia.org/wiki/Message_Signaled_Interrupts">message-based interrupts&lt;/a> interrupts. è¿™é‡Œä¸åšä»‹ç».&lt;a href="https://en.wikipedia.org/wiki/Message_Signaled_Interrupts">wiki&lt;/a>&lt;/p>
&lt;h3 id="private-peripheral-interrupt-ppi">Private Peripheral Interrupt (PPI)&lt;/h3>
&lt;p>PPIæ˜¯è·¯ç”±åˆ°&lt;strong>å•ä¸ªCPU&lt;/strong>çš„å¤–è®¾ä¸­æ–­, ä¸åŒçš„CPUå¯ä»¥ä½¿ç”¨ç›¸åŒçš„ä¸­æ–­å·. ä¾‹å¦‚, æ‰€æœ‰CPUéƒ½å¯ä»¥ä½¿ç”¨ä¸­æ–­å·16è¡¨ç¤ºç§æœ‰çš„å®šæ—¶å™¨ä¸­æ–­.&lt;/p>
&lt;h3 id="shared-peripheral-interrupt-spi">Shared Peripheral Interrupt (SPI)&lt;/h3>
&lt;p>SPIæ˜¯å¯è·¯ç”±åˆ°&lt;strong>ä¸€ç»„CPU&lt;/strong>çš„å¤–è®¾ä¸­æ–­, Distributor è´Ÿè´£SPIè·¯ç”±.&lt;/p>
&lt;h3 id="software-generated-interrupt-sgi">Software Generated Interrupt (SGI)&lt;/h3>
&lt;p>SGIæ˜¯ç”±æŸä¸ªCPUäº§ç”Ÿ, è·¯ç”±åˆ°ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªCPU, é€šå¸¸ç”¨äºå¤„ç†å™¨é—´é€šä¿¡.&lt;/p>
&lt;h2 id="gicv3-çš„ç»„ä»¶">GICv3 çš„ç»„ä»¶&lt;/h2>
&lt;p>GICv3æ¶æ„ç”±ä»¥ä¸‹é€»è¾‘ç»„ä»¶æ„æˆ:&lt;/p>
&lt;ul>
&lt;li>A Distributor&lt;/li>
&lt;li>A Redistributor for each CPU&lt;/li>
&lt;li>A CPU interface for each CPU&lt;/li>
&lt;li>Interrupt Translation Service components (ITS). å¯é€‰, æš‚ä¸ä»‹ç»&lt;/li>
&lt;/ul>
&lt;p>The Distributor, Redistributor ä¸€èµ·ç»„æˆäº† &lt;em>IRI(Interrupt Routing Infrastructure)&lt;/em>.&lt;/p>
&lt;p>&lt;img src="./IRI.png" alt="iri">{width=&amp;ldquo;10px&amp;rdquo;}&lt;/p>
&lt;h3 id="distributor">Distributor&lt;/h3>
&lt;p>æ§åˆ¶SPIå’ŒSGIçš„è·¯ç”±. å¯¹äº SPI, æä¾›äº†ä¸€ä¸‹æ¥å£:&lt;/p>
&lt;ul>
&lt;li>å¯åŠ¨/ç¦ç”¨ SPI&lt;/li>
&lt;li>è®¾ç½® SPI çš„ä¼˜å…ˆçº§&lt;/li>
&lt;li>é…ç½®å¯¹äº SPI çš„è·¯ç”±&lt;/li>
&lt;li>è®¾ç½® SPI çš„è§¦å‘æ–¹å¼&lt;/li>
&lt;li>ç”Ÿæˆ message-based SPI&lt;/li>
&lt;li>ä¸ºæ¯ä¸ª SPI åˆ†ç»„&lt;/li>
&lt;li>æ§åˆ¶ SPI çš„ &lt;code>pending and active&lt;/code> çŠ¶æ€&lt;/li>
&lt;/ul>
&lt;p>å¯¹äº&lt;code>Distributor&lt;/code>çš„å¤§éƒ¨åˆ†é…ç½®é€šè¿‡&lt;code>GICD_CTLR&lt;/code>å®ç°. åŒ…æ‹¬:&lt;/p>
&lt;ul>
&lt;li>å¯ç”¨ Affinity routing&lt;/li>
&lt;li>ç¦ç”¨å®‰å…¨æ€§&lt;/li>
&lt;li>ä¸­æ–­åˆ†ç»„çš„é…ç½®.&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>å…³äºDistributor å¯„å­˜å™¨éƒ½å«æœ‰ &lt;code>GICD_&lt;/code> å‰ç¼€, é€šè¿‡ &lt;code>memory-mapped&lt;/code> æ–¹å¼è®¿é—®.&lt;/p>
&lt;/blockquote>
&lt;h3 id="redistributor">Redistributor&lt;/h3>
&lt;ul>
&lt;li>å¯åŠ¨/ç¦ç”¨ SGI å’Œ PPI&lt;/li>
&lt;li>è®¾ç½® SGI å’Œ PPI çš„ä¼˜å…ˆçº§&lt;/li>
&lt;li>è®¾ç½® SGI å’Œ PPI çš„è§¦å‘æ–¹å¼&lt;/li>
&lt;li>ä¸º SGI å’Œ PPI åˆ†é…ç»„&lt;/li>
&lt;li>æ§åˆ¶ SGI å’Œ PPI çš„ &lt;code>pending&lt;/code> çŠ¶æ€å’Œ &lt;code>active&lt;/code> çŠ¶æ€&lt;/li>
&lt;li>ä¸ä¹‹é“¾æ¥çš„ CPU çš„ç”µæºç®¡ç†.&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>å…³äºRedistributor å¯„å­˜å™¨éƒ½å«æœ‰ &lt;code>GICR_&lt;/code> å‰ç¼€, é€šè¿‡ &lt;code>memory-mapped&lt;/code> æ–¹å¼è®¿é—®.&lt;/p>
&lt;/blockquote>
&lt;h3 id="cpu-interface">CPU interface&lt;/h3>
&lt;ul>
&lt;li>Acknowledge ä¸€ä¸ªä¸­æ–­&lt;/li>
&lt;li>æ‰§è¡Œ End Of Interrupt&lt;/li>
&lt;li>Deactivate ä¸€ä¸ªä¸­æ–­&lt;/li>
&lt;li>è®¾ç½® CPU çš„ä¼˜å…ˆçº§Mask&lt;/li>
&lt;li>é…ç½®ä¸­æ–­æŠ¢å &lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>å…³äº CPU interface å¯„å­˜å™¨æ˜¯ä»¥ &lt;code>ICC_&lt;/code> ä¸ºå‰ç¼€, è¿˜æœ‰ &lt;code>ICV&lt;/code> for vitual interrupt, &lt;code>ICH&lt;/code> for hypervisor configuration.&lt;/p>
&lt;/blockquote>
&lt;h2 id="ä¸­æ–­çš„çŠ¶æ€è½¬æ¢">ä¸­æ–­çš„çŠ¶æ€è½¬æ¢&lt;/h2>
&lt;p>&lt;img src="./int-lifestyle.png" alt="">&lt;/p>
&lt;ol>
&lt;li>ç”Ÿæˆä¸­æ–­. ä¸­æ–­å¯èƒ½æ¥è‡ªå¤–éƒ¨ä¿¡å·, æˆ–è€…è½¯ä»¶ç”Ÿæˆ(SGI)&lt;/li>
&lt;li>Distribute. IRI è´Ÿè´£ä¸­æ–­çš„åˆ†ç»„, ä¼˜å…ˆçº§å±è”½ç­‰. å°†åˆé€‚çš„ä¸­æ–­å‘é€åˆ°CPU Interface.&lt;/li>
&lt;li>Deliver. CPU interface å°†ä¸­æ–­å‘é€åˆ°è¿æ¥çš„CPU.&lt;/li>
&lt;li>Activate. CPUè¯»å–IARå¯„å­˜å™¨, å³å‘é€ACK. è¯¥ä¸­æ–­çš„çŠ¶æ€è½¬ä¸ºactive.&lt;/li>
&lt;li>Priority drop. å¤„ç†ç¨‹åºç»“æŸä¹‹å, å†™&lt;code>ICC_EOIR&lt;/code>å¯„å­˜å™¨, end of interrupt&lt;/li>
&lt;li>Deactivation. å†™&lt;code>ICC_DIR&lt;/code>å¯„å­˜å™¨æ¸…é™¤ä¸­æ–­çš„activeæ ‡å¿—ä½. ä¸€èˆ¬æ¥è¯´, end of interrupt å’Œ deactivation å¯é…ç½®æˆåŒæ—¶å‘ç”Ÿ.&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>&lt;code>ICC_CTLR_ELx.EOImode&lt;/code> ä½æ§åˆ¶æ˜¯å¦ end of interrupt åŒæ—¶å¯¼è‡´ deactivation.&lt;/p>
&lt;p>â“ EOI å’Œ deactivated åˆ†å¼€è¿›è¡Œæš‚æ—¶è¿˜ä¸çŸ¥é“åº”ç”¨åœºæ™¯.&lt;/p>
&lt;/blockquote>
&lt;h2 id="ä¸­æ–­id-intid">ä¸­æ–­ID: INTID&lt;/h2>
&lt;p>INTID æ˜¯ä¸­æ–­çš„æ ‡è¯†ç¬¦, å®ƒçš„æœ€å¤§å€¼æ˜¯&lt;em>å®ç°å®šä¹‰&lt;/em>çš„, å¯ä»¥åœ¨&lt;code>GICD_TYPER.IDbits&lt;/code>ä¸­è¯»å–ã€‚&lt;/p>
&lt;p>INTIDæŒ‰ç…§ä¸­æ–­ç±»å‹åˆ†ç±»çš„, å¯¹ç…§è¡¨å¦‚ä¸‹:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>INTID&lt;/th>
&lt;th>ä¸­æ–­ç±»å‹&lt;/th>
&lt;th>Note&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>0-15&lt;/td>
&lt;td>SGI&lt;/td>
&lt;td>æœ¬åœ°çš„, ä¸åŒCPUå¯ä½¿ç”¨åŒä¸€ä¸­æ–­å·ä»£è¡¨ä¸åŒä¸­æ–­&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>16-31&lt;/td>
&lt;td>PPI&lt;/td>
&lt;td>æœ¬åœ°çš„&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>32-1019&lt;/td>
&lt;td>SPI&lt;/td>
&lt;td>å…¨å±€çš„&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>1020-1023&lt;/td>
&lt;td>ç‰¹æ®Šä¸­æ–­&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>1056-1119&lt;/td>
&lt;td>æ‰©å±•çš„PPI&lt;/td>
&lt;td>æœ¬åœ°çš„&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4096 â€“ 5119&lt;/td>
&lt;td>æ‰©å±•çš„SPI&lt;/td>
&lt;td>å…¨å±€çš„&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="ç‰¹æ®Šä¸­æ–­å·">ç‰¹æ®Šä¸­æ–­å·&lt;/h3>
&lt;blockquote>
&lt;p>These INTIDs do not require an end of interrupt or deactivation.&lt;/p>
&lt;/blockquote>
&lt;p>1020:&lt;/p>
&lt;p>1021:&lt;/p>
&lt;p>1022:&lt;/p>
&lt;p>1023: è¯»&lt;code>ICC_IAR1_EL1&lt;/code> è¿”å›è¯¥å€¼è¡¨æ˜å½“å‰çš„CPUä¸Šæ²¡æœ‰å¾…å¤„ç†çš„ä¸­æ–­.&lt;/p>
&lt;h2 id="ä¸­æ–­åˆ†ç»„">ä¸­æ–­åˆ†ç»„&lt;/h2>
&lt;p>ä¸ºäº†é…åˆ ARMv8 çš„å¼‚å¸¸æ¨¡å‹å’Œå®‰å…¨æ¨¡å‹, GICv3 æ”¯æŒä¸ºæ¯ä¸ªä¸­æ–­é…ç½®ä¸åŒçš„ç»„. ä¸åŒç»„çš„ä¸­æ–­åªèƒ½è·¯ç”±åˆ°ç‰¹å®šçš„å¼‚å¸¸ç­‰çº§å’Œå®‰å…¨çŠ¶æ€è¿›è¡Œå¤„ç†.&lt;/p>
&lt;p>å…±åŒ…å«ä¸‰ä¸ªåˆ†ç»„: Gourp 0, Secure Group 1, Non-secure Group 1.&lt;/p>
&lt;ul>
&lt;li>Group 0çš„ä¸­æ–­éœ€è¦åœ¨EL3 å¤„ç†.&lt;/li>
&lt;li>Secure Group1 çš„ä¸­æ–­éœ€è¦åœ¨ Secure EL1 æˆ–è€… Secure EL2(å¦‚æœå¯ç”¨äº†è™šæ‹ŸåŒ–)å¤„ç†.&lt;/li>
&lt;li>Non-secure Group 1 çš„ä¸­æ–­éœ€è¦åœ¨ Non-secure EL2 or Non-secure EL1 if not using virtualization&lt;/li>
&lt;/ul>
&lt;p>åŒæ—¶, ä¸­æ–­ä½äºå“ªä¸ªç»„ä¹Ÿå†³å®šäº†å…¶è§¦å‘çš„æ˜¯FIQè¿˜æ˜¯IRQ. å¯¹äº AArch64 æ¥è¯´, å¯¹åº”å…³ç³»å¯è§ä¸‹è¡¨:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>å½“å‰å¼‚å¸¸ç­‰çº§&lt;/th>
&lt;th>Group 0 çš„ä¸­æ–­&lt;/th>
&lt;th>Secure Group 1 çš„ä¸­æ–­&lt;/th>
&lt;th>Non-secure Group 1&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Secure EL1/0/2&lt;/td>
&lt;td>FIQ&lt;/td>
&lt;td>IRQ&lt;/td>
&lt;td>FIQ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Non-secure EL1/0/2&lt;/td>
&lt;td>FIQ&lt;/td>
&lt;td>FIQ&lt;/td>
&lt;td>IRQ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>EL3&lt;/td>
&lt;td>FIQ&lt;/td>
&lt;td>FIQ&lt;/td>
&lt;td>FIQ&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;ul>
&lt;li>Group 0 çš„ä¸­æ–­, éœ€è¦åœ¨EL3å¤„ç†, å…¶ä¼˜å…ˆçº§è¾ƒé«˜, æ‰€ä»¥å‡å±äº FIQ&lt;/li>
&lt;/ul>
&lt;h2 id="ä¸­æ–­è·¯ç”±">ä¸­æ–­è·¯ç”±&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>PPIs are routed directly from the source to the local Redistributor .&lt;/p>
&lt;/li>
&lt;li>
&lt;p>SPIs are routed from the source through the Distributor to the target Redistributor and the associated CPU interface.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>SGIs are generated by software through the CPU interface and Redistributor. They are then routed through the Distributor to one or more target Redistributors and the associated CPU interfaces&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="what-is-affinity-routing">What is Affinity Routing?&lt;/h3>
&lt;p>Affinity routing æ˜¯ä¸€ç§åŸºäºåœ°å€çš„æ ‡è¯†å¤šä¸ªCPUçš„æ–¹æ³•, ç”¨äºä¸­æ–­çš„è·¯ç”±. Affinity value ç”±4ä¸ª8bitå­—æ®µç»„æˆ, ç»“æ„æ˜¯&lt;code>aff3.aff2.aff1.aff0&lt;/code>.&lt;/p>
&lt;p>ç”±äº PPI çš„ä¸­æ–­æºæ˜¯ç›´è¿ Redistributor çš„, æ‰€ä»¥ä»… SPI å’Œ SGI å¯ä»¥ä½¿ç”¨ Affinity routing.&lt;/p>
&lt;ul>
&lt;li>å¯¹äº SPI, ç›®æ ‡CPUçš„ affinity value é€šè¿‡&lt;code>GICD_IROUTER&amp;lt;n&amp;gt;&lt;/code> è®¾ç½®.&lt;/li>
&lt;li>å¯¹äº SGI, åœ¨ç”Ÿæˆæ—¶å³å¯åŒæ—¶é…ç½®, è¯¦è§ &lt;code>ICC_SGI0R_EL1&lt;/code> å’Œ &lt;code>ICC_SGI1R_EL1&lt;/code>.&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>Aff3.Aff2.Aff1.Aff0 ä¸ Aff3.Aff2.Aff2.TargetList&lt;/p>
&lt;p>å¯¹äºSPI, ç›®æ ‡çš„CPUåªèƒ½æ˜¯ä¸€ä¸ª, æ•…&lt;code>Aff0&lt;/code>è¡¨ç¤ºè¯¥CPUçš„ID. è€ŒSGIå¯ä»¥é…ç½®åŒæ—¶å‘ç»™å¤šä¸ªCPU, æ‰€ä»¥&lt;code>TargetList&lt;/code>æ˜¯åŸºäºä½æ“ä½œçš„, æ¯ä¸ªä½è¡¨ç¤ºä¸€ä¸ªCPU.&lt;/p>
&lt;/blockquote>
&lt;h2 id="ç¼–ç¨‹æŒ‡å¯¼">ç¼–ç¨‹æŒ‡å¯¼&lt;/h2>
&lt;h3 id="åˆå§‹åŒ–">åˆå§‹åŒ–&lt;/h3>
&lt;p>ç”±äº &lt;em>Distributor&lt;/em> æ•´ä¸ªç³»ç»Ÿå…±äº«çš„, æ‰€ä»¥å¿…é¡»åœ¨å…¶ä»–æ ¸å¯åŠ¨ä¹‹å‰, ç”±ä¸»æ ¸å®Œæˆåˆå§‹åŒ–. ç„¶åå½“æ‰€æœ‰æ ¸éƒ½å¯åŠ¨å, å„è‡ªå®Œæˆå„è‡ª &lt;em>Redistributor&lt;/em> å’Œ &lt;em>CPU interface&lt;/em> çš„åˆå§‹åŒ–å·¥ä½œ.&lt;/p>
- https://wangloo.github.io/posts/armv8/gicv3/ - @2019 Notepadium.</description></item><item><title>æ­¦å™¨åº“: shell scripts</title><link>https://wangloo.github.io/posts/shell/shell-script/</link><pubDate>Wed, 20 Jul 2022 11:54:13 +0800</pubDate><guid>https://wangloo.github.io/posts/shell/shell-script/</guid><description>Wangloo's BLOG https://wangloo.github.io/posts/shell/shell-script/ -&lt;p>â„¹ï¸ ä»¥ä¸‹å‘½ä»¤/è„šæœ¬çš„æ‰§è¡Œç¯å¢ƒå‡ä¸º &lt;code>bash&lt;/code>.&lt;/p>
&lt;h2 id="ç»Ÿè®¡ä»£ç é‡">ç»Ÿè®¡ä»£ç é‡&lt;/h2>
&lt;blockquote>
&lt;p>ä½¿ç”¨åˆ°çš„å‘½ä»¤åŒ…å«: find, wc, xargs, sort ç­‰&lt;/p>
&lt;/blockquote>
&lt;p>åˆ—å‡º&lt;em>æ‰€æœ‰çš„æ–‡ä»¶åŠå…¶ä»£ç è¡Œæ•°&lt;/em>, åªç»Ÿè®¡.c å’Œ.h, è¿‡æ»¤&lt;code>./scripts&lt;/code>ç›®å½•.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>find -name &lt;span style="color:#f1fa8c">&amp;#39;*.[c|h]&amp;#39;&lt;/span> ! -path &lt;span style="color:#f1fa8c">&amp;#39;./scripts/*&amp;#39;&lt;/span> | xargs wc -l
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>+å°†å†…å®¹æŒ‰ç…§ä»£ç è¡Œæ•°é™åºæ’åˆ—&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>find -name &lt;span style="color:#f1fa8c">&amp;#39;*.[c|h]&amp;#39;&lt;/span> ! -path &lt;span style="color:#f1fa8c">&amp;#39;./scripts/*&amp;#39;&lt;/span> | xargs wc -l | sort -rn
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è‹¥ä»…åˆ—å‡º&lt;em>æ€»çš„ä»£ç è¡Œæ•°&lt;/em>, å»é™¤&lt;strong>ç©ºè¡Œ&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">(&lt;/span>find ./ -name &lt;span style="color:#f1fa8c">&amp;#39;*.[c|h]&amp;#39;&lt;/span> -print0 | xargs -0 cat&lt;span style="color:#ff79c6">)&lt;/span> | sed &lt;span style="color:#f1fa8c">&amp;#39;/^\s*$/d&amp;#39;&lt;/span> | wc -l
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åˆ é™¤ç›®å½•ä¸‹æ‰€æœ‰çš„å¯æ‰§è¡Œæ–‡ä»¶">åˆ é™¤ç›®å½•ä¸‹æ‰€æœ‰çš„å¯æ‰§è¡Œæ–‡ä»¶&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>find . -maxdepth &lt;span style="color:#bd93f9">1&lt;/span> -executable -type f | xargs rm
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åˆ¤æ–­æ‰§è¡Œè„šæœ¬æ—¶å¸¦çš„å‚æ•°">åˆ¤æ–­æ‰§è¡Œè„šæœ¬æ—¶å¸¦çš„å‚æ•°&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">if&lt;/span> &lt;span style="color:#ff79c6">[&lt;/span> &lt;span style="color:#8be9fd;font-style:italic">$#&lt;/span> -ne &lt;span style="color:#bd93f9">1&lt;/span> &lt;span style="color:#ff79c6">]&lt;/span>; &lt;span style="color:#ff79c6">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd;font-style:italic">echo&lt;/span> &lt;span style="color:#f1fa8c">&amp;#34;ONE parameter is needed&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd;font-style:italic">exit&lt;/span> -1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">if&lt;/span> &lt;span style="color:#ff79c6">[&lt;/span> &lt;span style="color:#8be9fd;font-style:italic">$1&lt;/span> &lt;span style="color:#ff79c6">==&lt;/span> &lt;span style="color:#f1fa8c">&amp;#39;build&amp;#39;&lt;/span> &lt;span style="color:#ff79c6">]&lt;/span>; &lt;span style="color:#ff79c6">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#6272a4"># do something&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">elif&lt;/span> &lt;span style="color:#ff79c6">[&lt;/span> &lt;span style="color:#8be9fd;font-style:italic">$1&lt;/span> &lt;span style="color:#ff79c6">==&lt;/span> &lt;span style="color:#f1fa8c">&amp;#39;run&amp;#39;&lt;/span> &lt;span style="color:#ff79c6">]&lt;/span>; &lt;span style="color:#ff79c6">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#6272a4"># do something&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">elif&lt;/span> &lt;span style="color:#ff79c6">[&lt;/span> &lt;span style="color:#8be9fd;font-style:italic">$1&lt;/span> &lt;span style="color:#ff79c6">==&lt;/span> &lt;span style="color:#f1fa8c">&amp;#39;gdb&amp;#39;&lt;/span> &lt;span style="color:#ff79c6">]&lt;/span>; &lt;span style="color:#ff79c6">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#6272a4"># do something&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd;font-style:italic">echo&lt;/span> &lt;span style="color:#f1fa8c">&amp;#34;Not supported command&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">fi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="è‡ªåŠ¨æ‹·è´æ–‡ä»¶åˆ°-sd-card">è‡ªåŠ¨æ‹·è´æ–‡ä»¶åˆ° SD Card&lt;/h2>
&lt;blockquote>
&lt;p>TODO&lt;/p>
&lt;ol>
&lt;li>æ·»åŠ è¿›åº¦æ¡&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">sd_path&lt;/span>&lt;span style="color:#ff79c6">=&lt;/span>&lt;span style="color:#ff79c6">$(&lt;/span>find /media/&lt;span style="color:#8be9fd;font-style:italic">$USER&lt;/span> -maxdepth &lt;span style="color:#bd93f9">1&lt;/span> -type d -name &lt;span style="color:#f1fa8c">&amp;#34;*-*&amp;#34;&lt;/span>&lt;span style="color:#ff79c6">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">while&lt;/span> &lt;span style="color:#ff79c6">[&lt;/span> ! -d &lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">sd_path&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span> &lt;span style="color:#ff79c6">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sleep &lt;span style="color:#bd93f9">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd;font-style:italic">echo&lt;/span> &lt;span style="color:#f1fa8c">&amp;#34;waiting for inserting SD-Card&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">echo&lt;/span> &lt;span style="color:#f1fa8c">&amp;#34;SD-Card is inserted&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cp ./output/kernel/kernel.bin &lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">sd_path&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">echo&lt;/span> &lt;span style="color:#f1fa8c">&amp;#34;Copy completely&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="è·å–æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯å¯é€’å½’è¿›å…¥å­ç›®å½•">è·å–æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯(å¯é€’å½’è¿›å…¥å­ç›®å½•)&lt;/h2>
&lt;p>è·å–&lt;code>dir&lt;/code>è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶çš„ä¿¡æ¯, è¿™é‡Œè·å–çš„æ˜¯æ–‡ä»¶çš„&lt;strong>å®Œæ•´è·¯å¾„&lt;/strong>.&lt;/p>
&lt;blockquote>
&lt;p>TODO&lt;/p>
&lt;ol>
&lt;li>æ“ä½œæ•°ç»„ä¸‹æ ‡çš„æ–¹å¼å¯èƒ½æœ‰å¾…æ”¹è¿›? &lt;code>filenum&lt;/code>æ„Ÿè§‰æ²¡å¿…è¦, æš‚æ—¶è¿˜ä¸ä¼šæ”¹&lt;/li>
&lt;li>é€šè¿‡æ‹¼æ¥è·å¾—æ–‡ä»¶ä¿¡æ¯(è·¯å¾„)çš„æ–¹å¼ä¹Ÿæœ‰ç‚¹æ€ªå¼‚&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">dir&lt;/span>&lt;span style="color:#ff79c6">=&lt;/span>./
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">files&lt;/span>&lt;span style="color:#ff79c6">=()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">filenum&lt;/span>&lt;span style="color:#ff79c6">=&lt;/span>&lt;span style="color:#bd93f9">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">function&lt;/span> getfiles&lt;span style="color:#ff79c6">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">for&lt;/span> file in &lt;span style="color:#f1fa8c">`&lt;/span>ls &lt;span style="color:#8be9fd;font-style:italic">$dir&lt;/span>&lt;span style="color:#f1fa8c">`&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">if&lt;/span> &lt;span style="color:#ff79c6">[&lt;/span> -d &lt;span style="color:#8be9fd;font-style:italic">$file&lt;/span> &lt;span style="color:#ff79c6">]&lt;/span>; &lt;span style="color:#ff79c6">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd;font-style:italic">cd&lt;/span> &lt;span style="color:#8be9fd;font-style:italic">$file&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> getfiles
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd;font-style:italic">cd&lt;/span> ..
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> files&lt;span style="color:#ff79c6">[&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">$filenum&lt;/span>&lt;span style="color:#ff79c6">]=&lt;/span>&lt;span style="color:#ff79c6">$(&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">pwd&lt;/span> &lt;span style="color:#8be9fd;font-style:italic">$file&lt;/span>&lt;span style="color:#ff79c6">)&lt;/span>/&lt;span style="color:#ff79c6">$(&lt;/span>basename &lt;span style="color:#8be9fd;font-style:italic">$file&lt;/span>&lt;span style="color:#ff79c6">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#6272a4"># echo file=$(pwd $file)/$(basename $file)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd;font-style:italic">let&lt;/span> filenum++
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å¸¦é¢œè‰²çš„è¾“å‡º">å¸¦é¢œè‰²çš„è¾“å‡º&lt;/h2>
&lt;p>ä½¿ç”¨&lt;a href="https://en.wikipedia.org/wiki/ANSI_escape_code">ANSI escape code&lt;/a>&lt;/p>
&lt;pre tabindex="0">&lt;code>Black 0;30 Dark Gray 1;30
Red 0;31 Light Red 1;31
Green 0;32 Light Green 1;32
Brown/Orange 0;33 Yellow 1;33
Blue 0;34 Light Blue 1;34
Purple 0;35 Light Purple 1;35
Cyan 0;36 Light Cyan 1;36
Light Gray 0;37 White 1;37
&lt;/code>&lt;/pre>&lt;p>Code example:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">RED&lt;/span>&lt;span style="color:#ff79c6">=&lt;/span>&lt;span style="color:#f1fa8c">&amp;#39;\033[0;31m&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">GREEN&lt;/span>&lt;span style="color:#ff79c6">=&lt;/span>&lt;span style="color:#f1fa8c">&amp;#39;\033[0;32m&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">YELLOW&lt;/span>&lt;span style="color:#ff79c6">=&lt;/span>&lt;span style="color:#f1fa8c">&amp;#39;\033[1;33m&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">BLUE&lt;/span>&lt;span style="color:#ff79c6">=&lt;/span>&lt;span style="color:#f1fa8c">&amp;#39;\033[0;34m&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">CYAN&lt;/span>&lt;span style="color:#ff79c6">=&lt;/span>&lt;span style="color:#f1fa8c">&amp;#39;\033[0;36m&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">NC&lt;/span>&lt;span style="color:#ff79c6">=&lt;/span>&lt;span style="color:#f1fa8c">&amp;#39;\033[0m&amp;#39;&lt;/span> &lt;span style="color:#6272a4"># No Color&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">echo&lt;/span> -e &lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">YELLOW&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">HELLO, YELLOW&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">NC&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">echo&lt;/span> -e &lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">GREEN&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">HELLO, GREEN&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">NC&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">echo&lt;/span> -e &lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">RED&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">HELLO, RED&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">NC&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">echo&lt;/span> -e &lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">BLUE&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">HELLO, BLUE&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">NC&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd;font-style:italic">echo&lt;/span> -e &lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">CYAN&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">HELLO, CYAN&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">NC&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">#########################################################&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"># generic functions #####################################&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">function&lt;/span> ERROR&lt;span style="color:#ff79c6">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd;font-style:italic">echo&lt;/span> -e &lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">RED&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">[error] &lt;/span>&lt;span style="color:#8be9fd;font-style:italic">$*&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">NC&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd;font-style:italic">exit&lt;/span> &lt;span style="color:#bd93f9">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">function&lt;/span> INFO &lt;span style="color:#ff79c6">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd;font-style:italic">echo&lt;/span> -e &lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">BLUE&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">[info] &lt;/span>&lt;span style="color:#8be9fd;font-style:italic">$*&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">NC&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">function&lt;/span> WARN &lt;span style="color:#ff79c6">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd;font-style:italic">echo&lt;/span> -e &lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">YELLOW&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">[warn] &lt;/span>&lt;span style="color:#8be9fd;font-style:italic">$*&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">NC&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">function&lt;/span> LOG &lt;span style="color:#ff79c6">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd;font-style:italic">echo&lt;/span> -e &lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">GREEN&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">[log] &lt;/span>&lt;span style="color:#8be9fd;font-style:italic">$*&lt;/span>&lt;span style="color:#f1fa8c">${&lt;/span>&lt;span style="color:#8be9fd;font-style:italic">NC&lt;/span>&lt;span style="color:#f1fa8c">}&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span> &amp;gt;&amp;gt; &lt;span style="color:#8be9fd;font-style:italic">$LOG&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>INFO &lt;span style="color:#f1fa8c">&amp;#34;This is an infomation&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>WARN &lt;span style="color:#f1fa8c">&amp;#34;This is a log&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>- https://wangloo.github.io/posts/shell/shell-script/ - @2019 Notepadium.</description></item><item><title>C è¯­è¨€ä½æ“ä½œæŠ€å·§</title><link>https://wangloo.github.io/posts/c/bitops/</link><pubDate>Sun, 03 Jul 2022 09:44:13 +0800</pubDate><guid>https://wangloo.github.io/posts/c/bitops/</guid><description>Wangloo's BLOG https://wangloo.github.io/posts/c/bitops/ -&lt;h2 id="è¿ç»­å†…å­˜å–n-bit">è¿ç»­å†…å­˜å–n bit&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#include&lt;/span> &lt;span style="color:#ff79c6">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span style="color:#ff79c6">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#include&lt;/span> &lt;span style="color:#ff79c6">&amp;lt;stdint.h&amp;gt;&lt;/span>&lt;span style="color:#ff79c6">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#include&lt;/span> &lt;span style="color:#ff79c6">&amp;lt;assert.h&amp;gt;&lt;/span>&lt;span style="color:#ff79c6">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#define bitmask(n) ((1ul &amp;lt;&amp;lt; (n)) - 1)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"> * ä»ptræŒ‡å‘çš„å†…å­˜å¼€å§‹ï¼ŒæŠ½å–ç¬¬startä¸ªbitå¼€å§‹çš„è¿ç»­nä¸ªbit
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"> * é™åˆ¶: n &amp;lt; 32
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">uint32_t&lt;/span> &lt;span style="color:#50fa7b">extract_bits&lt;/span>(&lt;span style="color:#8be9fd">uint8_t&lt;/span> &lt;span style="color:#ff79c6">*&lt;/span>ptr, &lt;span style="color:#8be9fd">uint32_t&lt;/span> start, &lt;span style="color:#8be9fd">uint32_t&lt;/span> n)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">uint32_t&lt;/span> start_byte &lt;span style="color:#ff79c6">=&lt;/span> start &lt;span style="color:#ff79c6">/&lt;/span> &lt;span style="color:#bd93f9">8&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">uint32_t&lt;/span> start_offset &lt;span style="color:#ff79c6">=&lt;/span> start &lt;span style="color:#ff79c6">%&lt;/span> &lt;span style="color:#bd93f9">8&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">uint32_t&lt;/span> &lt;span style="color:#ff79c6">*&lt;/span>pstart &lt;span style="color:#ff79c6">=&lt;/span> (&lt;span style="color:#8be9fd">uint32_t&lt;/span> &lt;span style="color:#ff79c6">*&lt;/span>)(ptr &lt;span style="color:#ff79c6">+&lt;/span> start_byte);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">uint32_t&lt;/span> end &lt;span style="color:#ff79c6">=&lt;/span> start &lt;span style="color:#ff79c6">+&lt;/span> n &lt;span style="color:#ff79c6">-&lt;/span> &lt;span style="color:#bd93f9">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">uint32_t&lt;/span> end_byte &lt;span style="color:#ff79c6">=&lt;/span> end &lt;span style="color:#ff79c6">/&lt;/span> &lt;span style="color:#bd93f9">8&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">uint32_t&lt;/span> end_offset &lt;span style="color:#ff79c6">=&lt;/span> end &lt;span style="color:#ff79c6">%&lt;/span> &lt;span style="color:#bd93f9">8&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">uint32_t&lt;/span> &lt;span style="color:#ff79c6">*&lt;/span>pend &lt;span style="color:#ff79c6">=&lt;/span> (&lt;span style="color:#8be9fd">uint32_t&lt;/span> &lt;span style="color:#ff79c6">*&lt;/span>)(ptr &lt;span style="color:#ff79c6">+&lt;/span> end_byte);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">uint32_t&lt;/span> data &lt;span style="color:#ff79c6">=&lt;/span> &lt;span style="color:#ff79c6">*&lt;/span>pstart &lt;span style="color:#ff79c6">&amp;gt;&amp;gt;&lt;/span> start_offset;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">if&lt;/span> (n &lt;span style="color:#ff79c6">&amp;gt;&lt;/span> &lt;span style="color:#bd93f9">32&lt;/span> &lt;span style="color:#ff79c6">-&lt;/span> start_offset) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#6272a4">/* ç”±äºn &amp;lt; 32, æ‰€ä»¥è¡¥é½*pendä¸€å®šå°±å¤Ÿäº†ï¼Œ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"> * end_offsetå¯¹é½åˆ°æœ€åä¸€ä½(n-1).
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"> * ä¸¥è°¨æ€§è¯æ˜: n ä¸€å®š&amp;gt; end_offset + 1
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"> * å› ä¸ºn &amp;gt; 32-start_offset ==&amp;gt; n &amp;gt; 25,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"> * ä¸”end_offset + 1 &amp;lt; 9, æ•…å¾—è¯
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> data &lt;span style="color:#ff79c6">|=&lt;/span> &lt;span style="color:#ff79c6">*&lt;/span>pend &lt;span style="color:#ff79c6">&amp;lt;&amp;lt;&lt;/span> (n &lt;span style="color:#ff79c6">-&lt;/span> end_offset &lt;span style="color:#ff79c6">-&lt;/span> &lt;span style="color:#bd93f9">1&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">return&lt;/span> data &lt;span style="color:#ff79c6">&amp;amp;&lt;/span> bitmask(n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">void&lt;/span> &lt;span style="color:#50fa7b">test_val&lt;/span>(&lt;span style="color:#8be9fd">uint32_t&lt;/span> val, &lt;span style="color:#8be9fd">uint32_t&lt;/span> expect)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">if&lt;/span> (val &lt;span style="color:#ff79c6">!=&lt;/span> expect) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#f1fa8c">&amp;#34;error: val: 0x%x, expect: 0x%x&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>, val, expect);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert(val &lt;span style="color:#ff79c6">==&lt;/span> expect);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">int&lt;/span> &lt;span style="color:#50fa7b">main&lt;/span>(&lt;span style="color:#8be9fd">void&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">uint32_t&lt;/span> vals[] &lt;span style="color:#ff79c6">=&lt;/span> {&lt;span style="color:#bd93f9">0x11223344&lt;/span>, &lt;span style="color:#bd93f9">0x11223344&lt;/span>};
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">uint32_t&lt;/span> ret;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ret &lt;span style="color:#ff79c6">=&lt;/span> extract_bits((&lt;span style="color:#8be9fd">uint8_t&lt;/span> &lt;span style="color:#ff79c6">*&lt;/span>)vals, &lt;span style="color:#bd93f9">31&lt;/span>, &lt;span style="color:#bd93f9">30&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> test_val(ret, &lt;span style="color:#bd93f9">0x22446688&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#f1fa8c">&amp;#34;Test Passed!&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">return&lt;/span> &lt;span style="color:#bd93f9">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ä¸€ä¸ªæ•°å–è¿ç»­n-bit">ä¸€ä¸ªæ•°å–è¿ç»­n bit&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"> * ä»ä¸€ä¸ªæ•°ä¸­å–ç¬¬startä¸ªbitå¼€å§‹çš„è¿ç»­nä¸ªbit
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">uint32_t&lt;/span> &lt;span style="color:#50fa7b">extract_bits&lt;/span> (&lt;span style="color:#8be9fd">uint32_t&lt;/span> val, &lt;span style="color:#8be9fd">uint32_t&lt;/span> start, &lt;span style="color:#8be9fd">uint32_t&lt;/span> n)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">return&lt;/span> (val &lt;span style="color:#ff79c6">&amp;gt;&amp;gt;&lt;/span> start) &lt;span style="color:#ff79c6">&amp;amp;&lt;/span> bitmask(n);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯å¦ä¸º2çš„å¹‚">åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯å¦ä¸º2çš„å¹‚&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">unsigned&lt;/span> &lt;span style="color:#8be9fd">int&lt;/span> v;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">if&lt;/span> ((v &lt;span style="color:#ff79c6">&amp;amp;&lt;/span> (v &lt;span style="color:#ff79c6">-&lt;/span> &lt;span style="color:#bd93f9">1&lt;/span>)) &lt;span style="color:#ff79c6">==&lt;/span> &lt;span style="color:#bd93f9">0&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#f1fa8c">&amp;#34;v is a power of 2&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">printf&lt;/span>(&lt;span style="color:#f1fa8c">&amp;#34;v is not a power of 2&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Â &lt;/p>
&lt;h2 id="ç»Ÿè®¡ä¸€ä¸ªæ•°çš„äºŒè¿›åˆ¶ä¸­1çš„æ•°é‡">ç»Ÿè®¡ä¸€ä¸ªæ•°çš„äºŒè¿›åˆ¶ä¸­1çš„æ•°é‡&lt;/h2>
&lt;p>ä¾ç„¶æ˜¯åˆ©ç”¨&lt;code>v &amp;amp; (v -1)&lt;/code>çš„è¿ç®—ç»“æœä¼šå°†vçš„æœ€ä½ä½çš„&lt;code>1&lt;/code>(å¦‚æœæœ‰çš„è¯)ç½®&lt;code>0&lt;/code>.&lt;/p>
&lt;p>å¾ªç¯æ‰§è¡Œæ­¤æ“ä½œå°±å¯ç»Ÿè®¡vä¸­&lt;code>1&lt;/code>çš„æ•°é‡.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">int&lt;/span> &lt;span style="color:#50fa7b">numberof1&lt;/span>(&lt;span style="color:#8be9fd">int&lt;/span> v) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">int&lt;/span> count &lt;span style="color:#ff79c6">=&lt;/span> &lt;span style="color:#bd93f9">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">while&lt;/span>(v) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> count&lt;span style="color:#ff79c6">++&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> v &lt;span style="color:#ff79c6">=&lt;/span> v &lt;span style="color:#ff79c6">&amp;amp;&lt;/span> (v &lt;span style="color:#ff79c6">-&lt;/span>&lt;span style="color:#bd93f9">1&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">return&lt;/span> count;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Â &lt;/p>
&lt;h2 id="å°†ä¸€ä¸ªæ•°å‘ä¸Šå–æ•´ä¸º2çš„å¹‚">å°†ä¸€ä¸ªæ•°å‘ä¸Šå–æ•´ä¸º2çš„å¹‚&lt;/h2>
&lt;p>ç”¨ä¸€ä¸ª&lt;code>1&lt;/code>ä¸€ç›´å·¦ç§», ç›´åˆ°æ¯”è¿™ä¸ªæ•°å¤§ä¸ºæ­¢.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">uint32_t&lt;/span> &lt;span style="color:#50fa7b">roundup_pow_of_two&lt;/span>(&lt;span style="color:#ff79c6">const&lt;/span> &lt;span style="color:#8be9fd">uint32_t&lt;/span> x) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">uint32_t&lt;/span> ret &lt;span style="color:#ff79c6">=&lt;/span> &lt;span style="color:#bd93f9">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">while&lt;/span> (ret &lt;span style="color:#ff79c6">&amp;lt;&lt;/span> x) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ret &lt;span style="color:#ff79c6">=&lt;/span> ret &lt;span style="color:#ff79c6">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#bd93f9">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">return&lt;/span> ret;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Linuxå†…æ ¸ä¸­ä½¿ç”¨äº†ä¸€ç§æ›´å¿«çš„æ–¹æ¡ˆ, amazing!!!&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">static&lt;/span> __inline__ &lt;span style="color:#8be9fd">int&lt;/span> &lt;span style="color:#50fa7b">generic_fls&lt;/span>(&lt;span style="color:#8be9fd">int&lt;/span> x)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">int&lt;/span> r &lt;span style="color:#ff79c6">=&lt;/span> &lt;span style="color:#bd93f9">32&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">if&lt;/span> (&lt;span style="color:#ff79c6">!&lt;/span>x)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">return&lt;/span> &lt;span style="color:#bd93f9">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">if&lt;/span> (&lt;span style="color:#ff79c6">!&lt;/span>(x &lt;span style="color:#ff79c6">&amp;amp;&lt;/span> &lt;span style="color:#bd93f9">0xffff0000u&lt;/span>)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> x &lt;span style="color:#ff79c6">&amp;lt;&amp;lt;=&lt;/span> &lt;span style="color:#bd93f9">16&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r &lt;span style="color:#ff79c6">-=&lt;/span> &lt;span style="color:#bd93f9">16&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">if&lt;/span> (&lt;span style="color:#ff79c6">!&lt;/span>(x &lt;span style="color:#ff79c6">&amp;amp;&lt;/span> &lt;span style="color:#bd93f9">0xff000000u&lt;/span>)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> x &lt;span style="color:#ff79c6">&amp;lt;&amp;lt;=&lt;/span> &lt;span style="color:#bd93f9">8&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r &lt;span style="color:#ff79c6">-=&lt;/span> &lt;span style="color:#bd93f9">8&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">if&lt;/span> (&lt;span style="color:#ff79c6">!&lt;/span>(x &lt;span style="color:#ff79c6">&amp;amp;&lt;/span> &lt;span style="color:#bd93f9">0xf0000000u&lt;/span>)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> x &lt;span style="color:#ff79c6">&amp;lt;&amp;lt;=&lt;/span> &lt;span style="color:#bd93f9">4&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r &lt;span style="color:#ff79c6">-=&lt;/span> &lt;span style="color:#bd93f9">4&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">if&lt;/span> (&lt;span style="color:#ff79c6">!&lt;/span>(x &lt;span style="color:#ff79c6">&amp;amp;&lt;/span> &lt;span style="color:#bd93f9">0xc0000000u&lt;/span>)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> x &lt;span style="color:#ff79c6">&amp;lt;&amp;lt;=&lt;/span> &lt;span style="color:#bd93f9">2&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r &lt;span style="color:#ff79c6">-=&lt;/span> &lt;span style="color:#bd93f9">2&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">if&lt;/span> (&lt;span style="color:#ff79c6">!&lt;/span>(x &lt;span style="color:#ff79c6">&amp;amp;&lt;/span> &lt;span style="color:#bd93f9">0x80000000u&lt;/span>)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> x &lt;span style="color:#ff79c6">&amp;lt;&amp;lt;=&lt;/span> &lt;span style="color:#bd93f9">1&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r &lt;span style="color:#ff79c6">-=&lt;/span> &lt;span style="color:#bd93f9">1&lt;/span>;&lt;span style="color:#bd93f9">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">return&lt;/span> r;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">static&lt;/span> &lt;span style="color:#ff79c6">inline&lt;/span> &lt;span style="color:#8be9fd">unsigned&lt;/span> &lt;span style="color:#8be9fd">long&lt;/span> __attribute_const__ &lt;span style="color:#50fa7b">roundup_pow_of_two&lt;/span>(&lt;span style="color:#8be9fd">unsigned&lt;/span> &lt;span style="color:#8be9fd">long&lt;/span> x)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">return&lt;/span> (&lt;span style="color:#bd93f9">1UL&lt;/span> &lt;span style="color:#ff79c6">&amp;lt;&amp;lt;&lt;/span> generic_fls(x &lt;span style="color:#ff79c6">-&lt;/span> &lt;span style="color:#bd93f9">1&lt;/span>));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Â &lt;/p>
&lt;h2 id="å‘ä¸Šå‘ä¸‹å¯¹é½-æ£€æŸ¥æ˜¯å¦å¯¹é½">å‘ä¸Š/å‘ä¸‹å¯¹é½, æ£€æŸ¥æ˜¯å¦å¯¹é½&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">/* uintptr_t ä»£è¡¨æŒ‡é’ˆçš„ä½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"> * åŠ uintptr_tè½¬æ¢çš„åŸå› æ˜¯: (void *)ä¸èƒ½è¿›è¡Œè¿ç®—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#define IS_ALIGNED(X, align) (((uintptr_t)(const void *)(X)) % (align) == 0)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#define ALIGN_UP(X, align) (((X) + ((align) - 1)) &amp;amp; ~((align) - 1))
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#define ALIGN_DOWN(x, align) ((X) &amp;amp; ~((align) - 1))
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#define X (0x12345675)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#define align (1 &amp;lt;&amp;lt; 2)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">int&lt;/span> &lt;span style="color:#50fa7b">main&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">int&lt;/span> v &lt;span style="color:#ff79c6">=&lt;/span> IS_ALIGNED(X, align);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">if&lt;/span> (&lt;span style="color:#bd93f9">0&lt;/span> &lt;span style="color:#ff79c6">==&lt;/span> v) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#f1fa8c">&amp;#34;Given X(0x%x) is not align to 0x%08x&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>, X, align);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#f1fa8c">&amp;#34;After align up, new X = 0x%x&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>, ALIGN_UP(X, align));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#f1fa8c">&amp;#34;After align down, new X = 0x%x&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>, ALIGN_DOWN(X, align));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#ff79c6">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#f1fa8c">&amp;#34;Give X(0x%x) is aligned to 0x%08x&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>, X, align);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#f1fa8c">&amp;#34;After align up, new X = 0x%x&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>, ALIGN_UP(X, align));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#f1fa8c">&amp;#34;After align down, new X = 0x%x&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>, ALIGN_DOWN(X, align));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">return&lt;/span> &lt;span style="color:#bd93f9">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Â &lt;/p>
&lt;h2 id="æ£€æŸ¥ä¸¤ä¸ªæœ‰ç¬¦å·æ•°æ˜¯å¦å¼‚å·">æ£€æŸ¥ä¸¤ä¸ªæœ‰ç¬¦å·æ•°æ˜¯å¦å¼‚å·&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">int&lt;/span> x,y;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">if&lt;/span> ((x &lt;span style="color:#ff79c6">^&lt;/span> y) &lt;span style="color:#ff79c6">&amp;lt;&lt;/span> &lt;span style="color:#bd93f9">0&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#f1fa8c">&amp;#34;They have opposite signs&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">printf&lt;/span>(&lt;span style="color:#f1fa8c">&amp;#34;They have same signs&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Â &lt;/p>
&lt;h2 id="å¤§å°ç«¯è½¬æ¢">å¤§å°ç«¯è½¬æ¢&lt;/h2>
&lt;p>Â &lt;/p>
&lt;h2 id="å¯¹æŸä¸ªä½çš„getsetclearæ“ä½œ">å¯¹æŸä¸ªä½çš„get/set/clearæ“ä½œ&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#define GET_BIT(x, bit) ( ((x) &amp;amp; (1ULL &amp;lt;&amp;lt; (bit))) &amp;gt;&amp;gt; (bit) )
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#define SET_BIT(x, bit) ( (x) |= (1ULL &amp;lt;&amp;lt; (bit)) )
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#define CLEAR_BIT(x, bit) ( (x) &amp;amp;= ~(1ULL &amp;lt;&amp;lt; (bit)) )
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>Release note:&lt;/p>
&lt;ol>
&lt;li>æ·»åŠ å¯¹&lt;code>unsigned long long&lt;/code>é•¿åº¦çš„æ”¯æŒ&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;p>Â &lt;/p>
&lt;h2 id="sign-extending-from-a-varaiable-bit-width">Sign extending from a varaiable bit-width&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">int&lt;/span> bits &lt;span style="color:#ff79c6">=&lt;/span> &lt;span style="color:#bd93f9">2&lt;/span> &lt;span style="color:#ff79c6">*&lt;/span> &lt;span style="color:#bd93f9">8&lt;/span>; &lt;span style="color:#6272a4">// number of bits representing the number in x
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> &lt;span style="color:#8be9fd">int&lt;/span> x &lt;span style="color:#ff79c6">=&lt;/span> &lt;span style="color:#bd93f9">0xFFC1&lt;/span>; &lt;span style="color:#6272a4">// ready to get sign-extended
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> &lt;span style="color:#8be9fd">int&lt;/span> rst; &lt;span style="color:#6272a4">// resulting sign-extended number
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> &lt;span style="color:#8be9fd">int&lt;/span> &lt;span style="color:#ff79c6">const&lt;/span> mask &lt;span style="color:#ff79c6">=&lt;/span> &lt;span style="color:#bd93f9">1U&lt;/span> &lt;span style="color:#ff79c6">&amp;lt;&amp;lt;&lt;/span> (bits &lt;span style="color:#ff79c6">-&lt;/span> &lt;span style="color:#bd93f9">1&lt;/span>); &lt;span style="color:#6272a4">// mask can be pre-computed if bits if fixed.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> x &lt;span style="color:#ff79c6">=&lt;/span> x &lt;span style="color:#ff79c6">&amp;amp;&lt;/span> ((&lt;span style="color:#bd93f9">1U&lt;/span> &lt;span style="color:#ff79c6">&amp;lt;&amp;lt;&lt;/span> bits) &lt;span style="color:#ff79c6">-&lt;/span> &lt;span style="color:#bd93f9">1&lt;/span>); &lt;span style="color:#6272a4">// cut x if it holds more bits
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> rst &lt;span style="color:#ff79c6">=&lt;/span> (x &lt;span style="color:#ff79c6">^&lt;/span> mask) &lt;span style="color:#ff79c6">-&lt;/span> mask; &lt;span style="color:#6272a4">// excellent trick!
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#f1fa8c">&amp;#34;INPUT: 0x%x, RESULT: 0x%x&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>, x, rst);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Â &lt;/p>
&lt;h2 id="å­—ç¬¦å­—ç¬¦æ•°ç»„çš„å¤§å°å†™è½¬æ¢">å­—ç¬¦/å­—ç¬¦æ•°ç»„çš„å¤§å°å†™è½¬æ¢&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#define TO_LOWER(c) (unsigned char)((c &amp;gt;= &amp;#39;A&amp;#39; &amp;amp;&amp;amp; c &amp;lt;= &amp;#39;Z&amp;#39;) ? (c | 0x20) : c)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#define TO_UPPER(c) (unsigned char)((c &amp;gt;= &amp;#39;a&amp;#39; &amp;amp;&amp;amp; c &amp;lt;= &amp;#39;z&amp;#39;) ? (c &amp;amp; ~0x20) : c)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#define TO_LOWER_STR(s, len) { \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6"> for (int i = 0; i &amp;lt; len &amp;amp;&amp;amp; s[i] != &amp;#39;\0&amp;#39;; i++) { \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6"> s[i] = TO_LOWER(s[i]); \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6"> } \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#define TO_UPPER_STR(s, len) {\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6"> for (int i = 0; i &amp;lt; len &amp;amp;&amp;amp; s[i] != &amp;#39;\0&amp;#39;; i++) { \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6"> s[i] = TO_UPPER(s[i]); \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6"> } \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">}
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>- https://wangloo.github.io/posts/c/bitops/ - @2019 Notepadium.</description></item><item><title>Stack and Heap</title><link>https://wangloo.github.io/posts/os/stack-and-heap/</link><pubDate>Tue, 28 Jun 2022 16:41:54 +0800</pubDate><guid>https://wangloo.github.io/posts/os/stack-and-heap/</guid><description>Wangloo's BLOG https://wangloo.github.io/posts/os/stack-and-heap/ -&lt;p>Â &lt;/p>
&lt;h2 id="å †çš„å«ä¹‰">å †çš„å«ä¹‰&lt;/h2>
&lt;p>æˆ‘ä»¬éƒ½çŸ¥é“&lt;code>malloc&lt;/code>åŠ¨æ€ç”³è¯·çš„å˜é‡æ˜¯å­˜æ”¾åœ¨å †ä¸­. æ‰€ä»¥ç›¸æ¯”æ ˆæ¥è¯´, å †æ˜¯åŠ¨æ€çš„.&lt;/p>
&lt;p>å †å æ®è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„å¤§éƒ¨åˆ†, æˆ‘ä»¬å¯èƒ½é€šè¿‡å †æ¥ç”³è¯·&lt;code>1GB&lt;/code>çš„æ•°ç»„, ä½†æ˜¯æ ˆé€šå¸¸ä¸è¡Œ
, å¤§å¤šä¹Ÿå°±å‡ å…†çš„ç©ºé—´.&lt;/p>
&lt;p>Â &lt;/p>
&lt;h2 id="å †ç©ºé—´çš„ç®¡ç†">å †ç©ºé—´çš„ç®¡ç†&lt;/h2>
&lt;p>è¿›ç¨‹ä¸­å †ç©ºé—´çš„ç®¡ç†æ˜¯&lt;code>è¿è¡Œåº“&lt;/code>è´Ÿè´£çš„, åœ¨Linuxä¸­æ˜¯&lt;code>GLIBC&lt;/code>.&lt;/p>
&lt;p>è¿è¡Œåº“åœ¨åˆå§‹åŒ–æ—¶ä¼šåƒæ“ä½œç³»ç»Ÿç”³è¯·ä¸€å¤§å—çš„å †ç©ºé—´, å†ä¸ºæ¯ä¸ªè¿›è¡Œåˆ†åˆ«åˆ†é…éœ€æ±‚. å½“ç„¶,
å¦‚æœæŸäº›ç¨‹åºçš„éœ€æ±‚è¿‡å¤§, è¿è¡Œåº“ä¹Ÿå¯ä»¥ä½¿ç”¨&lt;code>mmap&lt;/code>ç³»ç»Ÿè°ƒç”¨ç›´æ¥å‘æ“ä½œç³»ç»Ÿç”³è¯·, ç„¶å
è¿”å›ç»™ç”¨æˆ·è¿›ç¨‹.&lt;/p>
&lt;blockquote>
&lt;p>GLIBCçš„&lt;code>malloc&lt;/code>å‡½æ•°çš„å¤„ç†æ–¹å¼æ˜¯: å¯¹äºå°äº&lt;code>128KB&lt;/code>çš„ç”³è¯·, ä¼šä»è¿è¡Œåº“&amp;quot;æ‰¹å‘çš„&amp;quot;å †ç©ºé—´
é‡Œåˆ†å‡ºä¸€å—æ¥; ä½†è‹¥ç”³è¯·çš„ç©ºé—´è¿‡å¤§, åˆ™ä½¿ç”¨&lt;code>mmap&lt;/code>ç³»ç»Ÿè°ƒç”¨æ¥åˆ›å»ºåŒ¿åç©ºé—´åˆ†é…ç»™ç”¨æˆ·.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>Linuxä¸­è™šæ‹Ÿåœ°å€å—(VMA)çš„ç®¡ç†ä½¿ç”¨äº†çº¢é»‘æ ‘, å¯ä»¥ç”¨äºè¿è¡Œåº“ç®¡ç†è‡ªå·±å‘æ“ä½œç³»ç»Ÿ
&amp;ldquo;æ‰¹å‘&amp;quot;çš„å †ç©ºé—´. ä½¿å¾—ç”¨æˆ·ç¨‹åºåŠ¨æ€ç”³è¯·å’Œé‡Šæ”¾å†…å­˜æ€§èƒ½æé«˜.&lt;/p>
&lt;/blockquote>
- https://wangloo.github.io/posts/os/stack-and-heap/ - @2019 Notepadium.</description></item></channel></rss>