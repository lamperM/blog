<?xml-stylesheet href="/rss.xsl" type="text/xsl"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Homepage ğŸŒˆ on Soben's Secret Base</title><link>https://wangloo.github.io/</link><description>Recent content in Homepage ğŸŒˆ on Soben's Secret Base</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>@2019 Notepadium.</copyright><lastBuildDate>Thu, 15 Sep 2022 15:14:05 +0800</lastBuildDate><atom:link href="https://wangloo.github.io/index.xml" rel="self" type="application/rss+xml"/><item><title>Cè¯­è¨€ 'inline' å…³é”®å­—</title><link>https://wangloo.github.io/posts/c/inline/</link><pubDate>Thu, 24 Nov 2022 01:35:24 +0800</pubDate><guid>https://wangloo.github.io/posts/c/inline/</guid><description>Soben's Secret Base https://wangloo.github.io/posts/c/inline/ -&lt;p>TODO: inline çš„å‘å±•å†ç¨‹: &lt;a href="https://gustedt.wordpress.com/2010/11/29/myth-and-reality-about-inline-in-c99/">Myth and reality about inline in C99 â€“ Jens Gustedt&amp;rsquo;s Blog (wordpress.com)&lt;/a>&lt;/p>
&lt;h2 id="gnu89">GNU89:&lt;/h2>
&lt;p>å‡½æ•°çš„&lt;strong>å®ç°&lt;/strong>ä¹‹å‰æ·»åŠ ä¸åŒçš„å…³é”®å­—:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>inline&lt;/code>: è¡¨æ˜è¿™ä¸ªå‡½æ•°å¯èƒ½è¢«ä¼˜åŒ–. å¦‚æœæ²¡æœ‰è¢«ä¼˜åŒ–, ç¼–è¯‘å™¨å°±ä¼šè§†ä¸ºä¸€ä¸ªå¸¸è§„å‡½æ•°çš„å®šä¹‰.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>extern inline&lt;/code>: è¡¨æ˜è¿™ä¸ªå‡½æ•°å¯èƒ½è¢«ä¼˜åŒ–. å¦‚æœæ²¡æœ‰è¢«ä¼˜åŒ–, ç¼–è¯‘å™¨å°±å°†è¿™ä¸ªå‡½æ•°çš„å®šä¹‰&lt;strong>è½¬æ¢ä¸ºè¯¥å‡½æ•°çš„å£°æ˜&lt;/strong>, å³ &lt;code>extern inline func();&lt;/code> å› æ­¤å½“æ­¤å‡½æ•°è¢«è°ƒç”¨æ—¶, å¯ä»¥è°ƒç”¨ä¸€ä¸ªå¤–éƒ¨çš„å‡½æ•°æ¥æ›¿ä»£. å¦‚æœæ²¡æœ‰å‡½æ•°è°ƒç”¨å®ƒ, é‚£ä¹ˆä¹Ÿå¯ä»¥æ²¡æœ‰å¤–éƒ¨çš„æ›¿ä»£å‡½æ•°å®ç°.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>static inline&lt;/code>: è¡¨æ˜è¿™ä¸ªå‡½æ•°å¯èƒ½è¢«ä¼˜åŒ–. å¦‚æœæ²¡æœ‰è¢«ä¼˜åŒ–, ç¼–è¯‘å™¨å°±ä¼šè§†ä¸ºä¸€ä¸ª&lt;strong>å¸¸è§„é™æ€å‡½æ•°&lt;/strong>.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="c99">C99:&lt;/h2>
&lt;p>å‡½æ•°çš„å®ç°ä¹‹å‰æ·»åŠ ä¸åŒçš„å…³é”®å­—:&lt;/p>
&lt;ul>
&lt;li>&lt;code>inline&lt;/code>: ç­‰æ•ˆäºgnu89ä¸­çš„&lt;code>extern inline&lt;/code>&lt;/li>
&lt;li>&lt;code>extern inline&lt;/code>: ç­‰æ•ˆäºgnu89ä¸­çš„&lt;code>inline&lt;/code>&lt;/li>
&lt;li>&lt;code>static inline&lt;/code>: ä¸gnu89ç›¸åŒå«ä¹‰.&lt;/li>
&lt;/ul>
&lt;h2 id="c">C++:&lt;/h2>
&lt;p>åªæœ‰&lt;code>inline&lt;/code>ä¸€ä¸ªå…³é”®å­—, å¦‚æœä¸èƒ½ä¼˜åŒ–å°±å®šä¹‰ä¸ºæ™®é€šå‡½æ•°&lt;/p>
&lt;blockquote>
&lt;p>Ref:&lt;/p>
&lt;p>&lt;a href="https://stackoverflow.com/questions/216510/what-does-extern-inline-do/216546#216546">c++ - What does extern inline do? - Stack Overflow&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://gustedt.wordpress.com/2010/11/29/myth-and-reality-about-inline-in-c99/">Myth and reality about inline in C99 â€“ Jens Gustedt&amp;rsquo;s Blog (wordpress.com)&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>&lt;a href="https://github.com/wangloo/inline-c99-gnu89-demo">C demo&lt;/a> å…³äºä»¥ä¸Šçš„å„ç§æƒ…å†µ&lt;/p>
&lt;/blockquote>
- https://wangloo.github.io/posts/c/inline/ - @2019 Notepadium.</description></item><item><title>Cè¯­è¨€å·¥å…·å®</title><link>https://wangloo.github.io/posts/c/c-macros/</link><pubDate>Thu, 24 Nov 2022 01:35:24 +0800</pubDate><guid>https://wangloo.github.io/posts/c/c-macros/</guid><description>Soben's Secret Base https://wangloo.github.io/posts/c/c-macros/ -&lt;h3 id="è®¡ç®—æ•°ç»„å…ƒç´ çš„ä¸ªæ•°">è®¡ç®—æ•°ç»„å…ƒç´ çš„ä¸ªæ•°&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#define nelem(array) sizeof(array)/sizeof(array[0])
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>- https://wangloo.github.io/posts/c/c-macros/ - @2019 Notepadium.</description></item><item><title>x86/ARMv8 å‡½æ•°è°ƒç”¨çº¦å®š</title><link>https://wangloo.github.io/posts/os/function-call-conventions/</link><pubDate>Mon, 21 Nov 2022 10:30:35 +0800</pubDate><guid>https://wangloo.github.io/posts/os/function-call-conventions/</guid><description>Soben's Secret Base https://wangloo.github.io/posts/os/function-call-conventions/ -&lt;p>ç¬¦åˆè°ƒç”¨çº¦å®šä½¿å¾—è°ƒç”¨å‡½æ•°èƒ½å¤Ÿæ­£å¸¸è·å–å‚æ•°, calleeç»“æŸä¹‹åèƒ½å¤Ÿå›åˆ°åŸæ¥ä½ç½®ç»§ç»­æ‰§è¡Œ.&lt;/p>
&lt;h2 id="x86-è°ƒç”¨çº¦å®š">X86 è°ƒç”¨çº¦å®š&lt;/h2>
&lt;h3 id="å‡½æ•°è°ƒç”¨">å‡½æ•°è°ƒç”¨&lt;/h3>
&lt;p>x86æ¶æ„ä¸­, å‡½æ•°è°ƒç”¨ä»¥ä¸€æ¡&lt;code>call&lt;/code>æŒ‡ä»¤ä¸ºåˆ†ç•Œ.&lt;/p>
&lt;p>åœ¨&lt;code>call&lt;/code>æŒ‡ä»¤æ‰§è¡Œä¹‹å‰, æ‰€æœ‰çš„å‚æ•°å¿…é¡»éƒ½èººåœ¨æ ˆä¸­, å‚æ•°å…¥æ ˆçš„è§„åˆ™æ˜¯: &lt;strong>ç¬¬ä¸€ä¸ªå‚æ•°æœ€åå…¥æ ˆ&lt;/strong>.&lt;/p>
&lt;p>å¦å¤–, æ‰§è¡Œ&lt;code>call&lt;/code>æŒ‡ä»¤ä¹‹å‰, å¿…é¡»ç¡®ä¿æ ˆæŒ‡é’ˆ&lt;code>esp&lt;/code>æ˜¯16-byteå¯¹é½. è¿™é¡¹å·¥ä½œæ˜¯&lt;strong>ç¼–è¯‘å™¨&lt;/strong>å®Œæˆçš„, å¦‚æœå®ƒåˆ¤æ–­å‚æ•°å…¥æ ˆä¹‹åçš„&lt;code>esp&lt;/code> ä¸æ»¡è¶³å¯¹é½æ¡ä»¶, åˆ™ä¼šæ‰‹åŠ¨è°ƒæ•´&lt;code>esp&lt;/code>ä½¿ä¹‹å¯¹é½. å®ç°æ–¹å¼è§ä¸‹é¢ä¾‹å­.&lt;/p>
&lt;p>&lt;code>call&lt;/code> æŒ‡ä»¤çš„è¯­ä¹‰æ˜¯:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-asm" data-lang="asm">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">push&lt;/span> pc+&lt;span style="color:#bd93f9">1&lt;/span> &lt;span style="color:#6272a4">;push next insttuction
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>mov pc, func &lt;span style="color:#6272a4">;set pc = new function
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>call&lt;/code> æŒ‡ä»¤ä¹‹åçš„ä¸‹ä¸€æ¡æŒ‡ä»¤å°±æ˜¯calleeçš„å†…å®¹äº†, è‡³æ­¤å°±ç®—æ˜¯è¿›å…¥æ–°å‡½æ•°çš„åœ°ç›˜.&lt;/p>
&lt;p>ä½†æ˜¯åœ¨æ‰§è¡Œæ–°çš„ä»»åŠ¡ä¹‹å‰, calleeè¿˜éœ€è¦å®Œæˆ&lt;strong>æ ˆçš„è½¬æ¢&lt;/strong>, å› ä¸ºæ­¤æ—¶ä½¿ç”¨çš„æ ˆè¿˜æ˜¯callerçš„.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-asm" data-lang="asm">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">push&lt;/span> ebp &lt;span style="color:#6272a4">;preserve location of caller&amp;#39;s stack
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>mov ebp, esp &lt;span style="color:#6272a4">;new ebp is old esp
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>æ­¤æ—¶&lt;code>esp&lt;/code>ä¹Ÿå°±æ˜¯æ ˆæŒ‡é’ˆç­‰äº&lt;code>ebp&lt;/code>, è¿™æ˜¯calleeæ ˆçš„åˆå§‹æ¡ä»¶&lt;/strong>. ä¸‡äº‹ä¿±å¤‡, å¯ä»¥å¼€å§‹æ‰§è¡Œcalleeçš„å®é™…ä»»åŠ¡äº†.&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>ebp&lt;/code>åœ¨æ•´ä¸ªå‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­æ˜¯å›ºå®šçš„, å¥½å¤„æ˜¯: èƒ½å¤Ÿ&lt;strong>å¿«é€Ÿçš„æˆ–è€…å‡½æ•°å‚æ•°, è¿”å›åœ°å€&lt;/strong>.&lt;/p>
&lt;/blockquote>
&lt;h3 id="å‡½æ•°è¿”å›">å‡½æ•°è¿”å›&lt;/h3>
&lt;p>calleeæ‰§è¡Œå®Œæ¯•å, éœ€è¦è¿”å›åˆ°callerç»§ç»­æ‰§è¡Œ. åˆšæ‰è¯´è¿‡, calleeçš„è¿”å›åœ°å€åœ¨æ ˆä¸­, æ‰€ä»¥æˆ‘ä»¬è¦åšçš„æ˜¯æ‰¾åˆ°è¿”å›åœ°å€æ‰€åœ¨çš„ä½ç½®, ç„¶åä½¿&lt;code>pc = è¿”å›åœ°å€&lt;/code>. å½“ç„¶, è¿˜æœ‰å¦ä¸€ä¸ªé‡è¦çš„ä»»åŠ¡å°±æ˜¯&lt;strong>æ¢å¤callerçš„æ ˆ&lt;/strong>.&lt;/p>
&lt;p>ä¸Šè¿°ä»»åŠ¡çš„å®ç°ä½¿ç”¨ä¸¤æ¡æ±‡ç¼–è¯­å¥å°±å¯å®Œæˆ: &lt;code>leave&lt;/code> å’Œ &lt;code>ret&lt;/code>.&lt;/p>
&lt;p>&lt;code>leave&lt;/code> è´Ÿè´£æå®šæ ˆ, å…¶è¯­ä¹‰ä¸º:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-asm" data-lang="asm">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">mov&lt;/span> esp, ebp &lt;span style="color:#6272a4">;å›æ»šæ ˆç©ºé—´
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>pop ebp &lt;span style="color:#6272a4">;æ¢å¤callerçš„ebp
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>ret&lt;/code> è´Ÿè´£æå®š&lt;code>pc&lt;/code>, å…¶è¯­ä¹‰ä¸º:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-asm" data-lang="asm">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">pop&lt;/span> ebx &lt;span style="color:#6272a4">;å–å‡ºè¿”å›åœ°å€
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>mov pc, ebx &lt;span style="color:#6272a4">;jmp to è¿”å›åœ°å€
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>ret&lt;/code> ä¹‹å, å°±ç®—æ˜¯è¿”å›callerçš„åœ°ç›˜äº†. è¿˜æœ‰ä¸€ä»¶å°äº‹åˆ«å¿˜äº†åš: &lt;strong>ç”¨äºä¿å­˜å‚æ•°çš„æ ˆç©ºé—´è¿˜æ²¡æœ‰å›æ”¶&lt;/strong>, å›åˆ°callerä¹‹åéœ€è¦å…ˆå°†&lt;code>esp&lt;/code>çš„ä½ç½®è¿›è¡Œè°ƒæ•´.&lt;/p>
&lt;h3 id="example-å‡½æ•°çš„è°ƒç”¨å’Œè¿”å›">Example: å‡½æ•°çš„è°ƒç”¨å’Œè¿”å›&lt;/h3>
&lt;p>ä¸€ä¸ªå…³äºå‡½æ•°è°ƒç”¨å’Œè¿”å›å®ç°çš„å®Œæ•´ä¾‹å­.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">void&lt;/span> &lt;span style="color:#50fa7b">caller&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Func(&lt;span style="color:#bd93f9">1&lt;/span>, &lt;span style="color:#bd93f9">2&lt;/span>, &lt;span style="color:#bd93f9">3&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">void&lt;/span> &lt;span style="color:#50fa7b">Func&lt;/span>(&lt;span style="color:#8be9fd">int&lt;/span> a, &lt;span style="color:#8be9fd">int&lt;/span> b, &lt;span style="color:#8be9fd">int&lt;/span> c)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#6272a4">/* Do something */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>(ä»¥ä¸‹æ±‡ç¼–æ˜¯&lt;strong>AT&amp;amp;T&lt;/strong>æ ¼å¼çš„, è¯·è§è°…).&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-asm" data-lang="asm">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">; Caller
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>&lt;span style="color:#50fa7b">sub&lt;/span> $0x4,&lt;span style="color:#8be9fd;font-style:italic">%esp&lt;/span> &lt;span style="color:#6272a4">;make 16-bytes align before call. 0x4 æ˜¯ç”±ç¼–è¯‘å™¨è®¡ç®—çš„
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>push $0x3 &lt;span style="color:#6272a4">;push å‚æ•°, é¡ºåºæ˜¯ä»å³åˆ°å·¦
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>push $0x2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">push&lt;/span> $0x1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">call&lt;/span> &lt;span style="color:#bd93f9">f01000ad&lt;/span> &amp;lt;Func&amp;gt; &lt;span style="color:#6272a4">;Func()&amp;#39;addr is f01000ad
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">;===========&amp;gt;&amp;gt; Turn to callee
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#6272a4">;Func()
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> push &lt;span style="color:#8be9fd;font-style:italic">%ebp&lt;/span> &lt;span style="color:#6272a4">;preserve old ebp
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> mov &lt;span style="color:#8be9fd;font-style:italic">%esp&lt;/span>,&lt;span style="color:#8be9fd;font-style:italic">%ebp&lt;/span> &lt;span style="color:#6272a4">;set new ebp, ebp=esp now
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> /* Do something */
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">leave&lt;/span> &lt;span style="color:#6272a4">;restore stack
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> ret &lt;span style="color:#6272a4">;restore instruction point
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">;&amp;lt;&amp;lt;=========== Back to caller
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>add $0x10,&lt;span style="color:#8be9fd;font-style:italic">%esp&lt;/span> &lt;span style="color:#6272a4">;recycle stack(12 bytes parameters plus 4 bytes alignment)
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="armv8-è°ƒç”¨çº¦å®š">Armv8 è°ƒç”¨çº¦å®š&lt;/h2>
&lt;p>å¤§ä½“çš„æ€æƒ³ä¸x86ç›¸ä¼¼, åªæ˜¯ç»†èŠ‚æœ‰äº›è®¸ä¸åŒ&lt;/p>
&lt;h3 id="å‡½æ•°è°ƒç”¨-1">å‡½æ•°è°ƒç”¨&lt;/h3>
&lt;p>ARMv8æ¶æ„ä¸­, å‡½æ•°è°ƒç”¨ä»¥ä¸€æ¡&lt;code>bl&lt;/code>æŒ‡ä»¤ä¸ºåˆ†ç•Œ.&lt;/p>
&lt;p>æ‰§è¡Œ&lt;code>bl&lt;/code>æŒ‡ä»¤ä¹‹å‰, éœ€è¦å°†å‚æ•°å‡†å¤‡å¥½. æ³¨æ„, &lt;strong>ARMv8ä¸­, å°‘äº8ä¸ªå‚æ•°çš„å‡½æ•°åœ¨ä¼ å‚æ—¶, å‚æ•°æ˜¯æ”¾åœ¨x0-x7ä¸­&lt;/strong>, æœ€å·¦è¾¹çš„å‚æ•°å…ˆä½¿ç”¨x0, ä»¥æ­¤ç±»æ¨. å‚æ•°è¶…è¿‡8ä¸ªçš„æƒ…å†µä¸‹æ‰ä½¿ç”¨æ ˆ, è¿™ä¸x86çš„æ–¹å¼ä¸åŒ.&lt;/p>
&lt;p>&lt;code>bl&lt;/code>æŒ‡ä»¤ä¿å­˜è¿”å›åœ°å€, å¹¶è·³è½¬åˆ°calleeæ‰§è¡Œ, å…¶è¯­ä¹‰æ˜¯:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-asm" data-lang="asm">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">mov&lt;/span> lr, pc+&lt;span style="color:#bd93f9">1&lt;/span> &lt;span style="color:#6272a4">;preserve return address
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> &lt;span style="color:#6272a4">;lr specially used for preservering return addr
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>mov pc, new_func &lt;span style="color:#6272a4">;set pc = new function
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸x86ç›¸åŒ, è·³è½¬åˆ°calleeä¹‹åå¿…é¡»å…ˆè¿›è¡Œæ ˆçš„è®¾ç½®, &lt;strong>Armä¸x86ä¸åŒçš„æ˜¯å®ƒä¸éœ€è¦ç®¡ç†æ ˆåº•å¯„å­˜å™¨&lt;/strong>. å› ä¸ºå‚æ•°å¤§éƒ¨åˆ†æ˜¯é€šè¿‡å¯„å­˜å™¨æ¥ä¼ é€’, è¿”å›åœ°å€ä¹Ÿæ˜¯å­˜å‚¨åœ¨&lt;code>lr(x30)&lt;/code>å¯„å­˜å™¨ä¸­, æ²¡å¿…è¦ä¸ºäº†æå°‘çš„æƒ…å†µæ¥åšä¼˜åŒ–.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-asm" data-lang="asm">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">sub&lt;/span> sp, sp, &lt;span style="color:#6272a4">#enough-space
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å‡½æ•°è¿”å›-1">å‡½æ•°è¿”å›&lt;/h3>
&lt;p>è¦å®Œæˆä¸¤ä»¶äº‹: (1) æ¢å¤æ ˆ (2)è¿”å›åŸæ¥ä½ç½®æ‰§è¡Œ&lt;/p>
&lt;p>å…ˆè¯´(2), ç”±äº&lt;code>lr&lt;/code>å¯„å­˜å™¨å§‹ç»ˆä¿å­˜è¿”å›åœ°å€, ç›´æ¥ &lt;code>mov sp, lr&lt;/code> å°±èƒ½è¿”å›callerç»§ç»­æ‰§è¡Œ. &lt;strong>è¿™ä¹Ÿå°±æ˜¯&lt;code>ret&lt;/code>æŒ‡ä»¤çš„è¯­ä¹‰&lt;/strong>.&lt;/p>
&lt;p>(1)æ¢å¤æ ˆçš„è¿™ä»¶äº‹åŒx86ä¸€æ ·ç”±calleeå®Œæˆ,&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-asm" data-lang="asm">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">add&lt;/span> sp, sp, &lt;span style="color:#6272a4">#enough-space
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ol>
&lt;li>x86 call æŒ‡ä»¤æ‰§è¡Œå‰éœ€è¦espå¯¹é½åˆ° 16-byte: &lt;a href="https://stackoverflow.com/questions/41971481/what-are-the-following-instructions-after-this-call-assembly">x86 - What are the following instructions after this call (assembly) - Stack Overflow&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://zhuanlan.zhihu.com/p/290689333">x86æ ˆå¸§åŸç† - çŸ¥ä¹ (zhihu.com)&lt;/a>&lt;/li>
&lt;/ol>
&lt;h2 id="ç»“è¯­">ç»“è¯­&lt;/h2>
&lt;p>èƒ½å¤Ÿæ­£ç¡®è¾¾åˆ°å‡½æ•°è°ƒç”¨å’Œè¿”å›çš„å®ç°æ–¹å¼æœ‰å¾ˆå¤š, &lt;strong>ä¸æ˜¯ä»…æœ‰è¿™ä¸€ç§æ–¹å¼&lt;/strong>, çº¦å®šä»…ä»…æ˜¯ä¸€ä¸ªçº¦å®š, å¤§å®¶éƒ½è¿™æ ·å»åšé™ä½äº†å¼€å‘çš„éš¾åº¦.&lt;/p>
- https://wangloo.github.io/posts/os/function-call-conventions/ - @2019 Notepadium.</description></item><item><title>äºŒçº§æŒ‡é’ˆæ“ä½œé“¾è¡¨</title><link>https://wangloo.github.io/posts/c/pointers-pointers-list/</link><pubDate>Sun, 20 Nov 2022 23:40:30 +0800</pubDate><guid>https://wangloo.github.io/posts/c/pointers-pointers-list/</guid><description>Soben's Secret Base https://wangloo.github.io/posts/c/pointers-pointers-list/ -&lt;p>é—®é¢˜æºäºæˆ‘åœ¨çŸ¥ä¹åˆ·åˆ°çš„ä¸€ä¸ªå›ç­”: &lt;a href="https://www.zhihu.com/question/477832027/answer/2044206446">èƒ½åˆ†äº«ä½ CæŒ‡é’ˆç”¨å¾—æœ€çµæ´»ï¼ˆé£˜ï¼‰çš„ä¸€æ¬¡å—?&lt;/a>&lt;/p>
&lt;p>æ–‡ä¸­æåˆ°äº†Linuså…³äº&lt;strong>æ— å¤´èŠ‚ç‚¹å•é¡¹é“¾è¡¨çš„åˆ é™¤æ“ä½œ&lt;/strong>ç»™å‡ºçš„ä¸€ç§æ–°çš„æ€è·¯, æˆ‘è§‰å¾—å¯¹ç†è§£æŒ‡é’ˆéå¸¸æœ‰å¸®åŠ©, æ‰€ä»¥åœ¨è¿™é‡Œè¯¦ç»†æè¿°ä¸€ä¸‹è¿™ä»¶äº‹.&lt;/p>
&lt;p>ä»æˆ‘å­¦ä¹ æ•°æ®ç»“æ„èµ·, å¯¹ä¸å«å¤´èŠ‚ç‚¹çš„å•å‘é“¾è¡¨çš„åˆ é™¤æ“ä½œ, åšæ³•å¸¸æ˜¯: å€Ÿç”¨&lt;strong>preæŒ‡é’ˆ&lt;/strong>æœç´¢. è¿™ç§æƒ…å†µä¸‹é¿å…ä¸äº†å¯¹äºé“¾è¡¨ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„ç‰¹åˆ¤(ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰pre).&lt;/p>
&lt;p>Linusæåˆ°äº†ä¸€ç§å€ŸåŠ©&lt;strong>äºŒçº§æŒ‡é’ˆé¿å…è¯¥åˆ†æ”¯&lt;/strong>çš„æ–¹æ³•.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">void&lt;/span> &lt;span style="color:#50fa7b">remove_if&lt;/span>(node &lt;span style="color:#ff79c6">**&lt;/span> head, remove_fn rm)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">for&lt;/span> (node&lt;span style="color:#ff79c6">**&lt;/span> curr &lt;span style="color:#ff79c6">=&lt;/span> head; &lt;span style="color:#ff79c6">*&lt;/span>curr; )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> node &lt;span style="color:#ff79c6">*&lt;/span> entry &lt;span style="color:#ff79c6">=&lt;/span> &lt;span style="color:#ff79c6">*&lt;/span>curr;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">if&lt;/span> (rm(entry))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">*&lt;/span>curr &lt;span style="color:#ff79c6">=&lt;/span> entry&lt;span style="color:#ff79c6">-&amp;gt;&lt;/span>next;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> free(entry);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> curr &lt;span style="color:#ff79c6">=&lt;/span> &lt;span style="color:#ff79c6">&amp;amp;&lt;/span>entry&lt;span style="color:#ff79c6">-&amp;gt;&lt;/span>next;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŒ‡é’ˆçš„å†…å®¹å°±æ˜¯åœ°å€, &lt;code>int *p = a&lt;/code> ä¹Ÿå°±æ„å‘³ç€å˜é‡&lt;code>p&lt;/code> ä¸­ä¿å­˜ç€å˜é‡&lt;code>a&lt;/code>çš„åœ°å€. æ‰€ä»¥å‚æ•°&lt;code>head&lt;/code>åœ¨å†…å­˜ä¸­çš„å«ä¹‰ä¸º:&lt;/p>
&lt;p>&lt;img src="./mem.png" alt="listçš„å†…å­˜å¸ƒå±€">&lt;/p>
&lt;p>å‡å¦‚è¦åˆ é™¤node2, é‚£ä¹ˆæ”¹å˜&lt;code>*curr&lt;/code>å®é™…ä¸Šå°±æ˜¯&lt;strong>æ”¹äº†node1çš„&lt;code>next&lt;/code>æˆå‘˜&lt;/strong>.&lt;/p>
- https://wangloo.github.io/posts/c/pointers-pointers-list/ - @2019 Notepadium.</description></item><item><title>å¤§å°ç«¯é—®é¢˜</title><link>https://wangloo.github.io/posts/os/big-little-endian/</link><pubDate>Thu, 17 Nov 2022 10:30:35 +0800</pubDate><guid>https://wangloo.github.io/posts/os/big-little-endian/</guid><description>Soben's Secret Base https://wangloo.github.io/posts/os/big-little-endian/ -&lt;hr>
&lt;h2 id="å¤§å°ç«¯é—®é¢˜çš„ç”±æ¥">å¤§å°ç«¯é—®é¢˜çš„ç”±æ¥&lt;/h2>
&lt;p>ä¸ºä»€ä¹ˆè®¡ç®—æœºä¸–ç•Œéœ€è¦åŒºåˆ†å¤§å°ç«¯? &lt;strong>å†…å­˜é‡Œå­˜å–çš„å•ä½æ˜¯å­—èŠ‚&lt;/strong>, å¦‚æœæ‰€æœ‰çš„æ•°æ®ç±»å‹é•¿åº¦éƒ½æ˜¯ä¸€ä¸ªå­—èŠ‚, é‚£å°±å®Œå…¨ä¸éœ€è¦å¤§å°ç«¯äº†, æ¯ä¸ªå˜é‡éƒ½ä»…å æ®å•ç‹¬ä¸€ä¸ªå­—èŠ‚.&lt;/p>
&lt;p>ä¾‹å¦‚, ä¸‰ä¸ªå˜é‡ &lt;code>a=10, b=20, c=30&lt;/code>, åœ¨å†…å­˜ä¸­çš„å¸ƒå±€å¯èƒ½å°±æ˜¯:&lt;/p>
&lt;pre tabindex="0">&lt;code> â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”‚
â”‚ 10 â”‚ a
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚
â”‚ 20 â”‚ b
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚
â”‚ 30 â”‚ c
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚
â”‚ â”‚
â”‚ â”‚
â”‚ â”‚
â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code>&lt;/pre>&lt;p>ä½†æ˜¯æˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„æ•°æ®ç±»å‹è‚¯å®šæœ‰è¶…è¿‡ä¸€ä¸ªå­—èŠ‚çš„, &lt;code>int&lt;/code>ç±»å‹åœ¨64ä½çš„ç³»ç»Ÿä¸­å°±å &lt;strong>4ä¸ªå­—èŠ‚&lt;/strong>. ä¾‹å¦‚å˜é‡&lt;code>a=0xaabbccdd&lt;/code>&lt;/p>
&lt;p>ä¸€ä¸ªå˜é‡çš„å¤§å°ä¸€æ—¦è¶…è¿‡4ä¸ªå­—èŠ‚, &lt;strong>å†…å­˜çš„å­˜å–åˆæ˜¯ä»¥å­—èŠ‚ä½å•ä½çš„&lt;/strong>, é‚£ä¹ˆè¦æŠŠå®ƒå¡åˆ°å†…å­˜é‡Œå°±å¿…ç„¶ä¼šäº§ç”Ÿä¸¤ç§ä¸åŒå­˜æ”¾æ–¹å¼: &lt;strong>å…ˆæ”¾&lt;code>0xaa&lt;/code>è¿˜æ˜¯å…ˆæ”¾&lt;code>0xdd&lt;/code>&lt;/strong>&lt;/p>
&lt;p>é¦–å…ˆ, &lt;code>0xdd&lt;/code>æ˜¯å˜é‡açš„ä½8ä½, &lt;code>0xaa&lt;/code>æ˜¯æœ€é«˜8ä½, è¿™æ˜¯ç¡®å®šçš„.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å¦‚æœå…ˆæ”¾&lt;code>0xaa&lt;/code>, å³ä½åœ°å€æ”¾é«˜ä½, å°±å«åš&lt;em>å¤§ç«¯&lt;/em>, å¦‚å·¦å›¾;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦‚æœå…ˆæ”¾&lt;code>0xdd&lt;/code>, å³ä½åœ°å€æ”¾ä½ä½, å°±å«&lt;em>å°ç«¯&lt;/em>, å¦‚å³å›¾.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>
start addr of `a` start addr of `a`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”‚ â”‚ â”‚
â”‚ aa â”‚ â”‚ dd â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚ â”‚ â”‚
â”‚ bb â”‚ â”‚ cc â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚ â”‚ â”‚
â”‚ cc â”‚ â”‚ bb â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚ â”‚ â”‚
â”‚ dd â”‚ â”‚ aa â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code>&lt;/pre>&lt;h2 id="ä»€ä¹ˆæƒ…å†µ">ä»€ä¹ˆæƒ…å†µ?&lt;/h2>
&lt;p>çœ‹ä¸‹é¢çš„ä»£ç , çŒœæµ‹è¾“å‡ºçš„ç»“æœ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">unsigned&lt;/span> &lt;span style="color:#8be9fd">int&lt;/span> i &lt;span style="color:#ff79c6">=&lt;/span> &lt;span style="color:#bd93f9">0x00646c72&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>printf(&lt;span style="color:#f1fa8c">&amp;#34;Hello Wo%s&amp;#34;&lt;/span>, &lt;span style="color:#ff79c6">&amp;amp;&lt;/span>i);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>%s&lt;/code> ä¼šæŒ‰å­—èŠ‚ä¸€ç›´æ‰“å°å†…å­˜ä¸­çš„å­—ç¬¦, ç›´åˆ°é‡åˆ°&lt;code>\0&lt;/code>. é¦–å…ˆæ‰“å°çš„å­—ç¬¦ä¾¿æ˜¯å˜é‡&lt;code>i&lt;/code>çš„åœ°å€å¤„çš„å†…å®¹.&lt;/p>
&lt;p>å¦‚æœæ˜¯å°ç«¯å­˜å‚¨æ–¹å¼, å˜é‡&lt;code>i&lt;/code>çš„åœ°å€å¤„çš„ä¸€ä¸ªå­—èŠ‚å€¼æ˜¯0x72, å³å­—ç¬¦&lt;code>r&lt;/code>. ä»¥æ­¤ç±»æ¨, æ‰€ä»¥å¦‚æœCPUçš„å­—èŠ‚åºæ˜¯å°ç«¯å½¢å¼, é‚£ä¹ˆ&lt;code>printf&lt;/code>çš„ç»“æœæ˜¯: Hello world&lt;/p>
&lt;h2 id="å¤§å°ç«¯å½¢å¼çš„ä¼˜ç¼ºç‚¹">å¤§å°ç«¯å½¢å¼çš„ä¼˜ç¼ºç‚¹&lt;/h2>
&lt;p>å°ç«¯çš„ä¼˜åŠ¿:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>ä»¥ä¸åŒçš„é•¿åº¦è¯»å–å˜é‡éå¸¸æ–¹ä¾¿, ä¸ç”¨è®¡ç®—åœ°å€. ä¾‹å¦‚&lt;code>u64 a=0x1234&lt;/code>, å½“&lt;code>(u16)a&lt;/code>æ—¶, CPUä¸éœ€è¦é‡æ–°è®¡ç®—è¯»å–çš„èµ·å§‹ä½ç½®, æ°¸è¿œéƒ½æ˜¯å˜é‡açš„èµ·å§‹åœ°å€.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Easily to do mathematical computations â€œbecause of the 1:1 relationship between address offset and byte number (offset 0 is byte 0), multiple precision math routines are correspondingly easy to write.â€&lt;/p>
&lt;/li>
&lt;/ol>
- https://wangloo.github.io/posts/os/big-little-endian/ - @2019 Notepadium.</description></item><item><title>æ“ä½œç³»ç»Ÿâ€”â€”ä¸Šä¸‹æ–‡åˆ‡æ¢</title><link>https://wangloo.github.io/posts/os/context/</link><pubDate>Mon, 14 Nov 2022 22:13:06 +0800</pubDate><guid>https://wangloo.github.io/posts/os/context/</guid><description>Soben's Secret Base https://wangloo.github.io/posts/os/context/ -&lt;p>æœ¬æ–‡åŸºäº&lt;strong>AArch64&lt;/strong>æ‰§è¡Œç¯å¢ƒ, ä»‹ç»ç°ä»£æ“ä½œç³»ç»Ÿä¸­ä¸Šä¸‹æ–‡åˆ‡æ¢çš„ç›¸å…³å†…å®¹.&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡">ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡ï¼Ÿ&lt;/h2>
&lt;p>ä¸Šä¸‹æ–‡åˆç§°â€œç°åœºâ€,&lt;/p>
&lt;h2 id="ä¸ºä»€ä¹ˆéœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢">ä¸ºä»€ä¹ˆéœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢?&lt;/h2>
&lt;p>(TODO: ä¸ºä»€ä¹ˆè¯´çº¿ç¨‹æ˜¯è°ƒåº¦çš„å•ä½?)&lt;/p>
&lt;p>ç°ä»£æ“ä½œç³»ç»Ÿä¸­åŒæ—¶å­˜åœ¨ç€æˆåƒä¸Šç™¾ä¸ªçº¿ç¨‹, ä½†æ˜¯ä¸€ä¸ªCPUåŒä¸€æ—¶åˆ»åªèƒ½è¿è¡Œä¸€ä¸ªçº¿ç¨‹, ä»–ä»¬æ˜¯è½®æµçš„å ç”¨CPU, ä¹Ÿå«å¹¶å‘æ‰§è¡Œ. (TODO: å¦‚ä½•æŸ¥çœ‹çº¿ç¨‹åˆ‡æ¢çš„é—´éš”?) çº¿ç¨‹é«˜é¢‘ç‡çš„åˆ‡æ¢, æ“ä½œç³»ç»Ÿæ˜¯å¦‚ä½•ä¿è¯åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ‰§è¡Œçš„çº¿ç¨‹æ—¶, å®ƒèƒ½å¤Ÿç»§ç»­ä¸Šæ¬¡çš„å·¥ä½œå‘¢?&lt;/p>
&lt;h3 id="ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡-1">ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡?&lt;/h3>
&lt;p>æˆ‘ä»¬æ­£åœ¨çœ‹ä¸€æœ¬ä¹¦çš„æ—¶å€™å¦‚æœè¢«å…¶ä»–çš„äº‹æƒ…æ‰“æ–­, è¿”å›æ—¶ä¸ºäº†èƒ½å¤Ÿä»ä¸Šæ¬¡è¢«æ‰“æ–­çš„ä½ç½®ç»§ç»­è¯», å°±è¦åœ¨è¢«æ‰“æ–­çš„æ—¶å€™è®°ä¸‹æ¥å½“å‰æ˜¯è¯»åˆ°äº†å“ªä¸ªç¬¬å‡ é¡µçš„ç¬¬å‡ è¡Œ.&lt;/p>
&lt;p>æ“ä½œç³»ç»Ÿå¯¹å¾…çº¿ç¨‹ä¹Ÿæ˜¯å¦‚æ­¤, éœ€è¦ä¿å­˜çš„ç”¨äºæ¢å¤çº¿ç¨‹æ‰§è¡Œçš„ä¿¡æ¯å°±ç§°ä¸ºçº¿ç¨‹çš„ä¸Šä¸‹æ–‡.&lt;/p>
&lt;p>é‚£ä¹ˆå¯¹äºçº¿ç¨‹æ¥è¯´éœ€è¦è®°ä¸‹çš„å†…å®¹æœ‰ä»€ä¹ˆå‘¢? å¯„å­˜å™¨å’Œæ ˆå³å¯. æ‹¿AArch64æ¶æ„æ¥è·ç¦», çº¿ç¨‹çš„ä¸Šä¸‹æ–‡å°±æ˜¯:&lt;/p>
&lt;ol>
&lt;li>é€šç”¨å¯„å­˜å™¨&lt;code>x0-x29&lt;/code>: å‡½æ•°è°ƒç”¨çš„å‚æ•°, æŸäº›è®¡ç®—è¿‡ç¨‹çš„ä¸­é—´å€¼, éƒ½è¦ç”¨åˆ°è¿™äº›å¯„å­˜å™¨. &lt;strong>çº¿ç¨‹çš„æ‰§è¡Œæµå¯èƒ½åœ¨ä»»ä½•æ—¶å€™è¢«æ‰“æ–­&lt;/strong>, å½“ç„¶è¿™äº›å†…å®¹ä¹Ÿä¸èƒ½ä¸¢.&lt;/li>
&lt;li>é€šç”¨å¯„å­˜å™¨&lt;code>lr(x30)&lt;/code>: &lt;code>lr&lt;/code> ä¿å­˜ç€è¿”å›åœ°å€, å³å½“å‰å‡½æ•°ç»“æŸä¹‹åè¯¥è¿”å›åˆ°å“ªæ‰§è¡Œ.&lt;/li>
&lt;li>æ ˆé¡¶æŒ‡é’ˆ &lt;code>sp&lt;/code>: æ ˆçš„é‡è¦æ€§æ— éœ€å¤šè¨€. ä½†æ˜¯éœ€è¦è¯´æ˜çš„æ˜¯æˆ‘ä»¬ä¿å­˜æ ˆçš„æ–¹å¼&lt;strong>å¹¶éå°†æ ˆä¸­çš„æ‰€æœ‰å†…å®¹ä¿å­˜, è€Œæ˜¯ä¿å­˜æ ˆçš„ä½ç½®&lt;/strong>å³å¯. å› ä¸ºæ“ä½œç³»ç»Ÿæœ‰åˆ«çš„æœºåˆ¶(TODO), èƒ½å¤Ÿä¿è¯å³ä¾¿çº¿ç¨‹ä¸åœ¨æ‰§è¡Œ, å±äºè¯¥çº¿ç¨‹çš„æ ˆä¹Ÿä¸ä¼šè¢«ç ´å.&lt;/li>
&lt;li>ç¨‹åºè®¡æ•°å™¨ &lt;code>pc&lt;/code>: è¢«æ‰“æ–­çš„çº¿ç¨‹å¦‚æœå†æ¬¡æ‰§è¡Œ, ä»å“ªé‡Œæ‰§è¡Œå‘¢? æ˜¾ç„¶æ˜¯è¢«æ‰“æ–­æŒ‡ä»¤çš„ä¸‹ä¸€æ¡(æˆ–è€…é‡æ–°æ‰§è¡Œå½“å‰). è¿™ä¸ªæŒ‡ä»¤çš„åœ°å€å½“ç„¶ä¹Ÿéœ€è¦è¢«ä¿å­˜å¥½.&lt;/li>
&lt;li>PSTATE: æƒ³ä¸€ä¸‹, æœ‰äº†ä»¥ä¸Šçš„å†…å®¹å°±èƒ½å¤Ÿä¿è¯çº¿ç¨‹å®Œæ•´çš„æ¢å¤ä¹‹å‰çš„ç¯å¢ƒå—? å…¶ä»–çš„ä¾‹å¦‚ä¸­æ–­æ˜¯å¼€è¿˜æ˜¯å…³, æœ‰å“ªäº›æ ‡å¿—ä½(NZCV)è¢«è®¾ç½®äº†. è¿™äº›ä¿¡æ¯åœ¨AArch64ä¸­æ˜¯ä¿å­˜åœ¨PSTATEçš„å„ä¸ªå­—æ®µä¸­.&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæœ‰ä¸€ä¸ªé€‚å½“çš„é€»è¾‘, åœ¨çº¿ç¨‹åˆ‡æ¢å‡ºå»çš„æ—¶å€™å°†ä¸Šä¸‹æ–‡ä¿å­˜èµ·æ¥, ç„¶åæ¢å¤æ–°çº¿ç¨‹çš„ä¸Šä¸‹æ–‡, æ˜¯ä¸æ˜¯çº¿ç¨‹åˆ‡æ¢è¿™ä»¶äº‹å°±èƒ½åšåˆ°äº†. å¦‚ä½•ç»„ç»‡è¿™ä¸ªä¿å­˜å’Œæ¢å¤çš„è¿‡ç¨‹åœ¨ä¸‹é¢ä¼šä»‹ç»åˆ°.&lt;/p>
&lt;h2 id="linux-å¦‚ä½•å¤„ç†ä¸Šä¸‹æ–‡åˆ‡æ¢">Linux å¦‚ä½•å¤„ç†ä¸Šä¸‹æ–‡åˆ‡æ¢&lt;/h2>
&lt;h2 id="å¦ä¸€ç§å¤„ç†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ€è·¯">å¦ä¸€ç§å¤„ç†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ€è·¯&lt;/h2>
&lt;h2 id="åç¨‹çš„ä¸Šä¸‹æ–‡">åç¨‹çš„ä¸Šä¸‹æ–‡&lt;/h2>
&lt;p>åç¨‹æ˜¯ç”¨æˆ·çº§åˆ«çš„çº¿ç¨‹,&lt;/p>
&lt;ul>
&lt;li>åç¨‹ä¹‹é—´çš„åˆ‡æ¢ä¸è¿›å…¥å†…æ ¸&lt;/li>
&lt;li>åˆ‡æ¢åç¨‹åªèƒ½æ˜¯æŸä¸ªåç¨‹&lt;strong>ä¸»åŠ¨æ”¾å¼ƒæ§åˆ¶æƒ&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>æˆ‘ä»¬åœ¨è¿™é‡Œè®¨è®ºä¸€ä¸‹åç¨‹åˆ‡æ¢æ—¶éœ€è¦ä¿å­˜çš„ä¸Šä¸‹æ–‡æ˜¯å¦ä¸çº¿ç¨‹æœ‰æ‰€ä¸åŒ.&lt;/p>
&lt;p>é¦–å…ˆ, PCä¸€å®šå±äº, è¿™ä¸ªæ¯‹åº¸ç½®ç–‘. å…¶æ¬¡æ˜¯æ ˆé¡¶æŒ‡é’ˆsp, &lt;strong>æ¯ä¸ªåç¨‹éƒ½æœ‰å•ç‹¬çš„æ ˆ&lt;/strong>, å¦‚æœä¸ä¿å­˜æ ˆçš„ä½ç½®, é‚£ä¹ˆåç¨‹å†…éƒ¨å®šä¹‰å±€éƒ¨å˜é‡å°±æ²¡æ³•è®¿é—®äº†(å±€éƒ¨å˜é‡çš„è®¿é—®æŒ‡ä»¤éƒ½æ˜¯ä»¥spä¸ºbaseçš„åç§»æ¥åšçš„).&lt;/p>
&lt;p>å¦å¤–, å…³äºé€šç”¨å¯„å­˜å™¨, ç”±äºåç¨‹çš„åˆ‡æ¢éœ€è¦ä¸»åŠ¨è°ƒç”¨æŸä¸ªå‡½æ•°(é€šå¸¸å«åš&lt;code>yield()&lt;/code>), åœ¨å‡½æ•°çš„æœ€åå°†PCè®¾ç½®ä¸ºæ–°åç¨‹çš„ä¸Šä¸‹æ–‡PC. ä¿å­˜å½“å‰åç¨‹ä¸Šä¸‹æ–‡çš„æ“ä½œä¹Ÿåœ¨è¿™ä¸ªå‡½æ•°ä¸­, è€Œå…¶å‚æ•°æˆ‘ä»¬å¹¶ä¸å…³å¿ƒ, å³&lt;code>x0&lt;/code>-&lt;code>x7&lt;/code>æ²¡å¿…è¦ä¿å­˜. åŒæ ·çš„, &lt;strong>caller-savedå¯„å­˜å™¨ä¹Ÿæ˜¯æ²¡å¿…è¦ä¿å­˜çš„&lt;/strong>, å› ä¸ºè¿™äº›å¯„å­˜å™¨ä½œä¸ºå‡½æ•°è°ƒç”¨ä½¿ç”¨çš„ä¸´æ—¶å˜é‡, å½“å†æ¬¡è¿”å›è¯¥åç¨‹æ—¶, PC=yield()è¿”å›åœ°å€, callerå¦‚æœå…³å¿ƒè¿™äº›å¯„å­˜å™¨åº”å½“è‡ªå·±æ‰§è¡Œä¿å­˜å’Œæ¢å¤. ä½†æ˜¯&lt;strong>callee-savedå¯„å­˜å™¨å¿…é¡»è¦ä¿å­˜åˆ°ä¸Šä¸‹æ–‡ä¸­&lt;/strong>, å› ä¸ºåœ¨yield()ä¸­, æˆ‘ä»¬å¦‚æœä¿®æ”¹äº†callee-savedå¯„å­˜å™¨, å°±éœ€è¦åœ¨è¿”å›æ—¶(ä¹Ÿå°±æ˜¯å†æ¬¡è°ƒåº¦åˆ°è¯¥åç¨‹æ—¶) æ¢å¤, è¿™æ˜¯calleeè¯¥åšçš„, ä¹Ÿå°±æ˜¯ä¸Šä¸‹æ–‡ä¸­åº”è¯¥æœ‰çš„å”¯ä¸€é€šç”¨å¯„å­˜å™¨ç»„.&lt;/p>
- https://wangloo.github.io/posts/os/context/ - @2019 Notepadium.</description></item><item><title>åŸºäºARM64å®ç°setjmp/longjmp</title><link>https://wangloo.github.io/posts/c/setjmp_and_longjmp/</link><pubDate>Tue, 01 Nov 2022 23:38:54 +0800</pubDate><guid>https://wangloo.github.io/posts/c/setjmp_and_longjmp/</guid><description>Soben's Secret Base https://wangloo.github.io/posts/c/setjmp_and_longjmp/ -&lt;h2 id="ä»‹ç»">ä»‹ç»&lt;/h2>
&lt;p>setjmp() and longjmp() æ˜¯ä¸€å¯¹ç»„åˆä½¿ç”¨çš„å‡½æ•°, å¯ä»¥å®ç°&lt;strong>å…¨å±€çš„goto&lt;/strong>.&lt;/p>
&lt;p>setjmp() æ„é€ ä¸€ä¸ªè¿è¡Œç¯å¢ƒ, è°ƒç”¨longjmp() åˆ™å°†æ‰§è¡Œæµåˆ‡æ¢åˆ°è¯¥ç¯å¢ƒ.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">/* setjmp() ä¿å­˜å½“å‰çš„è¿è¡Œç¯å¢ƒ(ä¸Šä¸‹æ–‡)åˆ° env å‚æ•°ä¸­ */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">int&lt;/span> &lt;span style="color:#50fa7b">setjmp&lt;/span>(jmp_buf env);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">/* longjmp() å°†æ§åˆ¶æµåˆ‡æ¢åˆ° env æŒ‡å®šçš„è¿è¡Œç¯å¢ƒ */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">void&lt;/span> &lt;span style="color:#50fa7b">longjmp&lt;/span>(jmp_buf env, &lt;span style="color:#8be9fd">int&lt;/span> val);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ä½¿ç”¨æ–¹æ³•">ä½¿ç”¨æ–¹æ³•&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#include&lt;/span> &lt;span style="color:#ff79c6">&amp;lt;setjmp.h&amp;gt;&lt;/span>&lt;span style="color:#ff79c6">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">#include&lt;/span> &lt;span style="color:#ff79c6">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span style="color:#ff79c6">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>jmp_buf e;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">void&lt;/span> &lt;span style="color:#50fa7b">foo&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> longjmp(e, &lt;span style="color:#bd93f9">1&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">int&lt;/span> &lt;span style="color:#50fa7b">main&lt;/span>(&lt;span style="color:#8be9fd">void&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">int&lt;/span> ret;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#6272a4">/* After calling longjmp(), the execution flow back to setjmp(),
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4"> and setjmp() will return not 0. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ret &lt;span style="color:#ff79c6">=&lt;/span> setjmp(e);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">if&lt;/span> (ret &lt;span style="color:#ff79c6">==&lt;/span> &lt;span style="color:#bd93f9">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#f1fa8c">&amp;#34;Return from setjmp&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> foo();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#ff79c6">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> printf(&lt;span style="color:#f1fa8c">&amp;#34;Return from longjmp&lt;/span>&lt;span style="color:#f1fa8c">\n&lt;/span>&lt;span style="color:#f1fa8c">&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ff79c6">return&lt;/span> &lt;span style="color:#bd93f9">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åŸºäº-aarch64-çš„å®ç°">åŸºäº AArch64 çš„å®ç°&lt;/h2>
&lt;p>éœ€è¦ä¿å­˜çš„ä¸Šä¸‹æ–‡åŒ…æ‹¬&lt;/p>
&lt;ul>
&lt;li>&lt;strong>callee-saved é€šç”¨å¯„å­˜å™¨&lt;/strong>, å› ä¸ºå¯èƒ½ç¬¬ä¸€æ¬¡è°ƒç”¨ &lt;code>setjmp()&lt;/code> ä¹‹åçš„æ‰§è¡Œæµä¿®æ”¹äº†è¿™äº›å¯„å­˜å™¨, ä»ç¬¬äºŒæ¬¡å›åˆ° &lt;code>setjmp()&lt;/code> çš„è§’åº¦æ¥çœ‹, å°±æ˜¯æ‰§è¡Œsetjmp() ä¸­ç ´åçš„. caller-saved å¯„å­˜å™¨åˆ™ä¸å¿…, å› ä¸ºæœ¬æ¥å³ä¾¿çœ‹ä½œæ˜¯ &lt;code>setjmp()&lt;/code> ç ´åçš„, ä¹Ÿæ˜¯æ­£å¸¸çš„.&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-asm" data-lang="asm">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">.macro&lt;/span> func _name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">.global&lt;/span> \_name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">.type&lt;/span> \_name, %function
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>\&lt;span style="color:#8be9fd;font-style:italic">_name:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">.endm&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">.macro&lt;/span> endfunc _name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">.size&lt;/span> \_name, .-\_name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">.endm&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>/**
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">setjmp&lt;/span> (jmp_buf env)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> *
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">See&lt;/span> also:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">longjmp&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> *
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * @&lt;span style="color:#50fa7b">return&lt;/span> &lt;span style="color:#bd93f9">0&lt;/span> - if returns from direct call,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">nonzero&lt;/span> - if returns after longjmp.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> */
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">func&lt;/span> setjmp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">stp&lt;/span> x19, x20, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> stp x21, x22, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> stp x23, x24, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> stp x25, x26, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> stp x27, x28, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> stp x29, x18, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> mov x9, sp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">stp&lt;/span> lr, x9, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> mov x0, &lt;span style="color:#6272a4">#0
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ret
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">endfunc&lt;/span> setjmp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>/**
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">longjmp&lt;/span> (jmp_buf env, int val)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> *
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#8be9fd;font-style:italic">Note:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">if&lt;/span> val is not &lt;span style="color:#bd93f9">0&lt;/span>, then it would be returned from setjmp,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">otherwise&lt;/span> - &lt;span style="color:#bd93f9">1&lt;/span> would be returned.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> *
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">See&lt;/span> also:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * &lt;span style="color:#50fa7b">setjmp&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> */
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">func&lt;/span> longjmp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">ldp&lt;/span> x19, x20, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> ldp x21, x22, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> ldp x23, x24, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> ldp x25, x26, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> ldp x27, x28, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> ldp x29, x18, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> ldp lr, x9, [x0], &lt;span style="color:#6272a4">#16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span> mov sp, x9
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">mov&lt;/span> x0, x1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">cbnz&lt;/span> x0, &lt;span style="color:#bd93f9">1&lt;/span>f
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">add&lt;/span> x0, x0, &lt;span style="color:#6272a4">#1
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">&lt;/span>&lt;span style="color:#bd93f9">1&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#50fa7b">ret&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#50fa7b">endfunc&lt;/span> longjmp
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="setjmp-å®ç°-try-catch">setjmp() å®ç° try-catch&lt;/h2>
- https://wangloo.github.io/posts/c/setjmp_and_longjmp/ - @2019 Notepadium.</description></item><item><title>Armv8 Kernel Monitor</title><link>https://wangloo.github.io/posts/os/monitor/</link><pubDate>Fri, 28 Oct 2022 22:56:19 +0800</pubDate><guid>https://wangloo.github.io/posts/os/monitor/</guid><description>Soben's Secret Base https://wangloo.github.io/posts/os/monitor/ -&lt;p>Â &lt;/p>
&lt;h2 id="kernel-monitor-æ˜¯ä»€ä¹ˆ">Kernel Monitor æ˜¯ä»€ä¹ˆ&lt;/h2>
&lt;p>Kernel Monitor æ˜¯ä¸€ä¸ªé€‚é…æˆ‘ä»¬å¾®å†…æ ¸æ“ä½œç³»ç»Ÿçš„ Kernel è°ƒè¯•å’Œç›‘æ§ç³»ç»Ÿ. å®ƒèƒ½å®ç°å†…æ ¸çš„åŠ¨æ€è°ƒè¯•å’Œç›‘æ§. åŒæ—¶, å®ƒè¿˜æ¥ç®¡å†…æ ¸çš„åŒæ­¥å¼‚å¸¸å’Œç³»ç»Ÿé”™è¯¯, ä½¿å¼€å‘è€…èƒ½å¤Ÿäº†è§£å‘ç”Ÿå¼‚å¸¸æ—¶ç³»ç»Ÿçš„çŠ¶æ€.&lt;/p>
&lt;p>Kernel Monitor å…·æœ‰ä¸€å®šçš„å¯æ‰©å±•æ€§, ä¾‹å¦‚é€šè¿‡ç»Ÿè®¡å†…æ ¸ä¸­å­˜å‚¨çš„ TCB æ¥å®æ—¶ç›‘æ§ç³»ç»Ÿä¸­æ‰€æœ‰çº¿ç¨‹çš„çŠ¶æ€. å¯æ ¹æ®å¼€å‘è€…çš„éœ€æ±‚æ·»åŠ ç»Ÿè®¡çš„å¯¹è±¡, å¦‚ Endpoint, Capabilityç­‰.&lt;/p>
&lt;p>Â &lt;/p>
&lt;h2 id="kernel-monitor-æ€»ä½“è®¾è®¡">Kernel Monitor æ€»ä½“è®¾è®¡&lt;/h2>
&lt;p>Kernel Monitor ç³»ç»ŸåŒ…å« Clinet å’Œ Server ä¸¤ä¸ªéƒ¨åˆ†. ç®€å•æ¥è¯´, Client è´Ÿè´£å¤„ç†ç”¨æˆ·è¾“å…¥, å¹¶å°†è¾“å…¥è¿›è¡Œè§£æ, å°è£…ä¸º ä¸€ç³»åˆ—åŸºç¡€å‘½ä»¤. å‘é€ç»™ Server. Server è´Ÿè´£æ‰§è¡Œè¿™äº› åŸºç¡€çš„å‘½ä»¤, å¦‚è®¾ç½®æ–­ç‚¹, æŸ¥çœ‹æŸä¸ªåœ°å€çš„å€¼ç­‰.&lt;/p>
&lt;p>æ•´ä¸ªç³»ç»Ÿæœ‰&lt;em>ä¸¤ç§æ¶æ„&lt;/em>: æœ¬åœ° Monitor å’Œè¿œç¨‹ Monitor.&lt;/p>
&lt;p>æœ¬åœ°monitor å’Œè¿œç¨‹ monitor çš„åŒºåˆ«æ˜¯: &lt;strong>Monitor Client çš„ä½ç½®åœ¨å“ª, æ˜¯å¦ä¸ Server åœ¨åŒä¸€ä¸ªæœºå™¨ä¸Š&lt;/strong>.&lt;/p>
&lt;blockquote>
&lt;p>å…ˆè¯´ Monitor Server, å®ƒå¿…é¡»åµŒå…¥è¦è°ƒè¯•çš„ Kernel ä¸­, &lt;strong>ä½äºä¸€ä¸ªåœ°å€ç©ºé—´&lt;/strong>, æ–¹ä¾¿æ“ä½œ Kernel çš„å†…å­˜.&lt;/p>
&lt;/blockquote>
&lt;h3 id="æœ¬åœ°-monitor">æœ¬åœ° Monitor&lt;/h3>
&lt;p>åœ¨æœ¬åœ° Monitor ä¸­, client å’Œ sever éƒ½ä½äºç›®æ ‡æœº(Target)ä¸Š, ç›®æ ‡æœºé€šå¸¸æ˜¯å¼€å‘æ¿.&lt;/p>
&lt;p>å¯¹äº AArch64 ä½“ç³»ç»“æ„æ¥è¯´, æœ€å¤šæœ‰å››ä¸ªå¼‚å¸¸ç­‰çº§(EL0-EL3). &lt;!-- raw HTML omitted -->Client å¯ä»¥è¿è¡Œåœ¨EL2.&lt;!-- raw HTML omitted -->&lt;/p>
&lt;p>&lt;img src="./%E6%9C%AC%E5%9C%B0monitor.png" alt="image-20221029141414942">&lt;/p>
&lt;h3 id="è¿œç¨‹-monitor">è¿œç¨‹ Monitor&lt;/h3>
&lt;p>è¿œç¨‹ Monitor æ¶æ„åˆ™ä¸åŒ, &lt;!-- raw HTML omitted -->Clinet è¿è¡Œåœ¨å®¿ä¸»æœº(Host)ä¸Š&lt;!-- raw HTML omitted -->, é€šå¸¸æ˜¯Linux. å®ƒä¸ Server çš„é€šä¿¡æ˜¯é€šè¿‡ç½‘ç»œ/UARTå®ç°çš„.&lt;/p>
&lt;p>&lt;img src="./%E8%BF%9C%E7%A8%8Bmonitor.png" alt="image-20221029142002468">&lt;/p>
&lt;blockquote>
&lt;p>Monitor Client è¿è¡Œåœ¨æœ¬åœ°å’Œè¿œç¨‹å¯¹äºå®ç°çš„éš¾åº¦å’Œç”¨æˆ·ä½“éªŒæœ‰å½±å“.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å¦‚æœ Client å®ç°åœ¨æœ¬åœ°, åˆ™ Client æ— éœ€å®ç°ç½‘å£å’Œä¸²å£çš„é©±åŠ¨, ä½†Monitor è¾“å…¥è¾“å‡ºçš„ä¸²å£ä¸æ“ä½œç³»ç»Ÿæœ¬èº«çš„ä¸²å£ç›¸åŒ, ä¿¡æ¯å†—æ‚åœ¨ä¸€èµ·ä¸æ˜“æŸ¥çœ‹; åŒæ—¶, å¦‚æœ Client å®ç°åœ¨æœ¬åœ°, é‚£ä¹ˆå¯¹äºELFçš„è§£æéœ€è¦åœ¨æ— æ“ä½œç³»ç»Ÿæä¾›çš„åº“æ”¯æŒä¸‹å®Œæˆ, å¯èƒ½æ¯”è¾ƒå¤æ‚.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦‚æœ Client å®ç°åœ¨è¿œç¨‹, å³ä¸º Linux ä¸Šçš„ä¸€ä¸ªAPP. é‚£ä¹ˆå®ƒå’Œ Server çš„é€šä¿¡å°±éœ€è¦é€šè¿‡å¤–éƒ¨çš„ç½‘å£æˆ–è€…ä¸²å£(å¯¹äºæˆ‘ä»¬ä½¿ç”¨çš„64ä½å¼€å‘æ¿åªå¼•å‡ºäº†ä¸€ä¸ªä¸²å£, æ‰€ä»¥åªèƒ½ä½¿ç”¨ç½‘å£). éœ€è¦åœ¨ Server ä¸Šå®ç°ç½‘å£çš„é©±åŠ¨, è¿™éƒ¨åˆ†æ¯”è¾ƒå¤æ‚. ä½†æ˜¯å¥½å¤„æ˜¯ Client çš„å®ç°ç®€å•å¾ˆå¤š, å› ä¸ºæœ‰ Linux APP è¿è¡Œç¯å¢ƒçš„æ”¯æŒ. åŒæ—¶, è¿œç¨‹ Monitor æ¶æ„ä¸‹, Monitor å’Œ æ“ä½œç³»ç»Ÿè‡ªèº«çš„è¾“å…¥è¾“å‡ºåˆ†å¼€, ç”¨æˆ·å¯è¯»æ€§æ›´å¥½.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Server æ˜¯åµŒå…¥åˆ°Kernelçš„ä»£ç ä¸­, ä¸Clientè¿›è¡Œäº¤äº’. å®ƒæ˜¯æ•´ä¸ª Monitor ç³»ç»Ÿçš„åç«¯, è´Ÿè´£å®ç°åŸºç¡€çš„è°ƒè¯•æ“ä½œ. ä¾‹å¦‚, è®¾ç½®æ–­ç‚¹, å†…å­˜çš„è¯»å†™, å¯„å­˜å™¨çš„è¯»å†™ç­‰.&lt;/p>
&lt;ul>
&lt;li>ç”±äºServerä¸ Kernel ä½äºåŒä¸€ä¸ªåœ°å€ç©ºé—´, æ‰€ä»¥æŸ¥çœ‹/ä¿®æ”¹å†…å­˜çš„å€¼æ˜¯éå¸¸æ–¹ä¾¿çš„. å¯¹äºå¯„å­˜å™¨ä¹Ÿæ˜¯åŒç†.&lt;/li>
&lt;li>æ–­ç‚¹(Breakpoint), ç›‘è§†ç‚¹(Watchpoint), å•æ­¥æ‰§è¡Œ(Soft step)çš„å®ç°ä¾èµ–ä¸ ARMv8 æä¾›çš„çš„ &lt;a href="https://developer.arm.com/-/media/Arm%20Developer%20Community/PDF/Learn%20the%20Architecture/V8A%20Self-hosted%20debug.pdf?revision=5eff4cc6-b4ca-4017-a07d-2957307058cb">self-hosted debug&lt;/a> æ”¯æŒ.&lt;/li>
&lt;/ul>
&lt;p>åŒæ—¶, Server è¿˜è´Ÿè´£ç›‘è§†ç³»ç»Ÿä¸­æ‰€æœ‰çš„ åŒæ­¥å¼‚å¸¸å’Œç³»ç»Ÿé”™è¯¯. ä¸€æ—¦å‘ç”Ÿ, å¯åœ¨ Monitor ä¸­æŸ¥çœ‹æŸäº›å†…å­˜, å¯„å­˜å™¨çš„å€¼å®šä½é—®é¢˜å‘ç”Ÿçš„åŸå› .&lt;/p>
&lt;h3 id="monitor-client-è®¾è®¡">Monitor Client è®¾è®¡&lt;/h3>
&lt;p>Client çš„æ„æˆå¯åˆ†ä¸ºä¸‰ä¸ªæ¨¡å— :&lt;/p>
&lt;ul>
&lt;li>ç”¨æˆ·äº¤äº’æ¨¡å—&lt;/li>
&lt;li>ç¬¦å·å¤„ç†æ¨¡å—&lt;/li>
&lt;li>æ¶ˆæ¯æ”¶å‘æ¨¡å—&lt;/li>
&lt;/ul>
&lt;p>ç”¨æˆ·äº¤äº’æ¨¡å—è´Ÿè´£å¤„ç†ç”¨æˆ·çš„è¾“å…¥è¾“å‡º, è°ƒç”¨å…¶ä»–ä¸¤ä¸ªæ¨¡å—å®Œæˆè°ƒè¯•å‘½ä»¤.&lt;/p>
&lt;p>ç¬¦å·å¤„ç†æ¨¡å—è´Ÿè´£è§£æå¯æ‰§è¡Œæ–‡ä»¶(ELF), å¹¶å»ºç«‹é™æ€ç¬¦å·è¡¨, å­˜å‚¨ç¬¦å·å’Œåœ°å€çš„å¯¹åº”å…³ç³». å°†ç”¨æˆ·è¾“å…¥çš„ç¬¦å·è§£æä¸ºè™šæ‹Ÿåœ°å€, æˆ–è€…åå‘è§£æ.&lt;/p>
&lt;p>æ¶ˆæ¯æ”¶å‘æ¨¡å—è´Ÿè´£å¤„ç†ç”¨æˆ·çš„è¾“å…¥, å°†å…¶è½¬åŒ–ä¸ºåŸºç¡€, æ ‡å‡†çš„å‘½ä»¤, å‘é€ç»™Serveræ‰§è¡Œ. Client å’Œ Serverä¹‹é—´é€šä¿¡çš„æ•°æ®åŒ…åè®®å¯ä»¥ä½¿ç”¨ &lt;a href="https://sourceware.org/gdb/onlinedocs/gdb/Remote-Protocol.html">GDB Remote Serial Protocol&lt;/a> (ä»¥ä¸‹ç®€ç§°RSPåè®®), æˆ–è€…è‡ªå·±è§„å®šä¸€ä¸ªåè®®ä¹Ÿæ˜¯å¯è¡Œçš„.&lt;/p>
&lt;blockquote>
&lt;p>RSPåè®®æ”¯æŒä¸‰ç§åŸºç¡€å‘½ä»¤:&lt;/p>
&lt;ol>
&lt;li>å¯„å­˜å™¨ç›¸å…³&lt;/li>
&lt;li>å†…å­˜ç›¸å…³&lt;/li>
&lt;li>ç¨‹åºæ§åˆ¶å‘½ä»¤&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;h3 id="å¯ç”¨-monitor-æ—¶-kernel-å¯åŠ¨æµç¨‹">å¯ç”¨ Monitor æ—¶ Kernel å¯åŠ¨æµç¨‹&lt;/h3>
&lt;ol>
&lt;li>Kernel é¦–å…ˆåšå¿…è¦çš„åˆå§‹åŒ–, GIC, å¼‚å¸¸å‘é‡è¡¨, MMUç­‰.&lt;/li>
&lt;li>å°†æ§åˆ¶æƒäº¤ç»™ Monitor, ç­‰å¾…ç”¨æˆ·è¾“å…¥.&lt;/li>
&lt;/ol>
&lt;p>Â &lt;/p>
&lt;h2 id="kernel-debug-è¿‡ç¨‹ç¤ºä¾‹">Kernel debug è¿‡ç¨‹ç¤ºä¾‹&lt;/h2>
&lt;h3 id="ç¤ºä¾‹ä¸€-æŸ¥çœ‹å˜é‡-var-çš„å€¼">ç¤ºä¾‹ä¸€: æŸ¥çœ‹å˜é‡ &lt;code>var&lt;/code> çš„å€¼&lt;/h3>
&lt;ol>
&lt;li>ç”¨æˆ·è¾“å…¥ &lt;code>print var&lt;/code> æŒ‡ä»¤.&lt;/li>
&lt;li>ç”±ç¬¦å·å¤„ç†æ¨¡å—, å°†&lt;code>var&lt;/code>ç¬¦å·è½¬ä¸ºvar è™šæ‹Ÿåœ°å€.&lt;/li>
&lt;li>ç”±æ¶ˆæ¯æ”¶å‘æŒ‡ä»¤å°†è¯·æ±‚å°è£…ä¸ºRSPåè®®åŒ…æ ¼å¼, å¹¶å‘é€åˆ° Monitor Server.&lt;/li>
&lt;li>æ‰§è¡Œæµç¨‹äº¤ç»™ Monitor Server, å®ƒè®¿é—®è¯¥åœ°å€, å°†å†…å®¹å°è£…å‘å› Monitor Client.&lt;/li>
&lt;li>Client è¾“å‡º&lt;code>var&lt;/code>çš„å€¼, ç»§ç»­ç­‰å¾…ç”¨æˆ·è¾“å…¥&lt;/li>
&lt;/ol>
&lt;h3 id="ç¤ºä¾‹äºŒ-æ·»åŠ æ–­ç‚¹åˆ°-main-å‡½æ•°">ç¤ºä¾‹äºŒ: æ·»åŠ æ–­ç‚¹åˆ° &lt;code>main&lt;/code> å‡½æ•°&lt;/h3>
&lt;ol>
&lt;li>ç”¨æˆ·è¾“å…¥ &lt;code>break main&lt;/code> æŒ‡ä»¤&lt;/li>
&lt;li>ç”±ç¬¦å·å¤„ç†æ¨¡å—, è§£æå¾—åˆ° &lt;code>main&lt;/code> å‡½æ•°çš„åœ°å€.&lt;/li>
&lt;li>æ¶ˆæ¯æ”¶å‘æ¨¡å—å°†è¯·æ±‚å°è£…ä¸ºRSPåŒ…æ ¼å¼, å‘é€åˆ°Monitor Server.&lt;/li>
&lt;li>æ‰§è¡Œæµç¨‹äº¤ç»™ Server. å®ƒæ‰§è¡Œ &lt;em>breakpoint exception æŒ‡ä»¤&lt;/em>, å¹¶è®¾ç½®ç›¸å…³è½¯ä»¶æ–­ç‚¹ç›¸å…³å¯„å­˜å™¨&lt;/li>
&lt;li>æ‰§è¡Œæµäº¤ç»™ Kernel, ç›´åˆ°è¾¾åˆ°æ–­ç‚¹å¤„(å¯ä½¿ç”¨åœ°å€+ContextIDåŒé‡éªŒè¯), è§¦å‘Debugå¼‚å¸¸&lt;/li>
&lt;li>Debugå¼‚å¸¸å±äºåŒæ­¥å¼‚å¸¸, ç”± Monitor ç³»ç»Ÿæ¥ç®¡, å›åˆ° Client ç»§ç»­ç­‰å¾…ç”¨æˆ·è¾“å…¥&lt;/li>
&lt;/ol>
&lt;h3 id="ç¤ºä¾‹ä¸‰-å•æ­¥æ‰§è¡Œ">ç¤ºä¾‹ä¸‰: å•æ­¥æ‰§è¡Œ&lt;/h3>
&lt;ol>
&lt;li>ç”¨æˆ·è¾“å…¥ &lt;code>step&lt;/code> æŒ‡ä»¤&lt;/li>
&lt;li>æ¶ˆæ¯æ”¶å‘æ¨¡å—å°†è¯·æ±‚å°è£…ä¸ºRSPåŒ…æ ¼å¼, å‘é€åˆ° Monitor Server.&lt;/li>
&lt;li>æ‰§è¡Œæµç¨‹äº¤ç»™ Server, å¯ç”¨ software step. ç„¶æ‰§è¡Œä¸€æ¬¡å¼‚å¸¸è¿”å›, å›åˆ°Kernel ç»§ç»­æ‰§è¡Œ.&lt;/li>
&lt;li>å› ä¸ºå¯ç”¨äº† Software step, å›åˆ° Kernel æ‰§è¡Œå®Œä¸€æ¡æŒ‡ä»¤å, å°±ä¼šè§¦å‘ Debugå¼‚å¸¸&lt;/li>
&lt;li>Debug å¼‚å¸¸å±äºåŒæ­¥å¼‚å¸¸, ç”± Monitor ç³»ç»Ÿæ¥ç®¡, å›åˆ° Client ç»§ç»­ç­‰å¾…ç”¨æˆ·è¾“å…¥&lt;/li>
&lt;/ol>
&lt;p>Â &lt;/p>
&lt;h2 id="å…¶ä»–æ‹“å±•åŠŸèƒ½">å…¶ä»–æ‹“å±•åŠŸèƒ½&lt;/h2>
&lt;p>back trace&lt;/p>
&lt;p>æ€§èƒ½åˆ†æ&lt;/p>
- https://wangloo.github.io/posts/os/monitor/ - @2019 Notepadium.</description></item><item><title>ARMv8-A MMUä»‹ç»</title><link>https://wangloo.github.io/posts/armv8/mmu/</link><pubDate>Thu, 29 Sep 2022 08:01:33 +0800</pubDate><guid>https://wangloo.github.io/posts/armv8/mmu/</guid><description>Soben's Secret Base https://wangloo.github.io/posts/armv8/mmu/ -&lt;h2 id="introduction">Introduction&lt;/h2>
&lt;p>MMU: ä¸“ç”¨äºå°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€. é€šå¸¸é…åˆåˆ†é¡µæœºåˆ¶æ¥å·¥ä½œ.&lt;/p>
&lt;p>é¡µè¡¨: é¡µè¡¨ä¸­çš„è¡¨é¡¹åŒ…å«æä¾›è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„.&lt;/p>
&lt;p>MMUå°±æ˜¯ç›´æ¥è®¿é—®é¡µè¡¨, å¹¶ä¸”é€šè¿‡å°†é¢‘ç¹ä½¿ç”¨çš„æ˜ å°„ç¼“å­˜åˆ°TLBä¸­.&lt;/p>
&lt;h3 id="mmu-çš„ç»“æ„">MMU çš„ç»“æ„&lt;/h3>
&lt;p>MMUæ˜¯ä¸€ç§ç¡¬ä»¶, å¯ä»¥é€šè¿‡åœ¨é€‚å½“çš„å®‰å…¨çŠ¶æ€ä¸‹å¯¹å…¶è¿›è¡Œé…ç½®. æ¯ä¸ªCoreéƒ½æœ‰è‡ªå·±çš„MMU, æ¯ä¸ªMMUåŒ…æ‹¬:&lt;/p>
&lt;ol>
&lt;li>ä¸€ä¸ªTLB, ç¼“å­˜æœ€è¿‘è®¿é—®çš„æ˜ å°„.&lt;/li>
&lt;li>ä¸€ä¸ªTable Walk Unit, ä»å†…å­˜ä¸­æŸ¥è¯¢é¡µè¡¨, å¾—åˆ°æœ€ç»ˆçš„è™šæ‹Ÿåœ°å€-ç‰©ç†åœ°å€çš„æ˜ å°„.&lt;/li>
&lt;/ol>
&lt;p>MMU æ§åˆ¶ç€æ•´ä¸ªç³»ç»Ÿçš„ç¼“å­˜ç­–ç•¥, å†…å­˜å±æ€§å’Œè®¿é—®æƒé™. MMUå¼€å¯å, è½¯ä»¶å‘å‡ºçš„æ‰€æœ‰å†…å­˜è®¿é—®éƒ½ä½¿ç”¨è™šæ‹Ÿåœ°å€, è¦æ±‚MMUä¸ºæ¯æ¬¡è®¿é—®è¿›è¡Œåœ°å€è½¬æ¢.&lt;/p>
&lt;h3 id="mmu-çš„é…ç½®">MMU çš„é…ç½®&lt;/h3>
&lt;p>åœ¨å¯ç”¨MMUå‰, å¿…é¡»å‘ŠçŸ¥å…¶é¡µè¡¨å­˜æ”¾çš„ä½ç½®.&lt;/p>
&lt;h3 id="mmu-åœ°å€è½¬æ¢çš„è¿‡ç¨‹">MMU åœ°å€è½¬æ¢çš„è¿‡ç¨‹&lt;/h3>
&lt;p>å¯¹äºæ¯ä¸ªè½¬æ¢è¯·æ±‚, MMUé¦–å…ˆæ£€æŸ¥TLBæ˜¯å¦å·²ç»å¯¹è¯¥åœ°å€ç¼“å­˜, å¦‚æœè¯¥åœ°å€æœªç¼“å­˜, åˆ™éœ€è¦éå†é¡µè¡¨.&lt;/p>
&lt;p>é¡µè¡¨éå†å•å…ƒåœ¨é¡µè¡¨ä¸­æœç´¢ç›¸å…³çš„æ˜ å°„è¡¨é¡¹.&lt;/p>
&lt;ul>
&lt;li>ä¸€æ—¦æ‰¾åˆ°æ˜ å°„, MMUå°±ä¼šæ£€æŸ¥æƒé™å’Œå±æ€§. å†³å®šå…è®¸æœ¬æ¬¡è®¿é—®, æˆ–è€…å‘å‡ºæ•…éšœä¿¡å·.&lt;/li>
&lt;li>è‹¥æœªæ‰¾åˆ°æ˜ å°„, åˆ™è§¦å‘ç¼ºé¡µå¼‚å¸¸.&lt;/li>
&lt;/ul>
&lt;h3 id="é¡µè¡¨çš„å·¥ä½œåŸç†">é¡µè¡¨çš„å·¥ä½œåŸç†&lt;/h3>
&lt;p>é¡µè¡¨çš„å·¥ä½œæ–¹å¼æ˜¯å°†è™šæ‹Ÿåœ°å€ç©ºé—´å’Œç‰©ç†åœ°å€ç©ºé—´åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„å—, ç§°ä¸ºé¡µé¢.&lt;/p>
&lt;p>é¡µè¡¨ä¸­çš„æ¯ä¸ªè¡¨é¡¹å¯¹åº”ç€ä¸€å—è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„å—, è¡¨é¡¹çš„å€¼å°±æ˜¯è¿™å—è™šæ‹Ÿåœ°å€ç©ºé—´å¯¹åº”çš„ç‰©ç†åœ°å€å—, ä»¥åŠè®¿é—®ç‰©ç†åœ°å€æ—¶è¦ä½¿ç”¨çš„å±æ€§.&lt;/p>
&lt;p>åœ¨æŸ¥è¡¨è¿‡ç¨‹ä¸­, å°†è™šæ‹Ÿåœ°å€åˆ†ä¸ºä¸¤éƒ¨åˆ†:&lt;/p>
&lt;ul>
&lt;li>é«˜é˜¶ä½ç”¨ä½œé¡µè¡¨çš„ç´¢å¼•. ç”¨æ¥æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†å—&lt;/li>
&lt;li>ä½åœ°å€æ˜¯å—å†…çš„åç§»é‡, ä¸ä¼šå› ä¸ºæ˜ å°„è€Œæ”¹å˜. é¡µè¡¨é¡¹ä¸­çš„ç‰©ç†åœ°å€ä¸è¯¥åç§»ç»„åˆå½¢æˆç”¨äºè®¿é—®å†…å­˜çš„ç‰©ç†åœ°å€.&lt;/li>
&lt;/ul>
&lt;h4 id="å¤šçº§é¡µè¡¨">å¤šçº§é¡µè¡¨&lt;/h4>
&lt;p>å®é™…å®ç°ä¸­, å¤šé‡‡ç”¨å¤šçº§é¡µè¡¨çš„æ–¹æ¡ˆ, å„çº§é¡µè¡¨è‡ªå®šå‘ä¸‹ç»„æˆæ ‘çš„å½¢å¼, åä½œå®ç°è™šæ‹Ÿåˆ°ç‰©ç†åœ°å€çš„è½¬æ¢.&lt;/p>
&lt;p>æ ‘ä¸­çš„åˆ†æ”¯æˆä¸ºé¡µç›®å½•, é¡µç›®å½•ä¸­çš„è¡¨é¡¹ä¸æ˜¯ç›´æ¥å­˜å‚¨ç›®æ ‡ç‰©ç†åœ°å€, è€Œæ˜¯ä¸‹ä¸€çº§é¡µè¡¨çš„åœ°å€; æœ€åä¸€çº§é¡µè¡¨çš„è¡¨é¡¹ä¸­ä¿å­˜ç€ç›®æ ‡ç‰©ç†åœ°å€.&lt;/p>
&lt;blockquote>
&lt;p>å¤šçº§é¡µè¡¨æ˜¯å‡å°é¡µè¡¨å ç”¨å­˜å‚¨ç©ºé—´è¿‡å¤§çš„æœ‰æ•ˆæ–¹æ¡ˆ.&lt;/p>
&lt;/blockquote>
&lt;p>é¡¶çº§é¡µè¡¨å°†åœ°å€ç©ºé—´åˆ’åˆ†ä¸ºå¤§å—, æ¯ä¸ªè¡¨é¡¹å¯ä»¥æŒ‡å‘å¤§å°ç›¸ç­‰çš„å†…å­˜å—. ä¹Ÿå¯ä»¥æŒ‡å‘å°†å—è¿›è¡Œå†æ¬¡ç»†åˆ†çš„ä¸‹ä¸€çº§é¡µè¡¨. æ”¯æŒå¤§å—çš„ä¼˜ç‚¹:&lt;/p>
&lt;ul>
&lt;li>å¤§çš„å†…å­˜å—éœ€è¦æŸ¥è¡¨çš„æ¬¡æ•°æ›´å°‘&lt;/li>
&lt;li>æå‡TLBçš„æ•ˆç‡, å› ä¸ºä¸€ä¸ªTLBè¡¨é¡¹è¦†ç›–æ›´å¤§çš„å†…å­˜åŒºåŸŸ.&lt;/li>
&lt;/ul>
&lt;p>å‡¡äº‹éƒ½æ˜¯æœ‰åˆ©æœ‰å¼Š, ä½¿ç”¨å¤§å—ä¹Ÿå¢åŠ äº†å†…å­˜æµªè´¹, å®é™…ä½¿ç”¨æ—¶éœ€è¦æ ¹æ®éœ€è¦æ¥æƒè¡¡.&lt;/p>
&lt;h2 id="å†…å­˜ç±»å‹">å†…å­˜ç±»å‹&lt;/h2>
&lt;h3 id="æ™®é€šç±»å‹å†…å­˜">æ™®é€šç±»å‹å†…å­˜&lt;/h3>
&lt;p>æ™®é€šç±»å‹çš„å†…å­˜æ˜¯å¼±ä¸€è‡´æ€§çš„(weakly ordered)å†…å­˜æ¨¡å‹, æ²¡æœ‰é¢å¤–çš„çº¦æŸ, å¯ä»¥æä¾›æœ€é«˜çš„å†…å­˜è®¿é—®æ€§èƒ½.&lt;/p>
&lt;p>é€šå¸¸ä»£ç æ®µ, æ•°æ®æ®µä»¥åŠå…¶ä»–æ•°æ®éƒ½æ”¾åœ¨æ™®é€šå†…å­˜ä¸­.&lt;/p>
&lt;p>æ™®é€šå†…å­˜å…è®¸å¤„ç†å™¨åšå¾ˆå¤šä¼˜åŒ–, å¦‚åˆ†æ”¯é¢„æµ‹, æ•°æ®é¢„å–, Cache lineé¢„å–, ä¹±åºæ‰§è¡Œç­‰.&lt;/p>
&lt;h3 id="è®¾å¤‡ç±»å‹å†…å­˜">è®¾å¤‡ç±»å‹å†…å­˜&lt;/h3>
&lt;p>CPUè®¿é—®è®¾å¤‡å†…å­˜ä¼šæœ‰å¾ˆå¤šé™åˆ¶, å¦‚ä¸èƒ½è¿›è¡Œæ•°æ®é¢„å–ç­‰. è®¾å¤‡ç±»å‹çš„å†…å­˜ä¸¥æ ¼æŒ‰ç…§æŒ‡ä»¤çš„é¡ºåºæ¥æ‰§è¡Œçš„.&lt;/p>
&lt;p>è®¾å¤‡ç±»å‹å†…å®¹é€šå¸¸ç•™ç»™è®¾å¤‡æ¥è®¿é—®, ä¾‹å¦‚ä¸­æ–­æ§åˆ¶å™¨(GIC), ä¸²å£, å®šæ—¶å™¨ç­‰.&lt;/p>
&lt;h2 id="ä¸¤å¥—é¡µè¡¨">ä¸¤å¥—é¡µè¡¨&lt;/h2>
&lt;ul>
&lt;li>å½“CPUè®¿é—®çš„åœ°å€å±äº&lt;em>ç”¨æˆ·ç©ºé—´&lt;/em>æ—¶, MMUä¼šè‡ªåŠ¨é€‰æ‹©&lt;strong>TTBR0&lt;/strong>æŒ‡å‘çš„é¡µè¡¨.&lt;/li>
&lt;li>å½“CPUè®¿é—®çš„åœ°å€å±äº&lt;em>å†…æ ¸ç©ºé—´&lt;/em>æ—¶. MMUä¼šè‡ªåŠ¨é€‰æ‹©&lt;strong>TTBR1&lt;/strong>æŒ‡å‘çš„é¡µè¡¨&lt;/li>
&lt;/ul>
&lt;p>EL2å’ŒEL3æ²¡æœ‰TTBR1, åªæœ‰TTBR0. ä¹Ÿå°±æ„å‘³ç€:&lt;/p>
&lt;p>â€¢ If EL2 is using AArch64, it can only use Virtual Addresses in the range 0x0 to 0x0000FFFF_FFFFFFFF.
â€¢ If EL3 is using AArch64, it can only use Virtual Addresses in the range 0x0 to 0x0000FFFF_FFFFFFFF.&lt;/p>
&lt;h2 id="è¶Šæƒ-è¶Šç•Œ">è¶Šæƒ, è¶Šç•Œ&lt;/h2>
&lt;p>åœ¨æœªä½¿ç”¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¹‹å‰, æ‰€æœ‰çš„ç”¨æˆ·ç¨‹åºéƒ½å¯ä»¥è®¿é—®å…¨éƒ¨çš„ç‰©ç†å†…å­˜, æ‰€ä»¥æ¶æ„ç¨‹åºå¯ä»¥ä¿®æ”¹å…¶ä»–ç¨‹åºçš„å†…å­˜æ•°æ®, è¿™ä½¿å¾—æ•´ä¸ªç³»ç»Ÿå¤„äºå±é™©çš„çŠ¶æ€. æ¯ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´éƒ½è¦å—åˆ°ä¿æŠ¤, ä»¥å…è¢«å…¶ä»–è¿›ç¨‹æœ‰æ„/æ— æ„çš„ç ´å.&lt;/p>
&lt;p>ç°ä»£æ“ä½œç³»ç»Ÿä¸­, æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´. åœ¨è¿›ç¨‹çš„è§’åº¦ä¸Š, å®ƒæ‹¥æœ‰æ•´ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´. ä¸åŒçš„è¿›ç¨‹å¯ä»¥åŒæ—¶ä½¿ç”¨ä¸€ä¸ªè™šæ‹Ÿåœ°å€, MMUé€šè¿‡é¡µè¡¨å°†å…¶æ˜ å°„åˆ°åˆé€‚çš„ç‰©ç†åœ°å€.&lt;/p>
&lt;h3 id="ä¸¤ä¸ªç‰©ç†åœ°å€ç©ºé—´">ä¸¤ä¸ªç‰©ç†åœ°å€ç©ºé—´&lt;/h3>
&lt;p>ARMv8 ä½“ç³»ç»“æ„å®šä¹‰ä¸¤ä¸ªç‰©ç†åœ°å€ç©ºé—´: secure address space å’Œ non-secure address space.&lt;/p>
&lt;p>ç†è®ºä¸Š, å®‰å…¨å’Œéå®‰å…¨çš„åœ°å€ç©ºé—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„, ç„¶è€Œç°å®ä¸­å¤§å¤šæ•°ç³»ç»Ÿéƒ½å°†å®‰å…¨å’Œéå®‰å…¨è§†ä¸ºè®¿é—®æ§åˆ¶çš„å±æ€§. æ­£å¸¸(éå®‰å…¨)ä¸–ç•Œåªèƒ½è®¿é—®éå®‰å…¨çš„ç‰©ç†å†…å­˜; è€Œå®‰å…¨ä¸–ç•Œå¯ä»¥è®¿é—®è¿™ä¸¤ä¸ªåœ°å€ç©ºé—´.&lt;/p>
&lt;h3 id="armv8-mmuæƒé™æ§åˆ¶">ARMv8 MMUæƒé™æ§åˆ¶&lt;/h3>
&lt;p>ç¨‹åºè¯·æ±‚æŸä¸ªåœ°å€æ—¶, MMUéœ€è¦è¿›è¡Œæƒé™æ£€æŸ¥. å¦‚æœè¯·æ±‚çš„åœ°å€æ˜¯æ•°æ®, åˆ™æ£€æŸ¥è¯»å†™æƒé™; å¦‚æœè¯·æ±‚çš„æ˜¯åœ°å€, åˆ™æ£€æŸ¥å…¶å¯æ‰§è¡Œæƒé™.&lt;/p>
&lt;p>ARMv8 é¡µè¡¨é¡¹çš„APå­—æ®µæ§åˆ¶è¯¥ä¸åŒå¼‚å¸¸ç­‰çº§ä¸‹, é¡µé¢çš„è¯»å†™æƒé™.&lt;/p>
&lt;p>[è¡¨æ ¼]&lt;/p>
&lt;p>ARMv8 é¡µè¡¨é¡¹çš„PNXå­—æ®µå’ŒXN/UXNå­—æ®µæ¥è®¾ç½®CPUæ˜¯å¦å¯¹è¿™ä¸ªé¡µé¢æœ‰æ‰§è¡Œæƒé™.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å½“ç³»ç»Ÿæœ‰ä¸¤å¥—é¡µè¡¨æ—¶, UXNæ˜¯ç”¨æ¥è®¾ç½®ç”¨æˆ·ç©ºé—´é¡µé¢æ˜¯å¦æœ‰å¯æ‰§è¡Œæƒé™; PXN ç”¨æ¥è®¾ç½®ç‰¹æƒç©ºé—´çš„é¡µé¢æ˜¯å¦æœ‰å¯æ‰§è¡Œæƒé™.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è‹¥ç³»ç»Ÿåªæœ‰ä¸€å¥—é¡µè¡¨, åˆ™é€šè¿‡XNå­—æ®µæ§åˆ¶&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="é¡µè¡¨çš„ç»“æ„">é¡µè¡¨çš„ç»“æ„&lt;/h2>
&lt;h3 id="åœ°å€å®½åº¦">åœ°å€å®½åº¦&lt;/h3>
&lt;p>48bit&lt;/p>
&lt;h3 id="é¡µé¢ç²’åº¦">é¡µé¢ç²’åº¦&lt;/h3>
&lt;p>é¡µé¢ç²’åº¦è¡¨ç¤ºä¸€æ¬¡æœ€å°åˆ†é…å†…å­˜å—çš„å¤§å°. AArch64æ”¯æŒä¸‰ç§é¡µçš„å¤§å°, 4KB, 16KB, 64KB. æ”¯æŒå“ªä¸€ç§æ˜¯ç”±å®ç°å®šä¹‰çš„ã€‚åˆ›å»ºé¡µè¡¨çš„ä»£ç èƒ½å¤Ÿè¯»å–ç³»ç»Ÿå¯„å­˜å™¨&lt;code>ID_AA64MMFR0_EL1&lt;/code>ï¼Œä»¥æ‰¾å‡ºå“ªäº›æ˜¯å—æ”¯æŒçš„å¤§å°ã€‚Cortex-A53å¤„ç†å™¨æ”¯æŒæ‰€æœ‰ä¸‰ç§å°ºå¯¸ï¼Œä½†æœ‰äº›å¤„ç†å™¨çš„æ—©æœŸç‰ˆæœ¬å¹¶éå¦‚æ­¤ï¼Œä¾‹å¦‚Cortex-A57ï¼Œå®ƒä¸æ”¯æŒ16Kç²’åº¦ã€‚&lt;/p>
&lt;h3 id="aarch64-é¡µè¡¨é¡¹ç»“æ„">AArch64 é¡µè¡¨é¡¹ç»“æ„&lt;/h3>
&lt;h4 id="æ— æ•ˆé¡µè¡¨é¡¹">æ— æ•ˆé¡µè¡¨é¡¹&lt;/h4>
&lt;h4 id="table">table&lt;/h4>
&lt;h4 id="block">block&lt;/h4>
&lt;h3 id="é¡µè¡¨ç»“æ„4kbé¡µé¢ä¸ºä¾‹">é¡µè¡¨ç»“æ„(4KBé¡µé¢ä¸ºä¾‹)&lt;/h3>
&lt;p>ä»¥4KBé¡µé¢ç²’åº¦, è™šæ‹Ÿåœ°å€å®½åº¦ä¸º 48ä½. ä½¿ç”¨4çº§é¡µè¡¨.&lt;/p>
&lt;p>48ä½åœ°å€æ¯å±‚è½¬æ¢æœ‰9ä¸ªåœ°å€ä½ï¼Œå³æ¯å±‚512ä¸ªæ¡ç›®ï¼Œæœ€å12ä½é€‰æ‹©4kBå†…çš„ä¸€ä¸ªå­—èŠ‚ï¼Œç›´æ¥æ¥è‡ªåŸå§‹åœ°å€&lt;/p>
&lt;h2 id="è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢è¿‡ç¨‹">è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢è¿‡ç¨‹&lt;/h2>
&lt;p>å½“å¤„ç†å™¨ä¸ºè·å–æŒ‡ä»¤æˆ–æ•°æ®è®¿é—®å‘å‡ºä¸€ä¸ª64ä½çš„è™šæ‹Ÿåœ°å€æ—¶ï¼ŒMMUç¡¬ä»¶å°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç›¸åº”çš„ç‰©ç†åœ°å€ã€‚å¯¹äºè™šæ‹Ÿåœ°å€ï¼Œå‰16ä½[63:47]å¿…é¡»å…¨éƒ¨ä¸º0æˆ–1ï¼Œå¦åˆ™åœ°å€å°†è§¦å‘æ•…éšœã€‚&lt;/p>
&lt;h3 id="non-secure-and-secure-access">Non-secure and secure access&lt;/h3>
&lt;p>ARMv8-Aæ¶æ„å®šä¹‰äº†ä¸¤ç§å®‰å…¨çŠ¶æ€:å®‰å…¨çš„å’Œéå®‰å…¨çš„ã€‚å®ƒè¿˜å®šä¹‰äº†ä¸¤ä¸ªç‰©ç†åœ°å€ç©ºé—´:å®‰å…¨çš„å’Œéå®‰å…¨çš„. æ­£å¸¸(éå®‰å…¨)ä¸–ç•Œåªèƒ½è®¿é—®éå®‰å…¨ç‰©ç†åœ°å€ç©ºé—´ã€‚å®‰å…¨ä¸–ç•Œå¯ä»¥è®¿é—®ä¸¤ä¸ªç‰©ç†åœ°å€ç©ºé—´ã€‚è¿™ä¹Ÿæ˜¯é€šè¿‡è½¬æ¢è¡¨æ¥æ§åˆ¶çš„ã€‚&lt;/p>
&lt;p>åœ¨éå®‰å…¨çŠ¶æ€ä¸‹ï¼Œè½¬æ¢è¡¨ä¸­çš„NSä½å’ŒNSTableä½å°†è¢«å¿½ç•¥ã€‚åªèƒ½è®¿é—®éå®‰å…¨å†…å­˜ã€‚åœ¨å®‰å…¨çŠ¶æ€ä¸‹ï¼ŒNSä½å’ŒNSTableä½æ§åˆ¶è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºå®‰å…¨ç‰©ç†åœ°å€è¿˜æ˜¯éå®‰å…¨ç‰©ç†åœ°å€ã€‚&lt;/p>
&lt;p>You can use SCR_EL3.SIF æ¥ç¦ç”¨å®‰å…¨ä¸–ç•Œè®¿é—®éå®‰å…¨åœ°å€.&lt;/p>
&lt;h2 id="ç›¸å…³çš„å¯„å­˜å™¨">ç›¸å…³çš„å¯„å­˜å™¨&lt;/h2>
&lt;p>ä¸åœ°å€è½¬æ¢ç›¸å…³çš„å¯„å­˜å™¨ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ª:&lt;/p>
&lt;ol>
&lt;li>è½¬æ¢æ§åˆ¶å¯„å­˜å™¨(TCR)&lt;/li>
&lt;li>ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨(SCTLR)&lt;/li>
&lt;li>é¡µè¡¨åŸºåœ°å€å¯„å­˜å™¨(TTBR)&lt;/li>
&lt;/ol>
&lt;h3 id="tcr">TCR&lt;/h3>
&lt;p>IPS: é…ç½®åœ°å€è½¬æ¢åè¾“å‡ºç‰©ç†åœ°å€çš„æœ€å¤§å€¼&lt;/p>
&lt;p>TxSz: é…ç½®è¾“å…¥åœ°å€çš„æœ€å¤§å€¼, å³è™šæ‹Ÿåœ°å€çš„å®½åº¦&lt;/p>
&lt;p>TG1: é…ç½®TTBR1é¡µè¡¨çš„é¡µé¢ç²’åº¦å¤§å°&lt;/p>
&lt;p>SHx: é…ç½®TTBRxç›¸å…³å†…å­˜çš„Cacheå…±äº«å±æ€§&lt;/p>
&lt;p>ORGNx:&lt;/p>
&lt;p>IRGNx:&lt;/p>
&lt;h3 id="sctlr">SCTLR&lt;/h3>
&lt;p>M: Disable/Enable MMUåœ°å€è½¬æ¢&lt;/p>
&lt;p>C: Disable/Enable Data Cache&lt;/p>
&lt;p>I: Disable/Enable Instruction Cache&lt;/p>
&lt;h3 id="ttbr">TTBR&lt;/h3>
&lt;p>å­˜å‚¨é¡µè¡¨çš„åŸºåœ°å€&lt;/p>
&lt;h2 id="aarch32-è™šæ‹Ÿå†…å­˜ç³»ç»Ÿ">AArch32 è™šæ‹Ÿå†…å­˜ç³»ç»Ÿ&lt;/h2>
&lt;p>ARMv8 AArch32 çš„è™šæ‹Ÿå†…å­˜ç³»ç»Ÿå‘åå…¼å®¹ARMv7, ä¸ARMv7çš„åŸºæœ¬ä¸€è‡´.&lt;/p>
- https://wangloo.github.io/posts/armv8/mmu/ - @2019 Notepadium.</description></item><item><title>AArch64/32 å¼‚å¸¸è¿”å›è¿‡ç¨‹</title><link>https://wangloo.github.io/posts/armv8/exception_return/</link><pubDate>Sat, 24 Sep 2022 21:19:01 +0800</pubDate><guid>https://wangloo.github.io/posts/armv8/exception_return/</guid><description>Soben's Secret Base https://wangloo.github.io/posts/armv8/exception_return/ -&lt;h2 id="armv8-å¼‚å¸¸è¿”å›æŒ‡ä»¤">ARMv8 å¼‚å¸¸è¿”å›æŒ‡ä»¤&lt;/h2>
&lt;p>å½“å¼‚å¸¸å¤„ç†ç¨‹åºç»“æŸåï¼Œéœ€è¦æ‰§è¡Œ&lt;em>å¼‚å¸¸è¿”å›æŒ‡ä»¤&lt;/em>æ¢å¤è¿›å…¥å¼‚å¸¸ä¹‹å‰çš„çŠ¶æ€.&lt;/p>
&lt;p>å…·ä½“è¦åšçš„äº‹æƒ…åŒ…æ‹¬:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>æ¢å¤å‘ç”Ÿå¼‚å¸¸å‰çš„PC&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä»SPSRä¸­æ¢å¤PSTATEå¯„å­˜å™¨(ç°åœº)&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>å¼‚å¸¸è¿”å›çš„æŒ‡ä»¤æ ¹æ®å½“å‰&lt;strong>æ‰§è¡ŒçŠ¶æ€&lt;/strong>ä¸ºAArch32è¿˜æ˜¯AArch64æœ‰æ‰€ä¸åŒ.&lt;/p>
&lt;h3 id="aarch32">AArch32&lt;/h3>
&lt;p>AArch32çš„å¼‚å¸¸è¿”å›æŒ‡ä»¤åœ¨ä¸åŒçš„&lt;strong>æ¨¡å¼&lt;/strong>ä¸‹ä¹Ÿæœ‰æ‰€ä¸åŒ:&lt;/p>
&lt;p>&lt;strong>è‹¥å¼‚å¸¸æ˜¯åœ¨Hypæ¨¡å¼ä¸‹å¤„ç†:&lt;/strong> ä»…å¯æ‰§è¡Œ&lt;code>ERET&lt;/code>æŒ‡ä»¤ä»å¼‚å¸¸è¿”å›.&lt;/p>
&lt;p>&lt;strong>è‹¥å¼‚å¸¸æ˜¯åœ¨å…¶ä»–æ¨¡å¼ä¸‹å¤„ç†&lt;/strong>, AArch32æä¾›äº†ä»¥ä¸‹çš„å¼‚å¸¸è¿”å›æŒ‡ä»¤:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>ERET&lt;/code> æŒ‡ä»¤&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä½¿ç”¨å¸¦Såç¼€çš„æ•°æ®å¤„ç†æŒ‡ä»¤ç›´æ¥æ“ä½œPC(ä¾‹å¦‚, &lt;code>MOVS, PC, LR&lt;/code>), æ¢å¤PSTATE&lt;/p>
&lt;/li>
&lt;li>
&lt;p>RFE æŒ‡ä»¤: &lt;code>RFE &amp;lt;Rn&amp;gt;&lt;/code>. ä»åŸºå€å¯„å­˜å™¨&lt;!-- raw HTML omitted -->æŒ‡å‘çš„åœ°å€ä¾æ¬¡åŠ è½½PCå’ŒPSTATE&lt;/p>
&lt;/li>
&lt;li>
&lt;p>LDM æŒ‡ä»¤: &lt;code>LDM &amp;lt;Rn&amp;gt; {pc..}&lt;/code>. è‹¥ç›®æ ‡å¯„å­˜å™¨ä¸­åŒ…å«PC, åˆ™ä¼šåŒæ—¶æ¢å¤PSTATE&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="aarch64">AArch64&lt;/h3>
&lt;p>AArch64ä¸‹&lt;strong>ç»Ÿä¸€ä½¿ç”¨&lt;/strong> &lt;code>ERET&lt;/code> æŒ‡ä»¤è¿›è¡Œå¼‚å¸¸è¿”å›.&lt;/p>
&lt;h3 id="æŒ‡ä»¤æ ¼å¼åŠç”¨æ³•å‚è€ƒ">æŒ‡ä»¤æ ¼å¼åŠç”¨æ³•å‚è€ƒ&lt;/h3>
&lt;h4 id="eret">ERET&lt;/h4>
&lt;p>ERETæŒ‡ä»¤å®Œæˆäº†:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>ä»ELR_ELxä¸­æ¢å¤PCæŒ‡é’ˆ&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä»SPSR_ELxä¸­æ¢å¤PSTATEå¯„å­˜å™¨çš„çŠ¶æ€.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h4 id="ldmload-multiple">LDM(Load Multiple)&lt;/h4>
&lt;p>æ ¼å¼: &lt;code>LDM &amp;lt;Rn&amp;gt; {registers}&lt;/code>&lt;/p>
&lt;p>å«ä¹‰: ä»åŸºå€å¯„å­˜å™¨&lt;code>&amp;lt;Rn&amp;gt;&lt;/code>æŒ‡å‘çš„åœ°å€å¼€å§‹ä¾æ¬¡åŠ è½½å¤šä¸ªå¯„å­˜å™¨å€¼. è‹¥ç›®æ ‡å¯„å­˜å™¨ä¸­åŒ…å«PC, åˆ™åŒæ—¶æ¢å¤PSTATE.&lt;/p>
&lt;p>ä¾‹å¦‚: &lt;code>LDM &amp;lt;r0&amp;gt; {pc, r1}&lt;/code> ç­‰ä»·äº:&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-assembly" data-lang="assembly">pc = [r0]
r1 = [r0+4]
PSTATE = SPSR ;ä»…å½“ç›®æ ‡å¯„å­˜å™¨åŒ…å«PCæ—¶è‡ªåŠ¨å®Œæˆ
&lt;/code>&lt;/pre>&lt;h4 id="rfereturn-from-exception">RFE(Return From Exception)&lt;/h4>
&lt;p>æ ¼å¼: &lt;code>LDM &amp;lt;Rn&amp;gt; &lt;/code>&lt;/p>
&lt;p>å«ä¹‰: ä»åŸºå€å¯„å­˜å™¨&lt;code>&amp;lt;Rn&amp;gt;&lt;/code>æŒ‡å‘çš„åœ°å€ä¾æ¬¡åŠ è½½PCå’ŒPSTATE.&lt;/p>
&lt;p>ä¾‹å¦‚: &lt;code>RFE &amp;lt;r0&amp;gt;&lt;/code> ç­‰ä»·äº:&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-ass" data-lang="ass">pc = [r0]
PSTATE = [r0+4]
&lt;/code>&lt;/pre>- https://wangloo.github.io/posts/armv8/exception_return/ - @2019 Notepadium.</description></item></channel></rss>