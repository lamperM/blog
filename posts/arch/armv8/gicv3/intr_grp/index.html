<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/syntax_pastie.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>ARMv8 中断管理(4): 中断分组</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#irq-%e5%92%8c-fiq-%e7%9a%84%e5%90%ab%e4%b9%89 aria-label="IRQ 和 FIQ 的含义">IRQ 和 FIQ 的含义</a></li><li><a href=#%e4%b8%ad%e6%96%ad%e5%88%86%e7%bb%84%e4%ba%a7%e7%94%9f%e7%9a%84%e5%8e%9f%e5%9b%a0 aria-label=中断分组产生的原因？>中断分组产生的原因？</a></li><li><a href=#%e6%80%8e%e4%b9%88%e5%b0%b1%e8%83%bd%e5%81%9a%e5%88%b0%e4%b8%8a%e8%bf%b0%e7%9a%84%e7%ba%a6%e5%ae%9a aria-label=怎么就能做到上述的约定？>怎么就能做到上述的约定？</a><ul><li><a href=#case-1ree-%e6%97%b6%e6%94%b6%e5%88%b0-nsg1 aria-label="Case 1：REE 时收到 NSG1">Case 1：REE 时收到 NSG1</a></li><li><a href=#case-2tee-%e6%94%b6%e5%88%b0-nsg1 aria-label="Case 2：TEE 收到 NSG1">Case 2：TEE 收到 NSG1</a></li><li><a href=#case-3bl31-%e6%94%b6%e5%88%b0-nsg1 aria-label="Case 3：BL31 收到 NSG1">Case 3：BL31 收到 NSG1</a></li><li><a href=#case-4tee-%e6%94%b6%e5%88%b0-sg1 aria-label="Case 4：TEE 收到 SG1">Case 4：TEE 收到 SG1</a></li><li><a href=#case-5ree-%e6%94%b6%e5%88%b0-sg1 aria-label="Case 5：REE 收到 SG1">Case 5：REE 收到 SG1</a></li><li><a href=#case-6atf-%e6%94%b6%e5%88%b0-sg1 aria-label="Case 6：ATF 收到 SG1">Case 6：ATF 收到 SG1</a></li><li><a href=#case-7tee-%e6%94%b6%e5%88%b0-g0 aria-label="Case 7：TEE 收到 G0">Case 7：TEE 收到 G0</a></li><li><a href=#case-8ree-%e6%94%b6%e5%88%b0-g0 aria-label="Case 8：REE 收到 G0">Case 8：REE 收到 G0</a></li><li><a href=#case-9bl31-%e6%94%b6%e5%88%b0-g0 aria-label="Case 9：BL31 收到 G0">Case 9：BL31 收到 G0</a></li></ul></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>ARMv8 中断管理(4): 中断分组</div></header><figure><img src=/interrupt_grp.jpg width=70%></figure><ul><li>NS Group 1： 想给 REE 处理的中断</li><li>S Group 1：想给 TEE 处理的中断</li><li>Group 0：想给 ATF 处理的中断</li></ul><h2 id=irq-和-fiq-的含义>IRQ 和 FIQ 的含义</h2><p>FIQ 并不是以前意义上的快速中断，而是 Forward 中断，需要被转发的中断。IRQ 和 FIQ 的优先级是相同的。</p><h2 id=中断分组产生的原因>中断分组产生的原因？</h2><h2 id=怎么就能做到上述的约定>怎么就能做到上述的约定？</h2><p>根据 3 种当前环境（REE、TEE、ATF）和 3 种中断分组，总共有 9 种可能得情况，依次进行分析。ATF 在这里也就等价于 BL31。</p><style type=text/css>.notice{--root-color:#444;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#c33;--warning-content:#fee;--info-title:#fb7;--info-content:#fec;--note-title:#6be;--note-content:#e7f2fa;--tip-title:#5a5;--tip-content:#efe}@media(prefers-color-scheme:dark){.notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}}body.dark .notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--root-color);background:var(--root-background)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background)}.notice.warning .notice-title{background:var(--warning-title)}.notice.warning{background:var(--warning-content)}.notice.info .notice-title{background:var(--info-title)}.notice.info{background:var(--info-content)}.notice.note .notice-title{background:var(--note-title)}.notice.note{background:var(--note-content)}.notice.tip .notice-title{background:var(--tip-title)}.notice.tip{background:var(--tip-content)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div class="notice info"><p class=notice-title><span class="icon-notice baseline"><svg xmlns="http://www.w3.org/2000/svg" viewBox="92 59.5 300 300"><path d="M292 303.25V272c0-3.516-2.734-6.25-6.25-6.25H267v-1e2c0-3.516-2.734-6.25-6.25-6.25h-62.5c-3.516.0-6.25 2.734-6.25 6.25V197c0 3.516 2.734 6.25 6.25 6.25H217v62.5h-18.75c-3.516.0-6.25 2.734-6.25 6.25v31.25c0 3.516 2.734 6.25 6.25 6.25h87.5c3.516.0 6.25-2.734 6.25-6.25zm-25-175V97c0-3.516-2.734-6.25-6.25-6.25h-37.5c-3.516.0-6.25 2.734-6.25 6.25v31.25c0 3.516 2.734 6.25 6.25 6.25h37.5c3.516.0 6.25-2.734 6.25-6.25zm125 81.25c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg></span><span></span></p><p>以下所有的 Case 描述都基于一个前提：</p><ol><li>BL31 非安全上下文中 SCR_EL3.IRQ=0,SCR_EL3.FIQ=1</li><li>安全上下文中 SCR_EL3.IRQ=0,SCR_EL3.FIQ=0。</li></ol><p>这是 BL31 初始化时的默认配置，2022 年前大部分厂家也是用的这种配置。但是现在随着功能的不断演进，已经有的厂家开始修改这种路由规则了。但是我感觉，只要你了解底层原理，也能快速地理解他们这样配置的理由。</p><p>TODO：EHF？</p></div><h3 id=case-1ree-时收到-nsg1>Case 1：REE 时收到 NSG1</h3><figure><img src=/gic_case1.jpg width=70%></figure><p>这是最简单的情况：</p><ul><li>因为 REE 处于 NS 状态，根据 GICv3 上述的真值表，NSG1 会触发 IRQ。</li><li>由于此时 SCR_EL3.IRQ=0，所以 IRQ 并不会 Trap 到 EL3，就是默认的情况在 Linux Kernel 处理。</li></ul><h3 id=case-2tee-收到-nsg1>Case 2：TEE 收到 NSG1</h3><figure><img src=/gic_case2.jpg width=70%></figure><p>这种情况就相对来说比较复杂，但是很经典：</p><ol><li>由于当前在 S 状态，NSG1 会触发为 FIQ</li><li>大部分的 TEE 对 FIQ 没有做任何操作，<strong>特别是没有 ack 这个中断</strong>，直接执行 smc 下去。</li><li>到了 BL31，切换安全状态，进入 REE。（猜测由于是 SMC 懈怠的参数识别了这种情况？）</li><li>由于中断没有 ack，所以还处于 pendding 状态，但切换到 NS 状态后，触发的就是 IRQ 了。</li><li>在 REE linux kernel 处理后，回到 BL31，准备返回 TEE。（猜测是由于设置了某种标志才知道 IRQ 处理完是要返回 BL31 的）</li><li>BL31 返回 TEE 继续执行。</li></ol><h3 id=case-3bl31-收到-nsg1>Case 3：BL31 收到 NSG1</h3><figure><img src=/gic_case3.jpg width=70%></figure><p>这种情况其实最终会转化成以上两种：
BL31 有两种 context，安全和非安全，NSG1 在 EL3 会触发为 FIQ，两种状态下默认 FIQ 都是被 MASK 的，所以根据你之前是从哪里陷入的就会再哪里去处理这个 NSG1 中断。</p><h3 id=case-4tee-收到-sg1>Case 4：TEE 收到 SG1</h3><p>也是比较简单的情况，当前是 S 状态，收到 SG1，触发 IRQ，直接在 TEE 里被处理，不涉及异常等级的切换。</p><h3 id=case-5ree-收到-sg1>Case 5：REE 收到 SG1</h3><figure><img src=/gic_case5.jpg width=70%></figure><ol><li>当前执行环境为 NS，SG1 被触发为 FIQ。因为 SCR_EL3.FIQ=1，所以中断直接到 BL31 FIQ handler。</li><li>BL31 实际不做处理，只是将 ELR 设置成 TEE 的处理函数，进行异常返回。（为什么没有在 TEE 重新被触发，而是在 EL3 被触发，因为 BL31 切换到 TEE 时就 MASK 所有的中断，所以用的配置 ELR 的方式进入异常处理函数）</li><li>TEE 处理完成后，返回 BL31</li><li>BL31 返回 REE</li></ol><h3 id=case-6atf-收到-sg1>Case 6：ATF 收到 SG1</h3><p>和 ATF 收到 NSG1 情况类似，最后都是转成上面的两种 case，因为 BL31 中无论是 NSG1 还是 SG1 触发的都是 FIQ，而 FIQ 被 MASK，所以最后怎么处理还是看 BL31 返回时到 REE 还是 TEE。</p><h3 id=case-7tee-收到-g0>Case 7：TEE 收到 G0</h3><figure><img src=/gic_case7.jpg width=70%></figure><ol><li>TEE 属于 S 状态，G0 被触发为 FIQ。因为 SCR.FIQ=0，所以 FIQ 在 TEE 触发。</li><li>TEE 不会对 FIQ 做任何处理，也不会 ack 中断，直接 smc 进入 BL31。</li><li>这个 BL31 不是 FIQ 的处理函数，而是一个 SMC 处理函数，因为此时中断是 MASK 的，所以不会在 BL31 再次出发。BL31 的做法是切换安全状态，回到 REE。</li><li>在 REE，G0 会再次触发，根据真值表来看仍然是 FIQ，而此时因为 SCR.FIQ=1，所以 BL31 可以直接进入中断处理函数。</li></ol><h3 id=case-8ree-收到-g0>Case 8：REE 收到 G0</h3><p>比较简单，REE 时 G0 触发为 FIQ，因为 SCR_EL3.FIQ=1，所以中断在 BL31 触发，直接被处理。再返回 REE。</p><h3 id=case-9bl31-收到-g0>Case 9：BL31 收到 G0</h3><p>默认 BL31 屏蔽，所以不会被触发。一直处于 pending 状态，直到返回 REE 或者 TEE，就又回到了 Case7 和 Case8 的情况。</p><p>TODO：EHF？</p></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2024-08-02T23:51:49, Lastmod: 2024-08-22T23:53:01</p></main></div></body></html>