<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>Thinking: Config Linux Network</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e6%8f%90%e5%87%ba%e9%97%ae%e9%a2%98 aria-label=提出问题>提出问题</a></li><li><a href=#%e5%8a%a8%e6%89%8b%e5%ae%9e%e8%b7%b5 aria-label=动手实践>动手实践</a><ul><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88cmdline%e6%b2%a1%e6%9c%89%e9%85%8d%e7%bd%ae%e4%b8%8a%e5%8e%bb%e5%91%a2 aria-label=为什么CMDLINE没有配置上去呢?>为什么CMDLINE没有配置上去呢?</a></li><li><a href=#%e4%bf%ae%e6%94%b9initrd%e8%be%be%e5%88%b0%e7%9b%ae%e7%9a%84 aria-label=修改Initrd达到目的>修改Initrd达到目的</a></li></ul></li><li><a href=#%e6%84%9f%e6%85%a8 aria-label=感慨>感慨</a></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>Thinking: Config Linux Network</div></header><p>起因：今天与一位同学一起尝试去配置Linux静态IP，这中间有不少坎坷，想简单把思考的过程写下来，
复盘一下是不是应该有可以更快的定位到问题并解决的方案。</p><h2 id=提出问题>提出问题</h2><p>Cl同学想要达到启动Linux后自动设置某个静态Ip的效果，
在我的理解里这并不是一件很复杂的事。</p><p>他给我的想法是在Kernel Command Line参数中指定Ip，
我之前没有看到过这种方式配网，但是网上搜了一下确实有这样的例子。
所以他目前已经完成的是:</p><blockquote><p>Linux是通过Uboot起的，要增加Linux Command Line，
可能是在Uboot的bootargs中添加。
但是他在修改完bootargs并重启的时候，发现变量没有成功赋值，
即使已经成功saveenv。所以就邀请我和他一起讨论。</p></blockquote><h2 id=动手实践>动手实践</h2><p>了解到问题之后，我先说出了我的想法：</p><ul><li>配置静态Ip这个事其实我第一时间想到的是以前修改<code>/etc/network/interfaces</code>文件的方式</li><li>但是我愿意陪他先看下为什么命令行参数没有配置上去</li></ul><p>这是两条路，因为他的系统里没有真正的文件系统，而是initrd，
所以我提出的方案需要去解包inird的压缩文件，还是尽量先去研究为什么命令行参数没有配置上去。</p><h3 id=为什么cmdline没有配置上去呢>为什么CMDLINE没有配置上去呢?</h3><p>首先它说bootargs没有保存成功，这个我也不知道为啥，
可以先不管，即便在每次启动之前在Uboot里设置了Bootargs，
他说在启动之后Kernel的打印也没有输出配置的项目。</p><p><strong>Uboot中Bootargs设置的值是和Kernel Command Line配套吗？
这个我反正是不太确定。</strong></p><p>好，那能不能通过别的方式来设置CmdLine呢？
我们搜索找到了两种方式：</p><ol><li>Dts中</li><li>Menuconfig中修改</li></ol><p>没有尝试Menuconfig是因为他说“目前Menuconfig配置的CmdLine为空，
但是实际Kernel启动后又是有值输出的，那么说明肯定是其他的地方有添加。”
对于这句话我也表示认同，Menuconfig里给的说明是：“默认配置”，
所以即便添加了也无法保证会不会被其他的给冲刷掉。所以，一个根本问题就是：
<strong>CmdLine配置的顺序，或者说优先级是什么？</strong></p><p>先去Dts里改改试试吧，找到了一个chosen结点有关于bootargs的配置，
不管怎么样改了一下，发现并没有生效，和最终Kernel输出的对不上。</p><p>所以，看起来修改CmdLine这条路要失败了，只能去修改initrd试试。</p><h3 id=修改initrd达到目的>修改Initrd达到目的</h3><p>initrd是打包好的，用的是cpio+lz4的方式。要修改首先要把他解开，
解开到还好说，网上能搜得到命令。
但是重新压缩回去问题很多，前期我就想到了我在华为实习时期遇到的类似的问题，
压缩的算法不对、打包的版本差异都会导致Kernel无法解析重新打包的initrd而panic。</p><p>实际也遇到了这个问题，但是这有个小插曲：<strong>即便是换回原来的initrd也还是panic</strong>。
最终破案是因为需要make clean之后重新make，猜测可能是用了什么中间文件。
不得不感慨Linux Kernel的构建还是相当复杂的。</p><p>问题来了：修改<code>/etc/network/interfaces</code>并没有改变静态Ip，
这就使我产生了疑惑，想着可以先在系统启动之后修改试试嘛，
执行ip down和ipup发现确实没有成功修改，这不禁让我想问为什么？</p><p>此时，我们突然想到一个问题，<strong>既然shell命令能成功修改Ip，
那么就在启动时增加一个脚本去执行设置Ip的行动，不就行了吗？</strong></p><p>确实是可以的，所以暂时先不管为什么interfaces不生效。
那就修改有关于/etc/init.d和/etc/inittab相关的知识了，
这一部分我就没参与了，网上的资料的非常全，最终是成功达到目的。</p><h2 id=感慨>感慨</h2><p>虽然成功达到了目的，但是消耗了4个小时左右的时间，我觉得这件事并不应该这么复杂。
主要原因是Linux可以配置网络的方式太多了，以至于像我们这种不是非常熟悉的人一时间不知道如何下手。</p><p>另外，其实这中间还有一些问题没有去解决，可能以后有时间再搞一个完整的qemu-liunx环境去测试一下吧💭。</p></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2023-12-08T17:19:44, Lastmod: 2023-12-16T19:20:35</p><script src=/js/clipboard.js></script></main></div></body></html>