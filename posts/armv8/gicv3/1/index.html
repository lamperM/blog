<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>ARMv8 中断管理(1): 架构与GICv3</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>所有文章</a></div><div class="a-block nav-link-item"><a href=/tags>Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#armv8-%e4%b8%ad%e6%96%ad%e7%b3%bb%e7%bb%9f%e7%9a%84%e6%9e%b6%e6%9e%84 aria-label="ARMv8 中断系统的架构">ARMv8 中断系统的架构</a></li><li><a href=#%e4%b8%ad%e6%96%ad%e6%8e%a7%e5%88%b6%e5%99%a8-gicv3 aria-label="中断控制器 GICv3">中断控制器 GICv3</a><ul><li><a href=#distributor aria-label=Distributor>Distributor</a></li><li><a href=#redistributor aria-label=Redistributor>Redistributor</a></li><li><a href=#cpu-interface aria-label="CPU Interface">CPU Interface</a></li></ul></li><li><a href=#gicv3-affinity-rounting aria-label="GICv3 Affinity Rounting">GICv3 Affinity Rounting</a></li><li><a href=#gicv3-%e4%b8%ad%e6%96%ad%e7%9a%84%e5%88%86%e7%b1%bb%e4%b8%8e%e6%a0%87%e8%af%86 aria-label="GICv3 中断的分类与标识">GICv3 中断的分类与标识</a><ul><li><a href=#%e4%b8%ad%e6%96%ad%e6%a0%87%e8%af%86-intid aria-label="中断标识: INTID">中断标识: INTID</a></li><li><a href=#%e7%89%b9%e6%ae%8a%e4%b8%ad%e6%96%ad%e5%8f%b7 aria-label=特殊中断号>特殊中断号</a></li></ul></li><li><a href=#%e5%b0%8f%e7%bb%93 aria-label=小结>小结</a></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>ARMv8 中断管理(1): 架构与GICv3</div></header><h1 id=armv8-中断系统的架构>ARMv8 中断系统的架构</h1><p>GIC 的输入为许多的中断线，但输出到 CPU 的只有 IRQ 和 FIQ 两种，
所以就要由 GIC 做中断的分发和过滤工作。</p><p>总体来说，整个中断系统架构从底向上可分为三部分:</p><ol><li>硬件接口；外设的引脚</li><li>中断控制器；桥梁，向下提供引脚连接外设，向上连接 CPU 在合适的时间
触发中断信号，<strong>充当中断系统的主管</strong></li><li>中断处理函数；GIC 将中断信号传递到 CPU 后，CPU 执行中断处理函数</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>+-----------+     +-----------+
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>|  Process  |     |  Process  |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>+---------+-+     ++----------+
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>          |        |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        +-+--------+----+
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        |               |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        |      GIC      |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        |               |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        +-------+-------+
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>                |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  +-------------+----------+
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  |   Peripheral Device    |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  +------------------------+
</span></span></code></pre></div><h1 id=中断控制器-gicv3>中断控制器 GICv3</h1><blockquote><p>GIC 的有许多版本，本文皆以 GIC version3 为例介绍, 简称为 GICv3</p></blockquote><p>如上所述，GIC 在中断系统中充当“管家”的作用。如果将 CPU 比作老板，
到来的中断比作约见老板的员工，那么 GIC 就是秘书，统筹安排何人何时
与老板谈话。</p><p>GICv3 的组成大概可分为 3 部分:</p><ul><li>Distributor</li><li>Redistributor</li><li>CPU Interface</li></ul><p>如果将上面架构图中的 GIC 拆开，大概的结构如下图所示。能够注意到除了
GIC 被细分外，外设中断源也划分为两部分，在下面<strong>中断分类</strong>中会详细
介绍。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>+----------------+    +----------------+
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>|    Process     |    |    Process     |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>+--+----------+--+    +--+----------+--+
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>   |   CPU    |          |   CPU    |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   | Interface|          | Interface|
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>   +----+-----+          +----+-----+
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        |                     |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span> +------+-------+      +------+-------+
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span> | Reditributor |      | Reditributor +-----+
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span> +----------+---+      +--+-----------+     |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            |             |                 |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        +---+-------------+-----+           |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        |                       |           |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        |     Distributor       |           |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        |                       |           |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        +-----------+-----------+           |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>                    |                       |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>          +---------+--------+      +-------+---------+
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>          |Peripheral Device |      |Peripheral Device|
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>          |      (SPI)       |      |      (PPI)      |
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>          +------------------+      +-----------------+
</span></span></code></pre></div><h2 id=distributor>Distributor</h2><p>负责全局中断的分发</p><h2 id=redistributor>Redistributor</h2><p>Redistributor 是 GICv3 相较于 v2 新引入的部件，在我看来，引入 Redistributor 的
主要原因是: <strong>提高中断相应的效率</strong>。 在以前，无论是全局中断还是私有中断都是通过一个
Distributor 分发，如果中断到来的比较频繁，则可能产生延迟。</p><p>Redistributor 就主要负责私有中断的分发，减轻了 Distributor 的负担。</p><h2 id=cpu-interface>CPU Interface</h2><p>物理结构上依附与 CPU，而不是 GIC。主要负责控制中断被 CPU 接收的过程，
即中断状态 pengding , active, inactive 的切换。</p><p>同时， CPU Interface 还负责优先级的过滤，只有符合优先级条件的中断才会被 CPU 响应。
相关的寄存器有<code>ICC_PMR_EL1</code>，<code>ICC_RPR_EL1</code>等</p><p>中断抢占的配置也是由其完成，详见<code>ICC_BPRx_EL1</code>寄存器。</p><h1 id=gicv3-affinity-rounting>GICv3 Affinity Rounting</h1><p>GICv3 以前都是用 target-list, 来设置中断到达的目的 CPU，这种方式类似于位图，
以前只有 8bit 来做这个，所以采用 GICv2 的系统最多支持 8 个 CPU。</p><p>而 GICv3 引入了 Affinity value 来支持更多的 CPU，类似于 IP 地址的方法，用 4 个 8bit 来标识。可以写作<code>a.b.c.d</code></p><ul><li>c: 一般是指某个 cluster</li><li>d: 转发时会填入 target-list，指定多个 CPU，最多 8 个(下图的形式还没有将d转为targetlist)</li></ul><figure><img src=/gic_affinity.jpg width=80%></figure><blockquote><p>所以用 Affinity value 虽然能指定大于 8 个 CPU，但是<strong>一次</strong>只能发往一个 cluster 内的最多 8CPU。</p></blockquote><h1 id=gicv3-中断的分类与标识>GICv3 中断的分类与标识</h1><p>在使用 GICv3 的系统上，中断被划分为 4 种类型:</p><ul><li>spi: 全局的中断，可以被路由到任意的一个或多个 CPU。一般对应所有 CPU 共用
的外设，例如串口中断。</li><li>ppi: 每个 CPU 私有的中断，只能被路由到该 CPU。对应与 CPU 私有的外设中断，
例如 CPU 内部定时器中断。</li><li>sgi: CPU 触发的中断，可以被路由到任意 CPU。一般用于核间通信使用。</li><li>lpi: <a href=https://en.wikipedia.org/wiki/Message_Signaled_Interrupts>message-based interrupts</a>
这里不做介绍.</li></ul><h2 id=中断标识-intid>中断标识: INTID</h2><p>CPU 如何区分当前来的中断是来自哪个外设的中断信号? 答案是通过 INTID，它是 GIC
定义的中断标识符，CPU 通过读取寄存器<code>ICC_IAR1_EL1</code>就能得知当前处理中断的 INTID。</p><p>INTID 按照中断类型分类的, 对照表如下:</p><table><thead><tr><th>INTID</th><th>中断类型</th><th>Note</th></tr></thead><tbody><tr><td>0-15</td><td>SGI</td><td>本地的, 不同 CPU 可使用同一中断号代表不同中断</td></tr><tr><td>16-31</td><td>PPI</td><td>本地的</td></tr><tr><td>32-1019</td><td>SPI</td><td>全局的</td></tr><tr><td>1020-1023</td><td>特殊中断</td><td></td></tr><tr><td>1056-1119</td><td>扩展的 PPI</td><td>本地的</td></tr><tr><td>4096 – 5119</td><td>扩展的 SPI</td><td>全局的</td></tr></tbody></table><blockquote><p>扩展中断号的最大值是<em>实现定义</em>的, 可以在<code>GICD_TYPER.IDbits</code>中读取。</p></blockquote><h2 id=特殊中断号>特殊中断号</h2><blockquote><p>特殊中断不需要 end of interrupt or deactivation 过程.</p></blockquote><ul><li><p>1020:</p></li><li><p>1021:</p></li><li><p>1022:</p></li><li><p>1023: 读<code>ICC_IAR1_EL1</code> 返回该值表明当前的 CPU 上没有待处理的中断，
编程时可当做<code>while</code>退出的标志</p></li></ul><h1 id=小结>小结</h1><p>这节主要总结 ARMv8 中断系统的总体架构和 GICv3 的组成结构，下一节将介绍
一个中断的生命周期，即中断的状态转换，以及在此过程中各个组件的作用。</p></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2023-04-12T21:51:49, Lastmod: 2024-01-17T16:38:18</p></main></div></body></html>