<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>GICv3 介绍</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>所有文章</a></div><div class="a-block nav-link-item"><a href=/tags>Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#gicv3generic-interrupt-controller---version-3 aria-label="GICV3(Generic Interrupt Controller - version 3)">GICV3(Generic Interrupt Controller - version 3)</a><ul><li><a href=#%e5%85%b3%e4%ba%8egic aria-label=关于GIC>关于GIC</a></li><li><a href=#%e5%af%b9%e6%af%94-gicv2 aria-label="对比 GICv2">对比 GICv2</a></li><li><a href=#%e4%b8%ad%e6%96%ad%e7%b1%bb%e5%9e%8b aria-label=中断类型>中断类型</a><ul><li><a href=#locality-specific-peripheral-interrupt-lpi aria-label="Locality-specific Peripheral Interrupt (LPI)">Locality-specific Peripheral Interrupt (LPI)</a></li><li><a href=#private-peripheral-interrupt-ppi aria-label="Private Peripheral Interrupt (PPI)">Private Peripheral Interrupt (PPI)</a></li><li><a href=#shared-peripheral-interrupt-spi aria-label="Shared Peripheral Interrupt (SPI)">Shared Peripheral Interrupt (SPI)</a></li><li><a href=#software-generated-interrupt-sgi aria-label="Software Generated Interrupt (SGI)">Software Generated Interrupt (SGI)</a></li></ul></li><li><a href=#gicv3-%e7%9a%84%e7%bb%84%e4%bb%b6 aria-label="GICv3 的组件">GICv3 的组件</a><ul><li><a href=#distributor aria-label=Distributor>Distributor</a></li><li><a href=#redistributor aria-label=Redistributor>Redistributor</a></li><li><a href=#cpu-interface aria-label="CPU interface">CPU interface</a></li></ul></li><li><a href=#%e4%b8%ad%e6%96%ad%e7%9a%84%e7%8a%b6%e6%80%81%e8%bd%ac%e6%8d%a2 aria-label=中断的状态转换>中断的状态转换</a></li><li><a href=#%e4%b8%ad%e6%96%adid-intid aria-label="中断ID: INTID">中断ID: INTID</a><ul><li><a href=#%e7%89%b9%e6%ae%8a%e4%b8%ad%e6%96%ad%e5%8f%b7 aria-label=特殊中断号>特殊中断号</a></li></ul></li><li><a href=#%e4%b8%ad%e6%96%ad%e5%88%86%e7%bb%84 aria-label=中断分组>中断分组</a></li><li><a href=#%e4%b8%ad%e6%96%ad%e8%b7%af%e7%94%b1 aria-label=中断路由>中断路由</a><ul><li><a href=#what-is-affinity-routing aria-label="What is Affinity Routing?">What is Affinity Routing?</a></li></ul></li><li><a href=#%e7%bc%96%e7%a8%8b%e6%8c%87%e5%af%bc aria-label=编程指导>编程指导</a><ul><li><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96 aria-label=初始化>初始化</a></li></ul></li></ul></li></ul></div></details></div></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>GICv3 介绍</div></header><h1 id=gicv3generic-interrupt-controller---version-3>GICV3(Generic Interrupt Controller - version 3)</h1><h2 id=关于gic>关于GIC</h2><p>GIC即中断控制器, 负责管理中断的接收, 屏蔽, 路由等相关任务, 并向系统程序员提供配置的接口.</p><p>GIC与异常模型协作完成中断的整个生命周期, GIC主要负责<code>中断源-产生IRQ/FIQ信号</code>这段路, 关于处理IRQ/FIQ则是由CPU内部的<em>异常模型</em>来完成.</p><h2 id=对比-gicv2>对比 GICv2</h2><ul><li>支持更多的处理器, 用<code>affinity routing</code> 方案来做中断路由.</li><li>支持中断分组, 为了配合ARMv8的异常等级模型</li><li>新增中断类型: SGI, 软件生成中断</li><li>新增中断类型: SPI, Shared Peripheral Interrupts</li><li>对于CPU interface的寄存器, 可直接使用系统寄存器接口(system register interface)来访问, 比memory-mapped的方式快.</li><li>ITS, Interrupt Translation Service 暂不介绍</li><li>LPI, Locality-specific Peripheral Interrupts . 暂不介绍</li></ul><blockquote><p>GICv3支持ARMv8-A或ARMv8-R系列处理器, 但没有必然的绑定关系. ARMv8-A也可以使用GICv2.</p></blockquote><h2 id=中断类型>中断类型</h2><h3 id=locality-specific-peripheral-interrupt-lpi>Locality-specific Peripheral Interrupt (LPI)</h3><p>LPIs are always <a href=https://en.wikipedia.org/wiki/Message_Signaled_Interrupts>message-based interrupts</a> interrupts. 这里不做介绍.<a href=https://en.wikipedia.org/wiki/Message_Signaled_Interrupts>wiki</a></p><h3 id=private-peripheral-interrupt-ppi>Private Peripheral Interrupt (PPI)</h3><p>PPI是路由到<strong>单个CPU</strong>的外设中断, 不同的CPU可以使用相同的中断号. 例如, 所有CPU都可以使用中断号16表示私有的定时器中断.</p><h3 id=shared-peripheral-interrupt-spi>Shared Peripheral Interrupt (SPI)</h3><p>SPI是可路由到<strong>一组CPU</strong>的外设中断, Distributor 负责SPI路由.</p><h3 id=software-generated-interrupt-sgi>Software Generated Interrupt (SGI)</h3><p>SGI是由某个CPU产生, 路由到系统中的一个或多个CPU, 通常用于处理器间通信.</p><h2 id=gicv3-的组件>GICv3 的组件</h2><p>GICv3架构由以下逻辑组件构成:</p><ul><li>A Distributor</li><li>A Redistributor for each CPU</li><li>A CPU interface for each CPU</li><li>Interrupt Translation Service components (ITS). 可选, 暂不介绍</li></ul><p>The Distributor, Redistributor 一起组成了 <em>IRI(Interrupt Routing Infrastructure)</em>.</p><p><img src=./IRI.png alt=iri>{width=&ldquo;10px&rdquo;}</p><h3 id=distributor>Distributor</h3><p>控制SPI和SGI的路由. 对于 SPI, 提供了一下接口:</p><ul><li>启动/禁用 SPI</li><li>设置 SPI 的优先级</li><li>配置对于 SPI 的路由</li><li>设置 SPI 的触发方式</li><li>生成 message-based SPI</li><li>为每个 SPI 分组</li><li>控制 SPI 的 <code>pending and active</code> 状态</li></ul><p>对于<code>Distributor</code>的大部分配置通过<code>GICD_CTLR</code>实现. 包括:</p><ul><li>启用 Affinity routing</li><li>禁用安全性</li><li>中断分组的配置.</li></ul><blockquote><p>关于Distributor 寄存器都含有 <code>GICD_</code> 前缀, 通过 <code>memory-mapped</code> 方式访问.</p></blockquote><h3 id=redistributor>Redistributor</h3><ul><li>启动/禁用 SGI 和 PPI</li><li>设置 SGI 和 PPI 的优先级</li><li>设置 SGI 和 PPI 的触发方式</li><li>为 SGI 和 PPI 分配组</li><li>控制 SGI 和 PPI 的 <code>pending</code> 状态和 <code>active</code> 状态</li><li>与之链接的 CPU 的电源管理.</li></ul><blockquote><p>关于Redistributor 寄存器都含有 <code>GICR_</code> 前缀, 通过 <code>memory-mapped</code> 方式访问.</p></blockquote><h3 id=cpu-interface>CPU interface</h3><ul><li>Acknowledge 一个中断</li><li>执行 End Of Interrupt</li><li>Deactivate 一个中断</li><li>设置 CPU 的优先级Mask</li><li>配置中断抢占</li></ul><blockquote><p>关于 CPU interface 寄存器是以 <code>ICC_</code> 为前缀, 还有 <code>ICV</code> for vitual interrupt, <code>ICH</code> for hypervisor configuration.</p></blockquote><h2 id=中断的状态转换>中断的状态转换</h2><p><img src=./int-lifestyle.png alt></p><ol><li>生成中断. 中断可能来自外部信号, 或者软件生成(SGI)</li><li>Distribute. IRI 负责中断的分组, 优先级屏蔽等. 将合适的中断发送到CPU Interface.</li><li>Deliver. CPU interface 将中断发送到连接的CPU.</li><li>Activate. CPU读取IAR寄存器, 即发送ACK. 该中断的状态转为active.</li><li>Priority drop. 处理程序结束之后, 写<code>ICC_EOIR</code>寄存器, end of interrupt</li><li>Deactivation. 写<code>ICC_DIR</code>寄存器清除中断的active标志位. 一般来说, end of interrupt 和 deactivation 可配置成同时发生.</li></ol><blockquote><p><code>ICC_CTLR_ELx.EOImode</code> 位控制是否 end of interrupt 同时导致 deactivation.</p><p>:question: EOI 和 deactivated 分开进行暂时还不知道应用场景.</p></blockquote><h2 id=中断id-intid>中断ID: INTID</h2><p>INTID 是中断的标识符, 它的最大值是<em>实现定义</em>的, 可以在<code>GICD_TYPER.IDbits</code>中读取。</p><p>INTID按照中断类型分类的, 对照表如下:</p><table><thead><tr><th>INTID</th><th>中断类型</th><th>Note</th></tr></thead><tbody><tr><td>0-15</td><td>SGI</td><td>本地的, 不同CPU可使用同一中断号代表不同中断</td></tr><tr><td>16-31</td><td>PPI</td><td>本地的</td></tr><tr><td>32-1019</td><td>SPI</td><td>全局的</td></tr><tr><td>1020-1023</td><td>特殊中断</td><td></td></tr><tr><td>1056-1119</td><td>扩展的PPI</td><td>本地的</td></tr><tr><td>4096 – 5119</td><td>扩展的SPI</td><td>全局的</td></tr></tbody></table><h3 id=特殊中断号>特殊中断号</h3><blockquote><p>These INTIDs do not require an end of interrupt or deactivation.</p></blockquote><p>1020:</p><p>1021:</p><p>1022:</p><p>1023: 读<code>ICC_IAR1_EL1</code> 返回该值表明当前的CPU上没有待处理的中断.</p><h2 id=中断分组>中断分组</h2><p>为了配合 ARMv8 的异常模型和安全模型, GICv3 支持为每个中断配置不同的组. 不同组的中断只能路由到特定的异常等级和安全状态进行处理.</p><p>共包含三个分组: Gourp 0, Secure Group 1, Non-secure Group 1.</p><ul><li>Group 0的中断需要在EL3 处理.</li><li>Secure Group1 的中断需要在 Secure EL1 或者 Secure EL2(如果启用了虚拟化)处理.</li><li>Non-secure Group 1 的中断需要在 Non-secure EL2 or Non-secure EL1 if not using virtualization</li></ul><p>同时, 中断位于哪个组也决定了其触发的是FIQ还是IRQ. 对于 AArch64 来说, 对应关系可见下表:</p><table><thead><tr><th>当前异常等级</th><th>Group 0 的中断</th><th>Secure Group 1 的中断</th><th>Non-secure Group 1</th></tr></thead><tbody><tr><td>Secure EL1/0/2</td><td>FIQ</td><td>IRQ</td><td>FIQ</td></tr><tr><td>Non-secure EL1/0/2</td><td>FIQ</td><td>FIQ</td><td>IRQ</td></tr><tr><td>EL3</td><td>FIQ</td><td>FIQ</td><td>FIQ</td></tr></tbody></table><ul><li>Group 0 的中断, 需要在EL3处理, 其优先级较高, 所以均属于 FIQ</li></ul><h2 id=中断路由>中断路由</h2><ul><li><p>PPIs are routed directly from the source to the local Redistributor .</p></li><li><p>SPIs are routed from the source through the Distributor to the target Redistributor and the associated CPU interface.</p></li><li><p>SGIs are generated by software through the CPU interface and Redistributor. They are then routed through the Distributor to one or more target Redistributors and the associated CPU interfaces</p></li></ul><h3 id=what-is-affinity-routing>What is Affinity Routing?</h3><p>Affinity routing 是一种基于地址的标识多个CPU的方法, 用于中断的路由. Affinity value 由4个8bit字段组成, 结构是<code>aff3.aff2.aff1.aff0</code>.</p><p>由于 PPI 的中断源是直连 Redistributor 的, 所以仅 SPI 和 SGI 可以使用 Affinity routing.</p><ul><li>对于 SPI, 目标CPU的 affinity value 通过<code>GICD_IROUTER&lt;n></code> 设置.</li><li>对于 SGI, 在生成时即可同时配置, 详见 <code>ICC_SGI0R_EL1</code> 和 <code>ICC_SGI1R_EL1</code>.</li></ul><blockquote><p>Aff3.Aff2.Aff1.Aff0 与 Aff3.Aff2.Aff2.TargetList</p><p>对于SPI, 目标的CPU只能是一个, 故<code>Aff0</code>表示该CPU的ID. 而SGI可以配置同时发给多个CPU, 所以<code>TargetList</code>是基于位操作的, 每个位表示一个CPU.</p></blockquote><h2 id=编程指导>编程指导</h2><h3 id=初始化>初始化</h3><p>由于 <em>Distributor</em> 整个系统共享的, 所以必须在其他核启动之前, 由主核完成初始化. 然后当所有核都启动后, 各自完成各自 <em>Redistributor</em> 和 <em>CPU interface</em> 的初始化工作.</p></article></body></main></div></body></html>