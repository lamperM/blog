<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>ARMv8 基础概念</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%a8%8b%e5%ba%8f%e6%80%a7%e8%83%bd%e7%9a%84%e5%88%86%e6%9e%90%e6%96%b9%e6%b3%95 aria-label=程序性能的分析方法>程序性能的分析方法</a></li><li><a href=#%e7%a8%8b%e5%ba%8f%e6%80%a7%e8%83%bd%e7%9a%84%e5%88%86%e6%9e%90%e5%b7%a5%e5%85%b7 aria-label=程序性能的分析工具>程序性能的分析工具</a><ul><li><a href=#linux-perf aria-label="Linux Perf">Linux Perf</a></li></ul></li><li><a href=#%e4%b8%8e-armv7-%e7%9b%b8%e6%af%94%e7%9a%84%e6%94%b9%e5%8a%a8 aria-label="与 ARMv7 相比的改动">与 ARMv7 相比的改动</a></li><li><a href=#arm-%e5%a4%84%e7%90%86%e5%99%a8%e7%9a%84%e6%9e%b6%e6%9e%84%e4%b8%8e%e5%be%ae%e6%9e%b6%e6%9e%84 aria-label="Arm 处理器的架构与微架构">Arm 处理器的架构与微架构</a></li><li><a href=#armv82-spe aria-label="Armv8.2 SPE">Armv8.2 SPE</a><ul><li><a href=#%e5%80%9f%e5%8a%a9perf%e4%bd%bf%e7%94%a8spe aria-label=借助perf使用SPE>借助perf使用SPE</a></li></ul></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>ARMv8 基础概念</div></header><figure><img src=/n2_core.jpg width=90%></figure><p>指令执行的过程：取指、译码、执行和写回。
根据这个将Core分为两部分：</p><ol><li>前端：指令从内存预取到Cpu，解码，发射。在Arm中，
前端的流程是顺序的。一个cycle里最多可以解码4条指令给后端。</li><li>后端：后端的作用是执行指令。后端一般包含几个执行单元，
整数、浮点数、Load/Store、Branch相关的执行单元。
后端中，如果指令之间没有依赖，支持乱序执行。</li></ol><p>Core中的Cache分布：Icache在前端，Dcache属于后端。</p><p>Core中的Tlb分布：ITlb在前端，DTlb在后端</p><p>指令执行完后，到达Retire，指令退役。</p><h2 id=程序性能的分析方法>程序性能的分析方法</h2><p>性能的问题可能出在前端，称为前端Stall，在后端时则称为后端Stall。</p><p>性能指标：</p><ul><li>IPC：IPC=INST_RETIRED / CPU_CYCLES，IPC并不能单独判断
是否性能比较好，比如说在某个处理器上，前端最多一个Cycle发射4
条指令，那么IPC是不是越接近4越好呢？其实不是，<strong>还要结合CPU
此时正在做什么事情</strong>，如果是死循环，那么就不代表什么。</li><li>Pipeline Stalls<ul><li>Stall Front-end rate=STALL_FRONTEND/CPU_CYCLES</li><li>Stall Back-end rate=STALL_BACKEND/CPU_CYCLES</li></ul></li><li>Frontend Bound<ul><li>ITLB events</li><li>I-Cache events</li></ul></li><li>Backend Bound<ul><li>DTLB events</li><li>Memory System related events</li><li>D-Cache events</li></ul></li><li>Retiring<ul><li>Instruct Mix</li></ul></li><li>Bad Speculation<ul><li>Branch Effectiveness events</li></ul></li></ul><h2 id=程序性能的分析工具>程序性能的分析工具</h2><h3 id=linux-perf>Linux Perf</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#888># Counting</span>
</span></span><span style=display:flex><span>perf stat -e &lt;event list&gt;
</span></span><span style=display:flex><span><span style=color:#888># Event based sampling</span>
</span></span><span style=display:flex><span>perf record -e &lt;event list&gt;
</span></span><span style=display:flex><span><span style=color:#888># SPE sampling</span>
</span></span><span style=display:flex><span>perf record -e árm_spe_0/ts_enable=1<span style=color:#a61717;background-color:#e3d2d2>&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=与-armv7-相比的改动>与 ARMv7 相比的改动</h2><ul><li>指令集： 新增 A64 指令集， 但也兼容原来的 A32 指令集</li><li>权限等级： AArch64 下新增 EL0-EL3 异常等级，对应 V7 的特权等级</li><li>通用寄存器：31 个通用寄存器，V7 15 个</li><li>虚拟地址长度：64 位的地址长度，理论支持 256TB 的寻址范围</li></ul><h2 id=arm-处理器的架构与微架构>Arm 处理器的架构与微架构</h2><p>架构可以理解为由<strong>指令集、内存模型等</strong>组成的一个<strong>行为规范</strong>，
或叫做 specification。相当于一种标准，会定义 Cpu 工作行为的预期，
并不会限制具体是如何实现。</p><p>微架构就是<strong>整个流水线的设计，包括前端和后端</strong>具体的设计与实现，
由芯片厂商自行开发。</p><h2 id=armv82-spe>Armv8.2 SPE</h2><p>SPE的全称为Statistical Profiling Extension, 统计分析扩展，
是Armv8.2引入的一个特性。</p><p>PMU能统计事件发生的次数，但是无法直到是哪一条指令导致的。
采样因为要通过中断的方式，所以准确性不高，太高的准确率会造成系统很大的负担。
因此开发者一般只能确定是哪一个函数，但是确定哪一行就比较困难。</p><p>SPE就是通过硬件的方式解决这个问题，直接在流水线上对指令进行采样。
用硬件对性能的损耗就会很低。</p><p>有个计数器，没取指一次，计数器-1，减到0之后的指令就是要采样的指令。</p><p>采集的指令非常全面：时间戳、PC、指令的分类、运行的时间等。</p><p>采集之后，可以做一次过滤，只保存关心的事件（执行时间大于几个Cycle？指令类型lr/str？）</p><p>保存的buffer满了之后，触发中断，软件读取。</p><h3 id=借助perf使用spe>借助perf使用SPE</h3><ul><li>FEAT_SPE Armv8.2 Support from 4.14 and 5.3</li><li>FEAT_SPEv1p1 Armv8.5 Only support from 5.11</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>perf list | grep arm_spe_0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>perf record -e arm_spe_0/branch_filter=1,ts_enable=1,pct_enable=1,pa_enable=1,<span style=color:#04d;background-color:#fff0f0>\
</span></span></span><span style=display:flex><span><span style=color:#04d;background-color:#fff0f0></span><span style=color:#369>load_filter</span>=1,jitter=1,store_filter=1,min_latency=0/ -- ./user.app
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>perf report -D -i perf.data
</span></span></code></pre></td></tr></table></div></div><ul><li><a href="https://developer.aliyun.com/live/252287?spm=a2c6h.28322828.J_3909373260.17.88865488AzlJRR">Arm架构下性能分析与优化介绍-云视频-阿里云开发者社区</a></li></ul></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2023-05-09T21:19:01, Lastmod: 2024-01-17T16:29:05</p><script src=/js/clipboard.js></script></main></div></body></html>