<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>Libdwarf 函数介绍及其实现方法</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#function aria-label=Function>Function</a><ul><li><a href=#dwarf_allocc aria-label=dwarf_alloc.c>dwarf_alloc.c</a><ul><li><a href=#_dwarf_get_alloc aria-label=_dwarf_get_alloc()>_dwarf_get_alloc()</a></li><li><a href=#_dwarf_error aria-label=_dwarf_error()>_dwarf_error()</a></li><li><a href=#%e5%87%bd%e6%95%b0%e5%8a%9f%e8%83%bd aria-label=函数功能>函数功能</a></li><li><a href=#%e5%87%bd%e6%95%b0%e6%b5%81%e7%a8%8b aria-label=函数流程>函数流程</a></li></ul></li><li><a href=#dwarf_elf_accessc aria-label=dwarf_elf_access.c>dwarf_elf_access.c</a><ul><li><a href=#dwarf_elf_object_access_init aria-label=dwarf_elf_object_access_init()>dwarf_elf_object_access_init()</a></li><li><a href=#%e5%87%bd%e6%95%b0%e5%8a%9f%e8%83%bd-1 aria-label=函数功能>函数功能</a></li><li><a href=#%e5%87%bd%e6%95%b0%e6%b5%81%e7%a8%8b-1 aria-label=函数流程>函数流程</a></li><li><a href=#_dwarf_get_elf_flags_func aria-label=_dwarf_get_elf_flags_func()>_dwarf_get_elf_flags_func()</a></li><li><a href=#%e5%87%bd%e6%95%b0%e5%8a%9f%e8%83%bd-2 aria-label=函数功能>函数功能</a></li></ul></li><li><a href=#dwarf_original_elf_initc aria-label=dwarf_original_elf_init.c>dwarf_original_elf_init.c</a><ul><li><a href=#dwarf_elf_object_access_init-1 aria-label=dwarf_elf_object_access_init()>dwarf_elf_object_access_init()</a></li></ul></li><li><a href=#dwarf_init_finishc aria-label=dwarf_init_finish.c>dwarf_init_finish.c</a><ul><li><a href=#this_section_dwarf_relevant aria-label=this_section_dwarf_relevant()>this_section_dwarf_relevant()</a></li><li><a href=#get_basic_section_data aria-label=get_basic_section_data()>get_basic_section_data()</a></li><li><a href=#_dwarf_load_section aria-label=_dwarf_load_section()>_dwarf_load_section()</a></li><li><a href=#add_debug_section_info aria-label=add_debug_section_info()>add_debug_section_info()</a></li><li><a href=#_dwarf_setup aria-label=★_dwarf_setup()>★_dwarf_setup()</a></li></ul></li><li><a href=#dwarf_die_delivc aria-label=dwarf_die_deliv.c>dwarf_die_deliv.c</a><ul><li><a href=#dwarf_next_cu_header_d aria-label=dwarf_next_cu_header_d()>dwarf_next_cu_header_d()</a></li></ul></li><li><a href=#_dwarf_next_die_info_ptr aria-label=_dwarf_next_die_info_ptr()>_dwarf_next_die_info_ptr()</a></li><li><a href=#dwarf_siblingof_b aria-label=dwarf_siblingof_b()>dwarf_siblingof_b()</a></li><li><a href=#dwarf_offdie aria-label=dwarf_offdie()>dwarf_offdie()</a></li></ul></li><li><a href=#structure aria-label=Structure>Structure</a><ul><li><a href=#dwarf_error aria-label=Dwarf_Error>Dwarf_Error</a></li><li><a href=#struct-dwarf_obj_access_section_s aria-label="struct Dwarf_Obj_Access_Section_s">struct Dwarf_Obj_Access_Section_s</a></li><li><a href=#struct-dwarf_section_s aria-label="struct Dwarf_Section_s">struct Dwarf_Section_s</a></li><li><a href=#struct-dwarf_dbg_sect_s aria-label="struct Dwarf_dbg_sect_s">struct Dwarf_dbg_sect_s</a></li><li><a href=#dwarf_cu_context aria-label=Dwarf_CU_Context>Dwarf_CU_Context</a></li><li><a href=#dwarf_debug_infotypes aria-label=Dwarf_Debug_InfoTypes>Dwarf_Debug_InfoTypes</a></li><li><a href=#dwarf_die aria-label=Dwarf_Die>Dwarf_Die</a></li><li><a href=#dwarf_abbrev_list aria-label=Dwarf_Abbrev_List>Dwarf_Abbrev_List</a></li></ul></li><li><a href=#%e5%85%b6%e4%bb%96%e8%81%94%e5%8a%a8%e6%96%b9%e5%bc%8f aria-label=其他联动方式>其他联动方式</a><ul><li><a href=#struct-dwarf_dbg_sect_s-%e5%92%8c-struct-dwarf_section_s-%e4%b9%8b%e9%97%b4%e7%9a%84%e5%85%b3%e7%b3%bb aria-label="struct Dwarf_dbg_sect_s 和 struct Dwarf_Section_s 之间的关系">struct Dwarf_dbg_sect_s 和 struct Dwarf_Section_s 之间的关系</a></li><li><a href=#dwarf_debug-%e5%92%8c-%e5%85%b6%e6%8b%a5%e6%9c%89%e7%9a%84-struct-dwarf_dbg_sect_s%e4%b9%8b%e9%97%b4%e7%9a%84%e5%85%b3%e7%b3%bb aria-label="Dwarf_Debug 和 其拥有的 struct Dwarf_dbg_sect_s之间的关系">Dwarf_Debug 和 其拥有的 struct Dwarf_dbg_sect_s之间的关系</a></li><li><a href=#%e5%8a%a8%e6%80%81%e7%94%b3%e8%af%b7%e7%9a%84%e7%a9%ba%e9%97%b4%e4%bd%95%e6%97%b6%e9%87%8a%e6%94%be aria-label=动态申请的空间何时释放?>动态申请的空间何时释放?</a></li></ul></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>Libdwarf 函数介绍及其实现方法</div></header><h2 id=function>Function</h2><h3 id=dwarf_allocc>dwarf_alloc.c</h3><h4 id=_dwarf_get_alloc>_dwarf_get_alloc()</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>_dwarf_get_alloc(Dwarf_Debug dbg,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    Dwarf_Small alloc_type, Dwarf_Unsigned count)
</span></span></code></pre></div><p>函数功能: 根据类型申请一块空间</p><p>注意, 申请时大小会多<code>DW_RESERVE</code>, 此函数返回的地址是 <code>mem_alloc()</code>返回的地址+<code>DW_RESERVE</code></p><h4 id=_dwarf_error>_dwarf_error()</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>void</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>_dwarf_error(Dwarf_Debug dbg, Dwarf_Error <span style=color:#ff79c6>*</span> error, Dwarf_Sword errval)
</span></span></code></pre></div><h4 id=函数功能>函数功能</h4><p>错误处理的函数</p><h4 id=函数流程>函数流程</h4><ol><li>判断传入参数<code>error</code>是否为空, 如果为空则跳转到 step 4.</li><li>分配一个新的<code>Dwarf_Error</code>空间</li><li>将传入的错误信息存入<code>Dwarf_Error</code>, 并将其作为指针返回</li><li><code>error</code>为空时, 一般要在出错时执行一些方法,即 <code>dbg->de_errhand()</code></li><li>所以, 此时<code>dbg</code> 和 <code>dbg->de_errhand</code> 必须非空.</li></ol><h3 id=dwarf_elf_accessc>dwarf_elf_access.c</h3><h4 id=dwarf_elf_object_access_init>dwarf_elf_object_access_init()</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>int</span>         
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>dwarf_elf_object_access_init(u64 elf_base_addr,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#8be9fd>int</span> libdwarf_owns_elf,                     
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    Dwarf_Obj_Access_Interface<span style=color:#ff79c6>**</span> ret_obj,      
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#8be9fd>int</span> <span style=color:#ff79c6>*</span>err)                      
</span></span></code></pre></div><h4 id=函数功能-1>函数功能</h4><p>初始化 <code>Dwarf_Obj_Access_Interface</code> 结构</p><h4 id=函数流程-1>函数流程</h4><ol><li>初始化其成员<code>object</code>, 使用的是<code>dwarf_elf_object_access_internals_init</code>方法</li><li>申请空间</li><li>为成员赋值</li><li>为全局变量<code>_dwarf_get_elf_flags_func_ptr</code>赋值, 为获取elf section flags的方法</li></ol><h4 id=_dwarf_get_elf_flags_func>_dwarf_get_elf_flags_func()</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span>                        
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>_dwarf_get_elf_flags_func(        
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span> obj_in,                 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    Dwarf_Half section_index,     
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    Dwarf_Unsigned <span style=color:#ff79c6>*</span>flags_out,    
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    Dwarf_Unsigned <span style=color:#ff79c6>*</span>addralign_out,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#8be9fd>int</span> <span style=color:#ff79c6>*</span>error)                   
</span></span></code></pre></div><h4 id=函数功能-2>函数功能</h4><p>获取elf指定section的flags</p><h3 id=dwarf_original_elf_initc>dwarf_original_elf_init.c</h3><h4 id=dwarf_elf_object_access_init-1>dwarf_elf_object_access_init()</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span>      
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>dwarf_elf_init_file_ownership(u64 elf_base_addr, 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#8be9fd>int</span> libdwarf_owns_elf,          
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    Dwarf_Unsigned access,          
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    Dwarf_Handler errhand,          
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    Dwarf_Ptr errarg,               
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    Dwarf_Debug <span style=color:#ff79c6>*</span> ret_dbg,          
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    Dwarf_Error <span style=color:#ff79c6>*</span> error)               
</span></span></code></pre></div><h3 id=dwarf_init_finishc>dwarf_init_finish.c</h3><h4 id=this_section_dwarf_relevant>this_section_dwarf_relevant()</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>this_section_dwarf_relevant(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>scn_name,<span style=color:#8be9fd>int</span> type)
</span></span></code></pre></div><p>函数功能: 通过section name判断该section是否与dwarf相关</p><h4 id=get_basic_section_data>get_basic_section_data()</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>get_basic_section_data(Dwarf_Debug dbg,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>struct</span> Dwarf_Section_s <span style=color:#ff79c6>*</span>secdata,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#ff79c6>struct</span> Dwarf_Obj_Access_Section_s <span style=color:#ff79c6>*</span>doas,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    Dwarf_Half section_index,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    Dwarf_Error<span style=color:#ff79c6>*</span> error,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#8be9fd>int</span> duperr, <span style=color:#8be9fd>int</span> emptyerr )
</span></span></code></pre></div><p>函数功能: 填充 <code>Dwarf_Section_s</code> 中一些基本信息, 不包含<code>dss_data</code>, 即section load不在这个函数完成</p><h4 id=_dwarf_load_section>_dwarf_load_section()</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>int</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>_dwarf_load_section(Dwarf_Debug dbg,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>struct</span> Dwarf_Section_s <span style=color:#ff79c6>*</span>section,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    Dwarf_Error <span style=color:#ff79c6>*</span> error)
</span></span></code></pre></div><p>函数功能: 加载一个ELF section, 填充对应的<code>struct Dwarf_Section_s</code>. 其caller一般为<code>_dwarf_load_debug_xxx()</code>, 例如<code>_dwarf_load_debug_info()</code>.</p><p>函数流程:</p><ol><li>检查这个段是否已经被加载了</li><li>调用<code>methods->load_section()</code> 加载section的dss_data</li><li>只需要赋值<code>dss_data</code>就行, 因为其他的成员在<code>get_basic_section_data()</code>时候已经完成了</li></ol><h4 id=add_debug_section_info>add_debug_section_info()</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>add_debug_section_info(Dwarf_Debug dbg, 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#6272a4>/* Name as seen in object file. */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>name,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#8be9fd>unsigned</span> obj_sec_num,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>struct</span> Dwarf_Section_s <span style=color:#ff79c6>*</span>secdata,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#6272a4>/*  The have_dwarf flag is a somewhat imprecise
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4>        way to determine if there is at least one &#39;meaningful&#39;
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4>        DWARF information section present in the object file.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4>        If not set on some section we claim (later) that there
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4>        is no DWARF info present. see &#39;foundDwarf&#39; in this file */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#8be9fd>int</span> duperr,<span style=color:#8be9fd>int</span> emptyerr,<span style=color:#8be9fd>int</span> have_dwarf,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#8be9fd>int</span> havezdebug,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#8be9fd>int</span> <span style=color:#ff79c6>*</span>err)
</span></span></code></pre></div><p>函数功能: 已经确定好某个section是debug相关section的前提下, 填充<code>dbg->de_debug_sections[]</code></p><h4 id=_dwarf_setup>★_dwarf_setup()</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span>                                        
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>_dwarf_setup(Dwarf_Debug dbg, Dwarf_Error <span style=color:#ff79c6>*</span> error)
</span></span></code></pre></div><p>函数功能: 填充dbg中与debug section相关的所有信息</p><p>函数流程:</p><ol><li>填充dbg中一些字段, 无关紧要</li><li>申请所有section的 <code>struct Dwarf_Section_s</code></li><li>循环elf中所有的section, 每次index+1</li><li>调用<code>get_section_info()</code>, 获取该段的信息, 存入<code>struct Dwarf_Obj_Access_Section_s</code></li><li>通过名称对比此段是否与dwarf相关, 若非dwarf相关段, 则返回step3 继续解析下一个段头</li><li>若属于dwarf相关段, 则将其相关信息添加到<code>dbg->debug_sections[]</code>数组中</li><li>返回step3进行下一段的初始化</li></ol><h3 id=dwarf_die_delivc>dwarf_die_deliv.c</h3><h4 id=dwarf_next_cu_header_d>dwarf_next_cu_header_d()</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>int</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#50fa7b>dwarf_next_cu_header_d</span>(Dwarf_Debug dbg,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    Dwarf_Bool is_info,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    Dwarf_Unsigned <span style=color:#ff79c6>*</span> cu_header_length,   <span style=color:#6272a4>// Returns the length of the just-read CU header.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4></span>    Dwarf_Half <span style=color:#ff79c6>*</span> version_stamp, <span style=color:#ff79c6>//</span> Returns the version number (<span style=color:#bd93f9>2</span> to <span style=color:#bd93f9>5</span>) of the CU header
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    Dwarf_Unsigned <span style=color:#ff79c6>*</span> abbrev_offset, <span style=color:#6272a4>// Returns the .debug_abbrev offset from the the CU header
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4></span>    Dwarf_Half <span style=color:#ff79c6>*</span> address_size, <span style=color:#6272a4>// Returns the address size specified for this CU, usually either 4 or 8.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span>    Dwarf_Half <span style=color:#ff79c6>*</span> offset_size, <span style=color:#6272a4>// Returns the offset size (the length of the size field from the header) specified for this CU
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>    Dwarf_Half <span style=color:#ff79c6>*</span> extension_size,  <span style=color:#6272a4>// If the section is standard 64bit DWARF then this value is 4. Else the value is zero.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>    Dwarf_Sig8 <span style=color:#ff79c6>*</span> signature,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    Dwarf_Unsigned <span style=color:#ff79c6>*</span> typeoffset,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    Dwarf_Unsigned <span style=color:#ff79c6>*</span> next_cu_offset,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    Dwarf_Half <span style=color:#ff79c6>*</span> header_cu_type, <span style=color:#6272a4>// Returns DW_UT_compile, or other DW_UT value
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>    Dwarf_Error <span style=color:#ff79c6>*</span> error);
</span></span></code></pre></div><p>函数功能: return information on next CU header</p><p>函数流程:</p><ol><li>计算下一个CU在.debug_info section的offset</li><li>检查下一个CU是否之前被解析过</li><li>如果是第一次解析这个cu, 构造一个<code>Dwarf_CU_Context</code>, 链接到<code>Dwarf_Debug_InfoTypes</code>中</li><li>填充返回参数</li></ol><h3 id=_dwarf_next_die_info_ptr>_dwarf_next_die_info_ptr()</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>_dwarf_next_die_info_ptr(Dwarf_Byte_Ptr die_info_ptr, <span style=color:#6272a4>// start of the DIE
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#6272a4></span>    Dwarf_CU_Context cu_context,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    Dwarf_Byte_Ptr die_info_end,   <span style=color:#6272a4>// end of CU the die belong to
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#6272a4></span>    Dwarf_Byte_Ptr cu_info_start,  <span style=color:#6272a4>// start of CU 
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#6272a4></span>    Dwarf_Bool want_AT_sibling,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    Dwarf_Bool <span style=color:#ff79c6>*</span> has_die_child,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    Dwarf_Byte_Ptr <span style=color:#ff79c6>*</span>next_die_ptr_out,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>    Dwarf_Error <span style=color:#ff79c6>*</span>error)
</span></span></code></pre></div><p>函数功能: 这个函数功能分为两部分, 取决于传入参数<code>want_AT_sibling</code></p><ul><li>if true, 且DIE有<code>AT_sibling</code>属性, 则其返回指向sibling DIE开始位置的指针. 如果没有属性, 则表现的行为像<code>false</code></li><li>if false, 返回指向下一个紧邻的DIE的指针?</li></ul><p>true时的函数流程:</p><ol><li>解析出传入DIE的attr和attrform, while解析到<code>attr=AT_sibling</code>停止</li><li>再根据attrform解析出attr的value, 即 sibling 的 offset</li><li>cu_info_start + offset 即为 sibling 的开始</li></ol><h3 id=dwarf_siblingof_b>dwarf_siblingof_b()</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>int</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#50fa7b>dwarf_siblingof_b</span>(Dwarf_Debug dbg,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    Dwarf_Die die,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    Dwarf_Bool is_info,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    Dwarf_Die <span style=color:#ff79c6>*</span> caller_ret_die, Dwarf_Error <span style=color:#ff79c6>*</span> error)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>{
</span></span></code></pre></div><p>函数功能:</p><ul><li>首先这个函数的功能分为两部分, 如果传入参数<code>die=NULL</code>, 那么函数的功能是返回当前读取cu的DIE_cu;</li><li>如果<code>die!=NULL</code>, 那么函数的功能是返回指定die的sibling DIE</li></ul><p>在<code>die!=NULL</code>时, 函数流程为:</p><ol><li>调用 <code>_dwarf_next_die_info_ptr</code> 得到 sibling的 global offset</li><li>申请一个新的 <code>Dwarf_Die</code>, 填充相应字段</li></ol><h3 id=dwarf_offdie>dwarf_offdie()</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>int</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>dwarf_offdie(Dwarf_Debug dbg,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    Dwarf_Off offset, Dwarf_Die <span style=color:#ff79c6>*</span> new_die, Dwarf_Error <span style=color:#ff79c6>*</span> error)
</span></span></code></pre></div><p>函数功能: 给定一个global offset(不是相对于cu的), 返回其对应的<code>Dwarf_Die</code>描述体.由caller 负责调用<code>dwarf_dealloc()</code>释放空间</p><h2 id=structure>Structure</h2><h3 id=dwarf_error>Dwarf_Error</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>typedef</span> <span style=color:#ff79c6>struct</span> Dwarf_Error_s<span style=color:#ff79c6>*</span>      Dwarf_Error;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>struct</span> Dwarf_Error_s {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#6272a4>/* 等效于error */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    Dwarf_Sword er_errval;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#6272a4>/*  If non-zero the Dwarf_Error_s struct is not malloc&#39;d.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4>        To aid when malloc returns NULL.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4>        If zero a normal dwarf_dealloc will work.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4>        er_static_alloc only accessed by dwarf_alloc.c.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4>        If er_static_alloc is 1 in a Dwarf_Error_s
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4>        struct (set by libdwarf) and client code accidentally
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4>        turns that 0 to zero through a wild
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4>        pointer reference (the field is hidden
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4>        from clients...) then chaos will
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4>        eventually follow.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4>    */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#8be9fd>int</span> er_static_alloc;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>};
</span></span></code></pre></div><h3 id=struct-dwarf_obj_access_section_s>struct Dwarf_Obj_Access_Section_s</h3><p>Used in the get_section interface function</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>struct</span> Dwarf_Obj_Access_Section_s {                                        
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#6272a4>/*  addr is the virtual address of the first byte of                   
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4>        the section data.  Usually zero when the address                   
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4>        makes no sense for a given section. */</span>                             
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    Dwarf_Addr     addr;                                                   
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>                                                                           
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#6272a4>/* Section type. */</span>                                                    
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    Dwarf_Unsigned type;                                                   
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                                                                           
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#6272a4>/* Size in bytes of the section. */</span>                                    
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    Dwarf_Unsigned size;                                                   
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>                                                                           
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#6272a4>/*  Having an accurate section name makes debugging of libdwarf easier.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4>        and is essential to find the .debug_ sections.  */</span>                 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span>    name;                                                   
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#6272a4>/*  Set link to zero if it is meaningless.  If non-zero                
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4>        it should be a link to a rela section or from symtab               
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4>        to strtab.  In Elf it is sh_link. */</span>                               
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    Dwarf_Unsigned link;                                                   
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>                                                                           
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#6272a4>/*  The section header index of the section to which the               
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4>        relocation applies. In Elf it is sh_info. */</span>                       
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    Dwarf_Unsigned info;                                                   
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>                                                                           
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#6272a4>/*  Elf sections that are tables have a non-zero entrysize so          
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4>        the count of entries can be calculated even without                
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#6272a4>        the right structure definition. If your object format              
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#6272a4>        does not have this data leave this zero. */</span>                        
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    Dwarf_Unsigned entrysize;                                              
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>};                                
</span></span></code></pre></div><h3 id=struct-dwarf_section_s>struct Dwarf_Section_s</h3><p>将很多对section相关的描述信息结合到一起</p><ul><li><code>dss_data</code> 指向这个section的起始地址</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>struct</span> Dwarf_Section_s {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    Dwarf_Small <span style=color:#ff79c6>*</span>  dss_data;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    Dwarf_Unsigned dss_size;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#6272a4>/*  dss_index is the section index as things are numbered in
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4>        an object file being read.   An Elf section number. */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    Dwarf_Word     dss_index;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#6272a4>/*  dss_addr is the &#39;section address&#39; which is only
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4>        non-zero for a GNU eh section.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4>        Purpose: to handle DW_EH_PE_pcrel encoding. Leaving
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4>        it zero is fine for non-elf.  */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    Dwarf_Addr     dss_addr;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    Dwarf_Small    dss_data_was_malloc;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#6272a4>/*  is_in_use set during initial object reading to
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4>        detect duplicates. Ignored after setup done. */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    Dwarf_Small    dss_is_in_use;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#6272a4>/*  If this is zdebug, to start  data/size are the
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4>        raw section bytes.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#6272a4>        Initially for all sections dss_data_was_malloc set FALSE
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#6272a4>            and dss_requires_decompress set FALSE.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4>        For zdebug dss_requires_decompress then set TRUE
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#6272a4>        On translation (ie zlib use and malloc)
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4>        Set dss_data dss_size to point to malloc space and
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4>            malloc size.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#6272a4>        Set dss_requires_decompress FALSE
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#6272a4>        Set dss_was_malloc  TRUE */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    Dwarf_Small    dss_requires_decompress;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    <span style=color:#6272a4>/*  For non-elf, leaving the following fields zero
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#6272a4>        will mean they are ignored. */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    <span style=color:#6272a4>/*  dss_link should be zero unless a section has a link
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#6272a4>        to another (sh_link).  Used to access relocation data for
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#6272a4>        a section (and for symtab section, access its strtab). */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    Dwarf_Word     dss_link;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    <span style=color:#6272a4>/*  The following is used when reading .rela sections
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#6272a4>        (such sections appear in some .o files). */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    Dwarf_Half     dss_reloc_index; <span style=color:#6272a4>/* Zero means ignore the reloc fields. */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    Dwarf_Small <span style=color:#ff79c6>*</span>  dss_reloc_data;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>    Dwarf_Unsigned dss_reloc_size;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>    Dwarf_Unsigned dss_reloc_entrysize;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>    Dwarf_Addr     dss_reloc_addr;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    <span style=color:#6272a4>/*  dss_reloc_symtab is the sh_link of a .rela to its .symtab, leave
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#6272a4>        it 0 if non-meaningful. */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    Dwarf_Addr     dss_reloc_symtab;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>    <span style=color:#6272a4>/*  dss_reloc_link should be zero unless a reloc section has a link
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#6272a4>        to another (sh_link).  Used to access the symtab for relocations
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span><span style=color:#6272a4>        a section. */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>    Dwarf_Word     dss_reloc_link;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>    <span style=color:#6272a4>/*  Pointer to the elf symtab, used for elf .rela. Leave it 0
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span><span style=color:#6272a4>        if not relevant. */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>    <span style=color:#ff79c6>struct</span> Dwarf_Section_s <span style=color:#ff79c6>*</span>dss_symtab;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>    <span style=color:#6272a4>/*  dss_name must never be freed, it is a quoted string
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span><span style=color:#6272a4>        in libdwarf. */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>    <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span> dss_name;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>    <span style=color:#6272a4>/* Object section number in object file. */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    <span style=color:#8be9fd>unsigned</span> dss_number;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>    <span style=color:#6272a4>/*  These are elf flags and non-elf object should
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span><span style=color:#6272a4>        just leave these fields zero. Which is essentially
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span><span style=color:#6272a4>        automatic as they are not in
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span><span style=color:#6272a4>        Dwarf_Obj_Access_Section_s.  */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>    Dwarf_Word  dss_flags;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>    Dwarf_Word  dss_addralign;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>};  
</span></span></code></pre></div><h3 id=struct-dwarf_dbg_sect_s>struct Dwarf_dbg_sect_s</h3><p>描述一个debug相关的section</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>struct</span> Dwarf_dbg_sect_s {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#6272a4>/*  Debug section name must not be freed, is quoted string.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4>        This is the name from the object file itself. */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>ds_name;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#6272a4>/* The section number in object section numbering. */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#8be9fd>unsigned</span> ds_number;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#6272a4>/*   Debug section information, points to de_debug_*member
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4>        (or the like) of the dbg struct.  */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>struct</span> Dwarf_Section_s <span style=color:#ff79c6>*</span>ds_secdata;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#8be9fd>int</span> ds_duperr;                     <span style=color:#6272a4>/* Error code for duplicated section */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#8be9fd>int</span> ds_emptyerr;                   <span style=color:#6272a4>/* Error code for empty section */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#8be9fd>int</span> ds_have_dwarf;                 <span style=color:#6272a4>/* Section contains DWARF */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#8be9fd>int</span> ds_have_zdebug;                <span style=color:#6272a4>/* Section compressed. */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>};
</span></span></code></pre></div><h3 id=dwarf_cu_context>Dwarf_CU_Context</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>typedef</span> <span style=color:#ff79c6>struct</span> Dwarf_CU_Context_s <span style=color:#ff79c6>*</span>Dwarf_CU_Context;
</span></span></code></pre></div><p>描述一个CU的内容.</p><p>包含描述 CU header的成员:</p><ul><li>cc_length</li><li>cc_version_stamp</li><li>cc_abbrev_offset</li><li>cc_address_size</li></ul><p><code>cc_debug_offset</code> 是该CU header在section中的offset</p><p><code>cc_dbg</code> 是该CU所属的dbg</p><h3 id=dwarf_debug_infotypes>Dwarf_Debug_InfoTypes</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>typedef</span> <span style=color:#ff79c6>struct</span> Dwarf_Debug_InfoTypes_s <span style=color:#ff79c6>*</span>Dwarf_Debug_InfoTypes;
</span></span></code></pre></div><p>是一个将.debug_info中所有CU组织起来的数据结构</p><ul><li><code>de_cu_context</code> 指向刚刚读取到的CU</li><li><code>de_cu_context_list</code> .debug_info的所有CU链表</li><li><code>de_cu_context_list_end</code> CU链表的结尾</li><li>&mldr;</li></ul><h3 id=dwarf_die>Dwarf_Die</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>typedef</span> <span style=color:#ff79c6>struct</span> Dwarf_Die_s<span style=color:#ff79c6>*</span>        Dwarf_Die;
</span></span></code></pre></div><p>描述一个DIE</p><ul><li><code>di_debug_ptr</code> DIE在section中的offset</li><li><code>di_cu_context</code> DIE所在的cu</li></ul><h3 id=dwarf_abbrev_list>Dwarf_Abbrev_List</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>typedef</span> <span style=color:#ff79c6>struct</span> Dwarf_Abbrev_List_s <span style=color:#ff79c6>*</span>Dwarf_Abbrev_List;
</span></span></code></pre></div><p>描述每个缩写</p><ul><li><code>abl_code</code> abbreviation code, unsigned LEB128编码</li><li><code>abl_tag</code> unsigned LEB128编码, 对应DIE的tag</li><li><code>abl_has_child</code> 指代此DIE是否有子项</li><li><code>abl_abbrev_ptr</code> Points to start of attribute and form pairs in the .debug_abbrev</li></ul><h2 id=其他联动方式>其他联动方式</h2><h3 id=struct-dwarf_dbg_sect_s-和-struct-dwarf_section_s-之间的关系>struct Dwarf_dbg_sect_s 和 struct Dwarf_Section_s 之间的关系</h3><p><code>Dwarf_dbg_sect_s</code> 是外层, 其成员 <code>ds_secdata</code>指向一个<code>Dwarf_Section_s</code>.</p><p>除此之外, 它还包含, 描述section number, 是否包含dwarf信息等成员.</p><h3 id=dwarf_debug-和-其拥有的-struct-dwarf_dbg_sect_s之间的关系>Dwarf_Debug 和 其拥有的 struct Dwarf_dbg_sect_s之间的关系</h3><p>Dwarf_Debug 中的成员<code>de_debug_sections</code>记录了加载的所有debug相关section, 成员<code>de_debug_sections_total_entries</code> 代表加载的section数量.</p><p>同时, Dwarf_Debug 的成员 <code>de_debug_xxx</code> 是 <code>struct Dwarf_Section_s</code> 类型的, 按照名称记录各个section, 方便直接访问, 不需要遍历 <code>de_debug_sections</code> 来查询</p><h3 id=动态申请的空间何时释放>动态申请的空间何时释放?</h3><p>我们经常会用到例如 <code>dwarf_offdie()</code>, <code>dwarf_attr()</code> 等接口来返回一个特定的dwarf相关结构. 在其中都调用了 <code>_dwarf_get_alloc()</code> 使用操作系统提供的动态内存分配算法申请一块空间, 那么是否需要我们来控制释放这些空间呢?</p><p>某些API的描述中说, 只要是使用<code>_dwarf_get_alloc</code>使用的空间, 必须由用户显式调用<code>dwarf_dealloc()</code> 释放. 在这个版本的libdwarf中, 这个过程其实是不必要的.</p><p>因为在<code>_dwarf_get_alloc()</code>中其实会将申请的空间记录在 Dwarf_Debug的成员de_alloc_tree中. 所以在<code>dwarf_finish()</code>中会遍历树, 将这些空间依次释放, 所以其实不显式的调用<code>dwarf_dealloc()</code>也不会造成内存泄漏.</p></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2023-05-07T14:51:49, Lastmod: 2024-01-04T16:59:55</p></main></div></body></html>