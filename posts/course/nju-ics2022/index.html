<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>课程笔记：NJU ICS2022</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e6%9e%84%e5%bb%ba%e7%b3%bb%e7%bb%9f aria-label=构建系统>构建系统</a><ul><li><a href=#%e7%bc%96%e8%af%91guest%e7%a8%8b%e5%ba%8f%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90 aria-label=编译Guest程序流程分析>编译Guest程序流程分析</a></li><li><a href=#am%e7%9a%84%e6%9e%84%e5%bb%ba%e6%80%9d%e8%b7%af aria-label=AM的构建思路>AM的构建思路</a></li></ul></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>课程笔记：NJU ICS2022</div></header><p>ISA: RISCV32</p><h2 id=构建系统>构建系统</h2><h3 id=编译guest程序流程分析>编译Guest程序流程分析</h3><p>编译dummy可执行文件的命令如下，很好奇是如何实现的。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#038>cd</span> am-kernels/am-kernels/tests/cpu-tests
</span></span><span style=display:flex><span>make <span style=color:#369>ARCH</span>=riscv32-nemu <span style=color:#369>ALL</span>=dummy
</span></span></code></pre></div><p>既然在当前目录执行make，自然先从 <code>am-kernels/am-kernels/tests/cpu-tests/Makefile</code>开始看起。</p><ul><li><code>ALL</code>默认是所有test的集合，参数指定会覆盖它。</li><li><code>ALL</code>的生成规则属于 <strong>静态规则</strong> ，通配符%代表ALL的全称即依赖Makefile.dummy。<a href=https://seisman.github.io/how-to-write-makefile/rules.html#id8>更多关于静态规则</a></li><li>Makefile.dummy的生成规则也就在下面，这个文件默认是不存在的，需要临时生成</li><li>生成的规则是 <code>echo -e "NAME = dummy\nSRCS = tests/dummy.c\ninclude $${AM_HOME}/Makefile" > $@</code>。包含了AM_HOME下的Makefile</li><li>AM是各个平台版本可执行文件的“制造机”，理念是将平台信息传入，生成指定格式的镜像。运行时库也包含在内。</li><li>最后就是执行 <code>make -f</code> 去调用刚才生成的临时Makefile.dummy，传入指定参数</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#369>ALL</span> = <span style=color:#080;font-weight:700>$(</span>basename <span style=color:#080;font-weight:700>$(</span>notdir <span style=color:#080;font-weight:700>$(</span>shell find tests/. -name <span style=color:#d20;background-color:#fff0f0>&#34;*.c&#34;</span><span style=color:#080;font-weight:700>)))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#06b;font-weight:700>all</span>: <span style=color:#080;font-weight:700>$(</span><span style=color:#369>addprefix</span> <span style=color:#369>Makefile</span>., <span style=color:#080;font-weight:700>$(</span><span style=color:#369>ALL</span><span style=color:#080;font-weight:700>))</span>
</span></span><span style=display:flex><span>	@echo <span style=color:#d20;background-color:#fff0f0>&#34;test list [</span><span style=color:#080;font-weight:700>$(</span>words <span style=color:#080;font-weight:700>$(</span>ALL<span style=color:#080;font-weight:700>))</span><span style=color:#d20;background-color:#fff0f0> item(s)]:&#34;</span> <span style=color:#080;font-weight:700>$(</span>ALL<span style=color:#080;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#06b;font-weight:700>$(ALL)</span>: %: Makefile.%
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#06b;font-weight:700>Makefile.%</span>: tests/%.c latest
</span></span><span style=display:flex><span>	@/bin/echo -e <span style=color:#d20;background-color:#fff0f0>&#34;NAME = </span><span style=color:#369>$*</span><span style=color:#d20;background-color:#fff0f0>\nSRCS = </span>$<span style=color:#d20;background-color:#fff0f0>&lt;\ninclude </span><span style=color:#369>$$</span><span style=color:#d20;background-color:#fff0f0>{AM_HOME}/Makefile&#34;</span> &gt; <span style=color:#369>$@</span>
</span></span><span style=display:flex><span>	@if make -s -f <span style=color:#369>$@</span> <span style=color:#369>ARCH</span>=<span style=color:#080;font-weight:700>$(</span>ARCH<span style=color:#080;font-weight:700>)</span> <span style=color:#080;font-weight:700>$(</span>MAKECMDGOALS<span style=color:#080;font-weight:700>)</span>; <span style=color:#080;font-weight:700>then</span> <span style=color:#04d;background-color:#fff0f0>\
</span></span></span><span style=display:flex><span><span style=color:#04d;background-color:#fff0f0></span>		<span style=color:#038>printf</span> <span style=color:#d20;background-color:#fff0f0>&#34;[%14s] </span><span style=color:#080;font-weight:700>$(</span>COLOR_GREEN<span style=color:#080;font-weight:700>)</span><span style=color:#d20;background-color:#fff0f0>PASS</span><span style=color:#080;font-weight:700>$(</span>COLOR_NONE<span style=color:#080;font-weight:700>)</span><span style=color:#d20;background-color:#fff0f0>\n&#34;</span> <span style=color:#369>$*</span> &gt;&gt; <span style=color:#080;font-weight:700>$(</span>RESULT<span style=color:#080;font-weight:700>)</span>; <span style=color:#04d;background-color:#fff0f0>\
</span></span></span><span style=display:flex><span><span style=color:#04d;background-color:#fff0f0></span>	<span style=color:#080;font-weight:700>else</span> <span style=color:#04d;background-color:#fff0f0>\
</span></span></span><span style=display:flex><span><span style=color:#04d;background-color:#fff0f0></span>		<span style=color:#038>printf</span> <span style=color:#d20;background-color:#fff0f0>&#34;[%14s] </span><span style=color:#080;font-weight:700>$(</span>COLOR_RED<span style=color:#080;font-weight:700>)</span><span style=color:#d20;background-color:#fff0f0>***FAIL***</span><span style=color:#080;font-weight:700>$(</span>COLOR_NONE<span style=color:#080;font-weight:700>)</span><span style=color:#d20;background-color:#fff0f0>\n&#34;</span> <span style=color:#369>$*</span> &gt;&gt; <span style=color:#080;font-weight:700>$(</span>RESULT<span style=color:#080;font-weight:700>)</span>; <span style=color:#04d;background-color:#fff0f0>\
</span></span></span><span style=display:flex><span><span style=color:#04d;background-color:#fff0f0></span>	<span style=color:#080;font-weight:700>fi</span>
</span></span><span style=display:flex><span>	-@rm -f Makefile.<span style=color:#369>$*</span>
</span></span></code></pre></div><p>目前为止大概的思路还算比较清晰：</p><ol><li>生成 <code>Makefile.dummy</code></li><li>执行它，传递命令行参数（<code>$(MAKECMDGOALS)</code>）</li></ol><p><code>Makefile.dummy</code> 是一个临时文件，编译命令执行后会被删除。注销删除命令，直接打开看它的内容。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#369>NAME</span> = dummy
</span></span><span style=display:flex><span><span style=color:#369>SRCS</span> = tests/dummy.c
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>include</span> <span style=color:#a61717;background-color:#e3d2d2>/home/soben/ics2023/abstract-machine/Makefile</span>
</span></span></code></pre></div><p>需要结合AM_HOME下的Makefile去理解了。
这么来看AM的构建系统像是一个“加工厂”，<strong>在软件设计术语叫“模板“</strong>。</p><ul><li>外部传入加工零件的要求（ARCH、NAME、SRCS&mldr;）</li><li>输出对应需求的产品（可执行文件）。</li><li>既可以要求它将我们传入的源文件编译成native架构下可执行文件，或者是NEMU、QEMU这类模拟器上。</li></ul><h3 id=am的构建思路>AM的构建思路</h3><style type=text/css>.notice{--root-color:#444;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#c33;--warning-content:#fee;--info-title:#fb7;--info-content:#fec;--note-title:#6be;--note-content:#e7f2fa;--tip-title:#5a5;--tip-content:#efe}@media(prefers-color-scheme:dark){.notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}}body.dark .notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--root-color);background:var(--root-background)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background)}.notice.warning .notice-title{background:var(--warning-title)}.notice.warning{background:var(--warning-content)}.notice.info .notice-title{background:var(--info-title)}.notice.info{background:var(--info-content)}.notice.note .notice-title{background:var(--note-title)}.notice.note{background:var(--note-content)}.notice.tip .notice-title{background:var(--tip-title)}.notice.tip{background:var(--tip-content)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div class="notice tip" id=帮助理解AM的Makefile><p class=notice-title><span class="icon-notice baseline"><svg xmlns="http://www.w3.org/2000/svg" viewBox="300.5 134 300 300"><path d="M551.281 252.36c0-3.32-1.172-6.641-3.515-8.985l-17.774-17.578c-2.344-2.344-5.469-3.711-8.789-3.711-3.32.0-6.445 1.367-8.789 3.71l-79.687 79.493-44.141-44.14c-2.344-2.344-5.469-3.712-8.79-3.712-3.32.0-6.444 1.368-8.788 3.711l-17.774 17.579c-2.343 2.343-3.515 5.664-3.515 8.984s1.172 6.445 3.515 8.789l70.704 70.703c2.343 2.344 5.664 3.711 8.789 3.711 3.32.0 6.64-1.367 8.984-3.71l106.055-106.056c2.343-2.343 3.515-5.468 3.515-8.789zM600.5 284c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg></span><span>帮助理解AM的Makefile</span></p><p>AM_HOME/Makefile 有命令转化makefile为html文件，帮助理解。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#888>### *Get a more readable version of this Makefile* by `make html` (requires python-markdown)
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#06b;font-weight:700>html</span>:
</span></span><span style=display:flex><span>	cat Makefile | sed <span style=color:#d20;background-color:#fff0f0>&#39;s/^\([^#]\)/    \1/g&#39;</span> | markdown_py &gt; Makefile.html
</span></span><span style=display:flex><span><span style=color:#06b;font-weight:700>.PHONY</span>: html
</span></span></code></pre></div></div><p>上面说过，AM的构建系统是一个模版，将源文件编译，使其能运行在指定的平台上。
甚至，运行时库也是集成到AM中的，最大程度上减少重复劳动。</p><p>下面是Makefile的源代码，我们选取关键的部分进行拆解。</p><ol><li>提前说明，传入的参数有ARCH、NAME、SRCS，剩余参数在$(MAKECMDGOALS)</li><li>环境检查（clean、html命令跳过）</li><li>从参数ARCH中分离出ISA和PLATFORM</li><li>设置编译器和编译选项</li><li>引入和ISA、Platform相关的一些规则，<strong>include <code>scripts/$ARCH.mk</code></strong>，下面会详细分析</li><li>一些通用的编译目标规则，比如.c/.S如何生成.o</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#888>## 1. Basic Setup and Checks
</span></span></span><span style=display:flex><span><span style=color:#888></span>
</span></span><span style=display:flex><span><span style=color:#888>### Default to create a bare-metal kernel image
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#a61717;background-color:#e3d2d2>ifeq</span> <span style=color:#a61717;background-color:#e3d2d2>(</span><span style=color:#080;font-weight:700>$(</span><span style=color:#369>MAKECMDGOALS</span><span style=color:#080;font-weight:700>)</span><span style=color:#a61717;background-color:#e3d2d2>,)</span>
</span></span><span style=display:flex><span>  <span style=color:#369>MAKECMDGOALS</span>  = image
</span></span><span style=display:flex><span>  .DEFAULT_GOAL = image
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>endif</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>### Override checks when `make clean/clean-all/html`
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#a61717;background-color:#e3d2d2>ifeq</span> <span style=color:#a61717;background-color:#e3d2d2>(</span><span style=color:#080;font-weight:700>$(</span><span style=color:#369>findstring</span> <span style=color:#080;font-weight:700>$(</span><span style=color:#369>MAKECMDGOALS</span><span style=color:#080;font-weight:700>)</span>,<span style=color:#369>clean</span>|<span style=color:#369>clean</span>-<span style=color:#369>all</span>|<span style=color:#369>html</span><span style=color:#080;font-weight:700>)</span><span style=color:#a61717;background-color:#e3d2d2>,)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888># 其他的检查暂时省略...
</span></span></span><span style=display:flex><span><span style=color:#888></span>
</span></span><span style=display:flex><span><span style=color:#888>### Extract instruction set architecture (`ISA`) and platform from `$ARCH`. Example: `ARCH=x86_64-qemu -&gt; ISA=x86_64; PLATFORM=qemu`
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#369>ARCH_SPLIT</span> = <span style=color:#080;font-weight:700>$(</span>subst -, ,<span style=color:#080;font-weight:700>$(</span>ARCH<span style=color:#080;font-weight:700>))</span>
</span></span><span style=display:flex><span><span style=color:#369>ISA</span>        = <span style=color:#080;font-weight:700>$(</span>word 1,<span style=color:#080;font-weight:700>$(</span>ARCH_SPLIT<span style=color:#080;font-weight:700>))</span>
</span></span><span style=display:flex><span><span style=color:#369>PLATFORM</span>   = <span style=color:#080;font-weight:700>$(</span>word 2,<span style=color:#080;font-weight:700>$(</span>ARCH_SPLIT<span style=color:#080;font-weight:700>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>### Check if there is something to build
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#a61717;background-color:#e3d2d2>ifeq</span> <span style=color:#a61717;background-color:#e3d2d2>(</span><span style=color:#080;font-weight:700>$(</span><span style=color:#369>flavor</span> <span style=color:#369>SRCS</span><span style=color:#080;font-weight:700>)</span><span style=color:#a61717;background-color:#e3d2d2>,</span> <span style=color:#a61717;background-color:#e3d2d2>undefined)</span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-weight:700>$(</span><span style=color:#369>error</span> <span style=color:#369>Nothing</span> <span style=color:#369>to</span> <span style=color:#369>build</span><span style=color:#080;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>endif</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>### Checks end here
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#a61717;background-color:#e3d2d2>endif</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>## 2. General Compilation Targets
</span></span></span><span style=display:flex><span><span style=color:#888></span>
</span></span><span style=display:flex><span><span style=color:#888>### Compilation targets (a binary image or archive)
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#369>IMAGE_REL</span> = build/<span style=color:#080;font-weight:700>$(</span>NAME<span style=color:#080;font-weight:700>)</span>-<span style=color:#080;font-weight:700>$(</span>ARCH<span style=color:#080;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#369>IMAGE</span>     = <span style=color:#080;font-weight:700>$(</span>abspath <span style=color:#080;font-weight:700>$(</span>IMAGE_REL<span style=color:#080;font-weight:700>))</span>
</span></span><span style=display:flex><span><span style=color:#369>ARCHIVE</span>   = <span style=color:#080;font-weight:700>$(</span>WORK_DIR<span style=color:#080;font-weight:700>)</span>/build/<span style=color:#080;font-weight:700>$(</span>NAME<span style=color:#080;font-weight:700>)</span>-<span style=color:#080;font-weight:700>$(</span>ARCH<span style=color:#080;font-weight:700>)</span>.a
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>### Collect the files to be linked: object files (`.o`) and libraries (`.a`)
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#369>OBJS</span>      = <span style=color:#080;font-weight:700>$(</span>addprefix <span style=color:#080;font-weight:700>$(</span>DST_DIR<span style=color:#080;font-weight:700>)</span>/, <span style=color:#080;font-weight:700>$(</span>addsuffix .o, <span style=color:#080;font-weight:700>$(</span>basename <span style=color:#080;font-weight:700>$(</span>SRCS<span style=color:#080;font-weight:700>))))</span>
</span></span><span style=display:flex><span><span style=color:#369>LIBS</span>     := <span style=color:#080;font-weight:700>$(</span>sort <span style=color:#080;font-weight:700>$(</span>LIBS<span style=color:#080;font-weight:700>)</span> am klib<span style=color:#080;font-weight:700>)</span> <span style=color:#888># lazy evaluation (&#34;=&#34;) causes infinite recursions</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>## 3. General Compilation Flags
</span></span></span><span style=display:flex><span><span style=color:#888># 省略：编译器和编译选项
</span></span></span><span style=display:flex><span><span style=color:#888></span>
</span></span><span style=display:flex><span><span style=color:#888>## 4. Arch-Specific Configurations
</span></span></span><span style=display:flex><span><span style=color:#888></span>
</span></span><span style=display:flex><span><span style=color:#888>### Paste in arch-specific configurations (e.g., from `scripts/x86_64-qemu.mk`)
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#a61717;background-color:#e3d2d2>-include</span> <span style=color:#080;font-weight:700>$(</span><span style=color:#369>AM_HOME</span><span style=color:#080;font-weight:700>)</span><span style=color:#a61717;background-color:#e3d2d2>/scripts/</span><span style=color:#080;font-weight:700>$(</span><span style=color:#369>ARCH</span><span style=color:#080;font-weight:700>)</span><span style=color:#a61717;background-color:#e3d2d2>.mk</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>### Fall back to native gcc/binutils if there is no cross compiler
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#a61717;background-color:#e3d2d2>ifeq</span> <span style=color:#a61717;background-color:#e3d2d2>(</span><span style=color:#080;font-weight:700>$(</span><span style=color:#369>wildcard</span> <span style=color:#080;font-weight:700>$(</span><span style=color:#369>shell</span> <span style=color:#369>which</span> <span style=color:#080;font-weight:700>$(</span><span style=color:#369>CC</span><span style=color:#080;font-weight:700>)))</span><span style=color:#a61717;background-color:#e3d2d2>,)</span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-weight:700>$(</span><span style=color:#369>info</span> #  <span style=color:#080;font-weight:700>$(</span><span style=color:#369>CC</span><span style=color:#080;font-weight:700>)</span> <span style=color:#369>not</span> <span style=color:#369>found</span>; <span style=color:#369>fall</span> <span style=color:#369>back</span> <span style=color:#369>to</span> <span style=color:#369>default</span> <span style=color:#369>gcc</span> <span style=color:#369>and</span> <span style=color:#369>binutils</span><span style=color:#080;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#369>CROSS_COMPILE</span> :=
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>endif</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>## 5. Compilation Rules
</span></span></span><span style=display:flex><span><span style=color:#888></span>
</span></span><span style=display:flex><span><span style=color:#888>### Rule (compile): a single `.c` -&gt; `.o` (gcc)
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#06b;font-weight:700>$(DST_DIR)/%.o</span>: %.c
</span></span><span style=display:flex><span>	@mkdir -p <span style=color:#080;font-weight:700>$(</span>dir <span style=color:#369>$@</span><span style=color:#080;font-weight:700>)</span> &amp;&amp; <span style=color:#038>echo</span> + CC $&lt;
</span></span><span style=display:flex><span>	@<span style=color:#080;font-weight:700>$(</span>CC<span style=color:#080;font-weight:700>)</span> -std=gnu11 <span style=color:#080;font-weight:700>$(</span>CFLAGS<span style=color:#080;font-weight:700>)</span> -c -o <span style=color:#369>$@</span> <span style=color:#080;font-weight:700>$(</span>realpath $&lt;<span style=color:#080;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888># 省略：一些其他的通用规则
</span></span></span><span style=display:flex><span><span style=color:#888></span>
</span></span><span style=display:flex><span><span style=color:#888>### Rule (recursive make): build a dependent library (am, klib, ...)
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#06b;font-weight:700>$(LIBS)</span>: %:
</span></span><span style=display:flex><span>	@<span style=color:#080;font-weight:700>$(</span>MAKE<span style=color:#080;font-weight:700>)</span> -s -C <span style=color:#080;font-weight:700>$(</span>AM_HOME<span style=color:#080;font-weight:700>)</span>/<span style=color:#369>$*</span> archive
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>### Rule (link): objects (`*.o`) and libraries (`*.a`) -&gt; `IMAGE.elf`, the final ELF binary to be packed into image (ld)
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#06b;font-weight:700>$(IMAGE).elf</span>: <span style=color:#080;font-weight:700>$(</span><span style=color:#369>OBJS</span><span style=color:#080;font-weight:700>)</span> <span style=color:#080;font-weight:700>$(</span><span style=color:#369>LIBS</span><span style=color:#080;font-weight:700>)</span>
</span></span><span style=display:flex><span>	@echo + LD <span style=color:#d20;background-color:#fff0f0>&#34;-&gt;&#34;</span> <span style=color:#080;font-weight:700>$(</span>IMAGE_REL<span style=color:#080;font-weight:700>)</span>.elf
</span></span><span style=display:flex><span>	@<span style=color:#080;font-weight:700>$(</span>LD<span style=color:#080;font-weight:700>)</span> <span style=color:#080;font-weight:700>$(</span>LDFLAGS<span style=color:#080;font-weight:700>)</span> -o <span style=color:#080;font-weight:700>$(</span>IMAGE<span style=color:#080;font-weight:700>)</span>.elf --start-group <span style=color:#080;font-weight:700>$(</span>LINKAGE<span style=color:#080;font-weight:700>)</span> --end-group
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>### Rule (archive): objects (`*.o`) -&gt; `ARCHIVE.a` (ar)
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#06b;font-weight:700>$(ARCHIVE)</span>: <span style=color:#080;font-weight:700>$(</span><span style=color:#369>OBJS</span><span style=color:#080;font-weight:700>)</span>
</span></span><span style=display:flex><span>	@echo + AR <span style=color:#d20;background-color:#fff0f0>&#34;-&gt;&#34;</span> <span style=color:#080;font-weight:700>$(</span>shell realpath <span style=color:#369>$@</span> --relative-to .<span style=color:#080;font-weight:700>)</span>
</span></span><span style=display:flex><span>	@<span style=color:#080;font-weight:700>$(</span>AR<span style=color:#080;font-weight:700>)</span> rcs <span style=color:#080;font-weight:700>$(</span>ARCHIVE<span style=color:#080;font-weight:700>)</span> <span style=color:#080;font-weight:700>$(</span>OBJS<span style=color:#080;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>### Rule (`#include` dependencies): paste in `.d` files generated by gcc on `-MMD`
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#a61717;background-color:#e3d2d2>-include</span> <span style=color:#080;font-weight:700>$(</span><span style=color:#369>addprefix</span> <span style=color:#080;font-weight:700>$(</span><span style=color:#369>DST_DIR</span><span style=color:#080;font-weight:700>)</span>/, <span style=color:#080;font-weight:700>$(</span><span style=color:#369>addsuffix</span> .<span style=color:#369>d</span>, <span style=color:#080;font-weight:700>$(</span><span style=color:#369>basename</span> <span style=color:#080;font-weight:700>$(</span><span style=color:#369>SRCS</span><span style=color:#080;font-weight:700>))))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>## 6. Miscellaneous
</span></span></span><span style=display:flex><span><span style=color:#888></span>
</span></span><span style=display:flex><span><span style=color:#888>### Build order control
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#06b;font-weight:700>image</span>: image-dep
</span></span><span style=display:flex><span><span style=color:#06b;font-weight:700>archive</span>: <span style=color:#080;font-weight:700>$(</span><span style=color:#369>ARCHIVE</span><span style=color:#080;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#06b;font-weight:700>image-dep</span>: <span style=color:#080;font-weight:700>$(</span><span style=color:#369>OBJS</span><span style=color:#080;font-weight:700>)</span> <span style=color:#080;font-weight:700>$(</span><span style=color:#369>LIBS</span><span style=color:#080;font-weight:700>)</span>
</span></span><span style=display:flex><span>	@echo <span style=color:#04d;background-color:#fff0f0>\#</span> Creating image [<span style=color:#080;font-weight:700>$(</span>ARCH<span style=color:#080;font-weight:700>)</span>]
</span></span><span style=display:flex><span><span style=color:#06b;font-weight:700>.PHONY</span>: image image-dep archive run <span style=color:#080;font-weight:700>$(</span><span style=color:#369>LIBS</span><span style=color:#080;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>### Clean a single project (remove `build/`)
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#06b;font-weight:700>clean</span>:
</span></span><span style=display:flex><span>	rm -rf Makefile.html <span style=color:#080;font-weight:700>$(</span>WORK_DIR<span style=color:#080;font-weight:700>)</span>/build/
</span></span><span style=display:flex><span><span style=color:#06b;font-weight:700>.PHONY</span>: clean
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>### Clean all sub-projects within depth 2 (and ignore errors)
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#369>CLEAN_ALL</span> = <span style=color:#080;font-weight:700>$(</span>dir <span style=color:#080;font-weight:700>$(</span>shell find . -mindepth <span style=color:#00d;font-weight:700>2</span> -name Makefile<span style=color:#080;font-weight:700>))</span>
</span></span><span style=display:flex><span><span style=color:#06b;font-weight:700>clean-all</span>: <span style=color:#080;font-weight:700>$(</span><span style=color:#369>CLEAN_ALL</span><span style=color:#080;font-weight:700>)</span> clean
</span></span><span style=display:flex><span><span style=color:#06b;font-weight:700>$(CLEAN_ALL)</span>:
</span></span><span style=display:flex><span>	-@<span style=color:#080;font-weight:700>$(</span>MAKE<span style=color:#080;font-weight:700>)</span> -s -C <span style=color:#369>$@</span> clean
</span></span><span style=display:flex><span><span style=color:#06b;font-weight:700>.PHONY</span>: clean-all <span style=color:#080;font-weight:700>$(</span><span style=color:#369>CLEAN_ALL</span><span style=color:#080;font-weight:700>)</span>
</span></span></code></pre></div><p>$ARCH.mk 文件规定一些架构、运行平台相关的选项：</p><ul><li>架构相关的：比如说交叉编译器是啥，和特殊的CFLAGS(<code>-march</code>)</li><li>平台相关的：因为命令行参数可以添加如<code>run</code>，编译完后直接运行，此时需要提前将平台准备好，编译好NEMU。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>include</span> <span style=color:#080;font-weight:700>$(</span><span style=color:#369>AM_HOME</span><span style=color:#080;font-weight:700>)</span><span style=color:#a61717;background-color:#e3d2d2>/scripts/isa/riscv.mk</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>include</span> <span style=color:#080;font-weight:700>$(</span><span style=color:#369>AM_HOME</span><span style=color:#080;font-weight:700>)</span><span style=color:#a61717;background-color:#e3d2d2>/scripts/platform/nemu.mk</span>
</span></span><span style=display:flex><span><span style=color:#369>CFLAGS</span>  += -DISA_H=<span style=color:#04d;background-color:#fff0f0>\&#34;</span>riscv/riscv.h<span style=color:#04d;background-color:#fff0f0>\&#34;</span>
</span></span><span style=display:flex><span><span style=color:#369>COMMON_CFLAGS</span> += -march=rv32im_zicsr -mabi=ilp32   <span style=color:#888># overwrite</span>
</span></span><span style=display:flex><span><span style=color:#369>LDFLAGS</span>       += -melf32lriscv                     <span style=color:#888># overwrite</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#369>AM_SRCS</span> += riscv/nemu/start.S <span style=color:#04d;background-color:#fff0f0>\
</span></span></span><span style=display:flex><span><span style=color:#04d;background-color:#fff0f0></span>           riscv/nemu/cte.c <span style=color:#04d;background-color:#fff0f0>\
</span></span></span><span style=display:flex><span><span style=color:#04d;background-color:#fff0f0></span>           riscv/nemu/trap.S <span style=color:#04d;background-color:#fff0f0>\
</span></span></span><span style=display:flex><span><span style=color:#04d;background-color:#fff0f0></span>           riscv/nemu/vme.c
</span></span></code></pre></div></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2024-04-16T19:28:12, Lastmod: 2024-04-17T23:52:53</p><script src=/js/clipboard.js></script></main></div></body></html>