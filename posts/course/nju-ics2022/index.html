<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/syntax_pastie.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>课程笔记：NJU ICS2022</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%bc%96%e8%af%91%e4%b8%80%e4%b8%aa%e5%ae%a2%e6%88%b7%e7%a8%8b%e5%ba%8f aria-label=编译一个客户程序>编译一个客户程序</a><ul><li><a href=#%e5%86%85%e5%ad%98%e5%b8%83%e5%b1%80 aria-label=内存布局>内存布局</a></li></ul></li><li><a href=#difftest-%e7%9a%84%e8%ae%be%e8%ae%a1%e7%90%86%e5%bf%b5 aria-label="Difftest 的设计理念">Difftest 的设计理念</a></li><li><a href=#%e6%9e%84%e5%bb%ba%e7%b3%bb%e7%bb%9f aria-label=构建系统>构建系统</a><ul><li><a href=#%e7%bc%96%e8%af%91guest%e7%a8%8b%e5%ba%8f%e5%b9%b6%e8%bf%bd%e5%8a%a0%e5%8f%82%e6%95%b0 aria-label=编译Guest程序并追加参数>编译Guest程序并追加参数</a></li><li><a href=#%e7%bc%96%e8%af%91guest%e7%a8%8b%e5%ba%8f%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90 aria-label=编译Guest程序流程分析>编译Guest程序流程分析</a></li><li><a href=#am%e7%9a%84%e6%9e%84%e5%bb%ba%e6%80%9d%e8%b7%af aria-label=AM的构建思路>AM的构建思路</a></li></ul></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>课程笔记：NJU ICS2022</div></header><p>ISA: RISCV32</p><h2 id=编译一个客户程序>编译一个客户程序</h2><h3 id=内存布局>内存布局</h3><p>貌似所有的格式，所有的平台都使用同一个链接脚本。</p><ul><li>栈空间在ELF中预留，好处是统一，缺点是增加了ELF的大小。</li><li>bss跟在数据段后面，导致数据段的filesz和memsz可能不同。NanOS是加载APP的时候，load segment时直接清零，而不是需要单独遍历一下bss，更加方便。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>ENTRY</span><span class=p>(</span><span class=n>_start</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>PHDRS</span> <span class=p>{</span> <span class=n>text</span> <span class=n>PT_LOAD</span><span class=p>;</span> <span class=n>data</span> <span class=n>PT_LOAD</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SECTIONS</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* _pmem_start and _entry_offset are defined in LDFLAGS */</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span> <span class=o>=</span> <span class=n>_pmem_start</span> <span class=o>+</span> <span class=n>_entry_offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nl>text</span> <span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>text</span><span class=o>*</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>:</span> <span class=n>text</span>
</span></span><span class=line><span class=cl>  <span class=n>etext</span> <span class=o>=</span> <span class=p>.;</span>
</span></span><span class=line><span class=cl>  <span class=n>_etext</span> <span class=o>=</span> <span class=p>.;</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nl>rodata</span> <span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>rodata</span><span class=o>*</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nl>data</span> <span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>:</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>  <span class=n>edata</span> <span class=o>=</span> <span class=p>.;</span>
</span></span><span class=line><span class=cl>  <span class=n>_data</span> <span class=o>=</span> <span class=p>.;</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nl>bss</span> <span class=p>:</span> <span class=p>{</span>  <span class=cm>/* bss段跟在.data的后面，会被放入同一个segment，所以加载时需要清零 */</span>
</span></span><span class=line><span class=cl>	<span class=n>_bss_start</span> <span class=o>=</span> <span class=p>.;</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>bss</span><span class=o>*</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>sbss</span><span class=o>*</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>scommon</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* 栈空间在ELF中定义 */</span>
</span></span><span class=line><span class=cl>  <span class=n>_stack_top</span> <span class=o>=</span> <span class=n>ALIGN</span><span class=p>(</span><span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span> <span class=o>=</span> <span class=n>_stack_top</span> <span class=o>+</span> <span class=mh>0x8000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>_stack_pointer</span> <span class=o>=</span> <span class=p>.;</span>
</span></span><span class=line><span class=cl>  <span class=n>end</span> <span class=o>=</span> <span class=p>.;</span>
</span></span><span class=line><span class=cl>  <span class=n>_end</span> <span class=o>=</span> <span class=p>.;</span>
</span></span><span class=line><span class=cl>  <span class=n>_heap_start</span> <span class=o>=</span> <span class=n>ALIGN</span><span class=p>(</span><span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=difftest-的设计理念>Difftest 的设计理念</h2><p>揭开Difftest的魔法。</p><p>进行DiffTest需要提供一个和DUT(Design Under Test, 测试对象) 功能相同但实现方式不同的REF(Reference, 参考实现), 然后让它们接受相同的有定义的输入, 观测它们的行为是否相同.</p><p>拿NEMU作为DUT，Spike作为REF来说，Difftest的原理就是：</p><ol><li>微调REF，使得两者初始化环境相同，同时输入的客户机程序也相同。</li><li>DUT执行一条指令</li><li>发送信号让REF执行一条指令。</li><li>拷贝REF的运行环境（寄存器）到DUT中</li><li>在DUT中检查是否一致。</li><li>DUT和REF继续执行指令，直至客户程序结束</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// (1) 如何保证两者初始环境相同？
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>init_difftest</span><span class=p>()</span> <span class=c1>// NEMU
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>=&gt;</span> <span class=n>dlopen</span><span class=p>()</span>  <span class=c1>// 打开REF的动态链接库（Spike）
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>=&gt;</span> <span class=n>dlsym</span><span class=p>()</span>   <span class=c1>// 过动态链接对动态库中的上述API符号进行符号解析和重定位
</span></span></span><span class=line><span class=cl><span class=c1></span>               <span class=c1>// 返回REF中函数的地址，可以在DUT里强制调用
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>=&gt;</span> <span class=n>ref_difftest_init</span><span class=p>()</span> <span class=c1>// REF初始化，等待DUT的命令
</span></span></span><span class=line><span class=cl><span class=c1></span>                         <span class=c1>// Spike怎么做的不清楚，但是QEMU是用Gdb监听，DUT给Gdb发命令
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>=&gt;</span> <span class=n>ref_difftest_memcpy</span><span class=p>()</span> <span class=c1>// 将DUT的guest memory拷贝到REF中
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>=&gt;</span> <span class=n>ref_difftest_regcpy</span><span class=p>()</span> <span class=c1>// 将DUT的寄存器状态拷贝到REF中
</span></span></span><span class=line><span class=cl><span class=c1>// (2) DUT执行一条指令
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>exec_once</span><span class=p>()</span> 
</span></span><span class=line><span class=cl><span class=c1>// (3) 并让REF也执行指令，比较结果
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>difftest_step</span><span class=p>()</span> 
</span></span><span class=line><span class=cl>  <span class=o>=&gt;</span> <span class=n>ref_difftest_exec</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=c1>// REF执行一条指令，QEMU来说就是让Gdb发送一条si命令
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>=&gt;</span> <span class=n>ref_difftest_regcpy</span><span class=p>(</span><span class=n>DIFFTEST_TO_DUT</span><span class=p>);</span> <span class=c1>// 将REF的寄存器拷贝过来，准备比较
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>=&gt;</span> <span class=n>checkregs</span><span class=p>();</span> <span class=c1>// 比较DUT和REF的寄存器值
</span></span></span></code></pre></div><p>NEMU的简化会导致某些指令的行为与REF有所差异, 因而无法进行对比。
Difftest支持跳过对比某些指令，大概的过程如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=c1>// (1) 情况1: NEMU执行一条指令，但是QEMU如果也执行会发生差异，
</span></span></span><span class=line><span class=cl><span class=c1>//     所以让QEMU跳过执行这条指令。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>difftest_skip_ref</span><span class=p>()</span> <span class=c1>// 在执行NEMU指令的任意阶段调用
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>=&gt;</span> <span class=n>is_skip_ref</span> <span class=o>=</span> <span class=nb>true</span> <span class=c1>// 标记跳过下次REF指令执行阶段
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>=&gt;</span> <span class=n>skip_dut_nr_inst</span> <span class=o>=</span> <span class=mi>0</span> <span class=c1>// 与情况2有关，下面再介绍
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>difftest_step</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>is_skip_ref</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ref_difftest_regcpy</span><span class=p>(</span><span class=n>DIFFTEST_TO_REF</span><span class=p>);</span> <span class=c1>// 同步DUT到REF，相当于跳过
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>is_skip_ref</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>   <span class=c1>// 跳过REF，直接返回到下一条指令
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// (2) 情况2: NEMU跳过执行，让REF执行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>difftest_skip_dut</span><span class=p>()</span> <span class=c1>// 在执行NEMU指令的任意阶段调用
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>=&gt;</span> <span class=n>skip_dut_nr_inst</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=o>=&gt;</span> <span class=n>ref_difftest_exec</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=c1>// REF先执行一次，更新了REF上下文
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>difftest_step</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>skip_dut_nr_inst</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ref_difftest_regcpy</span><span class=p>(</span><span class=n>DIFFTEST_TO_DUT</span><span class=p>);</span> <span class=c1>// 不管NEMU此次的结果，同步REF到DUT
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>ref_r</span><span class=p>.</span><span class=n>pc</span> <span class=o>==</span> <span class=n>npc</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>skip_dut_nr_inst</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>checkregs</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ref_r</span><span class=p>,</span> <span class=n>npc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>skip_dut_nr_inst</span> <span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=构建系统>构建系统</h2><h3 id=编译guest程序并追加参数>编译Guest程序并追加参数</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>make <span class=nv>ARCH</span><span class=o>=</span><span class=nv>$ISA</span>-nemu run <span class=nv>mainargs</span><span class=o>=</span>I-love-PA
</span></span></code></pre></div><h3 id=编译guest程序流程分析>编译Guest程序流程分析</h3><p>编译dummy可执行文件的命令如下，很好奇是如何实现的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> am-kernels/am-kernels/tests/cpu-tests
</span></span><span class=line><span class=cl>make <span class=nv>ARCH</span><span class=o>=</span>riscv32-nemu <span class=nv>ALL</span><span class=o>=</span>dummy
</span></span></code></pre></div><p>既然在当前目录执行make，自然先从 <code>am-kernels/am-kernels/tests/cpu-tests/Makefile</code>开始看起。</p><ul><li><code>ALL</code>默认是所有test的集合，参数指定会覆盖它。</li><li><code>ALL</code>的生成规则属于 <strong>静态规则</strong> ，通配符%代表ALL的全称即依赖Makefile.dummy。<a href=https://seisman.github.io/how-to-write-makefile/rules.html#id8>更多关于静态规则</a></li><li>Makefile.dummy的生成规则也就在下面，这个文件默认是不存在的，需要临时生成</li><li>生成的规则是 <code>echo -e "NAME = dummy\nSRCS = tests/dummy.c\ninclude $${AM_HOME}/Makefile" > $@</code>。包含了AM_HOME下的Makefile</li><li>AM是各个平台版本可执行文件的“制造机”，理念是将平台信息传入，生成指定格式的镜像。运行时库也包含在内。</li><li>最后就是执行 <code>make -f</code> 去调用刚才生成的临时Makefile.dummy，传入指定参数</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>ALL</span> <span class=o>=</span> <span class=k>$(</span>basename <span class=k>$(</span>notdir <span class=k>$(</span>shell find tests/. -name <span class=s2>&#34;*.c&#34;</span><span class=k>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> <span class=k>$(</span><span class=nv>addprefix</span> <span class=nv>Makefile</span>., <span class=k>$(</span><span class=nv>ALL</span><span class=k>))</span>
</span></span><span class=line><span class=cl>	@echo <span class=s2>&#34;test list [</span><span class=k>$(</span>words <span class=k>$(</span>ALL<span class=k>))</span><span class=s2> item(s)]:&#34;</span> <span class=k>$(</span>ALL<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>$(ALL)</span><span class=o>:</span> %: <span class=n>Makefile</span>.%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>Makefile.%</span><span class=o>:</span> <span class=n>tests</span>/%.<span class=n>c</span> <span class=n>latest</span>
</span></span><span class=line><span class=cl>	@/bin/echo -e <span class=s2>&#34;NAME = </span><span class=nv>$*</span><span class=s2>\nSRCS = </span>$<span class=s2>&lt;\ninclude </span><span class=nv>$$</span><span class=s2>{AM_HOME}/Makefile&#34;</span> &gt; <span class=nv>$@</span>
</span></span><span class=line><span class=cl>	@if make -s -f <span class=nv>$@</span> <span class=nv>ARCH</span><span class=o>=</span><span class=k>$(</span>ARCH<span class=k>)</span> <span class=k>$(</span>MAKECMDGOALS<span class=k>)</span><span class=p>;</span> <span class=k>then</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		<span class=nb>printf</span> <span class=s2>&#34;[%14s] </span><span class=k>$(</span>COLOR_GREEN<span class=k>)</span><span class=s2>PASS</span><span class=k>$(</span>COLOR_NONE<span class=k>)</span><span class=s2>\n&#34;</span> <span class=nv>$*</span> &gt;&gt; <span class=k>$(</span>RESULT<span class=k>)</span><span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	<span class=k>else</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		<span class=nb>printf</span> <span class=s2>&#34;[%14s] </span><span class=k>$(</span>COLOR_RED<span class=k>)</span><span class=s2>***FAIL***</span><span class=k>$(</span>COLOR_NONE<span class=k>)</span><span class=s2>\n&#34;</span> <span class=nv>$*</span> &gt;&gt; <span class=k>$(</span>RESULT<span class=k>)</span><span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	<span class=k>fi</span>
</span></span><span class=line><span class=cl>	-@rm -f Makefile.<span class=nv>$*</span>
</span></span></code></pre></div><p>目前为止大概的思路还算比较清晰：</p><ol><li>生成 <code>Makefile.dummy</code></li><li>执行它，传递命令行参数（<code>$(MAKECMDGOALS)</code>）</li></ol><p><code>Makefile.dummy</code> 是一个临时文件，编译命令执行后会被删除。注销删除命令，直接打开看它的内容。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>NAME</span> <span class=o>=</span> dummy
</span></span><span class=line><span class=cl><span class=nv>SRCS</span> <span class=o>=</span> tests/dummy.c
</span></span><span class=line><span class=cl><span class=err>include</span> <span class=err>/home/soben/ics2023/abstract-machine/Makefile</span>
</span></span></code></pre></div><p>需要结合AM_HOME下的Makefile去理解了。
这么来看AM的构建系统像是一个“加工厂”，<strong>在软件设计术语叫“模板“</strong>。</p><ul><li>外部传入加工零件的要求（ARCH、NAME、SRCS&mldr;）</li><li>输出对应需求的产品（可执行文件）。</li><li>既可以要求它将我们传入的源文件编译成native架构下可执行文件，或者是NEMU、QEMU这类模拟器上。</li></ul><h3 id=am的构建思路>AM的构建思路</h3><style type=text/css>.notice{--root-color:#444;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#c33;--warning-content:#fee;--info-title:#fb7;--info-content:#fec;--note-title:#6be;--note-content:#e7f2fa;--tip-title:#5a5;--tip-content:#efe}@media(prefers-color-scheme:dark){.notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}}body.dark .notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--root-color);background:var(--root-background)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background)}.notice.warning .notice-title{background:var(--warning-title)}.notice.warning{background:var(--warning-content)}.notice.info .notice-title{background:var(--info-title)}.notice.info{background:var(--info-content)}.notice.note .notice-title{background:var(--note-title)}.notice.note{background:var(--note-content)}.notice.tip .notice-title{background:var(--tip-title)}.notice.tip{background:var(--tip-content)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div class="notice tip" id=帮助理解AM的Makefile><p class=notice-title><span class="icon-notice baseline"><svg xmlns="http://www.w3.org/2000/svg" viewBox="300.5 134 300 300"><path d="M551.281 252.36c0-3.32-1.172-6.641-3.515-8.985l-17.774-17.578c-2.344-2.344-5.469-3.711-8.789-3.711-3.32.0-6.445 1.367-8.789 3.71l-79.687 79.493-44.141-44.14c-2.344-2.344-5.469-3.712-8.79-3.712-3.32.0-6.444 1.368-8.788 3.711l-17.774 17.579c-2.343 2.343-3.515 5.664-3.515 8.984s1.172 6.445 3.515 8.789l70.704 70.703c2.343 2.344 5.664 3.711 8.789 3.711 3.32.0 6.64-1.367 8.984-3.71l106.055-106.056c2.343-2.343 3.515-5.468 3.515-8.789zM600.5 284c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg></span><span>帮助理解AM的Makefile</span></p><p>AM_HOME/Makefile 有命令转化makefile为html文件，帮助理解。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c>### *Get a more readable version of this Makefile* by `make html` (requires python-markdown)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>html</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	cat Makefile <span class=p>|</span> sed <span class=s1>&#39;s/^\([^#]\)/    \1/g&#39;</span> <span class=p>|</span> markdown_py &gt; Makefile.html
</span></span><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>html</span>
</span></span></code></pre></div></div><p>上面说过，AM的构建系统是一个模版，将源文件编译，使其能运行在指定的平台上。
甚至，运行时库也是集成到AM中的，最大程度上减少重复劳动。</p><p>下面是Makefile的源代码，我们选取关键的部分进行拆解。</p><ol><li>提前说明，传入的参数有ARCH、NAME、SRCS，剩余参数在$(MAKECMDGOALS)</li><li>环境检查（clean、html命令跳过）</li><li>从参数ARCH中分离出ISA和PLATFORM</li><li>设置编译器和编译选项</li><li>引入和ISA、Platform相关的一些规则，<strong>include <code>scripts/$ARCH.mk</code></strong>，下面会详细分析</li><li>一些通用的编译目标规则，比如.c/.S如何生成.o</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c>## 1. Basic Setup and Checks
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=c>### Default to create a bare-metal kernel image
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>ifeq</span> <span class=err>(</span><span class=k>$(</span><span class=nv>MAKECMDGOALS</span><span class=k>)</span><span class=err>,)</span>
</span></span><span class=line><span class=cl>  <span class=nv>MAKECMDGOALS</span>  <span class=o>=</span> image
</span></span><span class=line><span class=cl>  .DEFAULT_GOAL <span class=o>=</span> image
</span></span><span class=line><span class=cl><span class=err>endif</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Override checks when `make clean/clean-all/html`
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>ifeq</span> <span class=err>(</span><span class=k>$(</span><span class=nv>findstring</span> <span class=k>$(</span><span class=nv>MAKECMDGOALS</span><span class=k>)</span>,<span class=nv>clean</span>|<span class=nv>clean</span>-<span class=nv>all</span>|<span class=nv>html</span><span class=k>)</span><span class=err>,)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 其他的检查暂时省略...
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=c>### Extract instruction set architecture (`ISA`) and platform from `$ARCH`. Example: `ARCH=x86_64-qemu -&gt; ISA=x86_64; PLATFORM=qemu`
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>ARCH_SPLIT</span> <span class=o>=</span> <span class=k>$(</span>subst -, ,<span class=k>$(</span>ARCH<span class=k>))</span>
</span></span><span class=line><span class=cl><span class=nv>ISA</span>        <span class=o>=</span> <span class=k>$(</span>word 1,<span class=k>$(</span>ARCH_SPLIT<span class=k>))</span>
</span></span><span class=line><span class=cl><span class=nv>PLATFORM</span>   <span class=o>=</span> <span class=k>$(</span>word 2,<span class=k>$(</span>ARCH_SPLIT<span class=k>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Check if there is something to build
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>ifeq</span> <span class=err>(</span><span class=k>$(</span><span class=nv>flavor</span> <span class=nv>SRCS</span><span class=k>)</span><span class=err>,</span> <span class=err>undefined)</span>
</span></span><span class=line><span class=cl>  <span class=k>$(</span><span class=nv>error</span> <span class=nv>Nothing</span> <span class=nv>to</span> <span class=nv>build</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=err>endif</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Checks end here
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>endif</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 2. General Compilation Targets
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=c>### Compilation targets (a binary image or archive)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>IMAGE_REL</span> <span class=o>=</span> build/<span class=k>$(</span>NAME<span class=k>)</span>-<span class=k>$(</span>ARCH<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>IMAGE</span>     <span class=o>=</span> <span class=k>$(</span>abspath <span class=k>$(</span>IMAGE_REL<span class=k>))</span>
</span></span><span class=line><span class=cl><span class=nv>ARCHIVE</span>   <span class=o>=</span> <span class=k>$(</span>WORK_DIR<span class=k>)</span>/build/<span class=k>$(</span>NAME<span class=k>)</span>-<span class=k>$(</span>ARCH<span class=k>)</span>.a
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Collect the files to be linked: object files (`.o`) and libraries (`.a`)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>OBJS</span>      <span class=o>=</span> <span class=k>$(</span>addprefix <span class=k>$(</span>DST_DIR<span class=k>)</span>/, <span class=k>$(</span>addsuffix .o, <span class=k>$(</span>basename <span class=k>$(</span>SRCS<span class=k>))))</span>
</span></span><span class=line><span class=cl><span class=nv>LIBS</span>     <span class=o>:=</span> <span class=k>$(</span>sort <span class=k>$(</span>LIBS<span class=k>)</span> am klib<span class=k>)</span> <span class=c1># lazy evaluation (&#34;=&#34;) causes infinite recursions</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 3. General Compilation Flags
</span></span></span><span class=line><span class=cl><span class=c># 省略：编译器和编译选项
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=c>## 4. Arch-Specific Configurations
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=c>### Paste in arch-specific configurations (e.g., from `scripts/x86_64-qemu.mk`)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>-include</span> <span class=k>$(</span><span class=nv>AM_HOME</span><span class=k>)</span><span class=err>/scripts/</span><span class=k>$(</span><span class=nv>ARCH</span><span class=k>)</span><span class=err>.mk</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Fall back to native gcc/binutils if there is no cross compiler
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>ifeq</span> <span class=err>(</span><span class=k>$(</span><span class=nv>wildcard</span> <span class=k>$(</span><span class=nv>shell</span> <span class=nv>which</span> <span class=k>$(</span><span class=nv>CC</span><span class=k>)))</span><span class=err>,)</span>
</span></span><span class=line><span class=cl>  <span class=k>$(</span><span class=nv>info</span> #  <span class=k>$(</span><span class=nv>CC</span><span class=k>)</span> <span class=nv>not</span> <span class=nv>found</span>; <span class=nv>fall</span> <span class=nv>back</span> <span class=nv>to</span> <span class=nv>default</span> <span class=nv>gcc</span> <span class=nv>and</span> <span class=nv>binutils</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=nv>CROSS_COMPILE</span> <span class=o>:=</span>
</span></span><span class=line><span class=cl><span class=err>endif</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 5. Compilation Rules
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=c>### Rule (compile): a single `.c` -&gt; `.o` (gcc)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>$(DST_DIR)/%.o</span><span class=o>:</span> %.<span class=n>c</span>
</span></span><span class=line><span class=cl>	@mkdir -p <span class=k>$(</span>dir <span class=nv>$@</span><span class=k>)</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span> + CC $&lt;
</span></span><span class=line><span class=cl>	@<span class=k>$(</span>CC<span class=k>)</span> -std<span class=o>=</span>gnu11 <span class=k>$(</span>CFLAGS<span class=k>)</span> -c -o <span class=nv>$@</span> <span class=k>$(</span>realpath $&lt;<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 省略：一些其他的通用规则
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=c>### Rule (recursive make): build a dependent library (am, klib, ...)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>$(LIBS)</span><span class=o>:</span> %:
</span></span><span class=line><span class=cl>	@<span class=k>$(</span>MAKE<span class=k>)</span> -s -C <span class=k>$(</span>AM_HOME<span class=k>)</span>/<span class=nv>$*</span> archive
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Rule (link): objects (`*.o`) and libraries (`*.a`) -&gt; `IMAGE.elf`, the final ELF binary to be packed into image (ld)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>$(IMAGE).elf</span><span class=o>:</span> <span class=k>$(</span><span class=nv>OBJS</span><span class=k>)</span> <span class=k>$(</span><span class=nv>LIBS</span><span class=k>)</span>
</span></span><span class=line><span class=cl>	@echo + LD <span class=s2>&#34;-&gt;&#34;</span> <span class=k>$(</span>IMAGE_REL<span class=k>)</span>.elf
</span></span><span class=line><span class=cl>	@<span class=k>$(</span>LD<span class=k>)</span> <span class=k>$(</span>LDFLAGS<span class=k>)</span> -o <span class=k>$(</span>IMAGE<span class=k>)</span>.elf --start-group <span class=k>$(</span>LINKAGE<span class=k>)</span> --end-group
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Rule (archive): objects (`*.o`) -&gt; `ARCHIVE.a` (ar)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>$(ARCHIVE)</span><span class=o>:</span> <span class=k>$(</span><span class=nv>OBJS</span><span class=k>)</span>
</span></span><span class=line><span class=cl>	@echo + AR <span class=s2>&#34;-&gt;&#34;</span> <span class=k>$(</span>shell realpath <span class=nv>$@</span> --relative-to .<span class=k>)</span>
</span></span><span class=line><span class=cl>	@<span class=k>$(</span>AR<span class=k>)</span> rcs <span class=k>$(</span>ARCHIVE<span class=k>)</span> <span class=k>$(</span>OBJS<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Rule (`#include` dependencies): paste in `.d` files generated by gcc on `-MMD`
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>-include</span> <span class=k>$(</span><span class=nv>addprefix</span> <span class=k>$(</span><span class=nv>DST_DIR</span><span class=k>)</span>/, <span class=k>$(</span><span class=nv>addsuffix</span> .<span class=nv>d</span>, <span class=k>$(</span><span class=nv>basename</span> <span class=k>$(</span><span class=nv>SRCS</span><span class=k>))))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## 6. Miscellaneous
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=c>### Build order control
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>image</span><span class=o>:</span> <span class=n>image</span>-<span class=n>dep</span>
</span></span><span class=line><span class=cl><span class=nf>archive</span><span class=o>:</span> <span class=k>$(</span><span class=nv>ARCHIVE</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nf>image-dep</span><span class=o>:</span> <span class=k>$(</span><span class=nv>OBJS</span><span class=k>)</span> <span class=k>$(</span><span class=nv>LIBS</span><span class=k>)</span>
</span></span><span class=line><span class=cl>	@echo <span class=se>\#</span> Creating image <span class=o>[</span><span class=k>$(</span>ARCH<span class=k>)</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>image</span> <span class=n>image</span>-<span class=n>dep</span> <span class=n>archive</span> <span class=n>run</span> <span class=k>$(</span><span class=nv>LIBS</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Clean a single project (remove `build/`)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	rm -rf Makefile.html <span class=k>$(</span>WORK_DIR<span class=k>)</span>/build/
</span></span><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>clean</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>### Clean all sub-projects within depth 2 (and ignore errors)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>CLEAN_ALL</span> <span class=o>=</span> <span class=k>$(</span>dir <span class=k>$(</span>shell find . -mindepth <span class=m>2</span> -name Makefile<span class=k>))</span>
</span></span><span class=line><span class=cl><span class=nf>clean-all</span><span class=o>:</span> <span class=k>$(</span><span class=nv>CLEAN_ALL</span><span class=k>)</span> <span class=n>clean</span>
</span></span><span class=line><span class=cl><span class=nf>$(CLEAN_ALL)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	-@<span class=k>$(</span>MAKE<span class=k>)</span> -s -C <span class=nv>$@</span> clean
</span></span><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>clean</span>-<span class=n>all</span> <span class=k>$(</span><span class=nv>CLEAN_ALL</span><span class=k>)</span>
</span></span></code></pre></div><p>$ARCH.mk 文件规定一些架构、运行平台相关的选项：</p><ul><li>架构相关的：比如说交叉编译器是啥，和特殊的CFLAGS(<code>-march</code>)</li><li>平台相关的：因为命令行参数可以添加如<code>run</code>，编译完后直接运行，此时需要提前将平台准备好，编译好NEMU。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=err>include</span> <span class=k>$(</span><span class=nv>AM_HOME</span><span class=k>)</span><span class=err>/scripts/isa/riscv.mk</span>
</span></span><span class=line><span class=cl><span class=err>include</span> <span class=k>$(</span><span class=nv>AM_HOME</span><span class=k>)</span><span class=err>/scripts/platform/nemu.mk</span>
</span></span><span class=line><span class=cl><span class=nv>CFLAGS</span>  <span class=o>+=</span> -DISA_H<span class=o>=</span><span class=se>\&#34;</span>riscv/riscv.h<span class=se>\&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>COMMON_CFLAGS</span> <span class=o>+=</span> -march<span class=o>=</span>rv32im_zicsr -mabi<span class=o>=</span>ilp32   <span class=c1># overwrite</span>
</span></span><span class=line><span class=cl><span class=nv>LDFLAGS</span>       <span class=o>+=</span> -melf32lriscv                     <span class=c1># overwrite</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>AM_SRCS</span> <span class=o>+=</span> riscv/nemu/start.S <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           riscv/nemu/cte.c <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           riscv/nemu/trap.S <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           riscv/nemu/vme.c
</span></span></code></pre></div></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2024-04-16T19:28:12, Lastmod: 2024-05-12T21:54:13</p><script src=/js/copy-to-clipboard.js></script></main></div></body></html>