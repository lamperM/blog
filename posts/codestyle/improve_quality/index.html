<!doctype html><html><head><title>Improving the quality of C code</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content="Some useful rules to improve programming quality of C."><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/journal.min.a4a96c4dc87303b81206f86623ab533a5c6cc7fe9ac433fcdd808d2089bae63b.css integrity="sha256-pKlsTchzA7gSBvhmI6tTOlxsx/6axDP83YCNIIm65js=" media=screen><link rel=stylesheet href=/scss/dark-mode.min.8d11714119bdb3c376b7eab64344dcd1f183f83f58c906bbe5d8b770bccf9c03.css integrity="sha256-jRFxQRm9s8N2t+q2Q0Tc0fGD+D9YyQa75di3cLzPnAM=" media=screen><script src=/vendor/js/loadCSS.js></script>
<script>loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons")</script><script src=/js/toc.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script>
<script src=/vendor/js/md5.min.js></script>
<script>var gitalk=new Gitalk({clientID:"12dfb0f809e5e6afde3d",clientSecret:"72aaf5660b3a7b43b0bffb4d683a605a7ea65dad",repo:"blogcomments_gitalk",owner:"wangloo",admin:["wangloo"],id:md5(location.pathname),distractionFreeMode:"false"});window.onload=function(){gitalk.render("gitalk-container")}</script></head><body><div id=app><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://wangloo.github.io/><div class=nav-title>Soben's Secret Base</div><div class=nav-subtitle>花有重开日, 人无再少年</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>Archive</a>
<a class="a-block nav-link-item false" href=/tags>Tags</a>
<a class="a-block nav-link-item false" href=/categories>Categories</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
@2019 Notepadium.</div></div><div id=extraContainer class=extra-container><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e6%b7%bb%e5%8a%a0%e6%9b%b4%e5%a4%9a%e7%9a%84%e7%bc%96%e8%af%91%e9%80%89%e9%a1%b9comiler-options%e6%9d%a5%e9%98%b2%e6%ad%a2bug onclick="onNavClick(`#添加更多的编译选项comiler-options来防止bug-nav`)" id=添加更多的编译选项comiler-options来防止bug-nav>添加更多的编译选项(comiler options)来防止bug</a></li><li><a href=#%e5%8a%a8%e6%80%81%e7%94%b3%e8%af%b7%e7%9a%84%e7%a9%ba%e9%97%b4%e5%88%b0%e5%ba%95%e8%a6%81%e4%b8%8d%e8%a6%81%e9%87%8a%e6%94%be onclick="onNavClick(`#动态申请的空间到底要不要释放-nav`)" id=动态申请的空间到底要不要释放-nav>动态申请的空间到底要不要释放</a></li><ul><li><a href=#%e5%b0%bd%e5%8f%af%e8%83%bd%e5%9c%a8%e5%88%9b%e5%bb%ba%e5%8f%98%e9%87%8f%e6%97%b6%e8%b5%8b%e5%88%9d%e5%80%bc onclick="onNavClick(`#尽可能在创建变量时赋初值-nav`)" id=尽可能在创建变量时赋初值-nav>尽可能在创建变量时赋初值</a></li><li><a href=#%e4%bd%bf%e7%94%a8define-enum onclick="onNavClick(`#使用define-enum-nav`)" id=使用define-enum-nav>使用#define, enum</a></li><li><a href=#%e4%bd%bf%e7%94%a8typedef%e4%bc%98%e5%8c%96function-pointer onclick="onNavClick(`#使用typedef优化function-pointer-nav`)" id=使用typedef优化function-pointer-nav>使用typedef优化function pointer</a></li><li><a href=#%e9%87%8d%e5%ae%9a%e4%b9%89%e4%b8%80%e5%a5%97%e8%87%aa%e5%b7%b1%e7%9a%84%e7%b1%bb%e5%9e%8b onclick="onNavClick(`#重定义一套自己的类型-nav`)" id=重定义一套自己的类型-nav>重定义一套自己的类型</a></li></ul><li><a href=#%e5%96%84%e7%94%a80 onclick="onNavClick(`#善用0-nav`)" id=善用0-nav>善用~0</a></li><li><a href=#%e5%90%88%e7%90%86%e7%9a%84%e4%bd%bf%e7%94%a8goto%e8%af%ad%e5%8f%a5 onclick="onNavClick(`#合理的使用goto语句-nav`)" id=合理的使用goto语句-nav>合理的使用goto语句</a></li><li><a href=#%e6%b0%b8%e8%bf%9c%e4%b8%ba%e4%bd%a0%e7%9a%84%e5%87%bd%e6%95%b0%e8%ae%be%e7%bd%aeerror-return-value onclick="onNavClick(`#永远为你的函数设置error-return-value-nav`)" id=永远为你的函数设置error-return-value-nav>永远为你的函数设置error return value</a></li><li><a href=#%e5%8f%98%e9%87%8f%e7%b1%bb%e5%9e%8b%e7%9a%84%e9%80%89%e6%8b%a9 onclick="onNavClick(`#变量类型的选择-nav`)" id=变量类型的选择-nav>变量类型的选择</a></li><li><a href=#reference onclick="onNavClick(`#reference-nav`)" id=reference-nav>Reference</a></li></ul></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a>
<a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>Archive</a>
<a class="a-block drawer-menu-item false" href=/tags>Tags</a>
<a class="a-block drawer-menu-item false" href=/categories>Categories</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e6%b7%bb%e5%8a%a0%e6%9b%b4%e5%a4%9a%e7%9a%84%e7%bc%96%e8%af%91%e9%80%89%e9%a1%b9comiler-options%e6%9d%a5%e9%98%b2%e6%ad%a2bug onclick="onNavClick(`#添加更多的编译选项comiler-options来防止bug-nav`)" id=添加更多的编译选项comiler-options来防止bug-nav>添加更多的编译选项(comiler options)来防止bug</a></li><li><a href=#%e5%8a%a8%e6%80%81%e7%94%b3%e8%af%b7%e7%9a%84%e7%a9%ba%e9%97%b4%e5%88%b0%e5%ba%95%e8%a6%81%e4%b8%8d%e8%a6%81%e9%87%8a%e6%94%be onclick="onNavClick(`#动态申请的空间到底要不要释放-nav`)" id=动态申请的空间到底要不要释放-nav>动态申请的空间到底要不要释放</a></li><ul><li><a href=#%e5%b0%bd%e5%8f%af%e8%83%bd%e5%9c%a8%e5%88%9b%e5%bb%ba%e5%8f%98%e9%87%8f%e6%97%b6%e8%b5%8b%e5%88%9d%e5%80%bc onclick="onNavClick(`#尽可能在创建变量时赋初值-nav`)" id=尽可能在创建变量时赋初值-nav>尽可能在创建变量时赋初值</a></li><li><a href=#%e4%bd%bf%e7%94%a8define-enum onclick="onNavClick(`#使用define-enum-nav`)" id=使用define-enum-nav>使用#define, enum</a></li><li><a href=#%e4%bd%bf%e7%94%a8typedef%e4%bc%98%e5%8c%96function-pointer onclick="onNavClick(`#使用typedef优化function-pointer-nav`)" id=使用typedef优化function-pointer-nav>使用typedef优化function pointer</a></li><li><a href=#%e9%87%8d%e5%ae%9a%e4%b9%89%e4%b8%80%e5%a5%97%e8%87%aa%e5%b7%b1%e7%9a%84%e7%b1%bb%e5%9e%8b onclick="onNavClick(`#重定义一套自己的类型-nav`)" id=重定义一套自己的类型-nav>重定义一套自己的类型</a></li></ul><li><a href=#%e5%96%84%e7%94%a80 onclick="onNavClick(`#善用0-nav`)" id=善用0-nav>善用~0</a></li><li><a href=#%e5%90%88%e7%90%86%e7%9a%84%e4%bd%bf%e7%94%a8goto%e8%af%ad%e5%8f%a5 onclick="onNavClick(`#合理的使用goto语句-nav`)" id=合理的使用goto语句-nav>合理的使用goto语句</a></li><li><a href=#%e6%b0%b8%e8%bf%9c%e4%b8%ba%e4%bd%a0%e7%9a%84%e5%87%bd%e6%95%b0%e8%ae%be%e7%bd%aeerror-return-value onclick="onNavClick(`#永远为你的函数设置error-return-value-nav`)" id=永远为你的函数设置error-return-value-nav>永远为你的函数设置error return value</a></li><li><a href=#%e5%8f%98%e9%87%8f%e7%b1%bb%e5%9e%8b%e7%9a%84%e9%80%89%e6%8b%a9 onclick="onNavClick(`#变量类型的选择-nav`)" id=变量类型的选择-nav>变量类型的选择</a></li><li><a href=#reference onclick="onNavClick(`#reference-nav`)" id=reference-nav>Reference</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a id=navTitle class=navbar-brand href=https://wangloo.github.io/>Soben's Secret Base</a>
<button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://wangloo.github.io/><div class=single-column-header-title>Soben's Secret Base</div><div class=single-column-header-subtitle>花有重开日, 人无再少年</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>Improving the quality of C code<div class=post-subtitle>Some useful rules to improve programming quality of C.</div><div class=post-meta><time itemprop=datePublished>2022-06-14 17:59</time>
<i class=material-icons>label</i>
<a href=/tags/c>c</a>
&nbsp;
<i class=material-icons>schedule</i>
6 min
9 s.</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h2 id=添加更多的编译选项comiler-options来防止bug>添加更多的编译选项(comiler options)来防止bug</h2><p>对于我常用的<code>GCC</code>, 推荐开启一下的compiler options:</p><ul><li><p><code>-Wall</code>: enable a lot of common warnings</p></li><li><p><code>-Wno-format-truncation</code>: warns about the snprintf output buffer not being
large enough for a corresponding “%s” in the format string.</p></li><li><p><code>-Werror</code>: turn warnings into errors.</p></li></ul><p> </p><h2 id=动态申请的空间到底要不要释放>动态申请的空间到底要不要释放</h2><p>When using a barebones embedded OS, you absolutely need to tightly manage your memory.</p><p>但是, 如果你是写应用业务的代码, 特别是在内存足够的场景下. 最好不要手动释放内存,
因为当线程/进程退出时, 操作系统会自动帮我们释放. <strong>某些情况下, 释放内存的操作会很大程度上增加逻辑的复杂度</strong>.</p><blockquote><p>如果你是一个内核程序员, 则必须手动的释放. 不用怀疑.</p></blockquote><p> </p><h3 id=尽可能在创建变量时赋初值>尽可能在创建变量时赋初值</h3><p>放置某些变量创建后是 <code>magic value</code>. 而使用这些变量可能不会立马导致错误, 但是这是一个隐患.</p><p>但这会产生一个问题, 有时我们定义变量之后的不久之后就会对其赋予正确的值, 这时候初值就是
多余的. 而且维护者可能认为这个值是meaningful, 这就要求我们如果要赋初值, 就要说明这个值
仅仅是<strong>无意义的</strong>初值.</p><p> </p><h3 id=使用define-enum>使用<code>#define</code>, <code>enum</code></h3><p>对于代码在不同地方使用的同一个值, 应使用<code>#define</code>来声明使得代码<strong>maintainable</strong>.</p><p>如果这些值有多个且能规划为同一类别, 则还可将<code>#define</code>的方式换为<code>enum</code>. 这会使代码更加<strong>meaningful</strong></p><blockquote><p>使用<code>enum</code>使还要注意其所占内存空间在不同架构中可能不同的问题, see <a href=https://www.cnblogs.com/bluettt/p/16041867.html>enum的优势和漏洞</a></p></blockquote><p> </p><h3 id=使用typedef优化function-pointer>使用<code>typedef</code>优化function pointer</h3><p> </p><h3 id=重定义一套自己的类型>重定义一套自己的类型</h3><p>在开发大项目时, 需要考虑可移植性的情况下, 最好利用<code>typedef</code>对类型进行重定义.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>#if SYSTEM1
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>    <span style=color:#ff79c6>typedef</span>  <span style=color:#8be9fd>int</span>  INT32;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span><span style=color:#ff79c6>#else
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>    <span style=color:#ff79c6>typedef</span>  <span style=color:#8be9fd>long</span> INT32;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span><span style=color:#ff79c6>#endif
</span></span></span></code></pre></div><p>如上, 对于某些架构<code>int</code>类型可能不是32bit, 此时就要使用<code>long</code>. 这种定义的方式会保证我们的系统
在任何架构中都不会出现类型的bug. 而且也增加了代码的<strong>readability</strong>.</p><p> </p><h2 id=善用0>善用<code>~0</code></h2><p>在做嵌入式编程时, 有时在设置掩码(mask)或者其他情况会要用到<strong>全1</strong>的变量值, 你是否经常这样声明?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> mask <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0xffff</span>;
</span></span></code></pre></div><p>暂且不谈<code>int</code>类型到底占多少字节的问题. 就像上面一样, 我们程序员经常忘记某个类型的大小,
而少添加了<code>f</code>. 会导致变量<code>mask</code>的值不是全1(32位情况下).</p><p>这是要变换一下思维, 使用<code>~0</code>的定义方法就可轻松化解, 无需管变量的类型是什么.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> mask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>~</span><span style=color:#bd93f9>0</span>;
</span></span></code></pre></div><p> </p><h2 id=合理的使用goto语句>合理的使用<code>goto</code>语句</h2><p>在大学课堂中, 我们老师说过禁止使用<code>goto</code>语句, 但却没有给出明确的原因.</p><p>实际上, <strong>合理的</strong>使用<code>goto</code>能够极大的减少程序的冗余度.</p><p><code>goto</code>语句常用于程序出现错误要退出时, 可能有多个情况会使用重复的代码处理,
例如释放一些allocated memory. 相较于使用<code>flag</code>, 使用<code>goto</code>显然更加clearly and readability.</p><p>所以, 在面对重复的错误处理代码时, 想想能不能用<code>goto</code>进行优化. 当然, <strong>避免过早优化</strong>.</p><blockquote><p>注意, <code>goto</code>出现的场景其实很受限. Never use a backward <code>goto</code> or jump into control statements.</p></blockquote><p> </p><h2 id=永远为你的函数设置error-return-value>永远为你的函数设置error return value</h2><p>一旦你的函数可能被其他人调用, 那么养成设置return value的习惯. 即便你现在的实现
并不会产生任何错误, 也请返回<code>success</code>.</p><p>这样做的原因是, caller可以根据你的定义做错误判断, 即便以后你的实现加上了出错情况,
上层的代码也不需要修改.</p><p> </p><h2 id=变量类型的选择>变量类型的选择</h2><ul><li>名字, 特定不变的字符串使用<code>const char *</code>, 甚至<code>const char const*</code></li><li>长度使用<code>size_t</code></li><li>表示类型的参数尽可能使用<code>enum</code></li><li>循环变量i使用<code>signed</code>, 避免溢出后出错</li></ul><p> </p><h2 id=reference>Reference</h2><p><a href=https://www.msweet.org/blog/2020-12-31-how-i-improve-my-c-code-quality.html>How I Improve My (C) Code Quality</a></p><p><a href=https://www.codeproject.com/Articles/357065/Ten-Fallacies-of-Good-C-Code>Ten Fallacies of Good C Code</a></p><hr width=100% id=EOF><p style=color:#777>Last modified on 2022-08-12</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/os-learning/elf-format/>Next<br>ELF 文件的链接与加载</a>
<a class=older-posts href=/posts/microkernel/sel4/>Previous<br>MicroKernel Learning: SeL4</a></nav><div class=post-comment-wrapper><div id=gitalk-container></div></div></div></div></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
@2019 Notepadium.</div></div><script src=/js/journal.js></script></body></html>