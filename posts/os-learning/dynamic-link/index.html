<!doctype html><html><head><title>Dynamic Link</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=https://wangloo.github.io/scss/journal.min.0f46f98b723f2aad4b02d9370bb6aa7848b5c2b2a5579642014082283683d2d8.css integrity="sha256-D0b5i3I/Kq1LAtk3C7aqeEi1wrKlV5ZCAUCCKDaD0tg=" media=screen><link rel=stylesheet href=https://wangloo.github.io/scss/dark-mode.min.79c34391dbcff20df8b4dac718e2606701efcbfdb9f3b08447ac39ac9dc7b463.css integrity="sha256-ecNDkdvP8g34tNrHGOJgZwHvy/2587CER6w5rJ3HtGM=" media=screen><script src=/vendor/js/loadCSS.js></script>
<script>loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons")</script><script src=/js/toc.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script>
<script src=/vendor/js/md5.min.js></script>
<script>var gitalk=new Gitalk({clientID:"12dfb0f809e5e6afde3d",clientSecret:"72aaf5660b3a7b43b0bffb4d683a605a7ea65dad",repo:"blogcomments_gitalk",owner:"wangloo",admin:["wangloo"],id:md5(location.pathname),distractionFreeMode:"false"});window.onload=function(){gitalk.render("gitalk-container")}</script></head><body><div id=app><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://wangloo.github.io/><div class=nav-title>Soben's Secret Base</div><div class=nav-subtitle>花有重开日, 人无再少年</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>Archive</a>
<a class="a-block nav-link-item false" href=/tags>Tags</a>
<a class="a-block nav-link-item false" href=/categories>Categories</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
@2019 Notepadium.</div></div><div id=extraContainer class=extra-container><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e9%9d%99%e6%80%81%e9%93%be%e6%8e%a5%e5%b8%a6%e6%9d%a5%e7%9a%84%e9%97%ae%e9%a2%98 onclick="onNavClick(`#静态链接带来的问题-nav`)" id=静态链接带来的问题-nav>静态链接带来的问题</a></li><li><a href=#%e5%8a%a8%e6%80%81%e9%93%be%e6%8e%a5%e7%9a%84%e8%bf%87%e7%a8%8b onclick="onNavClick(`#动态链接的过程-nav`)" id=动态链接的过程-nav>动态链接的过程</a></li><li><a href=#%e5%9c%b0%e5%9d%80%e6%97%a0%e5%85%b3%e4%bb%a3%e7%a0%81 onclick="onNavClick(`#地址无关代码-nav`)" id=地址无关代码-nav>地址无关代码</a></li></ul></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a>
<a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>Archive</a>
<a class="a-block drawer-menu-item false" href=/tags>Tags</a>
<a class="a-block drawer-menu-item false" href=/categories>Categories</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e9%9d%99%e6%80%81%e9%93%be%e6%8e%a5%e5%b8%a6%e6%9d%a5%e7%9a%84%e9%97%ae%e9%a2%98 onclick="onNavClick(`#静态链接带来的问题-nav`)" id=静态链接带来的问题-nav>静态链接带来的问题</a></li><li><a href=#%e5%8a%a8%e6%80%81%e9%93%be%e6%8e%a5%e7%9a%84%e8%bf%87%e7%a8%8b onclick="onNavClick(`#动态链接的过程-nav`)" id=动态链接的过程-nav>动态链接的过程</a></li><li><a href=#%e5%9c%b0%e5%9d%80%e6%97%a0%e5%85%b3%e4%bb%a3%e7%a0%81 onclick="onNavClick(`#地址无关代码-nav`)" id=地址无关代码-nav>地址无关代码</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a id=navTitle class=navbar-brand href=https://wangloo.github.io/>Soben's Secret Base</a>
<button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://wangloo.github.io/><div class=single-column-header-title>Soben's Secret Base</div><div class=single-column-header-subtitle>花有重开日, 人无再少年</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>Dynamic Link<div class=post-meta><time itemprop=datePublished>2022-06-26 19:50</time>
<i class=material-icons>folder</i>
<a href=/categories/>[Operating system]</a>
&nbsp;
<i class=material-icons>label</i>
<a href=/tags/operating-system>Operating system</a>
&nbsp;
<a href=/tags/dynamic-link>Dynamic link</a>
&nbsp;
<a href=/tags/pic>PIC</a>
&nbsp;
<i class=material-icons>schedule</i>
5 min
15 s.</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h2 id=静态链接带来的问题>静态链接带来的问题</h2><ol><li><p>像是<code>libc</code>这种几乎每个程序都要用到的库, 如果是静态的, 那么不仅意外着每个程序的
可执行文件很大, 浪费磁盘空间. 并且当程序加载到内存时, 可能许多程序都会用到<code>printf</code>
, 使得内存中会存在好多份的<code>printf</code>源码.</p></li><li><p>维护和更新难. 一旦静态链接的其中一个目标文件更新, 所有的可执行程序都要重新链接.</p></li><li><p>不满足局部性原理. 上面提到, 内存中同时存在多份的<code>printf</code>源码会破坏<em>局部性原理</em>的.
显然如果所有的程序共享一份<code>printf</code>源码的想法更好. 即动态加载.</p></li><li><p>可移植性差. 静态链接, 只要有一个依赖目标文件的实现不同, 软件厂商就得专门发布一个
版本. 而动态链接则信赖客户电脑上的<em>动态库</em>, 相当于一个中间层.</p></li></ol><p> </p><h2 id=动态链接的过程>动态链接的过程</h2><p>对比静态链接使用<code>ld</code>链接器在编译后即执行链接, 动态链接则是将链接过程推迟到<strong>运行时</strong>,
即装载到内存时.</p><p>这样, 链接器在链接产生可执行文件时就有两种做法:</p><ul><li>对于静态符号, 按照静态链接的规则进行<em>地址引用重定位</em></li><li>对于动态符号, 链接器则仅标记其为动态链接中的符号, 不进行处理. 而是等到装载时由
专门的<em>动态链接器</em>来完成动态符号的链接工作.</li></ul><p>⁉️ 链接器如何确定一个符号是静态的or动态的?</p><p>在动态共享对象(<em>.so)中保存了完整的</em>动态符号表*, 表中存在的符号即为动态的, 否则为静态.</p><blockquote><p>Linux的C语言运行库<code>glib</code>的动态链接版本叫<code>libc.so</code>. 它在外存上只保存一份, 所有的程序
都可以在运行时使用它. 所以千万不要删掉它.</p></blockquote><blockquote><p>动态链接有一定的性能损失, 因为每次运行程序时都要重新链接, 并不像静态链接是一劳永逸的.
也有例如<code>延迟绑定</code>对性能进行优化的方法, 大概仅有5%的损耗, 与带来的便利相比可以忽略不计.</p></blockquote><p> </p><h2 id=地址无关代码>地址无关代码</h2><p>GCC生成动态库时需要添加参数<code>-fPIC</code>, 含义就是生成地址无关码</p><p>地址无关码的含义是生成的目标文件中<strong>不包含任何的绝对地址引用</strong>, 全都是<strong>相对地址</strong>.
若动态链接库中的代码段包含绝对地址引用, 即在动态加载该动态库时进行了<em>重定位</em>,
会根据动态库加载到内存的位置对代码段进行了修改.</p><p>这样一来, 该动态库就变为该进程独享的了, 因为<strong>其他程序将对该动态库的映射肯定各不相同.</strong>
所以, 每个程序在动态加载时都需要重新加载一遍动态库到内存中, 也就失去了<strong>节省内存</strong>
这个特性.</p><p>而如果该动态库中全部使用相对地址, 那么加载时也就不需要进行重定位, 即所有的程序都可以
共享这些地址无关代码.</p><blockquote><p>上面说PIC的动态库不需要重定位其实是错误的, 只不过它的重定位过程不需要修改代码段,
而是设置了一个放置在数据段的<em>GOT</em>表来实现代码段部分的地址无关特性.</p></blockquote><blockquote><p>现在貌似GCC ARM版本在编译动态库时强制使用-fPIC选项, 否则会报错. 对此我不是
非常确定!</p></blockquote><blockquote><p>一般来说, 不将主程序编译为地址无关码. 因为主程序不需要共享, 而且地址无关码的调用
需要两个指令: <code>计算地址</code> + <code>跳转</code>. 多了一步根据偏移得到绝对地址.</p></blockquote><hr width=100% id=EOF><p style=color:#777>Last modified on 2022-09-26</p></div></div><nav class=post-pagination><a class=newer-posts href=https://wangloo.github.io/posts/os-learning/stack-and-heap/>Next<br>Stack and Heap</a>
<a class=older-posts href=https://wangloo.github.io/posts/os-learning/elf-format/>Previous<br>ELF 文件的链接与加载</a></nav><div class=post-comment-wrapper><div id=gitalk-container></div></div></div></div></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
@2019 Notepadium.</div></div><script src=/js/journal.js></script></body></html>