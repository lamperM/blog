<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>MicroKernel Learning: SeL4</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>所有文章</a></div><div class="a-block nav-link-item"><a href=/tags>Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput><ul id=searchResults></ul></div></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><h1>MicroKernel Learning: SeL4</h1></header><h2 id=sel4-capabilities>seL4 Capabilities</h2><p>In seL4, capabilities are stored in <strong>C-space</strong>. C-space is a hierarchical data structure very similar to <strong>page table</strong>.</p><ul><li>page table is a mapping from virtual address to physical address.</li><li>C-space is a mapping from <strong>object ID</strong> to <strong>capability</strong>.</li><li>Kernel object is made up of several <strong>C-nodes</strong>, just like a page table made up of individual page tables.</li><li>Each C-nodes is an array of cap <em>slots</em>, which contain capability.</li></ul><p>Inaccessible to userland, you can never hold an <strong>actual capability</strong></p><ul><li>You can only hold a reference to capability, which pointers into C-space(slot addresses)</li><li>These C-space addresses are called <strong>CPTRs</strong></li></ul><blockquote><p>You don&rsquo;t need to do the transform, because this is typically extracted in some libs.</p></blockquote><p>Capabilities convey specific privilege (acces rights)</p><ul><li>Read, Write, Execute, GrantReply(<code>call</code>), Grant(<code>cap transfer</code>)</li></ul><p>Main operations on capabilities:</p><ul><li><code>Invoke</code>perform operation on object referred to by cap.<ul><li>For example, map some frame into memory. You need to have capabilities to both the frame and address space.</li></ul></li><li><code>Copy</code>|<code>Mint</code>|<code>Grant</code>: create copy of cap with <strong>same/lesser</strong> privilege.</li><li><code>Move</code>|<code>Mutate</code>: transfer to different address with <strong>same/lesser</strong> privilege.<ul><li>Between C-space or within C-space.</li></ul></li><li><code>Delete</code>: invalidate slot(cleans up object if this is the only cap to it)</li><li><code>Revoke</code>: delete any derived(eg. copied or minted) caps</li></ul><h3 id=capability-derivation>Capability Derivation</h3><h4 id=mint-operation>MINT OPERATION</h4><p>The <strong>Mint</strong> operation creates a new, less powerful cap</p><ul><li>Can add badge</li><li>Can strip access rights, eg <code>RW->RO</code></li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>mint(dest, src, rights, badge)
</span></span></code></pre></td></tr></table></div></div><ul><li>The first two arguement are <strong>capability pointers(CPTR)</strong> to a C-space(represented by C-node), which are references inside C-node.</li><li>The <strong>destination C-node cap</strong> must allow modification</li><li>Then you have the rights and the <em>batch</em> of the new cap.</li></ul><p>:pushpin: This is an alternative of sending addressed capabilities by <strong>IPC operation</strong>.
That is what operating system do to set up protection domains for <strong>user level process</strong>.</p><h4 id=copy-operation>COPY OPERATION</h4><blockquote><p>Copy as a version of <em>Mint</em>.</p></blockquote><p> </p><h2 id=sel4-kernel-objects>seL4 Kernel Objects</h2><p>In file <code>libsel4\include\sel4\objecttype.h</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#00f>typedef</span> <span style=color:#00f>enum</span> api_object {
</span></span><span style=display:flex><span>    seL4_UntypedObject,
</span></span><span style=display:flex><span>    seL4_TCBObject,
</span></span><span style=display:flex><span>    seL4_EndpointObject,
</span></span><span style=display:flex><span>    seL4_NotificationObject,
</span></span><span style=display:flex><span>    seL4_CapTableObject,
</span></span><span style=display:flex><span><span style=color:#00f>#ifdef CONFIG_KERNEL_MCS
</span></span></span><span style=display:flex><span><span style=color:#00f></span>    seL4_SchedContextObject,
</span></span><span style=display:flex><span>    seL4_ReplyObject,
</span></span><span style=display:flex><span><span style=color:#00f>#endif
</span></span></span><span style=display:flex><span><span style=color:#00f></span>    seL4_NonArchObjectTypeCount,
</span></span><span style=display:flex><span>} seL4_ObjectType;
</span></span></code></pre></td></tr></table></div></div><p> </p><h2 id=sel4-system-calls>seL4 System Calls</h2><p>seL4 has <code>11</code> syscalls:</p><p><code>Yield()</code>: invokes scheduler</p><ul><li>does NOT require a capability!</li></ul><p><code>Send()</code>,<code>Recv()</code> and variants/combinations thereof: IPC operations</p><ul><li><code>Call()</code>,<code>ReplyRecv()</code>: usually invokes by client/server</li><li><code>Send()</code>, <code>NBSend()</code>: send-only and non-blocking version of it.</li><li><code>Recv()</code>, <code>NBRecv()</code>, <code>NBSendRecv()</code></li><li><code>Wait()</code>, <code>NBWait()</code>, <code>NBSendWait()</code></li></ul><blockquote><p>We just use <code>Call()</code> normally, the others are only for bootstrapping protocols and exception handling.</p></blockquote><p>Call() is atomic Send() + reply-object setup + Wait()</p><ul><li>cannot be simulated with one-way operations!</li></ul><p>ReplyRecv() is NBSend() + Recv()</p><h3 id=different-object-support-different-operations>Different object support different operations</h3><h4 id=endpoints>ENDPOINTS</h4><p>Endpoints support all 10 IPC variants.</p><h4 id=notifications>NOTIFICATIONS</h4><p>Notifications support:</p><ul><li>NBSend() - aliased as Signal()</li><li>Wait()</li><li>NBWait() - aliased as Poll()</li></ul><h4 id=other-objects>OTHER OBJECTS</h4><p>Other objects only supports <code>Call()</code> operation.</p><ul><li>Appear as (kernel-implemented) servers. If you invoking a method on an object, this is done by treating the object as a kernel-implemented server. And you invoke it with a <code>call()</code> operation just as you do a normal server invocation.</li><li>Each of these kernel objects has a different kernel-defined protocol<ul><li>operations encoded in message tag</li><li>parameters passed in message words</li></ul></li><li>Mostly hidden behind <strong>syscall</strong> wrappers, user do not need to know this details.</li></ul><p> </p><h2 id=sel4-ipc>seL4 IPC</h2><blockquote><p>IPC in seL4 is a way to realize <strong>cross-domain</strong> invocation.</p></blockquote><p>seL4 IPC is not a mechanism for shipping data. Transfering data is axillary but not the primary purpose.</p><p>seL4 IPC is a protected procedure call, a user-controlled context switch(from clients context into server context).</p><p> </p><h2 id=sel4-threads>seL4 Threads</h2><h3 id=creating-a-thread>Creating a thread</h3><ol><li>Obtain a TCB object</li><li>Set attributes: V-space, C-space, fault endpoint, IPC buffer</li><li>Set Scheduling parameters:<ul><li>priority, scheduling context, timeout endpoint(maybe MCP)</li></ul></li><li>Set architecture-related registers</li></ol><h3 id=threads-and-stacks>Threads and Stacks</h3><p>Stacks are completely user-managed, kernel doesn&rsquo;t care!</p><blockquote><p>Kernel only preserves SP.. on context switch</p></blockquote><p>Stack location, allocation, size must be managed by <strong>userland</strong>.</p><p>Kernel beware of stack overflow</p></article></body></main></div></body></html>