<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>C语言enum的使用</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>所有文章</a></div><div class="a-block nav-link-item"><a href=/tags>Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e6%9e%9a%e4%b8%be%e7%b1%bb%e5%9e%8b%e7%9a%84%e4%bc%98%e5%8a%bf aria-label=枚举类型的优势>枚举类型的优势</a></li><li><a href=#%e6%9e%9a%e4%b8%be%e7%b1%bb%e5%9e%8b%e6%89%80%e5%8d%a0%e7%9a%84%e5%a4%a7%e5%b0%8f aria-label=枚举类型所占的大小>枚举类型所占的大小</a><ul><li><a href=#%e7%bc%96%e8%af%91%e9%80%89%e9%a1%b9-fshort-enums aria-label=编译选项：-fshort-enums>编译选项：-fshort-enums</a></li></ul></li><li><a href=#enum-%e6%bd%9c%e5%9c%a8%e7%9a%84%e5%8f%af%e7%a7%bb%e6%a4%8d%e6%80%a7%e9%97%ae%e9%a2%98 aria-label="enum 潜在的可移植性问题">enum 潜在的可移植性问题</a></li></ul></div></details></div></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>C语言enum的使用</div></header><h2 id=枚举类型的优势>枚举类型的优势</h2><p>枚举类型完全可被宏定义替代，类如</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#00f>enum</span> Furniture {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>	DOOR = 1,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>	DESK,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>	LOCK,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>}
</span></span></code></pre></div><p>与下面的代码等效</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#00f>#define DOOR  1
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#00f>#define DESK  2
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#00f>#define LOCK  3
</span></span></span></code></pre></div><p>那么我们如何在两种设计方法中选择呢？在我看来某些情况下使用 enum 会有以下优势：</p><ol><li>提高代码键入效率；仅适用于所需变量的值是连续的整数，就像上面的情况，可以只给第一个 DOOR 赋值，其余的值累加。如果首个变量的值要求是 0，甚至每一个都无需显式赋值</li><li>提高代码的可维护性；可以划定范围，编译器也会检查类型是否正确，偶尔会有用</li><li>提高代码的可读性；例如 DOOR, DESK, LOCK&mldr; 都属于家具，均定义在 Furniture 中</li></ol><h2 id=枚举类型所占的大小>枚举类型所占的大小</h2><p>枚举类型所占内存的大小，即枚举变量的大小。</p><p>由于枚举变量的赋值，一次只能存放枚举结构中的某个常数。所以 枚举变量的大小，实质是常数所占内存空间的大小（常数为 int 类型，当前主流的编译器中一般是 32 位机器和 64 位机器中 int 型都是 4 个字节），枚举类型所占内存大小也是这样。</p><p>所以默认情况下，无论枚举变量的值是多少，都是占用 4 个字节。即执行：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>printf(<span style=color:#a31515>&#34;sizeof(enum Furniture) = %d</span><span style=color:#a31515>\n</span><span style=color:#a31515>&#34;</span>, <span style=color:#00f>sizeof</span>(<span style=color:#00f>enum</span> Furniture));
</span></span></code></pre></div><p>输入的结果是 4。</p><h3 id=编译选项-fshort-enums>编译选项：-fshort-enums</h3><p>GCC 下关于这个编译选项的介绍：</p><blockquote><p><strong>-fshort-enums</strong>
Allocate to an enum type only as many bytes as it needs for the declared range of possible values. Specifically, the enum type is equivalent to the smallest integer type that has enough room.
Warning: the -fshort-enums switch causes GCC to generate code that is not binary compatible with code generated without that switch. Use it to conform to a non-default application binary interface.</p></blockquote><p>意思是说使用<code>-fshort-enum</code>s 后，对改枚举类型所占空间的分配就会按照实际变量的占用空间，而非总是 4 字节。</p><p>启用该选项之后，再打印它的 size 就会是 1，因为用 1 个字节就能表示所有枚举变量的值（DOOR=1，DESK=2，LOCK=3）.</p><p>这个“1”不再是固定的，根据其中枚举变量值的不同，动态调整<code>enum Furniture</code>的大小。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#00f>enum</span> Furniture {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>	DOOR = 256,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>	DESK,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>	LOCK,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>}
</span></span></code></pre></div><p>再打印它的 size，结果为 2。因为值 256 无法用 1 个字节存下。</p><h2 id=enum-潜在的可移植性问题>enum 潜在的可移植性问题</h2><p>看似好像启用该选项会节约一定的内存空间，是的。但它也有一定的缺点，其一就是可移植性问题。</p><p>例如你编写的应用在编译时没有启用了该“优化”选项，默认采用 4 字节存储枚举变量。而链接的库文件在编译时却使用了“优化”选项，则库内部此枚举类型的大小可能为 1 字节。若此时恰好你有调用某个库 API，将 enum 变量作为参数进行传递，那么就会发生错误。</p><p>为避免不同库和应用程序使用“优化”选项的差异造成潜在的危险，常用的解决方案是强制使 enum 变量占用 4 个字节，无论其是否开启“优化”。实现方式是在 enum 变量末尾添加一个成员 <code>XXXX_END = 0xFFFFF</code>，例如：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#00f>enum</span> Furniture {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    DOOR = 1,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    DESK,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    LOCK,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    END = 0xFFFFF,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>}
</span></span></code></pre></div></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2023-03-09T17:18:57, Lastmod: 2023-06-24T17:22:07</p></main></div></body></html>