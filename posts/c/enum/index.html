<!doctype html><html><head><title>C语言enum的使用</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/journal.min.ea0f3d3af5cc437a42b1ad2f9b5ebeeaf367c8f8fc3004c55b78f4f503cea3a2.css integrity="sha256-6g89OvXMQ3pCsa0vm16+6vNnyPj8MATFW3j09QPOo6I=" media=screen><link rel=stylesheet href=/scss/dark-mode.min.2509d1ab7a8b17f2ca6b95285afc4f5ef50f8699b8114c954f01351654b5ceba.css integrity="sha256-JQnRq3qLF/LKa5UoWvxPXvUPhpm4EUyVTwE1FlS1zro=" media=screen><script src=/vendor/js/loadCSS.js></script>
<script>loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons")</script><script src=/js/toc.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script>
<script src=/vendor/js/md5.min.js></script>
<script>var gitalk=new Gitalk({clientID:"12dfb0f809e5e6afde3d",clientSecret:"72aaf5660b3a7b43b0bffb4d683a605a7ea65dad",repo:"blogcomments_gitalk",owner:"wangloo",admin:["wangloo"],id:md5(location.pathname),distractionFreeMode:"false"});window.onload=function(){gitalk.render("gitalk-container")}</script></head><body><div id=app><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://wangloo.github.io/><div class=nav-title>Wangloo's BLOG</div><div class=nav-subtitle>花有重开日, 人无再少年</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>Archive</a>
<a class="a-block nav-link-item false" href=/tags>Tags</a>
<a class="a-block nav-link-item false" href=/categories>Categories</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
@2019 Notepadium.</div></div><div id=extraContainer class=extra-container><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e6%9e%9a%e4%b8%be%e7%b1%bb%e5%9e%8b%e7%9a%84%e4%bc%98%e5%8a%bf onclick="onNavClick(`#枚举类型的优势-nav`)" id=枚举类型的优势-nav>枚举类型的优势</a></li><li><a href=#%e6%9e%9a%e4%b8%be%e7%b1%bb%e5%9e%8b%e6%89%80%e5%8d%a0%e7%9a%84%e5%a4%a7%e5%b0%8f onclick="onNavClick(`#枚举类型所占的大小-nav`)" id=枚举类型所占的大小-nav>枚举类型所占的大小</a></li><ul><li><a href=#%e7%bc%96%e8%af%91%e9%80%89%e9%a1%b9-fshort-enums onclick="onNavClick(`#编译选项-fshort-enums-nav`)" id=编译选项-fshort-enums-nav>编译选项：-fshort-enums</a></li></ul><li><a href=#enum-%e6%bd%9c%e5%9c%a8%e7%9a%84%e5%8f%af%e7%a7%bb%e6%a4%8d%e6%80%a7%e9%97%ae%e9%a2%98 onclick="onNavClick(`#enum-潜在的可移植性问题-nav`)" id=enum-潜在的可移植性问题-nav>enum 潜在的可移植性问题</a></li></ul></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a>
<a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>Archive</a>
<a class="a-block drawer-menu-item false" href=/tags>Tags</a>
<a class="a-block drawer-menu-item false" href=/categories>Categories</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e6%9e%9a%e4%b8%be%e7%b1%bb%e5%9e%8b%e7%9a%84%e4%bc%98%e5%8a%bf onclick="onNavClick(`#枚举类型的优势-nav`)" id=枚举类型的优势-nav>枚举类型的优势</a></li><li><a href=#%e6%9e%9a%e4%b8%be%e7%b1%bb%e5%9e%8b%e6%89%80%e5%8d%a0%e7%9a%84%e5%a4%a7%e5%b0%8f onclick="onNavClick(`#枚举类型所占的大小-nav`)" id=枚举类型所占的大小-nav>枚举类型所占的大小</a></li><ul><li><a href=#%e7%bc%96%e8%af%91%e9%80%89%e9%a1%b9-fshort-enums onclick="onNavClick(`#编译选项-fshort-enums-nav`)" id=编译选项-fshort-enums-nav>编译选项：-fshort-enums</a></li></ul><li><a href=#enum-%e6%bd%9c%e5%9c%a8%e7%9a%84%e5%8f%af%e7%a7%bb%e6%a4%8d%e6%80%a7%e9%97%ae%e9%a2%98 onclick="onNavClick(`#enum-潜在的可移植性问题-nav`)" id=enum-潜在的可移植性问题-nav>enum 潜在的可移植性问题</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a id=navTitle class=navbar-brand href=https://wangloo.github.io/>Wangloo's BLOG</a>
<button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://wangloo.github.io/><div class=single-column-header-title>Wangloo's BLOG</div><div class=single-column-header-subtitle>花有重开日, 人无再少年</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>C语言enum的使用<div class=post-meta><time itemprop=datePublished>2023-03-09 17:18</time>
<i class=material-icons>label</i>
<a href=/tags/c>c</a>
&nbsp;
<i class=material-icons>schedule</i>
4 min
28 s.</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h2 id=枚举类型的优势>枚举类型的优势</h2><p>枚举类型完全可被宏定义替代，类如</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>enum</span> Furniture {
</span></span><span style=display:flex><span>	DOOR <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>,
</span></span><span style=display:flex><span>	DESK,
</span></span><span style=display:flex><span>	LOCK,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>与下面的代码等效</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>#define DOOR  1
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define DESK  2
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#define LOCK  3
</span></span></span></code></pre></div><p>那么我们如何在两种设计方法中选择呢？在我看来某些情况下使用 enum 会有以下优势：</p><ol><li>提高代码键入效率；仅适用于所需变量的值是连续的整数，就像上面的情况，可以只给第一个 DOOR 赋值，其余的值累加。如果首个变量的值要求是 0，甚至每一个都无需显式赋值</li><li>提高代码的可维护性；可以划定范围，编译器也会检查类型是否正确，偶尔会有用</li><li>提高代码的可读性；例如 DOOR, DESK, LOCK&mldr; 都属于家具，均定义在 Furniture 中</li></ol><h2 id=枚举类型所占的大小>枚举类型所占的大小</h2><p>枚举类型所占内存的大小，即枚举变量的大小。</p><p>由于枚举变量的赋值，一次只能存放枚举结构中的某个常数。所以 枚举变量的大小，实质是常数所占内存空间的大小（常数为 int 类型，当前主流的编译器中一般是 32 位机器和 64 位机器中 int 型都是 4 个字节），枚举类型所占内存大小也是这样。</p><p>所以默认情况下，无论枚举变量的值是多少，都是占用 4 个字节。即执行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>printf(<span style=color:#f1fa8c>&#34;sizeof(enum Furniture) = %d</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, <span style=color:#ff79c6>sizeof</span>(<span style=color:#ff79c6>enum</span> Furniture));
</span></span></code></pre></div><p>输入的结果是 4。</p><h3 id=编译选项-fshort-enums>编译选项：-fshort-enums</h3><p>GCC 下关于这个编译选项的介绍：</p><blockquote><p><strong>-fshort-enums</strong>
Allocate to an enum type only as many bytes as it needs for the declared range of possible values. Specifically, the enum type is equivalent to the smallest integer type that has enough room.
Warning: the -fshort-enums switch causes GCC to generate code that is not binary compatible with code generated without that switch. Use it to conform to a non-default application binary interface.</p></blockquote><p>意思是说使用<code>-fshort-enum</code>s 后，对改枚举类型所占空间的分配就会按照实际变量的占用空间，而非总是 4 字节。</p><p>启用该选项之后，再打印它的 size 就会是 1，因为用 1 个字节就能表示所有枚举变量的值（DOOR=1，DESK=2，LOCK=3）.</p><p>这个“1”不再是固定的，根据其中枚举变量值的不同，动态调整<code>enum Furniture</code>的大小。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>enum</span> Furniture {
</span></span><span style=display:flex><span>	DOOR <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>256</span>,
</span></span><span style=display:flex><span>	DESK,
</span></span><span style=display:flex><span>	LOCK,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>再打印它的 size，结果为 2。因为值 256 无法用 1 个字节存下。</p><h2 id=enum-潜在的可移植性问题>enum 潜在的可移植性问题</h2><p>看似好像启用该选项会节约一定的内存空间，是的。但它也有一定的缺点，其一就是可移植性问题。</p><p>例如你编写的应用在编译时没有启用了该“优化”选项，默认采用 4 字节存储枚举变量。而链接的库文件在编译时却使用了“优化”选项，则库内部此枚举类型的大小可能为 1 字节。若此时恰好你有调用某个库 API，将 enum 变量作为参数进行传递，那么就会发生错误。</p><p>为避免不同库和应用程序使用“优化”选项的差异造成潜在的危险，常用的解决方案是强制使 enum 变量占用 4 个字节，无论其是否开启“优化”。实现方式是在 enum 变量末尾添加一个成员 <code>XXXX_END = 0xFFFFF</code>，例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>enum</span> Furniture {
</span></span><span style=display:flex><span>    DOOR <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>,
</span></span><span style=display:flex><span>    DESK,
</span></span><span style=display:flex><span>    LOCK,
</span></span><span style=display:flex><span>    END <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0xFFFFF</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr width=100% id=EOF><p style=color:#777>Last modified on 2023-06-24</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/armv8/memory_attr/>Next<br>AArch64 内存属性与内存类型</a>
<a class=older-posts href=/posts/c/feature/>Previous<br>C语言的特点与难点</a></nav><div class=post-comment-wrapper><div id=gitalk-container></div></div></div></div></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
@2019 Notepadium.</div></div><script src=/js/journal.js></script></body></html>