<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>C++ 特性的底层原理</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>所有文章</a></div><div class="a-block nav-link-item"><a href=/tags>Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#const-%e4%bf%ae%e9%a5%b0%e6%88%90%e5%91%98%e5%87%bd%e6%95%b0 aria-label="const 修饰成员函数">const 修饰成员函数</a></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>C++ 特性的底层原理</div></header><h2 id=const-修饰成员函数>const 修饰成员函数</h2><p>C++允许将成员函数添加const修饰符，代表此成员函数不会对成员变量进行修改，
否则会发生编译错误。在下面的示例中，set函数用const修饰就会出错，
而get函数用const修饰就能清楚的告诉别人这个函数不会修改类的成员。</p><p>对于一个声明为const的类实例，C++规定它只能调用const修饰的成员函数，
也就是说明这个类的成员是不允许被修改的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>class A {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#8be9fd>int</span> num;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#8be9fd;font-style:italic>public</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#8be9fd>void</span> set_num(<span style=color:#8be9fd>int</span> x) { num <span style=color:#ff79c6>=</span> x; }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#8be9fd>int</span> get_num(<span style=color:#8be9fd>void</span>) <span style=color:#ff79c6>const</span> { <span style=color:#ff79c6>return</span> num; }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>const</span> A a;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>a.set_num(<span style=color:#bd93f9>10</span>); <span style=color:#6272a4>// Compile error
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>a.get_num();   <span style=color:#6272a4>// Success
</span></span></span></code></pre></div><p>说起a为什么不允许调用set函数，我这里尝试从C的角度去进行解释，
毕竟C和C++本是同根生。C++定义的成员函数会有一个隐形的参数叫this指针，
this总是指向这个类的示例，所以实际上我理解调用成员函数的时候会将成员地址作为参数也传递给成员函数，毕竟这样才能用this指针嘛。然后就说为什么不能调用set函数呢？
我猜测对于一般的成员函数，规定接受的隐形参数this的类型是 <code>A*</code>，
而const修饰的成员函数接受的this类型为 <code>const A*</code>，
这样做就能限制用const修饰的类实例在将其自身地址传递给普通成员函数的时候出错，
即<code>const A *</code> 不能传递给参数类型为 <code>A*</code> 的函数哦，导致编译错误。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// 猜测C实现C++类
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>struct</span> A {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#8be9fd>int</span> num;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#8be9fd>void</span> (<span style=color:#ff79c6>*</span>set_num)(<span style=color:#ff79c6>struct</span> A <span style=color:#ff79c6>*</span>a, <span style=color:#8be9fd>int</span> x){...}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#8be9fd>void</span> (<span style=color:#ff79c6>*</span>get_num)(<span style=color:#ff79c6>const</span> <span style=color:#ff79c6>struct</span> A <span style=color:#ff79c6>*</span>a) {...}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>const</span> <span style=color:#ff79c6>struct</span> A a;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>a.set_num(<span style=color:#ff79c6>&amp;</span>a, <span style=color:#bd93f9>10</span>); <span style=color:#6272a4>// Compile error
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>a.get_num(<span style=color:#ff79c6>&amp;</span>a);     <span style=color:#6272a4>// Ok
</span></span></span></code></pre></div><p>查看编译后的结果能够证实上述的猜想，确实需要将类变量的地址传递给成员函数作为隐式参数。https://godbolt.org/z/dT9rnsvKz</p><figure><img src=/posts/c/cpp_const.jpg width=100%></figure></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2023-12-22T18:51:49, Lastmod: 2024-01-03T23:45:04</p></main></div></body></html>