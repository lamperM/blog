<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/syntax_pastie.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>A Demo of Posix Signal</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e5%92%8c-api-%e4%bb%8b%e7%bb%8d aria-label="数据结构和 API 介绍">数据结构和 API 介绍</a></li><li><a href=#%e4%bf%a1%e5%8f%b7%e4%bb%8e%e8%a7%a6%e5%8f%91%e5%88%b0%e8%a2%ab%e6%8d%95%e8%8e%b7%e7%9a%84%e8%bf%87%e7%a8%8b aria-label=信号从触发到被捕获的过程>信号从触发到被捕获的过程</a></li><li><a href=#%e7%ae%80%e5%8d%95%e7%89%88-demo aria-label="简单版 Demo">简单版 Demo</a></li><li><a href=#%e9%ab%98%e7%ba%a7%e7%89%88-demo aria-label="高级版 Demo">高级版 Demo</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>A Demo of Posix Signal</div></header><h2 id=数据结构和-api-介绍>数据结构和 API 介绍</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 信号配置中最关键的数据结构
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>sigaction</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span>     <span class=p>(</span><span class=o>*</span><span class=n>sa_handler</span><span class=p>)(</span><span class=kt>int</span><span class=p>);</span> <span class=c1>// 信号触发钩子函数（简单版）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>void</span>     <span class=p>(</span><span class=o>*</span><span class=n>sa_sigaction</span><span class=p>)(</span><span class=kt>int</span><span class=p>,</span> <span class=n>siginfo_t</span> <span class=o>*</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=p>);</span> <span class=c1>// 信号触发钩子函数（复杂版）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>sigset_t</span>   <span class=n>sa_mask</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span>        <span class=n>sa_flags</span><span class=p>;</span>  <span class=c1>// 一些标识位，下面会介绍
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>void</span>     <span class=p>(</span><span class=o>*</span><span class=n>sa_restorer</span><span class=p>)(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=c1>// 几种常用的sa_flags:
</span></span></span><span class=line><span class=cl><span class=c1>// SA_SIGINFO ==&gt; 触发信号后会调用更强大的 sa_sigaction()
</span></span></span><span class=line><span class=cl><span class=c1>// SA_ONSTACK ==&gt; 使用单独的栈运行handler，避免函数太大撑爆原来程序栈
</span></span></span><span class=line><span class=cl><span class=c1>// SA_RESTART ==&gt; 使信号触发可以打断阻塞状态（如read()等待），
</span></span></span><span class=line><span class=cl><span class=c1>//                此时errno将被置为 EINTR
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 为某个信号自定义触发handler，以及某些配置项
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>sigaction</span><span class=p>(</span><span class=kt>int</span> <span class=n>signum</span><span class=p>,</span> <span class=k>const</span> <span class=k>struct</span> <span class=n>sigaction</span> <span class=o>*</span><span class=n>act</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=k>struct</span> <span class=n>sigaction</span> <span class=o>*</span><span class=n>oldact</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 在当前进程中触发一个信号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>raise</span><span class=p>(</span><span class=kt>int</span> <span class=n>sig</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 向pid进程发送一个信号（本案例中用不到）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>kill</span><span class=p>(</span><span class=n>pid_t</span> <span class=n>pid</span><span class=p>,</span> <span class=kt>int</span> <span class=n>sig</span><span class=p>);</span>
</span></span></code></pre></div><h2 id=信号从触发到被捕获的过程>信号从触发到被捕获的过程</h2><figure><img src=/posix_signal.jpg width=70%></figure><h2 id=简单版-demo>简单版 Demo</h2><p>只有一个进程</p><ul><li>为 <code>SIGUSR1</code> 设置 handler</li><li>while(1)循环接受用户输入字符</li><li>当输入 q 时为当前进程触发信号</li><li>进入设定的信号 handler，设置进程退出标志</li><li>进程退出，终止</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;assert.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>need_exit</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>sig_handler</span><span class=p>(</span><span class=kt>int</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>assert</span> <span class=p>(</span><span class=n>sig</span> <span class=o>==</span> <span class=n>SIGUSR1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;SIGUSR1 triggered! Set need_exit, program will exit</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>need_exit</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>install_signal_handler</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>sigaction</span> <span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>s</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>s</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>s</span><span class=p>.</span><span class=n>sa_handler</span> <span class=o>=</span> <span class=n>sig_handler</span><span class=p>;</span> <span class=c1>// 重设信号的处理函数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// struct sigaction 的其他参数暂不关心
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>ret</span> <span class=o>=</span> <span class=n>sigaction</span><span class=p>(</span><span class=n>SIGUSR1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>s</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>assert</span><span class=p>(</span><span class=n>ret</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>pid_t</span> <span class=n>pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>install_signal_handler</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>while</span> <span class=p>((</span><span class=n>c</span> <span class=o>=</span> <span class=n>getchar</span><span class=p>()))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=c1>// printf(&#34;char: %c:\n&#34;, c);
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=k>if</span> <span class=p>(</span><span class=n>c</span> <span class=o>==</span> <span class=sc>&#39;q&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=n>raise</span><span class=p>(</span><span class=n>SIGUSR1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=k>if</span> <span class=p>(</span><span class=n>need_exit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=高级版-demo>高级版 Demo</h2><ul><li>设置 SA_SIGINFO 标志，即启用参数更多的 handler</li><li>实现简易的批处理系统？<ul><li>info.si_addr 来判断发生的地址，</li></ul></li></ul><p>重新注册了三个信号的 handler，分别有不同的作用</p><ul><li>SIGUSR1 模拟用户态程序发送 IO 请求</li><li>SIGUSR2 模拟用户态程序调用 yield()主动让出 CPU</li><li>SIGVTALRM 模拟 timer 中断</li><li>SIGSEGV 不是显式触发，程序执行出错自动触发被捕捉。<ul><li>出错可能有多种原因，利用 hangler 中的 <code>siginfo_t</code> 参数区分不同情况</li><li><code>siginfo_t</code> 的结构和成员说明在下方</li><li>主要用到 si_addr, si_code 来区分 syscall、iret、page_fault 行为</li></ul></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>sig_handler</span><span class=p>(</span><span class=kt>int</span> <span class=n>sig</span><span class=p>,</span> <span class=n>siginfo_t</span> <span class=o>*</span><span class=n>info</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>ucontext</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span> <span class=o>=</span> <span class=p>(</span><span class=n>Event</span><span class=p>)</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span><span class=p>.</span><span class=n>event</span> <span class=o>=</span> <span class=n>EVENT_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=n>sig</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>SIGUSR1</span><span class=p>:</span> <span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span><span class=p>.</span><span class=n>event</span> <span class=o>=</span> <span class=n>EVENT_IRQ_IODEV</span><span class=p>;</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>SIGUSR2</span><span class=p>:</span> <span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span><span class=p>.</span><span class=n>event</span> <span class=o>=</span> <span class=n>EVENT_YIELD</span><span class=p>;</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>SIGVTALRM</span><span class=p>:</span> <span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span><span class=p>.</span><span class=n>event</span> <span class=o>=</span> <span class=n>EVENT_IRQ_TIMER</span><span class=p>;</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>SIGSEGV</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>info</span><span class=o>-&gt;</span><span class=n>si_code</span> <span class=o>==</span> <span class=n>SEGV_ACCERR</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=p>((</span><span class=n>uintptr_t</span><span class=p>)</span><span class=n>info</span><span class=o>-&gt;</span><span class=n>si_addr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>case</span> <span class=mh>0x100000</span><span class=o>:</span> <span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span><span class=p>.</span><span class=n>event</span> <span class=o>=</span> <span class=n>EVENT_SYSCALL</span><span class=p>;</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>case</span> <span class=mh>0x100008</span><span class=o>:</span> <span class=n>iret</span><span class=p>(</span><span class=n>ucontext</span><span class=p>);</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>__am_in_userspace</span><span class=p>(</span><span class=n>info</span><span class=o>-&gt;</span><span class=n>si_addr</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>assert</span><span class=p>(</span><span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span><span class=p>.</span><span class=n>event</span> <span class=o>==</span> <span class=n>EVENT_ERROR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span><span class=p>.</span><span class=n>event</span> <span class=o>=</span> <span class=n>EVENT_PAGEFAULT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=p>(</span><span class=n>info</span><span class=o>-&gt;</span><span class=n>si_code</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>case</span> <span class=nl>SEGV_MAPERR</span><span class=p>:</span> <span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span><span class=p>.</span><span class=n>cause</span> <span class=o>=</span> <span class=n>MMAP_READ</span><span class=p>;</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=c1>// we do not support mapped user pages with MMAP_NONE
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>case</span> <span class=nl>SEGV_ACCERR</span><span class=p>:</span> <span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span><span class=p>.</span><span class=n>cause</span> <span class=o>=</span> <span class=n>MMAP_WRITE</span><span class=p>;</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>default</span><span class=o>:</span> <span class=n>assert</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span><span class=p>.</span><span class=n>ref</span> <span class=o>=</span> <span class=p>(</span><span class=n>uintptr_t</span><span class=p>)</span><span class=n>info</span><span class=o>-&gt;</span><span class=n>si_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span><span class=p>.</span><span class=n>event</span> <span class=o>==</span> <span class=n>EVENT_ERROR</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span><span class=p>.</span><span class=n>ref</span> <span class=o>=</span> <span class=p>(</span><span class=n>uintptr_t</span><span class=p>)</span><span class=n>info</span><span class=o>-&gt;</span><span class=n>si_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span><span class=p>.</span><span class=n>cause</span> <span class=o>=</span> <span class=p>(</span><span class=n>uintptr_t</span><span class=p>)</span><span class=n>info</span><span class=o>-&gt;</span><span class=n>si_code</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span><span class=p>.</span><span class=n>msg</span> <span class=o>=</span> <span class=n>strsignal</span><span class=p>(</span><span class=n>sig</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>setup_stack</span><span class=p>(</span><span class=n>thiscpu</span><span class=o>-&gt;</span><span class=n>ev</span><span class=p>.</span><span class=n>event</span><span class=p>,</span> <span class=n>ucontext</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// signal handlers are inherited across fork()
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>install_signal_handler</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>sigaction</span> <span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>s</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>s</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>s</span><span class=p>.</span><span class=n>sa_sigaction</span> <span class=o>=</span> <span class=n>sig_handler</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>s</span><span class=p>.</span><span class=n>sa_flags</span> <span class=o>=</span> <span class=n>SA_SIGINFO</span> <span class=o>|</span> <span class=n>SA_RESTART</span> <span class=o>|</span> <span class=n>SA_ONSTACK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>__am_get_intr_sigmask</span><span class=p>(</span><span class=o>&amp;</span><span class=n>s</span><span class=p>.</span><span class=n>sa_mask</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>ret</span> <span class=o>=</span> <span class=n>sigaction</span><span class=p>(</span><span class=n>SIGVTALRM</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>s</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>assert</span><span class=p>(</span><span class=n>ret</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>ret</span> <span class=o>=</span> <span class=n>sigaction</span><span class=p>(</span><span class=n>SIGUSR1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>s</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>assert</span><span class=p>(</span><span class=n>ret</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>ret</span> <span class=o>=</span> <span class=n>sigaction</span><span class=p>(</span><span class=n>SIGUSR2</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>s</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>assert</span><span class=p>(</span><span class=n>ret</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>ret</span> <span class=o>=</span> <span class=n>sigaction</span><span class=p>(</span><span class=n>SIGSEGV</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>s</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>assert</span><span class=p>(</span><span class=n>ret</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><style type=text/css>.notice{--root-color:#444;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#c33;--warning-content:#fee;--info-title:#fb7;--info-content:#fec;--note-title:#6be;--note-content:#e7f2fa;--tip-title:#5a5;--tip-content:#efe}@media(prefers-color-scheme:dark){.notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}}body.dark .notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--root-color);background:var(--root-background)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background)}.notice.warning .notice-title{background:var(--warning-title)}.notice.warning{background:var(--warning-content)}.notice.info .notice-title{background:var(--info-title)}.notice.info{background:var(--info-content)}.notice.note .notice-title{background:var(--note-title)}.notice.note{background:var(--note-content)}.notice.tip .notice-title{background:var(--tip-title)}.notice.tip{background:var(--tip-content)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div class="notice info" id=siginfo_t><p class=notice-title><span class="icon-notice baseline"><svg xmlns="http://www.w3.org/2000/svg" viewBox="92 59.5 300 300"><path d="M292 303.25V272c0-3.516-2.734-6.25-6.25-6.25H267v-1e2c0-3.516-2.734-6.25-6.25-6.25h-62.5c-3.516.0-6.25 2.734-6.25 6.25V197c0 3.516 2.734 6.25 6.25 6.25H217v62.5h-18.75c-3.516.0-6.25 2.734-6.25 6.25v31.25c0 3.516 2.734 6.25 6.25 6.25h87.5c3.516.0 6.25-2.734 6.25-6.25zm-25-175V97c0-3.516-2.734-6.25-6.25-6.25h-37.5c-3.516.0-6.25 2.734-6.25 6.25v31.25c0 3.516 2.734 6.25 6.25 6.25h37.5c3.516.0 6.25-2.734 6.25-6.25zm125 81.25c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg></span><span>siginfo_t</span></p><p>从 <code>siginfo_t</code> 中截取了某些关键成员，对他们的含义进行说明：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// [si_code] indicating why this signal was sent.
</span></span></span><span class=line><span class=cl><span class=c1>//           需要 man sigaction 才能找到对应与某个信号的所有si_code。
</span></span></span><span class=line><span class=cl><span class=c1>// [si_addr] the address of the fault.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>siginfo_t</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span>      <span class=n>si_signo</span><span class=p>;</span>     <span class=cm>/* Signal number */</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span>      <span class=n>si_errno</span><span class=p>;</span>     <span class=cm>/* An errno value */</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span>      <span class=n>si_code</span><span class=p>;</span>      <span class=cm>/* Signal code */</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span>      <span class=n>si_trapno</span><span class=p>;</span>    <span class=cm>/* Trap number that caused
</span></span></span><span class=line><span class=cl><span class=cm>                              hardware-generated signal
</span></span></span><span class=line><span class=cl><span class=cm>                              (unused on most architectures) */</span>
</span></span><span class=line><span class=cl>    <span class=n>pid_t</span>    <span class=n>si_pid</span><span class=p>;</span>       <span class=cm>/* Sending process ID */</span>
</span></span><span class=line><span class=cl>    <span class=n>uid_t</span>    <span class=n>si_uid</span><span class=p>;</span>       <span class=cm>/* Real user ID of sending process */</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span>      <span class=n>si_status</span><span class=p>;</span>    <span class=cm>/* Exit value or signal */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>union</span> <span class=n>sigval</span> <span class=n>si_value</span><span class=p>;</span> <span class=cm>/* Signal value */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span>    <span class=o>*</span><span class=n>si_addr</span><span class=p>;</span>      <span class=cm>/* Memory location which caused fault */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span>      <span class=n>si_fd</span><span class=p>;</span>        <span class=cm>/* File descriptor */</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div><h2 id=参考>参考</h2><ul><li>南京大学 AM 中 native 实现 CTE 的方案</li></ul></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2024-04-05T20:51:49, Lastmod: 2024-05-12T21:54:13</p><script src=/js/copy-to-clipboard.js></script></main></div></body></html>