<!doctype html><html><head><title>GNU C内联汇编学习笔记</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/journal.min.ea0f3d3af5cc437a42b1ad2f9b5ebeeaf367c8f8fc3004c55b78f4f503cea3a2.css integrity="sha256-6g89OvXMQ3pCsa0vm16+6vNnyPj8MATFW3j09QPOo6I=" media=screen><link rel=stylesheet href=/scss/dark-mode.min.2509d1ab7a8b17f2ca6b95285afc4f5ef50f8699b8114c954f01351654b5ceba.css integrity="sha256-JQnRq3qLF/LKa5UoWvxPXvUPhpm4EUyVTwE1FlS1zro=" media=screen><script src=/vendor/js/loadCSS.js></script>
<script>loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons")</script><script src=/js/toc.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script>
<script src=/vendor/js/md5.min.js></script>
<script>var gitalk=new Gitalk({clientID:"12dfb0f809e5e6afde3d",clientSecret:"72aaf5660b3a7b43b0bffb4d683a605a7ea65dad",repo:"blogcomments_gitalk",owner:"wangloo",admin:["wangloo"],id:md5(location.pathname),distractionFreeMode:"false"});window.onload=function(){gitalk.render("gitalk-container")}</script></head><body><div id=app><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://wangloo.github.io/><div class=nav-title>Wangloo's BLOG</div><div class=nav-subtitle>花有重开日, 人无再少年</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>Archive</a>
<a class="a-block nav-link-item false" href=/tags>Tags</a>
<a class="a-block nav-link-item false" href=/categories>Categories</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
@2019 Notepadium.</div></div><div id=extraContainer class=extra-container><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc-content><center>- CATALOG -</center><ul><ul><ul><li><a href=#%e8%af%ad%e5%8f%a5%e7%bb%93%e6%9e%84 onclick="onNavClick(`#语句结构-nav`)" id=语句结构-nav>语句结构</a></li><ul><li><a href=#qualifiers onclick="onNavClick(`#qualifiers-nav`)" id=qualifiers-nav>Qualifiers</a></li><li><a href=#parameters onclick="onNavClick(`#parameters-nav`)" id=parameters-nav>Parameters</a></li></ul><li><a href=#param-1-assemblertemplate onclick="onNavClick(`#param-1-assemblertemplate-nav`)" id=param-1-assemblertemplate-nav>Param #1: AssemblerTemplate</a></li><li><a href=#param-2-outputoperands onclick="onNavClick(`#param-2-outputoperands-nav`)" id=param-2-outputoperands-nav>Param #2: OutputOperands</a></li><li><a href=#param-3-input-operands onclick="onNavClick(`#param-3-input-operands-nav`)" id=param-3-input-operands-nav>Param #3: Input Operands</a></li><li><a href=#param-4-clobbers onclick="onNavClick(`#param-4-clobbers-nav`)" id=param-4-clobbers-nav>Param #4: Clobbers</a></li><li><a href=#param-5-gotolabels onclick="onNavClick(`#param-5-gotolabels-nav`)" id=param-5-gotolabels-nav>Param #5: GotoLabels</a></li><li><a href=#%e6%a0%b7%e4%be%8b onclick="onNavClick(`#样例-nav`)" id=样例-nav>样例</a></li><ul><li><a href=#%e6%9c%80%e7%ae%80%e5%8d%95%e7%9a%84%e6%a8%a1%e6%9d%bf onclick="onNavClick(`#最简单的模板-nav`)" id=最简单的模板-nav>最简单的模板</a></li><li><a href=#%e6%93%8d%e4%bd%9c%e6%95%b0%e4%bd%bf%e7%94%a8-asmsymbolicname onclick="onNavClick(`#操作数使用-asmsymbolicname-nav`)" id=操作数使用-asmsymbolicname-nav>操作数使用 asmSymbolicName</a></li><li><a href=#%e5%86%85%e9%83%a8%e5%ae%9a%e4%b9%89-label onclick="onNavClick(`#内部定义-label-nav`)" id=内部定义-label-nav>内部定义 label</a></li></ul></ul><li><a href=#reference onclick="onNavClick(`#reference-nav`)" id=reference-nav>Reference</a></li></ul></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a>
<a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>Archive</a>
<a class="a-block drawer-menu-item false" href=/tags>Tags</a>
<a class="a-block drawer-menu-item false" href=/categories>Categories</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><ul><li><a href=#%e8%af%ad%e5%8f%a5%e7%bb%93%e6%9e%84 onclick="onNavClick(`#语句结构-nav`)" id=语句结构-nav>语句结构</a></li><ul><li><a href=#qualifiers onclick="onNavClick(`#qualifiers-nav`)" id=qualifiers-nav>Qualifiers</a></li><li><a href=#parameters onclick="onNavClick(`#parameters-nav`)" id=parameters-nav>Parameters</a></li></ul><li><a href=#param-1-assemblertemplate onclick="onNavClick(`#param-1-assemblertemplate-nav`)" id=param-1-assemblertemplate-nav>Param #1: AssemblerTemplate</a></li><li><a href=#param-2-outputoperands onclick="onNavClick(`#param-2-outputoperands-nav`)" id=param-2-outputoperands-nav>Param #2: OutputOperands</a></li><li><a href=#param-3-input-operands onclick="onNavClick(`#param-3-input-operands-nav`)" id=param-3-input-operands-nav>Param #3: Input Operands</a></li><li><a href=#param-4-clobbers onclick="onNavClick(`#param-4-clobbers-nav`)" id=param-4-clobbers-nav>Param #4: Clobbers</a></li><li><a href=#param-5-gotolabels onclick="onNavClick(`#param-5-gotolabels-nav`)" id=param-5-gotolabels-nav>Param #5: GotoLabels</a></li><li><a href=#%e6%a0%b7%e4%be%8b onclick="onNavClick(`#样例-nav`)" id=样例-nav>样例</a></li><ul><li><a href=#%e6%9c%80%e7%ae%80%e5%8d%95%e7%9a%84%e6%a8%a1%e6%9d%bf onclick="onNavClick(`#最简单的模板-nav`)" id=最简单的模板-nav>最简单的模板</a></li><li><a href=#%e6%93%8d%e4%bd%9c%e6%95%b0%e4%bd%bf%e7%94%a8-asmsymbolicname onclick="onNavClick(`#操作数使用-asmsymbolicname-nav`)" id=操作数使用-asmsymbolicname-nav>操作数使用 asmSymbolicName</a></li><li><a href=#%e5%86%85%e9%83%a8%e5%ae%9a%e4%b9%89-label onclick="onNavClick(`#内部定义-label-nav`)" id=内部定义-label-nav>内部定义 label</a></li></ul></ul><li><a href=#reference onclick="onNavClick(`#reference-nav`)" id=reference-nav>Reference</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a id=navTitle class=navbar-brand href=https://wangloo.github.io/>Wangloo's BLOG</a>
<button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://wangloo.github.io/><div class=single-column-header-title>Wangloo's BLOG</div><div class=single-column-header-subtitle>花有重开日, 人无再少年</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>GNU C内联汇编学习笔记<div class=post-meta><time itemprop=datePublished>2022-09-24 16:48</time>
<i class=material-icons>label</i>
<a href=/tags/c>c</a>
&nbsp;
<i class=material-icons>schedule</i>
4 min
0 s.</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h3 id=语句结构>语句结构</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>asm</span> <span style=color:#ff79c6>asm</span><span style=color:#ff79c6>-</span>qualifiers ( <span style=color:#8be9fd;font-style:italic>AssemblerTemplate</span> 
</span></span><span style=display:flex><span>                      : <span style=color:#8be9fd;font-style:italic>OutputOperands</span>
</span></span><span style=display:flex><span>                      : <span style=color:#8be9fd;font-style:italic>InputOperands</span>
</span></span><span style=display:flex><span>                      : <span style=color:#8be9fd;font-style:italic>Clobbers</span>
</span></span><span style=display:flex><span>                      : GotoLabels)
</span></span></code></pre></div><p>The <code>asm</code> keyword is a GNU extension. 当使用编译选项 <code>-ansi</code> 或 <code>-std</code> 时, 使用 <code>__asm__</code>代替 <code>asm</code>.</p><h4 id=qualifiers>Qualifiers</h4><ul><li>volatile: 避免编译器的过分优化</li><li>goto</li><li>inline</li></ul><h4 id=parameters>Parameters</h4><p><em>AssemblerTemplate</em>: 字符串, 汇编代码的模板</p><p><em>OutputOperands</em>: 输出操作数; 指令将会修改的变量集合</p><p><em>InputOperands</em>: 输入操作数; 指令将读取的变量集合</p><p><em>Clobbers</em>: ???TODO</p><p><em>GotoLabels</em>: 仅当 qualifiers 使用<code>goto</code>时, 声明label集合.</p><blockquote><p>The total number of input + output + goto operands is limited to 30.</p></blockquote><p> </p><h3 id=param-1-assemblertemplate>Param #1: AssemblerTemplate</h3><p>多条语句可以放在一个asm字符串中, 但是更常见的是每条汇编语句使用一个字符串, 并在结束时使用换行符和制表符(<code>\n</code>, <code>\t</code>)来表示换行.</p><blockquote><p>貌似对于 arm 汇编, 只用 <code>\n</code> 也OK?</p></blockquote><p> </p><h3 id=param-2-outputoperands>Param #2: OutputOperands</h3><p>多个 OutputOperands 之间使用<code>,</code>隔开, 每个 OutputOperands 的格式如下:</p><pre tabindex=0><code>[ [asmSymbolicName] ] constraint (cvariablename)
</code></pre><p><em>asmSymbolicName</em>: 指定该操作数的名称</p><p><em>constraint</em>: 对该操作数的一些限制</p><pre tabindex=0><code>// 描述操作数的权限, 输出操作数的约束必须以此开头
=   忽略现有值
+   读写, 当原先值有意义时用它
&amp;   禁止编译器将该操作数与不相关的输入操作数分配同一个寄存器

// 描述输出操作数所在位置, 如果你不知道, 可以同时设置, 编译器会帮你决定
r   寄存器
m   内存
</code></pre><p><em>cvariablename</em>: 输出到的 C 语言变量名</p><p> </p><h3 id=param-3-input-operands>Param #3: Input Operands</h3><p>输入操作数的格式与输出操作数基本一致:</p><pre tabindex=0><code>[ [asmSymbolicName] ] constraint (cexpression)
</code></pre><blockquote><p>对于输入操作数, 一般没有别的限制, 仅使用<code>"r"(val)</code></p></blockquote><p> </p><h3 id=param-4-clobbers>Param #4: Clobbers</h3><p>每个 clobber 都是用双引号括起来, 并用逗号分隔的字符串常量.</p><p>常用的 clobber 参数:</p><ul><li><p>&ldquo;memory&rdquo;<br>告诉编译器, 这段内联汇编代码对输入和输出操作数中列出的项以外的内存读取或写入操作(例如，访问输入参数之一指向的内存). 为确保内存包含正确的值，GCC可能需要在执行ASM之前将特定寄存器值刷新到内存。此外, 阻止编译器越过该 ASM 语句进行 reorder, 形成针对编译器的 memory barrier. 注意, 此 clobber 不会阻止处理器在ASM语句之后执行推测性读取。为了防止出现这种情况，您需要特定于处理器的防护指令。</p></li><li><p>&ldquo;cc&rdquo;<br>This stands for &ldquo;condition codes&rdquo;. Since the add instruction will affect the carry flag amongst other things, we need to tell gcc about it. Otherwise it might want to split a test-and-branch around our code. If it did so, the branch might go the wrong way due to the condition codes being corrupted. Basically, any inline asm that does arithmetic should explicitly clobber the flags like this.</p></li></ul><p> </p><h3 id=param-5-gotolabels>Param #5: GotoLabels</h3><p>尽量不使用, 可以在ASM的内部直接定义 label</p><p>TODO</p><p> </p><h3 id=样例>样例</h3><h4 id=最简单的模板>最简单的模板</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> src <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> dst;   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>asm</span> (<span style=color:#f1fa8c>&#34;mov %1, %0</span><span style=color:#f1fa8c>\n\t</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;add $1, %0&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;=r&#34;</span> (dst) 
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;r&#34;</span> (src));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>printf(<span style=color:#f1fa8c>&#34;%d</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, dst);
</span></span></code></pre></div><h4 id=操作数使用-asmsymbolicname>操作数使用 asmSymbolicName</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>uint32_t</span> c <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span><span style=color:#8be9fd>uint32_t</span> d;
</span></span><span style=display:flex><span><span style=color:#8be9fd>uint32_t</span> <span style=color:#ff79c6>*</span>e <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>c;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>asm</span> (<span style=color:#f1fa8c>&#34;mov %[e], %[d]&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>:</span> [d] <span style=color:#f1fa8c>&#34;=rm&#34;</span> (d)
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>:</span> [e] <span style=color:#f1fa8c>&#34;rm&#34;</span> (<span style=color:#ff79c6>*</span>e));
</span></span></code></pre></div><h4 id=内部定义-label>内部定义 label</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#8be9fd>long</span> temp;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>long</span> ret;    
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>asm</span> <span style=color:#50fa7b>volatile</span>(
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;1:         </span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;ldxr %0, [%2]</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;sub  %0, %0, %3</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;stxr %w1, %0, [%2]</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;cbnz %w1, 1b</span><span style=color:#f1fa8c>\n\t</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;=&amp;r&#34;</span>(ret), <span style=color:#f1fa8c>&#34;=&amp;r&#34;</span>(temp) 
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;r&#34;</span>(p), <span style=color:#f1fa8c>&#34;r&#34;</span>(val)
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;memory&#34;</span>
</span></span><span style=display:flex><span>            );
</span></span></code></pre></div><h2 id=reference>Reference</h2><p><a href=https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#Extended-Asm>Extended Asm (Using the GNU Compiler Collection (GCC))</a></p><hr width=100% id=EOF><p style=color:#777>Last modified on 2023-03-09</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/armv8/exception_return/>Next<br>AArch64/32 异常返回过程</a>
<a class=older-posts href=/posts/armv8/gicv3/>Previous<br>GICv3 介绍</a></nav><div class=post-comment-wrapper><div id=gitalk-container></div></div></div></div></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
@2019 Notepadium.</div></div><script src=/js/journal.js></script></body></html>