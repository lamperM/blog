<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>GNU C 内联汇编学习</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e8%af%ad%e5%8f%a5%e7%bb%93%e6%9e%84 aria-label=语句结构>语句结构</a></li><li><a href=#qualifiers aria-label=Qualifiers>Qualifiers</a></li><li><a href=#parameters aria-label=Parameters>Parameters</a><ul><li><a href=#param-1-assemblertemplate aria-label="Param #1: AssemblerTemplate">Param #1: AssemblerTemplate</a></li><li><a href=#param-2-outputoperands aria-label="Param #2: OutputOperands">Param #2: OutputOperands</a></li><li><a href=#param-3-input-operands aria-label="Param #3: Input Operands">Param #3: Input Operands</a></li><li><a href=#param-4-clobbers aria-label="Param #4: Clobbers">Param #4: Clobbers</a></li><li><a href=#param-5-gotolabels aria-label="Param #5: GotoLabels">Param #5: GotoLabels</a></li></ul></li><li><a href=#%e6%a0%b7%e4%be%8b aria-label=样例>样例</a><ul><li><a href=#%e6%9c%80%e7%ae%80%e5%8d%95%e7%9a%84%e6%a8%a1%e6%9d%bf aria-label=最简单的模板>最简单的模板</a></li><li><a href=#%e6%93%8d%e4%bd%9c%e6%95%b0%e4%bd%bf%e7%94%a8-asmsymbolicname aria-label="操作数使用 asmSymbolicName">操作数使用 asmSymbolicName</a></li><li><a href=#%e5%86%85%e9%83%a8%e5%ae%9a%e4%b9%89-label aria-label="内部定义 label">内部定义 label</a></li></ul></li><li><a href=#reference aria-label=Reference>Reference</a></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>GNU C 内联汇编学习</div></header><h2 id=语句结构>语句结构</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#080;font-weight:700>asm</span> <span style=color:#080;font-weight:700>asm</span>-qualifiers ( <span style=color:#369;font-style:italic>AssemblerTemplate</span> 
</span></span><span style=display:flex><span>                      : <span style=color:#369;font-style:italic>OutputOperands</span>
</span></span><span style=display:flex><span>                      : <span style=color:#369;font-style:italic>InputOperands</span>
</span></span><span style=display:flex><span>                      : <span style=color:#369;font-style:italic>Clobbers</span>
</span></span><span style=display:flex><span>                      : GotoLabels)
</span></span></code></pre></div><p>The <code>asm</code> keyword is a GNU extension. 当使用编译选项 <code>-ansi</code> 或 <code>-std</code> 时, 使用 <code>__asm__</code>代替 <code>asm</code>.</p><h2 id=qualifiers>Qualifiers</h2><ul><li>volatile: 向<strong>编译器</strong>说明禁止内敛的语句与其他语句 reorder。但不能保证内部 reorder，那是<em>内存屏障</em>的任务</li><li>goto</li><li>inline</li></ul><h2 id=parameters>Parameters</h2><p><em>AssemblerTemplate</em>: 字符串, 汇编代码的模板</p><p><em>OutputOperands</em>: 输出操作数; 指令将会修改的变量集合</p><p><em>InputOperands</em>: 输入操作数; 指令将读取的变量集合</p><p><em>Clobbers</em>: ???TODO</p><p><em>GotoLabels</em>: 仅当 qualifiers 使用<code>goto</code>时, 声明label集合.</p><blockquote><p>The total number of input + output + goto operands is limited to 30.</p></blockquote><p> </p><h3 id=param-1-assemblertemplate>Param #1: AssemblerTemplate</h3><p>多条语句可以放在一个asm字符串中, 但是更常见的是每条汇编语句使用一个字符串, 并在结束时使用换行符和制表符(<code>\n</code>, <code>\t</code>)来表示换行.</p><blockquote><p>貌似对于 arm 汇编, 只用 <code>\n</code> 也OK?</p></blockquote><p> </p><h3 id=param-2-outputoperands>Param #2: OutputOperands</h3><p>多个 OutputOperands 之间使用<code>,</code>隔开, 每个 OutputOperands 的格式如下:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[ [asmSymbolicName] ] constraint (cvariablename)
</span></span></code></pre></div><p><em>asmSymbolicName</em>: 指定该操作数的名称</p><p><em>constraint</em>: 对该操作数的一些限制</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>//<span style=color:#bbb> </span><span style=color:#a61717;background-color:#e3d2d2>描述操作数的权限</span>,<span style=color:#bbb> </span><span style=color:#a61717;background-color:#e3d2d2>输出操作数的约束必须以此开头</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>=<span style=color:#bbb>   </span><span style=color:#a61717;background-color:#e3d2d2>忽略现有值</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>+<span style=color:#bbb>   </span><span style=color:#a61717;background-color:#e3d2d2>读写</span>,<span style=color:#bbb> </span><span style=color:#a61717;background-color:#e3d2d2>当原先值有意义时用它</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>&amp;<span style=color:#bbb>   </span><span style=color:#a61717;background-color:#e3d2d2>禁止编译器将该操作数与不相关的输入操作数分配同一个寄存器</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>//<span style=color:#bbb> </span><span style=color:#a61717;background-color:#e3d2d2>描述输出操作数所在位置</span>,<span style=color:#bbb> </span><span style=color:#a61717;background-color:#e3d2d2>如果你不知道</span>,<span style=color:#bbb> </span><span style=color:#a61717;background-color:#e3d2d2>可以同时设置</span>,<span style=color:#bbb> </span><span style=color:#a61717;background-color:#e3d2d2>编译器会帮你决定</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>r<span style=color:#bbb>   </span><span style=color:#a61717;background-color:#e3d2d2>寄存器</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>m<span style=color:#bbb>   </span><span style=color:#a61717;background-color:#e3d2d2>内存</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>//<span style=color:#bbb> </span><span style=color:#a61717;background-color:#e3d2d2>架构相关的</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>z<span style=color:#bbb>   </span>AArch64中存在.<span style=color:#bbb> </span><span style=color:#a61717;background-color:#e3d2d2>表达可以使用零寄存器</span>(XZR<span style=color:#bbb> </span><span style=color:#080;font-weight:700>or</span><span style=color:#bbb> </span>WZR).<span style=color:#bbb> </span>Useful<span style=color:#bbb> </span><span style=color:#080;font-weight:700>when</span><span style=color:#bbb> </span>combined<span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-weight:700>with</span><span style=color:#bbb> </span>`r`<span style=color:#bbb> </span><span style=color:#080;font-weight:700>to</span><span style=color:#bbb> </span>represent<span style=color:#bbb> </span>an<span style=color:#bbb> </span>operand<span style=color:#bbb> </span>that<span style=color:#bbb> </span>can<span style=color:#bbb> </span>be<span style=color:#bbb> </span>either<span style=color:#bbb> </span>a<span style=color:#bbb> </span>general-purpose<span style=color:#bbb> </span>register<span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-weight:700>or</span><span style=color:#bbb> </span>the<span style=color:#bbb> </span>zero<span style=color:#bbb> </span>register.<span style=color:#bbb>
</span></span></span></code></pre></div><p><em>cvariablename</em>: 输出到的 C 语言变量名</p><p> </p><h3 id=param-3-input-operands>Param #3: Input Operands</h3><p>输入操作数的格式与输出操作数基本一致:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[ [asmSymbolicName] ] constraint (cexpression)
</span></span></code></pre></div><blockquote><p>对于输入操作数, 一般没有别的限制, 仅使用<code>"r"(val)</code></p></blockquote><p> </p><h3 id=param-4-clobbers>Param #4: Clobbers</h3><p>每个 clobber 都是用双引号括起来, 并用逗号分隔的字符串常量.</p><p>常用的 clobber 参数:</p><ul><li><p>&ldquo;memory&rdquo;<br>向<strong>编译器</strong>说明对于所有内存访问操作，不能使用 asm 之前预加载到寄存器中的值，
而必须在 asm 内部重新加载。保证其内部访问内存值具有可见性和正确性。</p></li><li><p>&ldquo;cc&rdquo;<br>This stands for &ldquo;condition codes&rdquo;. Since the add instruction will affect the carry flag amongst other things, we need to tell gcc about it. Otherwise it might want to split a test-and-branch around our code. If it did so, the branch might go the wrong way due to the condition codes being corrupted. Basically, any inline asm that does arithmetic should explicitly clobber the flags like this.</p></li></ul><p> </p><h3 id=param-5-gotolabels>Param #5: GotoLabels</h3><p>尽量不使用, 可以在ASM的内部直接定义 label</p><p>TODO</p><p> </p><h2 id=样例>样例</h2><h3 id=最简单的模板>最简单的模板</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#888;font-weight:700>int</span> src = <span style=color:#00d;font-weight:700>1</span>;
</span></span><span style=display:flex><span><span style=color:#888;font-weight:700>int</span> dst;   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-weight:700>asm</span> (<span style=color:#d20;background-color:#fff0f0>&#34;mov %1, %0</span><span style=color:#04d;background-color:#fff0f0>\n\t</span><span style=color:#d20;background-color:#fff0f0>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d20;background-color:#fff0f0>&#34;add $1, %0&#34;</span>
</span></span><span style=display:flex><span>    : <span style=color:#d20;background-color:#fff0f0>&#34;=r&#34;</span> (dst) 
</span></span><span style=display:flex><span>    : <span style=color:#d20;background-color:#fff0f0>&#34;r&#34;</span> (src));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>printf(<span style=color:#d20;background-color:#fff0f0>&#34;%d</span><span style=color:#04d;background-color:#fff0f0>\n</span><span style=color:#d20;background-color:#fff0f0>&#34;</span>, dst);
</span></span></code></pre></div><h3 id=操作数使用-asmsymbolicname>操作数使用 asmSymbolicName</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#888;font-weight:700>uint32_t</span> c = <span style=color:#00d;font-weight:700>1</span>;
</span></span><span style=display:flex><span><span style=color:#888;font-weight:700>uint32_t</span> d;
</span></span><span style=display:flex><span><span style=color:#888;font-weight:700>uint32_t</span> *e = &amp;c;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-weight:700>asm</span> (<span style=color:#d20;background-color:#fff0f0>&#34;mov %[e], %[d]&#34;</span>
</span></span><span style=display:flex><span>   : [d] <span style=color:#d20;background-color:#fff0f0>&#34;=rm&#34;</span> (d)
</span></span><span style=display:flex><span>   : [e] <span style=color:#d20;background-color:#fff0f0>&#34;rm&#34;</span> (*e));
</span></span></code></pre></div><h3 id=内部定义-label>内部定义 label</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#888;font-weight:700>long</span> temp;
</span></span><span style=display:flex><span>    <span style=color:#888;font-weight:700>long</span> ret;    
</span></span><span style=display:flex><span>	<span style=color:#080;font-weight:700>asm</span> <span style=color:#06b;font-weight:700>volatile</span>(
</span></span><span style=display:flex><span>            <span style=color:#d20;background-color:#fff0f0>&#34;1:         </span><span style=color:#04d;background-color:#fff0f0>\n</span><span style=color:#d20;background-color:#fff0f0>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#d20;background-color:#fff0f0>&#34;ldxr %0, [%2]</span><span style=color:#04d;background-color:#fff0f0>\n</span><span style=color:#d20;background-color:#fff0f0>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#d20;background-color:#fff0f0>&#34;sub  %0, %0, %3</span><span style=color:#04d;background-color:#fff0f0>\n</span><span style=color:#d20;background-color:#fff0f0>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#d20;background-color:#fff0f0>&#34;stxr %w1, %0, [%2]</span><span style=color:#04d;background-color:#fff0f0>\n</span><span style=color:#d20;background-color:#fff0f0>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#d20;background-color:#fff0f0>&#34;cbnz %w1, 1b</span><span style=color:#04d;background-color:#fff0f0>\n\t</span><span style=color:#d20;background-color:#fff0f0>&#34;</span>
</span></span><span style=display:flex><span>            : <span style=color:#d20;background-color:#fff0f0>&#34;=&amp;r&#34;</span>(ret), <span style=color:#d20;background-color:#fff0f0>&#34;=&amp;r&#34;</span>(temp) 
</span></span><span style=display:flex><span>            : <span style=color:#d20;background-color:#fff0f0>&#34;r&#34;</span>(p), <span style=color:#d20;background-color:#fff0f0>&#34;r&#34;</span>(val)
</span></span><span style=display:flex><span>            : <span style=color:#d20;background-color:#fff0f0>&#34;memory&#34;</span>
</span></span><span style=display:flex><span>            );
</span></span></code></pre></div><h2 id=reference>Reference</h2><p><a href=https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#Extended-Asm>Extended Asm (Using the GNU Compiler Collection (GCC))</a></p><p><a href=https://developer.arm.com/documentation/100067/0612/armclang-Inline-Assembler/Inline-assembly-constraint-strings/Constraint-codes-for-AArch64-state>AArch64 Constraint codes</a></p></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2022-09-24T16:48:58, Lastmod: 2023-09-24T18:08:59</p><script src=/js/clipboard.js></script></main></div></body></html>