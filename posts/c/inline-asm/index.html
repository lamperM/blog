<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>GNU C内联汇编学习笔记</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>所有文章</a></div><div class="a-block nav-link-item"><a href=/tags>Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput><ul id=searchResults></ul></div></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><h1>GNU C内联汇编学习笔记</h1></header><h2 id=语句结构>语句结构</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#00f>asm</span> <span style=color:#00f>asm</span>-qualifiers ( AssemblerTemplate 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>                      : OutputOperands
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>                      : InputOperands
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>                      : Clobbers
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>                      : GotoLabels)
</span></span></code></pre></div><p>The <code>asm</code> keyword is a GNU extension. 当使用编译选项 <code>-ansi</code> 或 <code>-std</code> 时, 使用 <code>__asm__</code>代替 <code>asm</code>.</p><h2 id=qualifiers>Qualifiers</h2><ul><li>volatile: 避免编译器的过分优化</li><li>goto</li><li>inline</li></ul><h2 id=parameters>Parameters</h2><p><em>AssemblerTemplate</em>: 字符串, 汇编代码的模板</p><p><em>OutputOperands</em>: 输出操作数; 指令将会修改的变量集合</p><p><em>InputOperands</em>: 输入操作数; 指令将读取的变量集合</p><p><em>Clobbers</em>: ???TODO</p><p><em>GotoLabels</em>: 仅当 qualifiers 使用<code>goto</code>时, 声明label集合.</p><blockquote><p>The total number of input + output + goto operands is limited to 30.</p></blockquote><p> </p><h3 id=param-1-assemblertemplate>Param #1: AssemblerTemplate</h3><p>多条语句可以放在一个asm字符串中, 但是更常见的是每条汇编语句使用一个字符串, 并在结束时使用换行符和制表符(<code>\n</code>, <code>\t</code>)来表示换行.</p><blockquote><p>貌似对于 arm 汇编, 只用 <code>\n</code> 也OK?</p></blockquote><p> </p><h3 id=param-2-outputoperands>Param #2: OutputOperands</h3><p>多个 OutputOperands 之间使用<code>,</code>隔开, 每个 OutputOperands 的格式如下:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>[ [asmSymbolicName] ] constraint (cvariablename)
</span></span></code></pre></div><p><em>asmSymbolicName</em>: 指定该操作数的名称</p><p><em>constraint</em>: 对该操作数的一些限制</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>// <span>描述操作数的权限</span>, <span>输出操作数的约束必须以此开头</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>=   <span>忽略现有值</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>+   <span>读写</span>, <span>当原先值有意义时用它</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>&amp;   <span>禁止编译器将该操作数与不相关的输入操作数分配同一个寄存器</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>// <span>描述输出操作数所在位置</span>, <span>如果你不知道</span>, <span>可以同时设置</span>, <span>编译器会帮你决定</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>r   <span>寄存器</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>m   <span>内存</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>// <span>架构相关的</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>z   AArch64中存在. <span>表达可以使用零寄存器</span>(XZR <span style=color:#00f>or</span> WZR). Useful <span style=color:#00f>when</span> combined 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#00f>with</span> `r` <span style=color:#00f>to</span> represent an operand that can be either a general-purpose register 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#00f>or</span> the zero register.
</span></span></code></pre></div><p><em>cvariablename</em>: 输出到的 C 语言变量名</p><p> </p><h3 id=param-3-input-operands>Param #3: Input Operands</h3><p>输入操作数的格式与输出操作数基本一致:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>[ [asmSymbolicName] ] constraint (cexpression)
</span></span></code></pre></div><blockquote><p>对于输入操作数, 一般没有别的限制, 仅使用<code>"r"(val)</code></p></blockquote><p> </p><h3 id=param-4-clobbers>Param #4: Clobbers</h3><p>每个 clobber 都是用双引号括起来, 并用逗号分隔的字符串常量.</p><p>常用的 clobber 参数:</p><ul><li><p>&ldquo;memory&rdquo;<br>告诉编译器, 这段内联汇编代码对输入和输出操作数中列出的项以外的内存读取或写入操作(例如，访问输入参数之一指向的内存). 为确保内存包含正确的值，GCC可能需要在执行ASM之前将特定寄存器值刷新到内存。此外, 阻止编译器越过该 ASM 语句进行 reorder, 形成针对编译器的 memory barrier. 注意, 此 clobber 不会阻止处理器在ASM语句之后执行推测性读取。为了防止出现这种情况，您需要特定于处理器的防护指令。</p></li><li><p>&ldquo;cc&rdquo;<br>This stands for &ldquo;condition codes&rdquo;. Since the add instruction will affect the carry flag amongst other things, we need to tell gcc about it. Otherwise it might want to split a test-and-branch around our code. If it did so, the branch might go the wrong way due to the condition codes being corrupted. Basically, any inline asm that does arithmetic should explicitly clobber the flags like this.</p></li></ul><p> </p><h3 id=param-5-gotolabels>Param #5: GotoLabels</h3><p>尽量不使用, 可以在ASM的内部直接定义 label</p><p>TODO</p><p> </p><h2 id=样例>样例</h2><h3 id=最简单的模板>最简单的模板</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#2b91af>int</span> src = 1;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#2b91af>int</span> dst;   
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#00f>asm</span> (<span style=color:#a31515>&#34;mov %1, %0</span><span style=color:#a31515>\n\t</span><span style=color:#a31515>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#a31515>&#34;add $1, %0&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    : <span style=color:#a31515>&#34;=r&#34;</span> (dst) 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    : <span style=color:#a31515>&#34;r&#34;</span> (src));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>printf(<span style=color:#a31515>&#34;%d</span><span style=color:#a31515>\n</span><span style=color:#a31515>&#34;</span>, dst);
</span></span></code></pre></div><h3 id=操作数使用-asmsymbolicname>操作数使用 asmSymbolicName</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#2b91af>uint32_t</span> c = 1;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#2b91af>uint32_t</span> d;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#2b91af>uint32_t</span> *e = &amp;c;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#00f>asm</span> (<span style=color:#a31515>&#34;mov %[e], %[d]&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>   : [d] <span style=color:#a31515>&#34;=rm&#34;</span> (d)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>   : [e] <span style=color:#a31515>&#34;rm&#34;</span> (*e));
</span></span></code></pre></div><h3 id=内部定义-label>内部定义 label</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>    <span style=color:#2b91af>long</span> temp;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#2b91af>long</span> ret;    
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	<span style=color:#00f>asm</span> volatile(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>            <span style=color:#a31515>&#34;1:         </span><span style=color:#a31515>\n</span><span style=color:#a31515>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            <span style=color:#a31515>&#34;ldxr %0, [%2]</span><span style=color:#a31515>\n</span><span style=color:#a31515>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            <span style=color:#a31515>&#34;sub  %0, %0, %3</span><span style=color:#a31515>\n</span><span style=color:#a31515>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            <span style=color:#a31515>&#34;stxr %w1, %0, [%2]</span><span style=color:#a31515>\n</span><span style=color:#a31515>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>            <span style=color:#a31515>&#34;cbnz %w1, 1b</span><span style=color:#a31515>\n\t</span><span style=color:#a31515>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>            : <span style=color:#a31515>&#34;=&amp;r&#34;</span>(ret), <span style=color:#a31515>&#34;=&amp;r&#34;</span>(temp) 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            : <span style=color:#a31515>&#34;r&#34;</span>(p), <span style=color:#a31515>&#34;r&#34;</span>(val)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            : <span style=color:#a31515>&#34;memory&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            );
</span></span></code></pre></div><h2 id=reference>Reference</h2><p><a href=https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#Extended-Asm>Extended Asm (Using the GNU Compiler Collection (GCC))</a></p><p><a href=https://developer.arm.com/documentation/100067/0612/armclang-Inline-Assembler/Inline-assembly-constraint-strings/Constraint-codes-for-AArch64-state>AArch64 Constraint codes</a></p></article></body></main></div></body></html>