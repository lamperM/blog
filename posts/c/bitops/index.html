<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/syntax_pastie.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>C 语言位操作技巧</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e8%bf%9e%e7%bb%ad%e5%86%85%e5%ad%98%e5%8f%96n-bit aria-label="连续内存取n bit">连续内存取n bit</a></li><li><a href=#%e4%b8%80%e4%b8%aa%e6%95%b0%e5%8f%96%e8%bf%9e%e7%bb%adn-bit aria-label="一个数取连续n bit">一个数取连续n bit</a></li><li><a href=#%e5%88%a4%e6%96%ad%e4%b8%80%e4%b8%aa%e6%95%b0%e6%98%af%e5%90%a6%e4%b8%ba2%e7%9a%84%e5%b9%82 aria-label=判断一个数是否为2的幂>判断一个数是否为2的幂</a></li><li><a href=#%e7%bb%9f%e8%ae%a1%e4%b8%80%e4%b8%aa%e6%95%b0%e7%9a%84%e4%ba%8c%e8%bf%9b%e5%88%b6%e4%b8%ad1%e7%9a%84%e6%95%b0%e9%87%8f aria-label=统计一个数的二进制中1的数量>统计一个数的二进制中1的数量</a></li><li><a href=#%e5%b0%86%e4%b8%80%e4%b8%aa%e6%95%b0%e5%90%91%e4%b8%8a%e5%8f%96%e6%95%b4%e4%b8%ba2%e7%9a%84%e5%b9%82 aria-label=将一个数向上取整为2的幂>将一个数向上取整为2的幂</a></li><li><a href=#%e5%90%91%e4%b8%8a%e5%90%91%e4%b8%8b%e5%af%b9%e9%bd%90-%e6%a3%80%e6%9f%a5%e6%98%af%e5%90%a6%e5%af%b9%e9%bd%90 aria-label="向上/向下对齐, 检查是否对齐">向上/向下对齐, 检查是否对齐</a></li><li><a href=#%e6%a3%80%e6%9f%a5%e4%b8%a4%e4%b8%aa%e6%9c%89%e7%ac%a6%e5%8f%b7%e6%95%b0%e6%98%af%e5%90%a6%e5%bc%82%e5%8f%b7 aria-label=检查两个有符号数是否异号>检查两个有符号数是否异号</a></li><li><a href=#%e5%a4%a7%e5%b0%8f%e7%ab%af%e8%bd%ac%e6%8d%a2 aria-label=大小端转换>大小端转换</a></li><li><a href=#%e5%af%b9%e6%9f%90%e4%b8%aa%e4%bd%8d%e7%9a%84getsetclear%e6%93%8d%e4%bd%9c aria-label=对某个位的get/set/clear操作>对某个位的get/set/clear操作</a></li><li><a href=#sign-extending-from-a-varaiable-bit-width aria-label="Sign extending from a varaiable bit-width">Sign extending from a varaiable bit-width</a></li><li><a href=#%e5%ad%97%e7%ac%a6%e5%ad%97%e7%ac%a6%e6%95%b0%e7%bb%84%e7%9a%84%e5%a4%a7%e5%b0%8f%e5%86%99%e8%bd%ac%e6%8d%a2 aria-label=字符/字符数组的大小写转换>字符/字符数组的大小写转换</a></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>C 语言位操作技巧</div></header><h2 id=连续内存取n-bit>连续内存取n bit</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdint.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;assert.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define bitmask(n) ((1ul &lt;&lt; (n)) - 1)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* 
</span></span></span><span class=line><span class=cl><span class=cm> * 从ptr指向的内存开始，抽取第start个bit开始的连续n个bit
</span></span></span><span class=line><span class=cl><span class=cm> * 限制: n &lt; 32
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>uint32_t</span> <span class=nf>extract_bits</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=n>ptr</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>start</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint32_t</span> <span class=n>start_byte</span> <span class=o>=</span> <span class=n>start</span> <span class=o>/</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint32_t</span> <span class=n>start_offset</span> <span class=o>=</span> <span class=n>start</span> <span class=o>%</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint32_t</span> <span class=o>*</span><span class=n>pstart</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span> <span class=o>*</span><span class=p>)(</span><span class=n>ptr</span> <span class=o>+</span> <span class=n>start_byte</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>uint32_t</span> <span class=n>end</span> <span class=o>=</span> <span class=n>start</span> <span class=o>+</span> <span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint32_t</span> <span class=n>end_byte</span> <span class=o>=</span> <span class=n>end</span> <span class=o>/</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint32_t</span> <span class=n>end_offset</span> <span class=o>=</span> <span class=n>end</span> <span class=o>%</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint32_t</span> <span class=o>*</span><span class=n>pend</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span> <span class=o>*</span><span class=p>)(</span><span class=n>ptr</span> <span class=o>+</span> <span class=n>end_byte</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>uint32_t</span> <span class=n>data</span> <span class=o>=</span> <span class=o>*</span><span class=n>pstart</span> <span class=o>&gt;&gt;</span> <span class=n>start_offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>&gt;</span> <span class=mi>32</span> <span class=o>-</span> <span class=n>start_offset</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* 由于n &lt; 32, 所以补齐*pend一定就够了，
</span></span></span><span class=line><span class=cl><span class=cm>     * end_offset对齐到最后一位(n-1).
</span></span></span><span class=line><span class=cl><span class=cm>     * 
</span></span></span><span class=line><span class=cl><span class=cm>     * 严谨性证明: n 一定&gt; end_offset + 1
</span></span></span><span class=line><span class=cl><span class=cm>     * 因为n &gt; 32-start_offset ==&gt; n &gt; 25, 
</span></span></span><span class=line><span class=cl><span class=cm>     * 且end_offset + 1 &lt; 9, 故得证
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>|=</span> <span class=o>*</span><span class=n>pend</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=n>end_offset</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>data</span> <span class=o>&amp;</span> <span class=n>bitmask</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>test_val</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>val</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>expect</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>val</span> <span class=o>!=</span> <span class=n>expect</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;error: val: 0x%x, expect: 0x%x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>val</span><span class=p>,</span> <span class=n>expect</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>assert</span><span class=p>(</span><span class=n>val</span> <span class=o>==</span> <span class=n>expect</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint32_t</span> <span class=n>vals</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mh>0x11223344</span><span class=p>,</span> <span class=mh>0x11223344</span><span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint32_t</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>ret</span> <span class=o>=</span> <span class=n>extract_bits</span><span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span><span class=n>vals</span><span class=p>,</span> <span class=mi>31</span><span class=p>,</span> <span class=mi>30</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>test_val</span><span class=p>(</span><span class=n>ret</span><span class=p>,</span> <span class=mh>0x22446688</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Test Passed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=一个数取连续n-bit>一个数取连续n bit</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * 从一个数中取第start个bit开始的连续n个bit
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>uint32_t</span> <span class=nf>extract_bits</span> <span class=p>(</span><span class=kt>uint32_t</span> <span class=n>val</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>start</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=n>val</span> <span class=o>&gt;&gt;</span> <span class=n>start</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>bitmask</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=判断一个数是否为2的幂>判断一个数是否为2的幂</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>((</span><span class=n>v</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>v</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;v is a power of 2</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>else</span> 
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;v is not a power of 2</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p> </p><h2 id=统计一个数的二进制中1的数量>统计一个数的二进制中1的数量</h2><p>依然是利用<code>v & (v -1)</code>的运算结果会将v的最低位的<code>1</code>(如果有的话)置<code>0</code>.</p><p>循环执行此操作就可统计v中<code>1</code>的数量.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>numberof1</span><span class=p>(</span><span class=kt>int</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>count</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span> <span class=o>=</span> <span class=n>v</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>v</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p> </p><h2 id=将一个数向上取整为2的幂>将一个数向上取整为2的幂</h2><p>用一个<code>1</code>一直左移, 直到比这个数大为止.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>uint32_t</span> <span class=nf>roundup_pow_of_two</span><span class=p>(</span><span class=k>const</span> <span class=kt>uint32_t</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>ret</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=n>ret</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Linux内核中使用了一种更快的方案, amazing!!!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=n>__inline__</span> <span class=kt>int</span> <span class=nf>generic_fls</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>r</span> <span class=o>=</span> <span class=mi>32</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0xffff0000u</span><span class=p>))</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>		<span class=n>x</span> <span class=o>&lt;&lt;=</span> <span class=mi>16</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>r</span> <span class=o>-=</span> <span class=mi>16</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0xff000000u</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>x</span> <span class=o>&lt;&lt;=</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>r</span> <span class=o>-=</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0xf0000000u</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>x</span> <span class=o>&lt;&lt;=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>r</span> <span class=o>-=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0xc0000000u</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>x</span> <span class=o>&lt;&lt;=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>r</span> <span class=o>-=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0x80000000u</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>x</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>r</span> <span class=o>-=</span> <span class=mi>1</span><span class=p>;</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>__attribute_const__</span> <span class=nf>roundup_pow_of_two</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=p>(</span><span class=mi>1UL</span> <span class=o>&lt;&lt;</span> <span class=n>generic_fls</span><span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p> </p><h2 id=向上向下对齐-检查是否对齐>向上/向下对齐, 检查是否对齐</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* uintptr_t 代表指针的位数
</span></span></span><span class=line><span class=cl><span class=cm> * 加uintptr_t转换的原因是: (void *)不能进行运算
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#define IS_ALIGNED(X, align)  (((uintptr_t)(const void *)(X)) % (align) == 0)
</span></span></span><span class=line><span class=cl><span class=cp>#define ALIGN_UP(X, align)   (((X) + ((align) - 1)) &amp; ~((align) - 1))
</span></span></span><span class=line><span class=cl><span class=cp>#define ALIGN_DOWN(x, align) ((X) &amp; ~((align) - 1))
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define X      (0x12345675)
</span></span></span><span class=line><span class=cl><span class=cp>#define align  (1 &lt;&lt; 2)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>v</span> <span class=o>=</span> <span class=n>IS_ALIGNED</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>align</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=mi>0</span> <span class=o>==</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Given X(0x%x) is not align to 0x%08x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>align</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;After align up,   new X = 0x%x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ALIGN_UP</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>align</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;After align down, new X = 0x%x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ALIGN_DOWN</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>align</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Give X(0x%x) is aligned to 0x%08x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>align</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;After align up,   new X = 0x%x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ALIGN_UP</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>align</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;After align down, new X = 0x%x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ALIGN_DOWN</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>align</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p> </p><h2 id=检查两个有符号数是否异号>检查两个有符号数是否异号</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>((</span><span class=n>x</span> <span class=o>^</span> <span class=n>y</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;They have opposite signs</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;They have same signs</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p> </p><h2 id=大小端转换>大小端转换</h2><p> </p><h2 id=对某个位的getsetclear操作>对某个位的get/set/clear操作</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define GET_BIT(x, bit)     ( ((x) &amp; (1ULL &lt;&lt; (bit))) &gt;&gt; (bit) )
</span></span></span><span class=line><span class=cl><span class=cp>#define SET_BIT(x, bit)     ( (x) |= (1ULL &lt;&lt; (bit)) )
</span></span></span><span class=line><span class=cl><span class=cp>#define CLEAR_BIT(x, bit)   ( (x) &amp;= ~(1ULL &lt;&lt; (bit)) )
</span></span></span></code></pre></div><blockquote><p>Release note:</p><ol><li>添加对<code>unsigned long long</code>长度的支持</li></ol></blockquote><p> </p><h2 id=sign-extending-from-a-varaiable-bit-width>Sign extending from a varaiable bit-width</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>bits</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=mi>8</span><span class=p>;</span> <span class=c1>// number of bits representing the number in x
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mh>0xFFC1</span><span class=p>;</span>   <span class=c1>// ready to get sign-extended
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>rst</span><span class=p>;</span>          <span class=c1>// resulting sign-extended number
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=k>const</span> <span class=n>mask</span> <span class=o>=</span> <span class=mi>1U</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>bits</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span> <span class=c1>// mask can be  pre-computed if bits if fixed.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>x</span> <span class=o>&amp;</span> <span class=p>((</span><span class=mi>1U</span> <span class=o>&lt;&lt;</span> <span class=n>bits</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span> <span class=c1>// cut x if it holds more bits
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>rst</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=o>^</span> <span class=n>mask</span><span class=p>)</span> <span class=o>-</span> <span class=n>mask</span><span class=p>;</span>    <span class=c1>// excellent trick!
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;INPUT: 0x%x, RESULT: 0x%x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>rst</span><span class=p>);</span>
</span></span></code></pre></div><p> </p><h2 id=字符字符数组的大小写转换>字符/字符数组的大小写转换</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define TO_LOWER(c) (unsigned char)((c &gt;= &#39;A&#39; &amp;&amp; c &lt;= &#39;Z&#39;) ? (c | 0x20) : c)
</span></span></span><span class=line><span class=cl><span class=cp>#define TO_UPPER(c) (unsigned char)((c &gt;= &#39;a&#39; &amp;&amp; c &lt;= &#39;z&#39;) ? (c &amp; ~0x20) : c)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define TO_LOWER_STR(s, len) { \
</span></span></span><span class=line><span class=cl><span class=cp>    for (int i = 0; i &lt; len &amp;&amp; s[i] != &#39;\0&#39;; i++) { \
</span></span></span><span class=line><span class=cl><span class=cp>        s[i] = TO_LOWER(s[i]); \
</span></span></span><span class=line><span class=cl><span class=cp>    } \
</span></span></span><span class=line><span class=cl><span class=cp>}
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define TO_UPPER_STR(s, len) {\
</span></span></span><span class=line><span class=cl><span class=cp>    for (int i = 0; i &lt; len &amp;&amp; s[i] != &#39;\0&#39;; i++) { \
</span></span></span><span class=line><span class=cl><span class=cp>        s[i] = TO_UPPER(s[i]); \
</span></span></span><span class=line><span class=cl><span class=cp>    } \
</span></span></span><span class=line><span class=cl><span class=cp>}
</span></span></span></code></pre></div></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2022-07-03T09:44:13, Lastmod: 2023-09-24T18:08:59</p><script src=/js/copy-to-clipboard.js></script></main></div></body></html>