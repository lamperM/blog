<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/syntax_pastie.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>ARM64 上实现 setjmp/longjmp</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e4%bb%8b%e7%bb%8d aria-label=介绍>介绍</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95 aria-label=使用方法>使用方法</a></li><li><a href=#%e5%9f%ba%e4%ba%8e-aarch64-%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label="基于 AArch64 的实现">基于 AArch64 的实现</a></li><li><a href=#setjmp-%e5%ae%9e%e7%8e%b0-try-catch aria-label="setjmp() 实现 try-catch">setjmp() 实现 try-catch</a></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>ARM64 上实现 setjmp/longjmp</div></header><h2 id=介绍>介绍</h2><p>setjmp() and longjmp() 是一对组合使用的函数, 可以实现<strong>全局的goto</strong>.</p><p>setjmp() 构造一个运行环境, 调用longjmp() 则将执行流切换到该环境.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* setjmp() 保存当前的运行环境(上下文)到 env 参数中 */</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>setjmp</span><span class=p>(</span><span class=n>jmp_buf</span> <span class=n>env</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* longjmp() 将控制流切换到 env 指定的运行环境 */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>longjmp</span><span class=p>(</span><span class=n>jmp_buf</span> <span class=n>env</span><span class=p>,</span> <span class=kt>int</span> <span class=n>val</span><span class=p>);</span>
</span></span></code></pre></div><h2 id=使用方法>使用方法</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;setjmp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=n>jmp_buf</span> <span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>longjmp</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* After calling longjmp(), the execution flow back to setjmp(), 
</span></span></span><span class=line><span class=cl><span class=cm>       and setjmp() will return not 0. */</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=n>setjmp</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Return from setjmp</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>foo</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Return from longjmp</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=基于-aarch64-的实现>基于 AArch64 的实现</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=na>.macro</span> <span class=no>func</span> <span class=no>_name</span>
</span></span><span class=line><span class=cl><span class=na>.global</span> <span class=err>\</span><span class=no>_name</span>
</span></span><span class=line><span class=cl><span class=na>.type</span> <span class=err>\</span><span class=no>_name</span><span class=p>,</span> <span class=err>%</span><span class=no>function</span>
</span></span><span class=line><span class=cl><span class=err>\</span><span class=nl>_name:</span>
</span></span><span class=line><span class=cl><span class=na>.endm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>.macro</span> <span class=no>endfunc</span> <span class=no>_name</span>
</span></span><span class=line><span class=cl><span class=na>.size</span> <span class=err>\</span><span class=no>_name</span><span class=p>,</span> <span class=no>.-</span><span class=err>\</span><span class=no>_name</span>
</span></span><span class=line><span class=cl><span class=na>.endm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>/**</span>
</span></span><span class=line><span class=cl> <span class=err>*</span> <span class=nf>setjmp</span> <span class=p>(</span><span class=no>jmp_buf</span> <span class=no>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=err>*</span>
</span></span><span class=line><span class=cl> <span class=err>*</span> <span class=nf>See</span> <span class=no>also</span><span class=p>:</span>
</span></span><span class=line><span class=cl> <span class=err>*</span>          <span class=nf>longjmp</span>
</span></span><span class=line><span class=cl> <span class=err>*</span>
</span></span><span class=line><span class=cl> <span class=err>*</span> <span class=err>@</span><span class=nf>return</span> <span class=mi>0</span> <span class=p>-</span> <span class=no>if</span> <span class=no>returns</span> <span class=no>from</span> <span class=no>direct</span> <span class=no>call</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=err>*</span>         <span class=nf>nonzero</span> <span class=p>-</span> <span class=no>if</span> <span class=no>returns</span> <span class=no>after</span> <span class=no>longjmp.</span>
</span></span><span class=line><span class=cl> <span class=err>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>func</span> <span class=no>setjmp</span>
</span></span><span class=line><span class=cl>    <span class=nf>stp</span>     <span class=no>x19</span><span class=p>,</span> <span class=no>x20</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>],</span> <span class=c>#16
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>stp</span>     <span class=no>x21</span><span class=p>,</span> <span class=no>x22</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>],</span> <span class=c>#16
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>stp</span>     <span class=no>x23</span><span class=p>,</span> <span class=no>x24</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>],</span> <span class=c>#16
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>stp</span>     <span class=no>x25</span><span class=p>,</span> <span class=no>x26</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>],</span> <span class=c>#16
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>stp</span>     <span class=no>x27</span><span class=p>,</span> <span class=no>x28</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>],</span> <span class=c>#16
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>stp</span>     <span class=no>x29</span><span class=p>,</span> <span class=no>x18</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>],</span> <span class=c>#16
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>mov</span>     <span class=no>x9</span><span class=p>,</span> <span class=no>sp</span>
</span></span><span class=line><span class=cl>    <span class=nf>stp</span>     <span class=no>lr</span><span class=p>,</span> <span class=no>x9</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>],</span> <span class=c>#16
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>mov</span>     <span class=no>x0</span><span class=p>,</span> <span class=c>#0
</span></span></span><span class=line><span class=cl><span class=c></span>    
</span></span><span class=line><span class=cl>    <span class=no>ret</span>
</span></span><span class=line><span class=cl><span class=nf>endfunc</span> <span class=no>setjmp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>/**</span>
</span></span><span class=line><span class=cl> <span class=err>*</span> <span class=nf>longjmp</span> <span class=p>(</span><span class=no>jmp_buf</span> <span class=no>env</span><span class=p>,</span> <span class=no>int</span> <span class=no>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=err>*</span>
</span></span><span class=line><span class=cl> <span class=err>*</span> <span class=nl>Note:</span>
</span></span><span class=line><span class=cl> <span class=err>*</span>      <span class=nf>if</span> <span class=no>val</span> <span class=no>is</span> <span class=no>not</span> <span class=mi>0</span><span class=p>,</span> <span class=no>then</span> <span class=no>it</span> <span class=no>would</span> <span class=no>be</span> <span class=no>returned</span> <span class=no>from</span> <span class=no>setjmp</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=err>*</span>      <span class=nf>otherwise</span> <span class=p>-</span> <span class=mi>1</span> <span class=no>would</span> <span class=no>be</span> <span class=no>returned.</span>
</span></span><span class=line><span class=cl> <span class=err>*</span>
</span></span><span class=line><span class=cl> <span class=err>*</span> <span class=nf>See</span> <span class=no>also</span><span class=p>:</span>
</span></span><span class=line><span class=cl> <span class=err>*</span>          <span class=nf>setjmp</span>
</span></span><span class=line><span class=cl> <span class=err>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>func</span> <span class=no>longjmp</span>
</span></span><span class=line><span class=cl>    <span class=nf>ldp</span>     <span class=no>x19</span><span class=p>,</span> <span class=no>x20</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>],</span> <span class=c>#16
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>ldp</span>     <span class=no>x21</span><span class=p>,</span> <span class=no>x22</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>],</span> <span class=c>#16
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>ldp</span>     <span class=no>x23</span><span class=p>,</span> <span class=no>x24</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>],</span> <span class=c>#16
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>ldp</span>     <span class=no>x25</span><span class=p>,</span> <span class=no>x26</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>],</span> <span class=c>#16
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>ldp</span>     <span class=no>x27</span><span class=p>,</span> <span class=no>x28</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>],</span> <span class=c>#16
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>ldp</span>     <span class=no>x29</span><span class=p>,</span> <span class=no>x18</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>],</span> <span class=c>#16
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>ldp</span>     <span class=no>lr</span><span class=p>,</span> <span class=no>x9</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>],</span> <span class=c>#16
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>mov</span>     <span class=no>sp</span><span class=p>,</span> <span class=no>x9</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>mov</span>     <span class=no>x0</span><span class=p>,</span> <span class=no>x1</span>
</span></span><span class=line><span class=cl>    <span class=nf>cbnz</span>    <span class=no>x0</span><span class=p>,</span> <span class=mi>1</span><span class=no>f</span>
</span></span><span class=line><span class=cl>    <span class=nf>add</span> <span class=no>x0</span><span class=p>,</span> <span class=no>x0</span><span class=p>,</span> <span class=c>#1
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>ret</span>
</span></span><span class=line><span class=cl><span class=nf>endfunc</span> <span class=no>longjmp</span>
</span></span></code></pre></div><p>需要保存的上下文包括</p><ul><li><strong>callee-saved 通用寄存器</strong>, 因为可能第一次调用 <code>setjmp()</code> 之后的执行流修改了这些寄存器, 从第二次回到 <code>setjmp()</code> 的角度来看, 就是执行setjmp() 中破坏的. caller-saved 寄存器则不必, 因为本来即便看作是 <code>setjmp()</code> 破坏的, 也是正常的.</li></ul><p>解释一下：在如下的调用场景中, 可以看到在setjmp()之前分别赋值了x2和x19，
这其中x2是caller-saved，x19属于callee-saved。
callee-saved寄存器在子函数调用之前和之后应该是不变的，所以说如果子函数需要修改他们应该在函数进入前进行备份。
所以说显然在(1)的步骤中应该有x19的备份过程，(6)中也应该有对应的恢复。</p><p>那么对于setjmp()呢？它自身也是一个函数，也需要满足规定。所以必须保证(5)访问到数据一定是(3)中保存的。
问题是对于setjmp()的使用方法来说，不是都遵循(1)(2)(3)(4)(5)的调用，下次会从别的位置直接跳到(4)。
此时仍然需要确保x19寄存器的正确性，<strong>只能在首次调用setjmp()时将x19保存下来，以后每次不管从哪里调过来先去恢复保存的x19</strong>。这样就能够实现callee-saved寄存器的正确性。</p><p>再说说caller-saved寄存器，也就是demo中的x2为例，在中间跨越一个setjmp()的条件下，
arch不能保证(4)中得到的值一定是(2)保存的，因为setjmp()可以随意的修改caller-saved寄存器。所以说，如果func()不得不要求(4)访问值的正确性，
一个解决方法就是<strong>在调用setjmp()之前保存x2到栈中，在setjmp()之后立马恢复</strong>。
这是caller的责任，所以这个过程会在func()完成，而不是setjmp()内部。</p><p>以上就是为什么setjmp()只需要保存callee-saved寄存器的解释。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>func</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// (1)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Set</span>    <span class=n>x2</span>  <span class=c1>// (2)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Set</span>    <span class=n>x19</span> <span class=c1>// (3)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>setjmp</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>Access</span> <span class=n>x2</span>  <span class=c1>// (4)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Access</span> <span class=n>x19</span> <span class=c1>// (5)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// (6)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><h2 id=setjmp-实现-try-catch>setjmp() 实现 try-catch</h2></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2022-11-01T23:38:54, Lastmod: 2023-11-30T17:56:18</p><script src=/js/copy-to-clipboard.js></script></main></div></body></html>