<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>ARM64 上实现 setjmp/longjmp</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e4%bb%8b%e7%bb%8d aria-label=介绍>介绍</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95 aria-label=使用方法>使用方法</a></li><li><a href=#%e5%9f%ba%e4%ba%8e-aarch64-%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label="基于 AArch64 的实现">基于 AArch64 的实现</a></li><li><a href=#setjmp-%e5%ae%9e%e7%8e%b0-try-catch aria-label="setjmp() 实现 try-catch">setjmp() 实现 try-catch</a></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>ARM64 上实现 setjmp/longjmp</div></header><h2 id=介绍>介绍</h2><p>setjmp() and longjmp() 是一对组合使用的函数, 可以实现<strong>全局的goto</strong>.</p><p>setjmp() 构造一个运行环境, 调用longjmp() 则将执行流切换到该环境.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#888>/* setjmp() 保存当前的运行环境(上下文)到 env 参数中 */</span>
</span></span><span style=display:flex><span><span style=color:#888;font-weight:700>int</span> <span style=color:#06b;font-weight:700>setjmp</span>(jmp_buf env);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>/* longjmp() 将控制流切换到 env 指定的运行环境 */</span>
</span></span><span style=display:flex><span><span style=color:#888;font-weight:700>void</span> <span style=color:#06b;font-weight:700>longjmp</span>(jmp_buf env, <span style=color:#888;font-weight:700>int</span> val);
</span></span></code></pre></td></tr></table></div></div><h2 id=使用方法>使用方法</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#c00;font-weight:700>#include</span> <span style=color:#c00;font-weight:700>&lt;setjmp.h&gt;</span><span style=color:#c00;font-weight:700>
</span></span></span><span style=display:flex><span><span style=color:#c00;font-weight:700>#include</span> <span style=color:#c00;font-weight:700>&lt;stdio.h&gt;</span><span style=color:#c00;font-weight:700>
</span></span></span><span style=display:flex><span><span style=color:#c00;font-weight:700></span>
</span></span><span style=display:flex><span>jmp_buf e;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-weight:700>void</span> <span style=color:#06b;font-weight:700>foo</span>() {
</span></span><span style=display:flex><span>    longjmp(e, <span style=color:#00d;font-weight:700>1</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-weight:700>int</span> <span style=color:#06b;font-weight:700>main</span>(<span style=color:#888;font-weight:700>void</span>) {
</span></span><span style=display:flex><span>    <span style=color:#888;font-weight:700>int</span> ret;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#888>/* After calling longjmp(), the execution flow back to setjmp(), 
</span></span></span><span style=display:flex><span><span style=color:#888>       and setjmp() will return not 0. */</span>
</span></span><span style=display:flex><span>    ret = setjmp(e);
</span></span><span style=display:flex><span>    <span style=color:#080;font-weight:700>if</span> (ret == <span style=color:#00d;font-weight:700>0</span>) {
</span></span><span style=display:flex><span>        printf(<span style=color:#d20;background-color:#fff0f0>&#34;Return from setjmp</span><span style=color:#04d;background-color:#fff0f0>\n</span><span style=color:#d20;background-color:#fff0f0>&#34;</span>);
</span></span><span style=display:flex><span>        foo();
</span></span><span style=display:flex><span>    } <span style=color:#080;font-weight:700>else</span> {
</span></span><span style=display:flex><span>        printf(<span style=color:#d20;background-color:#fff0f0>&#34;Return from longjmp</span><span style=color:#04d;background-color:#fff0f0>\n</span><span style=color:#d20;background-color:#fff0f0>&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-weight:700>return</span> <span style=color:#00d;font-weight:700>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=基于-aarch64-的实现>基于 AArch64 的实现</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#369>.macro</span> <span style=color:#036;font-weight:700>func</span> <span style=color:#036;font-weight:700>_name</span>
</span></span><span style=display:flex><span><span style=color:#369>.global</span> <span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:#036;font-weight:700>_name</span>
</span></span><span style=display:flex><span><span style=color:#369>.type</span> <span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:#036;font-weight:700>_name</span>, <span style=color:#a61717;background-color:#e3d2d2>%</span><span style=color:#036;font-weight:700>function</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:#369;font-style:italic>_name:</span>
</span></span><span style=display:flex><span><span style=color:#369>.endm</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#369>.macro</span> <span style=color:#036;font-weight:700>endfunc</span> <span style=color:#036;font-weight:700>_name</span>
</span></span><span style=display:flex><span><span style=color:#369>.size</span> <span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:#036;font-weight:700>_name</span>, <span style=color:#036;font-weight:700>.-</span><span style=color:#a61717;background-color:#e3d2d2>\</span><span style=color:#036;font-weight:700>_name</span>
</span></span><span style=display:flex><span><span style=color:#369>.endm</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>/**</span>
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*</span> <span style=color:#06b;font-weight:700>setjmp</span> (<span style=color:#036;font-weight:700>jmp_buf</span> <span style=color:#036;font-weight:700>env</span>)
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*</span>
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*</span> <span style=color:#06b;font-weight:700>See</span> <span style=color:#036;font-weight:700>also</span>:
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*</span>          <span style=color:#06b;font-weight:700>longjmp</span>
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*</span>
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*</span> <span style=color:#a61717;background-color:#e3d2d2>@</span><span style=color:#06b;font-weight:700>return</span> <span style=color:#00d;font-weight:700>0</span> - <span style=color:#036;font-weight:700>if</span> <span style=color:#036;font-weight:700>returns</span> <span style=color:#036;font-weight:700>from</span> <span style=color:#036;font-weight:700>direct</span> <span style=color:#036;font-weight:700>call</span>,
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*</span>         <span style=color:#06b;font-weight:700>nonzero</span> - <span style=color:#036;font-weight:700>if</span> <span style=color:#036;font-weight:700>returns</span> <span style=color:#036;font-weight:700>after</span> <span style=color:#036;font-weight:700>longjmp.</span>
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#06b;font-weight:700>func</span> <span style=color:#036;font-weight:700>setjmp</span>
</span></span><span style=display:flex><span>    <span style=color:#06b;font-weight:700>stp</span>     <span style=color:#036;font-weight:700>x19</span>, <span style=color:#036;font-weight:700>x20</span>, [<span style=color:#036;font-weight:700>x0</span>], <span style=color:#888>#16
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#036;font-weight:700>stp</span>     <span style=color:#036;font-weight:700>x21</span>, <span style=color:#036;font-weight:700>x22</span>, [<span style=color:#036;font-weight:700>x0</span>], <span style=color:#888>#16
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#036;font-weight:700>stp</span>     <span style=color:#036;font-weight:700>x23</span>, <span style=color:#036;font-weight:700>x24</span>, [<span style=color:#036;font-weight:700>x0</span>], <span style=color:#888>#16
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#036;font-weight:700>stp</span>     <span style=color:#036;font-weight:700>x25</span>, <span style=color:#036;font-weight:700>x26</span>, [<span style=color:#036;font-weight:700>x0</span>], <span style=color:#888>#16
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#036;font-weight:700>stp</span>     <span style=color:#036;font-weight:700>x27</span>, <span style=color:#036;font-weight:700>x28</span>, [<span style=color:#036;font-weight:700>x0</span>], <span style=color:#888>#16
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#036;font-weight:700>stp</span>     <span style=color:#036;font-weight:700>x29</span>, <span style=color:#036;font-weight:700>x18</span>, [<span style=color:#036;font-weight:700>x0</span>], <span style=color:#888>#16
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#036;font-weight:700>mov</span>     <span style=color:#036;font-weight:700>x9</span>, <span style=color:#036;font-weight:700>sp</span>
</span></span><span style=display:flex><span>    <span style=color:#06b;font-weight:700>stp</span>     <span style=color:#036;font-weight:700>lr</span>, <span style=color:#036;font-weight:700>x9</span>, [<span style=color:#036;font-weight:700>x0</span>], <span style=color:#888>#16
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#036;font-weight:700>mov</span>     <span style=color:#036;font-weight:700>x0</span>, <span style=color:#888>#0
</span></span></span><span style=display:flex><span><span style=color:#888></span>    
</span></span><span style=display:flex><span>    <span style=color:#036;font-weight:700>ret</span>
</span></span><span style=display:flex><span><span style=color:#06b;font-weight:700>endfunc</span> <span style=color:#036;font-weight:700>setjmp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>/**</span>
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*</span> <span style=color:#06b;font-weight:700>longjmp</span> (<span style=color:#036;font-weight:700>jmp_buf</span> <span style=color:#036;font-weight:700>env</span>, <span style=color:#036;font-weight:700>int</span> <span style=color:#036;font-weight:700>val</span>)
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*</span>
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*</span> <span style=color:#369;font-style:italic>Note:</span>
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*</span>      <span style=color:#06b;font-weight:700>if</span> <span style=color:#036;font-weight:700>val</span> <span style=color:#036;font-weight:700>is</span> <span style=color:#036;font-weight:700>not</span> <span style=color:#00d;font-weight:700>0</span>, <span style=color:#036;font-weight:700>then</span> <span style=color:#036;font-weight:700>it</span> <span style=color:#036;font-weight:700>would</span> <span style=color:#036;font-weight:700>be</span> <span style=color:#036;font-weight:700>returned</span> <span style=color:#036;font-weight:700>from</span> <span style=color:#036;font-weight:700>setjmp</span>,
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*</span>      <span style=color:#06b;font-weight:700>otherwise</span> - <span style=color:#00d;font-weight:700>1</span> <span style=color:#036;font-weight:700>would</span> <span style=color:#036;font-weight:700>be</span> <span style=color:#036;font-weight:700>returned.</span>
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*</span>
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*</span> <span style=color:#06b;font-weight:700>See</span> <span style=color:#036;font-weight:700>also</span>:
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*</span>          <span style=color:#06b;font-weight:700>setjmp</span>
</span></span><span style=display:flex><span> <span style=color:#a61717;background-color:#e3d2d2>*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#06b;font-weight:700>func</span> <span style=color:#036;font-weight:700>longjmp</span>
</span></span><span style=display:flex><span>    <span style=color:#06b;font-weight:700>ldp</span>     <span style=color:#036;font-weight:700>x19</span>, <span style=color:#036;font-weight:700>x20</span>, [<span style=color:#036;font-weight:700>x0</span>], <span style=color:#888>#16
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#036;font-weight:700>ldp</span>     <span style=color:#036;font-weight:700>x21</span>, <span style=color:#036;font-weight:700>x22</span>, [<span style=color:#036;font-weight:700>x0</span>], <span style=color:#888>#16
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#036;font-weight:700>ldp</span>     <span style=color:#036;font-weight:700>x23</span>, <span style=color:#036;font-weight:700>x24</span>, [<span style=color:#036;font-weight:700>x0</span>], <span style=color:#888>#16
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#036;font-weight:700>ldp</span>     <span style=color:#036;font-weight:700>x25</span>, <span style=color:#036;font-weight:700>x26</span>, [<span style=color:#036;font-weight:700>x0</span>], <span style=color:#888>#16
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#036;font-weight:700>ldp</span>     <span style=color:#036;font-weight:700>x27</span>, <span style=color:#036;font-weight:700>x28</span>, [<span style=color:#036;font-weight:700>x0</span>], <span style=color:#888>#16
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#036;font-weight:700>ldp</span>     <span style=color:#036;font-weight:700>x29</span>, <span style=color:#036;font-weight:700>x18</span>, [<span style=color:#036;font-weight:700>x0</span>], <span style=color:#888>#16
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#036;font-weight:700>ldp</span>     <span style=color:#036;font-weight:700>lr</span>, <span style=color:#036;font-weight:700>x9</span>, [<span style=color:#036;font-weight:700>x0</span>], <span style=color:#888>#16
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#036;font-weight:700>mov</span>     <span style=color:#036;font-weight:700>sp</span>, <span style=color:#036;font-weight:700>x9</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#06b;font-weight:700>mov</span>     <span style=color:#036;font-weight:700>x0</span>, <span style=color:#036;font-weight:700>x1</span>
</span></span><span style=display:flex><span>    <span style=color:#06b;font-weight:700>cbnz</span>    <span style=color:#036;font-weight:700>x0</span>, <span style=color:#00d;font-weight:700>1</span><span style=color:#036;font-weight:700>f</span>
</span></span><span style=display:flex><span>    <span style=color:#06b;font-weight:700>add</span> <span style=color:#036;font-weight:700>x0</span>, <span style=color:#036;font-weight:700>x0</span>, <span style=color:#888>#1
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#00d;font-weight:700>1</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#06b;font-weight:700>ret</span>
</span></span><span style=display:flex><span><span style=color:#06b;font-weight:700>endfunc</span> <span style=color:#036;font-weight:700>longjmp</span>
</span></span></code></pre></td></tr></table></div></div><p>需要保存的上下文包括</p><ul><li><strong>callee-saved 通用寄存器</strong>, 因为可能第一次调用 <code>setjmp()</code> 之后的执行流修改了这些寄存器, 从第二次回到 <code>setjmp()</code> 的角度来看, 就是执行setjmp() 中破坏的. caller-saved 寄存器则不必, 因为本来即便看作是 <code>setjmp()</code> 破坏的, 也是正常的.</li></ul><p>解释一下：在如下的调用场景中, 可以看到在setjmp()之前分别赋值了x2和x19，
这其中x2是caller-saved，x19属于callee-saved。
callee-saved寄存器在子函数调用之前和之后应该是不变的，所以说如果子函数需要修改他们应该在函数进入前进行备份。
所以说显然在(1)的步骤中应该有x19的备份过程，(6)中也应该有对应的恢复。</p><p>那么对于setjmp()呢？它自身也是一个函数，也需要满足规定。所以必须保证(5)访问到数据一定是(3)中保存的。
问题是对于setjmp()的使用方法来说，不是都遵循(1)(2)(3)(4)(5)的调用，下次会从别的位置直接跳到(4)。
此时仍然需要确保x19寄存器的正确性，<strong>只能在首次调用setjmp()时将x19保存下来，以后每次不管从哪里调过来先去恢复保存的x19</strong>。这样就能够实现callee-saved寄存器的正确性。</p><p>再说说caller-saved寄存器，也就是demo中的x2为例，在中间跨越一个setjmp()的条件下，
arch不能保证(4)中得到的值一定是(2)保存的，因为setjmp()可以随意的修改caller-saved寄存器。所以说，如果func()不得不要求(4)访问值的正确性，
一个解决方法就是<strong>在调用setjmp()之前保存x2到栈中，在setjmp()之后立马恢复</strong>。
这是caller的责任，所以这个过程会在func()完成，而不是setjmp()内部。</p><p>以上就是为什么setjmp()只需要保存callee-saved寄存器的解释。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>func()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#888>// (1)
</span></span></span><span style=display:flex><span><span style=color:#888></span>  Set    x2  <span style=color:#888>// (2)
</span></span></span><span style=display:flex><span><span style=color:#888></span>  Set    x19 <span style=color:#888>// (3)
</span></span></span><span style=display:flex><span><span style=color:#888></span>  setjmp()
</span></span><span style=display:flex><span>  Access x2  <span style=color:#888>// (4)
</span></span></span><span style=display:flex><span><span style=color:#888></span>  Access x19 <span style=color:#888>// (5)
</span></span></span><span style=display:flex><span><span style=color:#888></span>  <span style=color:#888>// (6)
</span></span></span><span style=display:flex><span><span style=color:#888></span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=setjmp-实现-try-catch>setjmp() 实现 try-catch</h2></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2022-11-01T23:38:54, Lastmod: 2023-11-30T17:56:18</p><script src=/js/clipboard.js></script></main></div></body></html>