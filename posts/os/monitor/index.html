<!doctype html><html><head><title>Armv8 Kernel Monitor</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/journal.min.a4a96c4dc87303b81206f86623ab533a5c6cc7fe9ac433fcdd808d2089bae63b.css integrity="sha256-pKlsTchzA7gSBvhmI6tTOlxsx/6axDP83YCNIIm65js=" media=screen><link rel=stylesheet href=/scss/dark-mode.min.8d11714119bdb3c376b7eab64344dcd1f183f83f58c906bbe5d8b770bccf9c03.css integrity="sha256-jRFxQRm9s8N2t+q2Q0Tc0fGD+D9YyQa75di3cLzPnAM=" media=screen><script src=/vendor/js/loadCSS.js></script>
<script>loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons")</script><script src=/js/toc.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script>
<script src=/vendor/js/md5.min.js></script>
<script>var gitalk=new Gitalk({clientID:"12dfb0f809e5e6afde3d",clientSecret:"72aaf5660b3a7b43b0bffb4d683a605a7ea65dad",repo:"blogcomments_gitalk",owner:"wangloo",admin:["wangloo"],id:md5(location.pathname),distractionFreeMode:"false"});window.onload=function(){gitalk.render("gitalk-container")}</script></head><body><div id=app><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://wangloo.github.io/><div class=nav-title>Soben's Secret Base</div><div class=nav-subtitle>花有重开日, 人无再少年</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>Archive</a>
<a class="a-block nav-link-item false" href=/tags>Tags</a>
<a class="a-block nav-link-item false" href=/categories>Categories</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
@2019 Notepadium.</div></div><div id=extraContainer class=extra-container><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#kernel-monitor-%e6%98%af%e4%bb%80%e4%b9%88 onclick="onNavClick(`#kernel-monitor-是什么-nav`)" id=kernel-monitor-是什么-nav>Kernel Monitor 是什么</a></li><li><a href=#kernel-monitor-%e6%80%bb%e4%bd%93%e8%ae%be%e8%ae%a1 onclick="onNavClick(`#kernel-monitor-总体设计-nav`)" id=kernel-monitor-总体设计-nav>Kernel Monitor 总体设计</a></li><ul><li><a href=#%e6%9c%ac%e5%9c%b0-monitor onclick="onNavClick(`#本地-monitor-nav`)" id=本地-monitor-nav>本地 Monitor</a></li><li><a href=#%e8%bf%9c%e7%a8%8b-monitor onclick="onNavClick(`#远程-monitor-nav`)" id=远程-monitor-nav>远程 Monitor</a></li><li><a href=#monitor-client-%e8%ae%be%e8%ae%a1 onclick="onNavClick(`#monitor-client-设计-nav`)" id=monitor-client-设计-nav>Monitor Client 设计</a></li><li><a href=#%e5%90%af%e7%94%a8-monitor-%e6%97%b6-kernel-%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b onclick="onNavClick(`#启用-monitor-时-kernel-启动流程-nav`)" id=启用-monitor-时-kernel-启动流程-nav>启用 Monitor 时 Kernel 启动流程</a></li></ul><li><a href=#kernel-debug-%e8%bf%87%e7%a8%8b%e7%a4%ba%e4%be%8b onclick="onNavClick(`#kernel-debug-过程示例-nav`)" id=kernel-debug-过程示例-nav>Kernel debug 过程示例</a></li><ul><li><a href=#%e7%a4%ba%e4%be%8b%e4%b8%80-%e6%9f%a5%e7%9c%8b%e5%8f%98%e9%87%8f-var-%e7%9a%84%e5%80%bc onclick="onNavClick(`#示例一-查看变量-var-的值-nav`)" id=示例一-查看变量-var-的值-nav>示例一: 查看变量 var 的值</a></li><li><a href=#%e7%a4%ba%e4%be%8b%e4%ba%8c-%e6%b7%bb%e5%8a%a0%e6%96%ad%e7%82%b9%e5%88%b0-main-%e5%87%bd%e6%95%b0 onclick="onNavClick(`#示例二-添加断点到-main-函数-nav`)" id=示例二-添加断点到-main-函数-nav>示例二: 添加断点到 main 函数</a></li><li><a href=#%e7%a4%ba%e4%be%8b%e4%b8%89-%e5%8d%95%e6%ad%a5%e6%89%a7%e8%a1%8c onclick="onNavClick(`#示例三-单步执行-nav`)" id=示例三-单步执行-nav>示例三: 单步执行</a></li></ul><li><a href=#%e5%85%b6%e4%bb%96%e6%8b%93%e5%b1%95%e5%8a%9f%e8%83%bd onclick="onNavClick(`#其他拓展功能-nav`)" id=其他拓展功能-nav>其他拓展功能</a></li></ul></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a>
<a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>Archive</a>
<a class="a-block drawer-menu-item false" href=/tags>Tags</a>
<a class="a-block drawer-menu-item false" href=/categories>Categories</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#kernel-monitor-%e6%98%af%e4%bb%80%e4%b9%88 onclick="onNavClick(`#kernel-monitor-是什么-nav`)" id=kernel-monitor-是什么-nav>Kernel Monitor 是什么</a></li><li><a href=#kernel-monitor-%e6%80%bb%e4%bd%93%e8%ae%be%e8%ae%a1 onclick="onNavClick(`#kernel-monitor-总体设计-nav`)" id=kernel-monitor-总体设计-nav>Kernel Monitor 总体设计</a></li><ul><li><a href=#%e6%9c%ac%e5%9c%b0-monitor onclick="onNavClick(`#本地-monitor-nav`)" id=本地-monitor-nav>本地 Monitor</a></li><li><a href=#%e8%bf%9c%e7%a8%8b-monitor onclick="onNavClick(`#远程-monitor-nav`)" id=远程-monitor-nav>远程 Monitor</a></li><li><a href=#monitor-client-%e8%ae%be%e8%ae%a1 onclick="onNavClick(`#monitor-client-设计-nav`)" id=monitor-client-设计-nav>Monitor Client 设计</a></li><li><a href=#%e5%90%af%e7%94%a8-monitor-%e6%97%b6-kernel-%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b onclick="onNavClick(`#启用-monitor-时-kernel-启动流程-nav`)" id=启用-monitor-时-kernel-启动流程-nav>启用 Monitor 时 Kernel 启动流程</a></li></ul><li><a href=#kernel-debug-%e8%bf%87%e7%a8%8b%e7%a4%ba%e4%be%8b onclick="onNavClick(`#kernel-debug-过程示例-nav`)" id=kernel-debug-过程示例-nav>Kernel debug 过程示例</a></li><ul><li><a href=#%e7%a4%ba%e4%be%8b%e4%b8%80-%e6%9f%a5%e7%9c%8b%e5%8f%98%e9%87%8f-var-%e7%9a%84%e5%80%bc onclick="onNavClick(`#示例一-查看变量-var-的值-nav`)" id=示例一-查看变量-var-的值-nav>示例一: 查看变量 var 的值</a></li><li><a href=#%e7%a4%ba%e4%be%8b%e4%ba%8c-%e6%b7%bb%e5%8a%a0%e6%96%ad%e7%82%b9%e5%88%b0-main-%e5%87%bd%e6%95%b0 onclick="onNavClick(`#示例二-添加断点到-main-函数-nav`)" id=示例二-添加断点到-main-函数-nav>示例二: 添加断点到 main 函数</a></li><li><a href=#%e7%a4%ba%e4%be%8b%e4%b8%89-%e5%8d%95%e6%ad%a5%e6%89%a7%e8%a1%8c onclick="onNavClick(`#示例三-单步执行-nav`)" id=示例三-单步执行-nav>示例三: 单步执行</a></li></ul><li><a href=#%e5%85%b6%e4%bb%96%e6%8b%93%e5%b1%95%e5%8a%9f%e8%83%bd onclick="onNavClick(`#其他拓展功能-nav`)" id=其他拓展功能-nav>其他拓展功能</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a id=navTitle class=navbar-brand href=https://wangloo.github.io/>Soben's Secret Base</a>
<button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://wangloo.github.io/><div class=single-column-header-title>Soben's Secret Base</div><div class=single-column-header-subtitle>花有重开日, 人无再少年</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>Armv8 Kernel Monitor<div class=post-meta><time itemprop=datePublished>2022-10-28 22:56</time>
<i class=material-icons>schedule</i>
7 min
54 s.</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><p> </p><h2 id=kernel-monitor-是什么>Kernel Monitor 是什么</h2><p>Kernel Monitor 是一个适配我们微内核操作系统的 Kernel 调试和监控系统. 它能实现内核的动态调试和监控. 同时, 它还接管内核的同步异常和系统错误, 使开发者能够了解发生异常时系统的状态.</p><p>Kernel Monitor 具有一定的可扩展性, 例如通过统计内核中存储的 TCB 来实时监控系统中所有线程的状态. 可根据开发者的需求添加统计的对象, 如 Endpoint, Capability等.</p><p> </p><h2 id=kernel-monitor-总体设计>Kernel Monitor 总体设计</h2><p>Kernel Monitor 系统包含 Clinet 和 Server 两个部分. 简单来说, Client 负责处理用户输入, 并将输入进行解析, 封装为 一系列基础命令. 发送给 Server. Server 负责执行这些 基础的命令, 如设置断点, 查看某个地址的值等.</p><p>整个系统有<em>两种架构</em>: 本地 Monitor 和远程 Monitor.</p><p>本地monitor 和远程 monitor 的区别是: <strong>Monitor Client 的位置在哪, 是否与 Server 在同一个机器上</strong>.</p><blockquote><p>先说 Monitor Server, 它必须嵌入要调试的 Kernel 中, <strong>位于一个地址空间</strong>, 方便操作 Kernel 的内存.</p></blockquote><h3 id=本地-monitor>本地 Monitor</h3><p>在本地 Monitor 中, client 和 sever 都位于目标机(Target)上, 目标机通常是开发板.</p><p>对于 AArch64 体系结构来说, 最多有四个异常等级(EL0-EL3). Client 可以运行在EL2.</p><p><img src=./%E6%9C%AC%E5%9C%B0monitor.png alt=image-20221029141414942></p><h3 id=远程-monitor>远程 Monitor</h3><p>远程 Monitor 架构则不同, Clinet 运行在宿主机(Host)上, 通常是Linux. 它与 Server 的通信是通过网络/UART实现的.</p><p><img src=./%E8%BF%9C%E7%A8%8Bmonitor.png alt=image-20221029142002468></p><blockquote><p>Monitor Client 运行在本地和远程对于实现的难度和用户体验有影响.</p><ul><li><p>如果 Client 实现在本地, 则 Client 无需实现网口和串口的驱动, 但Monitor 输入输出的串口与操作系统本身的串口相同, 信息冗杂在一起不易查看; 同时, 如果 Client 实现在本地, 那么对于ELF的解析需要在无操作系统提供的库支持下完成, 可能比较复杂.</p></li><li><p>如果 Client 实现在远程, 即为 Linux 上的一个APP. 那么它和 Server 的通信就需要通过外部的网口或者串口(对于我们使用的64位开发板只引出了一个串口, 所以只能使用网口). 需要在 Server 上实现网口的驱动, 这部分比较复杂. 但是好处是 Client 的实现简单很多, 因为有 Linux APP 运行环境的支持. 同时, 远程 Monitor 架构下, Monitor 和 操作系统自身的输入输出分开, 用户可读性更好.</p></li></ul></blockquote><p>Server 是嵌入到Kernel的代码中, 与Client进行交互. 它是整个 Monitor 系统的后端, 负责实现基础的调试操作. 例如, 设置断点, 内存的读写, 寄存器的读写等.</p><ul><li>由于Server与 Kernel 位于同一个地址空间, 所以查看/修改内存的值是非常方便的. 对于寄存器也是同理.</li><li>断点(Breakpoint), 监视点(Watchpoint), 单步执行(Soft step)的实现依赖与 ARMv8 提供的的 <a href="https://developer.arm.com/-/media/Arm%20Developer%20Community/PDF/Learn%20the%20Architecture/V8A%20Self-hosted%20debug.pdf?revision=5eff4cc6-b4ca-4017-a07d-2957307058cb">self-hosted debug</a> 支持.</li></ul><p>同时, Server 还负责监视系统中所有的 同步异常和系统错误. 一旦发生, 可在 Monitor 中查看某些内存, 寄存器的值定位问题发生的原因.</p><h3 id=monitor-client-设计>Monitor Client 设计</h3><p>Client 的构成可分为三个模块 :</p><ul><li>用户交互模块</li><li>符号处理模块</li><li>消息收发模块</li></ul><p>用户交互模块负责处理用户的输入输出, 调用其他两个模块完成调试命令.</p><p>符号处理模块负责解析可执行文件(ELF), 并建立静态符号表, 存储符号和地址的对应关系. 将用户输入的符号解析为虚拟地址, 或者反向解析.</p><p>消息收发模块负责处理用户的输入, 将其转化为基础, 标准的命令, 发送给Server执行. Client 和 Server之间通信的数据包协议可以使用 <a href=https://sourceware.org/gdb/onlinedocs/gdb/Remote-Protocol.html>GDB Remote Serial Protocol</a> (以下简称RSP协议), 或者自己规定一个协议也是可行的.</p><blockquote><p>RSP协议支持三种基础命令:</p><ol><li>寄存器相关</li><li>内存相关</li><li>程序控制命令</li></ol></blockquote><h3 id=启用-monitor-时-kernel-启动流程>启用 Monitor 时 Kernel 启动流程</h3><ol><li>Kernel 首先做必要的初始化, GIC, 异常向量表, MMU等.</li><li>将控制权交给 Monitor, 等待用户输入.</li></ol><p> </p><h2 id=kernel-debug-过程示例>Kernel debug 过程示例</h2><h3 id=示例一-查看变量-var-的值>示例一: 查看变量 <code>var</code> 的值</h3><ol><li>用户输入 <code>print var</code> 指令.</li><li>由符号处理模块, 将<code>var</code>符号转为var 虚拟地址.</li><li>由消息收发指令将请求封装为RSP协议包格式, 并发送到 Monitor Server.</li><li>执行流程交给 Monitor Server, 它访问该地址, 将内容封装发回 Monitor Client.</li><li>Client 输出<code>var</code>的值, 继续等待用户输入</li></ol><h3 id=示例二-添加断点到-main-函数>示例二: 添加断点到 <code>main</code> 函数</h3><ol><li>用户输入 <code>break main</code> 指令</li><li>由符号处理模块, 解析得到 <code>main</code> 函数的地址.</li><li>消息收发模块将请求封装为RSP包格式, 发送到Monitor Server.</li><li>执行流程交给 Server. 它执行 <em>breakpoint exception 指令</em>, 并设置相关软件断点相关寄存器</li><li>执行流交给 Kernel, 直到达到断点处(可使用地址+ContextID双重验证), 触发Debug异常</li><li>Debug异常属于同步异常, 由 Monitor 系统接管, 回到 Client 继续等待用户输入</li></ol><h3 id=示例三-单步执行>示例三: 单步执行</h3><ol><li>用户输入 <code>step</code> 指令</li><li>消息收发模块将请求封装为RSP包格式, 发送到 Monitor Server.</li><li>执行流程交给 Server, 启用 software step. 然执行一次异常返回, 回到Kernel 继续执行.</li><li>因为启用了 Software step, 回到 Kernel 执行完一条指令后, 就会触发 Debug异常</li><li>Debug 异常属于同步异常, 由 Monitor 系统接管, 回到 Client 继续等待用户输入</li></ol><p> </p><h2 id=其他拓展功能>其他拓展功能</h2><p>back trace</p><p>性能分析</p><hr width=100% id=EOF><p style=color:#777>Last modified on 2023-02-27</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/c/setjmp_and_longjmp/>Next<br>基于ARM64实现setjmp/longjmp</a>
<a class=older-posts href=/posts/armv8/mmu/>Previous<br>ARMv8-A MMU介绍</a></nav><div class=post-comment-wrapper><div id=gitalk-container></div></div></div></div></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
@2019 Notepadium.</div></div><script src=/js/journal.js></script></body></html>