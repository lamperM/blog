<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/syntax_pastie.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>设备树 Device Tree</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e8%ae%be%e5%a4%87%e6%a0%91%e7%9a%84%e5%8a%a0%e8%bd%bd%e6%b5%81%e7%a8%8b aria-label=设备树的加载流程>设备树的加载流程</a></li><li><a href=#%e8%ae%be%e5%a4%87%e6%a0%91%e8%b0%83%e8%af%95 aria-label=设备树调试>设备树调试</a></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>设备树 Device Tree</div></header><p>设备树是一种描述硬件信息的文件格式。</p><p>设备树实现了驱动代码与硬件设备信息的分离，驱动代码可以有很多，但是不一定每个设备都要用。在设备树中配置了启用哪些设备，和一些关于设备的配置，比如说中断号是多少、内存地址是哪里。就能与驱动代码分离开，即便是不用板子的外设，只要型号一致就能用同一份驱动。其他的尽量做成可配置的。</p><h2 id=设备树的加载流程>设备树的加载流程</h2><p>Uboot将设备树的地址传给 Linux内核</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>bootm &lt;uImage_addr&gt; &lt;initrd_addr&gt; &lt;dtb_addr&gt;
</span></span></code></pre></div><p><code>start_kernel</code>是内核进入C环境调用的第一个函数，不久后便会调用dtb的解析。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>start_kernel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>=&gt;</span> <span class=n>setup_arch</span><span class=p>(</span><span class=o>&amp;</span><span class=n>command_line</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=o>=&gt;</span> <span class=n>setup_machine_fdt</span><span class=p>(</span><span class=n>__fdt_pointer</span><span class=p>);</span>
</span></span></code></pre></div><p>__fdt_pointer 是在汇编中赋值的，存储由Uboot传来的fdt地址。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>/*</span>
</span></span><span class=line><span class=cl> <span class=err>*</span> <span class=nf>Preserve</span> <span class=no>the</span> <span class=no>arguments</span> <span class=no>passed</span> <span class=no>by</span> <span class=no>the</span> <span class=no>bootloader</span> <span class=no>in</span> <span class=no>x0</span> <span class=no>..</span> <span class=no>x3</span>
</span></span><span class=line><span class=cl> <span class=err>*/</span>
</span></span><span class=line><span class=cl><span class=nf>SYM_CODE_START_LOCAL</span><span class=p>(</span><span class=no>preserve_boot_args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>mov</span>	<span class=no>x21</span><span class=p>,</span> <span class=no>x0</span>				<span class=err>//</span> <span class=no>x21</span><span class=err>=</span><span class=no>FDT</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>adr_l</span>	<span class=no>x0</span><span class=p>,</span> <span class=no>boot_args</span>			<span class=err>//</span> <span class=no>record</span> <span class=no>the</span> <span class=no>contents</span> <span class=no>of</span>
</span></span><span class=line><span class=cl>	<span class=nf>stp</span>	<span class=no>x21</span><span class=p>,</span> <span class=no>x1</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>]</span>			<span class=err>//</span> <span class=no>x0</span> <span class=no>..</span> <span class=no>x3</span> <span class=no>at</span> <span class=no>kernel</span> <span class=no>entry</span>
</span></span><span class=line><span class=cl>	<span class=nf>stp</span>	<span class=no>x2</span><span class=p>,</span> <span class=no>x3</span><span class=p>,</span> <span class=p>[</span><span class=no>x0</span><span class=p>,</span> <span class=c>#16]
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>	<span class=nf>dmb</span>	<span class=no>sy</span>				<span class=err>//</span> <span class=no>needed</span> <span class=no>before</span> <span class=no>dc</span> <span class=no>ivac</span> <span class=no>with</span>
</span></span><span class=line><span class=cl>						<span class=err>//</span> <span class=nf>MMU</span> <span class=no>off</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>mov</span>	<span class=no>x1</span><span class=p>,</span> <span class=c>#0x20			// 4 x 8 bytes
</span></span></span><span class=line><span class=cl><span class=c></span>	<span class=no>b</span>	<span class=no>__inval_dcache_area</span>		<span class=err>//</span> <span class=no>tail</span> <span class=no>call</span>
</span></span><span class=line><span class=cl><span class=nf>SYM_CODE_END</span><span class=p>(</span><span class=no>preserve_boot_args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>...</span>
</span></span><span class=line><span class=cl><span class=nf>str_l</span>	<span class=no>x21</span><span class=p>,</span> <span class=no>__fdt_pointer</span><span class=p>,</span> <span class=no>x5</span>		<span class=err>//</span> <span class=no>Save</span> <span class=no>FDT</span> <span class=no>pointer</span>
</span></span></code></pre></div><p>TBD：继续分析 <code>setup_machine_fdt()</code> ？</p><h2 id=设备树调试>设备树调试</h2><p>查看原始的dtb文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ls /sys/firmware/fdt 
</span></span><span class=line><span class=cl>hexdump -C /sys/firmware/fdt
</span></span></code></pre></div><p>查看设备树信息。以目录结构程现的dtb文件, 根节点对应base目录, 每一个节点对应一个目录, 每一个属性对应一个文件
/proc/device-tree 是链接文件, 指向 /sys/firmware/devicetree/base</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ls /sys/firmware/devicetree
</span></span><span class=line><span class=cl>ls /proc/device-tree
</span></span></code></pre></div><p>查看所有硬件信息。系统中所有的platform_device, 有来自设备树的, 也有来有.c文件中注册的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ls /sys/devices/platform
</span></span></code></pre></div></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2024-07-26T19:28:12, Lastmod: 2024-08-22T23:53:01</p><script src=/js/copy-to-clipboard.js></script></main></div></body></html>