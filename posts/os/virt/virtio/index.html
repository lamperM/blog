<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/syntax_pastie.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>虚拟化：Virtio基础</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e8%ae%be%e5%a4%87%e8%99%9a%e6%8b%9f%e5%8c%96 aria-label=设备虚拟化>设备虚拟化</a></li><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%80%89%e6%8b%a9virtio aria-label=为什么选择virtio>为什么选择virtio</a></li><li><a href=#virtio%e5%9c%a8qemu%e4%b8%8a%e5%a6%82%e4%bd%95%e6%8f%90%e5%8d%87%e6%80%a7%e8%83%bd aria-label=Virtio在QEMU上如何提升性能>Virtio在QEMU上如何提升性能</a></li><li><a href=#%e6%88%91%e6%98%af%e4%b8%80%e4%b8%aavmm%e5%bc%80%e5%8f%91%e8%80%85%e5%a6%82%e4%bd%95%e6%94%af%e6%8c%81virtio aria-label=我是一个VMM开发者，如何支持Virtio>我是一个VMM开发者，如何支持Virtio</a></li><li><a href=#%e6%88%91%e6%98%af%e4%b8%80%e4%b8%aalinux%e9%a9%b1%e5%8a%a8%e5%bc%80%e5%8f%91%e8%80%85%e5%a6%82%e4%bd%95%e6%94%af%e6%8c%81virtio aria-label=我是一个Linux驱动开发者，如何支持Virtio>我是一个Linux驱动开发者，如何支持Virtio</a></li><li><a href=#%e6%88%91%e6%98%af%e4%b8%80%e4%b8%aa%e8%ae%be%e5%a4%87%e5%8e%82%e5%95%86%e5%a6%82%e4%bd%95%e6%94%af%e6%8c%81virtio aria-label=我是一个设备厂商，如何支持Virtio>我是一个设备厂商，如何支持Virtio</a></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>虚拟化：Virtio基础</div></header><p>从最近开始接触虚拟化的基础知识，一直不太理解设备虚拟化的理念。然而通过最近对Virtio的了解，可能稍微有一些见解，在这里记录下。</p><h2 id=设备虚拟化>设备虚拟化</h2><p>我喜欢从简单、熟悉的事物中开始理解。串口是相对简单的一个设备，我在日常开发中也经常会用到，所以我想拿串口当作一个例子进行说明Virtio的初衷及原理。</p><p>设备虚拟化，实际就是GuestOS(kernel)与VMM之间通信，VMM如何将GuestOS发出的设备请求转换为物理设备的状态转换。</p><h2 id=为什么选择virtio>为什么选择virtio</h2><p>virtio 设计的初衷是简化设计、提高性能。</p><p>virtio 是一种接口规范，位于VM的前端和VMM的后端都可以随意设计，只要满足约定就能实现设备虚拟化。</p><p>站在VM、VMM的角度，互相更换不需要重新思考如何设计设备虚拟的方法，只要双方都支持Virtio，就能相互通信。</p><p>站在VMM的角度，如果是VMM自己实现硬件驱动的形式，Virtio能帮你节约大量开发时间、节约工程量。
因为VM可能需要很多设备的驱动（看Linux支持多少驱动），难道作为VMM要为每个驱动都设计映射方案？有那么多类型的串口设备，每个设备的数据寄存器都不同，VMM要知道每个设备寄存器的含义，并转换成真实设备的行为。这个工作量太大了！</p><h2 id=virtio在qemu上如何提升性能>Virtio在QEMU上如何提升性能</h2><p>为了方便，启用ARM VHE特定，Linux kernel和Hyper都在EL2，避免二者之间的切换。</p><p>VM APP想要在串口输出一串字符，未启用virtio时（全虚拟化）：</p><ol><li>VM kernel: 向串口的数据寄存器写一个字符 ==> trap to Hyper</li><li>Hyper: 设备请求处理不了，交给QEMU ==〉 back to Qemu</li><li>Qemu: 调用putchar打印 ==> syscall to Host kernel</li><li>Host Kernel: 写到真实的物理串口寄存器上</li></ol><h2 id=我是一个vmm开发者如何支持virtio>我是一个VMM开发者，如何支持Virtio</h2><h2 id=我是一个linux驱动开发者如何支持virtio>我是一个Linux驱动开发者，如何支持Virtio</h2><h2 id=我是一个设备厂商如何支持virtio>我是一个设备厂商，如何支持Virtio</h2></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2024-04-19T19:28:12, Lastmod: 2024-05-12T21:54:13</p></main></div></body></html>