<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>Qemu 启动 Linux Kernel(Arm64)</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><ul><li><a href=#%e6%9c%80%e7%bb%88%e6%95%88%e6%9e%9c aria-label=最终效果>最终效果</a></li><li><a href=#%e5%87%86%e5%a4%87-linux-%e5%86%85%e6%a0%b8%e9%95%9c%e5%83%8f aria-label="准备 Linux 内核镜像">准备 Linux 内核镜像</a><ul><li><a href=#%e4%b8%8b%e8%bd%bd aria-label=下载>下载</a></li><li><a href=#%e7%bc%96%e8%af%91 aria-label=编译>编译</a></li><li><a href=#%e4%b8%8d%e5%90%8c-linux-%e5%86%85%e6%a0%b8%e9%95%9c%e5%83%8f%e7%9a%84%e5%8c%ba%e5%88%ab aria-label="不同 Linux 内核镜像的区别">不同 Linux 内核镜像的区别</a><ul><li><a href=#vmlinux aria-label=vmlinux>vmlinux</a></li><li><a href=#vmlinuz aria-label=vmlinuz>vmlinuz</a></li><li><a href=#image aria-label=Image>Image</a></li><li><a href=#zimage aria-label=zImage>zImage</a></li><li><a href=#bzimage aria-label=bzImage>bzImage</a></li><li><a href=#uimage aria-label=uImage>uImage</a></li></ul></li><li><a href=#%e5%86%85%e6%a0%b8%e7%bc%96%e8%af%91%e8%84%9a%e6%9c%ac aria-label=内核编译脚本>内核编译脚本</a></li></ul></li><li><a href=#%e6%9e%84%e5%bb%ba%e6%a0%b9%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f aria-label=构建根文件系统>构建根文件系统</a><ul><li><a href=#%e6%ba%90%e7%a0%81%e4%b8%8b%e8%bd%bd aria-label=源码下载>源码下载</a></li><li><a href=#%e7%bc%96%e8%af%91-1 aria-label=编译>编译</a></li><li><a href=#%e9%80%82%e9%85%8d-initrd%e6%96%b9%e5%bc%8f aria-label="适配-initrd=方式">适配<code>-initrd=</code>方式</a></li><li><a href=#%e9%80%82%e9%85%8d-appendrootdevvda%e6%96%b9%e5%bc%8f aria-label="适配-append=&amp;quot;root=/dev/vda方式">适配<code>-append="root=/dev/vda</code>方式</a></li></ul></li><li><a href=#%e5%87%86%e5%a4%87-uboot%e6%9c%aa%e5%ae%8c%e6%88%90 aria-label="准备 Uboot（未完成）">准备 Uboot（未完成）</a><ul><li><a href=#%e6%ba%90%e7%a0%81%e4%b8%8b%e8%bd%bd-1 aria-label=源码下载>源码下载</a></li><li><a href=#%e7%bc%96%e8%af%91-2 aria-label=编译>编译</a></li><li><a href=#%e5%a4%b1%e8%b4%a5%e7%9a%84%e6%8a%98%e8%85%be aria-label=失败的折腾>失败的折腾</a><ul><li><a href=#%e5%88%b6%e4%bd%9c-sd-%e5%8d%a1 aria-label="制作 Sd 卡">制作 Sd 卡</a></li></ul></li></ul></li></ul><li><a href=#%e5%a2%9e%e5%8a%a0-perf aria-label="增加 perf">增加 perf</a><ul><li><a href=#%e8%af%95%e7%94%a8-kgdb-%e8%b0%83%e8%af%95%e5%86%85%e6%a0%b8 aria-label="试用 KGDB 调试内核">试用 KGDB 调试内核</a></li><li><a href=#%e5%a2%9e%e5%8a%a0-strace aria-label="增加 strace">增加 strace</a></li></ul></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>Qemu 启动 Linux Kernel(Arm64)</div></header><h2 id=最终效果>最终效果</h2><p>用的环境和各个软件版本为：</p><ul><li>Qemu: 8.1.50 (qemu-system-aarch64 -M virt)</li><li>linux-4.9.1</li><li>u-boot-2023.10</li><li>busybox-1.34.0</li></ul><p>经过一番折腾，还是没有成功 Qemu+Uboot 来引导 linux 内核，
因为 virt 板级不支持<code>-sd</code>参数，主要的折腾过程见下。
但理论上也可以，只是后面发现没啥必要，用<code>-kernel</code>也能完成目前需求。
<code>-kernel</code>形式下功能没问题，有 Rootfs，可以在 Guest 中读写。</p><h2 id=准备-linux-内核镜像>准备 Linux 内核镜像</h2><h3 id=下载>下载</h3><ul><li><a href=https://zh.wikipedia.org/wiki/Linux%E5%86%85%E6%A0%B8%E7%89%88%E6%9C%AC%E5%8E%86%E5%8F%B2>Linux 内核版本历史 - 维基百科</a></li><li><a href=http://ftp.sjtu.edu.cn/sites/ftp.kernel.org/pub/linux/kernel/>上海交通大学镜像站</a></li></ul><h3 id=编译>编译</h3><p>Linux kernel 使用 make 来构建，可以键入<code>make help</code>查看支持的命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>Cleaning targets:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  clean           - Remove most generated files but keep the config and
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>                    enough build support to build external modules
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  mrproper        - Remove all generated files + config + various backup files
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  distclean       - mrproper + remove editor backup and patch files
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>Configuration targets:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  config          - Update current config utilising a line-oriented program
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  nconfig         - Update current config utilising a ncurses menu based
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>                    program
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  menuconfig      - Update current config utilising a menu based program
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  xconfig         - Update current config utilising a Qt based front-end
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  gconfig         - Update current config utilising a GTK+ based front-end
</span></span></code></pre></div><h3 id=不同-linux-内核镜像的区别>不同 Linux 内核镜像的区别</h3><h4 id=vmlinux>vmlinux</h4><p>vmlinux 是可引导的、未压缩、可压缩的内核镜像，vm 代表 Virtual Memory。
（表示 Linux 支持虚拟内存，因此得名 vm）它是由用户对内核源码编译得到，
实质是 elf 格式的文件.也就是说 vmlinux 是编译出来的最原始的内核文件，未压缩。</p><figure><img src=/vmlinux.jpg width=80%></figure><h4 id=vmlinuz>vmlinuz</h4><p>vmlinuz 是可执行 的 Linux 内核，它位于/boot/vmlinuz，
它一般是一个软链接，比如是 vmlinuz-3.13.0-32-generic 的软链接。
vmlinuz 是 vmlinux 的压缩文件。vmlinuz 的建立有两种方式。
一是编译内核时通过“make zImage”创建，二是内核编译时通过命令 make bzImage 创建。</p><h4 id=image>Image</h4><p>Image 是经过 objcopy 处理的只包含二进制数据的内核代码，它已经不是 elf 格式了，但这种格式的内核镜像还没有经过压缩.</p><h4 id=zimage>zImage</h4><p>zImage 是 ARM linux 常用的一种压缩镜像文件，它是由 vmlinux 经过 objcopy ，
objcopy 实现由 vmlinux 的 elf 文件拷贝成纯二进制数据文件加上解压代码经 gzip 压缩而成，
命令格式是#make zImage.这种格式的 Linux 镜像文件多存放在 NAND 上。
适用于小内核的情况，它的存在是为了向后的兼容性。</p><figure><img src=/zImage.jpg width=80%></figure><h4 id=bzimage>bzImage</h4><p>bzImage 不是用 bzip2 压缩的，bz 表示 big zImage,其格式与 zImage 类似，
但采用了不同的压缩算法，注意，bzImage 的压缩率更高 ，是压缩的内核映像。</p><p>zImage/bzImage：它们不仅是一个压缩文件，而且在这两个文件的开头部分内嵌有解压缩代码。
两者的不同之处在于，老的 zImage 解压缩内核到低端内存(第一个 640K)，
bzImage 解压缩内核到高端内存(1M 以上)。如果内核比较小，那么可以采用 zImage 或 bzImage 之一，
两种方式引导的系统运行时是相同的。大的内核采用 bzImage，不能采用 zImage。</p><h4 id=uimage>uImage</h4><p>uImage 是 uboot 专用的镜像文件，它是在 zImage 之前加上一个长度为 0x40 的头信息(tag)（也就是说 uImage 是一个二进制文件），在头信息内说明了该镜像文件的类型、加载 位置、生成时间、大小等信息.换句话说，若直接从 uImage 的 0x40 位置开始执行，则 zImage 和 uImage 没有任何区别.命令格式是#make uImage.这种格式的 Linux 镜像文件多存放在 NAND 上.</p><figure><img src=/uImage.jpg width=80%></figure><style type=text/css>.notice{--root-color:#444;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#c33;--warning-content:#fee;--info-title:#fb7;--info-content:#fec;--note-title:#6be;--note-content:#e7f2fa;--tip-title:#5a5;--tip-content:#efe}@media(prefers-color-scheme:dark){.notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}}body.dark .notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--root-color);background:var(--root-background)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background)}.notice.warning .notice-title{background:var(--warning-title)}.notice.warning{background:var(--warning-content)}.notice.info .notice-title{background:var(--info-title)}.notice.info{background:var(--info-content)}.notice.note .notice-title{background:var(--note-title)}.notice.note{background:var(--note-content)}.notice.tip .notice-title{background:var(--tip-title)}.notice.tip{background:var(--tip-content)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div><svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg"><symbol id="tip-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379.0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628.0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628.0l-22.627 22.627c-6.248 6.248-6.248 16.379.0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/></symbol><symbol id="note-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="warning-notice" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet"><path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937.0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154.0l239.94 416.028zM288 354c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="info-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"/></symbol></svg></div><div class="notice info"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#info-notice"/></svg></span>Info</p><p>如何生成 uImage？</p><p>在 uboot 的/tools 目录下寻找 mkimage 文件，把其 copy 到系统/usr/local/bin 目录下，
这样就完成制作工具。然后在内核目录下运行 make uImage，如果成功，
便可以在 arch/arm/boot/目录下发现 uImage 文件，其大小比 zImage 多 64 个字节。</p><p>由于 bootloader 一般要占用 0x0 地址，所以，uImage 相比 zImage 的好处就是可以和 bootloader 共存。
其实就是一个自动跟手动的区别,有了 uImage 头部的描述,u-boot 就知道对应 Image 的信息,
如果没有头部则需要自己手动去搞那些参数。</p></div><h3 id=内核编译脚本>内核编译脚本</h3><p>编译完成后，用&ndash;kerenel 应该能够执行，因为目前没有 rootfs，所以会 panic 进不了 shell。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># get linux source code</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>wget http://ftp.sjtu.edu.cn/sites/ftp.kernel.org/pub/linux/kernel/
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4># extract</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>tar xvf linux-4.12.1.tar.gz
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4># enter dir</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#8be9fd;font-style:italic>cd</span> linux-4.12.1/
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4># generate .config</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>make <span style=color:#8be9fd;font-style:italic>ARCH</span><span style=color:#ff79c6>=</span>arm64 <span style=color:#8be9fd;font-style:italic>CROSS_COMPILE</span><span style=color:#ff79c6>=</span>aarch64-none-linux-gnu- defconfig
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>make <span style=color:#8be9fd;font-style:italic>ARCH</span><span style=color:#ff79c6>=</span>arm64 <span style=color:#8be9fd;font-style:italic>CROSS_COMPILE</span><span style=color:#ff79c6>=</span>aarch64-none-linux-gnu- menuconfig
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4># compile</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>make <span style=color:#8be9fd;font-style:italic>ARCH</span><span style=color:#ff79c6>=</span>arm64 <span style=color:#8be9fd;font-style:italic>CROSS_COMPILE</span><span style=color:#ff79c6>=</span>aarch64-none-linux-gnu- Image -j16
</span></span></code></pre></div><div class="notice warning"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#warning-notice"/></svg></span>Warning</p><p>亲测 Wsl2 编译 Linux 内核时不能用<code>-j</code>而不手动指定任务数，会使 Wsl 爆内存。</p></div><h2 id=构建根文件系统>构建根文件系统</h2><p>根文件系统有两种方式传递给 Qemu:</p><ol><li>通过在-append 参数执行 root 的设备名称，hdx 指定的可以是任意格式，ext4、raw</li><li>通过使用—initrd 参数指定 inital ramdisk 进行加载，必须是 linux 能识别的 ramfs 格式(cpio+gzip 可以）</li></ol><div class="notice info"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#info-notice"/></svg></span>Info</p><p>&ndash;append 中的 root=/dev/vdb 和 -hda -hdb 有什么关系？</p><p>如果说只有一个磁盘文件，那么传递-hda 还是 hdb 都会在启动时映射到/dev/vda,
只有当同时传入多个-hda 和 hdb 时，这是通过 root=来指定 rootfs 是哪个。</p></div><h3 id=源码下载>源码下载</h3><p>我使用 Busybox 构建, 下载源码时可能比较慢, 暂时没有发现国内镜像站。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Download busybox source code</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>wget https://busybox.net/downloads/busybox-1.35.0.tar.bz2
</span></span></code></pre></div><h3 id=编译-1>编译</h3><p>Compile and install to <code>_install/</code>.
<strong>Change to static build.</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>make <span style=color:#8be9fd;font-style:italic>ARCH</span><span style=color:#ff79c6>=</span>arm64 <span style=color:#8be9fd;font-style:italic>CROSS_COMPILE</span><span style=color:#ff79c6>=</span>aarch64-none-linux-gnu- menuconfig
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>make <span style=color:#8be9fd;font-style:italic>ARCH</span><span style=color:#ff79c6>=</span>arm64 <span style=color:#8be9fd;font-style:italic>CROSS_COMPILE</span><span style=color:#ff79c6>=</span>aarch64-none-linux-gnu-  -j
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>make <span style=color:#8be9fd;font-style:italic>ARCH</span><span style=color:#ff79c6>=</span>arm64 <span style=color:#8be9fd;font-style:italic>CROSS_COMPILE</span><span style=color:#ff79c6>=</span>aarch64-none-linux-gnu- install
</span></span></code></pre></div><h3 id=适配-initrd方式>适配<code>-initrd=</code>方式</h3><p>Create rootfs</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>cd</span> ../
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4># Create null rootfs, `also can be done by `dd` command</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4># TODO: different from initrd and initramfs</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>mkdir myinitramfs <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#8be9fd;font-style:italic>cd</span> myinitramfs
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4># Copy target files from busybox just compiled</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>cp -r ../busybox-1.34.0/_install/* .
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4># Create other necessary dirs</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>mkdir proc sys dev etc lib
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4># Copy lib/ from cross compiler</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4># TODO: No need now!</span>
</span></span></code></pre></div><p>Continue configging rootfs: make init script rcS.</p><p>fstab 是另一个需要创建的文件，
fstab 在 Linux 开机以后自动配置哪些需要自动挂载的分区，
这样在 rcS 中调用<code>mount -a</code>将这些分区进行挂载。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># Config /etc/</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>mkdir etc/init.d
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>touch etc/init.d/rcS etc/fstab
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>chmod +x etc/init.d/rcS
</span></span></code></pre></div><p>将以下内容赋值到 rcS:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>#!/bin/sh
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6></span>mount -a
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>/sbin/mdev -s
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>mount -a
</span></span></code></pre></div><p>将以下内容赋值到 fstab:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>#device  mount-point    type     options   dump   fsck order</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>proc /proc proc defaults <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>tmpfs /tmp tmpfs defaults <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>sysfs /sys sysfs defaults <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>tmpfs /dev tmpfs defaults <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>debugfs /sys/kernel/debug debugfs defaults <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>tracefs /sys/kernel/tracing tracefs defaults        <span style=color:#bd93f9>0</span>       <span style=color:#bd93f9>0</span>
</span></span></code></pre></div><p>创建 inittab 文件:</p><p>打包 initrd，此时的目录为:<code>/home/loo/linux-qemu/myinitramfs</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>find . | cpio -o -H newc | gzip -c &gt; ../myinitramfs.cpio.gz
</span></span></code></pre></div><p>启动脚本如下，<strong>这种方式的缺点是修改仅在内存中，重启后失效</strong>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>#!/bin/bash
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6></span>qemu-system-aarch64 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f1fa8c></span>  -machine virt,gic-version<span style=color:#ff79c6>=</span>3,its<span style=color:#ff79c6>=</span>off,secure<span style=color:#ff79c6>=</span>on,virtualization<span style=color:#ff79c6>=</span>on <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c></span>  -cpu cortex-a53 -smp <span style=color:#bd93f9>4</span> -m 2G <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f1fa8c></span>  -kernel ./linux-4.9.1/arch/arm64/boot/Image <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c></span>  -initrd ./myinitramfs.cpio.gz <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c></span>  -append <span style=color:#f1fa8c>&#34;rw rdinit=/linuxrc&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f1fa8c></span>  -serial mon:stdio <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#f1fa8c></span>  -gdb tcp::1234 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#f1fa8c></span>  -nographic <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f1fa8c></span>  <span style=color:#8be9fd;font-style:italic>$1</span>
</span></span></code></pre></div><h3 id=适配-appendrootdevvda方式>适配<code>-append="root=/dev/vda</code>方式</h3><p>因为通过-inird=指定的方法不能将修改保存到本地，
所以还得是借助非 ramdisk 的方式来实现根文件系统。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>dd <span style=color:#ff79c6>if</span><span style=color:#ff79c6>=</span>/dev/zero <span style=color:#8be9fd;font-style:italic>of</span><span style=color:#ff79c6>=</span>rootfs.ext4.img <span style=color:#8be9fd;font-style:italic>bs</span><span style=color:#ff79c6>=</span>1M <span style=color:#8be9fd;font-style:italic>count</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>512</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>mkfs.ext4 rootfs.ext4.img
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>sudo mount rootfs.ext4.img ./mnt-tmp
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>cd</span> ./mnt-tmp
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4># 根文件系统的内容都一样，这个可以直接拷贝</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>cp ../myinitramfs/* .
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#8be9fd;font-style:italic>cd</span> ..
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>sudo umount ./mnt-tmp
</span></span></code></pre></div><p>启动脚本为，在 Guest 中的修改能够写回根文件系统，但是注意等待写回之后再退出 Qemu，
否则可能造成在内存中缓存的情况。后续可以查资料关闭文件在内存中的缓存。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>#!/bin/bash                                                                                    qemu-system-aarch64 \
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6></span>  -machine virt,gic-version<span style=color:#ff79c6>=</span>3,its<span style=color:#ff79c6>=</span>off,secure<span style=color:#ff79c6>=</span>on,virtualization<span style=color:#ff79c6>=</span>on <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f1fa8c></span>  -cpu cortex-a53 -smp <span style=color:#bd93f9>4</span> -m 2G <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f1fa8c></span>  -kernel ./linux-4.9.1/arch/arm64/boot/Image <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f1fa8c></span>  -hda ./rootfs.ext4.img<span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f1fa8c></span>  -append <span style=color:#f1fa8c>&#34;root=/dev/vda rw rdinit=/linuxrc&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f1fa8c></span>  -serial mon:stdio <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f1fa8c></span>  -gdb tcp::1234 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#f1fa8c></span>  -nographic <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#f1fa8c></span>  <span style=color:#8be9fd;font-style:italic>$1</span>
</span></span></code></pre></div><h2 id=准备-uboot未完成>准备 Uboot（未完成）</h2><p>Image 不是内核的二进制文件吗？怎么可以使用 Qemu <code>--kernel</code>引导呢？
其实在 Qemu 内部有一个 Bios，我们当然想尽可能接近真实的工作环境，
所以还是能用 Uboot 最好。</p><h3 id=源码下载-1>源码下载</h3><ul><li><a href=https://ftp.denx.de/pub/u-boot/>https://ftp.denx.de/pub/u-boot/</a></li></ul><h3 id=编译-2>编译</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># 不能用 make ARCH= 来指定，编译会报错，详见</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4># https://forums.raspberrypi.com/viewtopic.php?t=345377</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>ARCH</span><span style=color:#ff79c6>=</span>arm64
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>CROSS_COMPILE</span><span style=color:#ff79c6>=</span>aarch64-none-linux-gnu-
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>make  qemu_arm64_defconfig
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>make -j
</span></span></code></pre></div><h3 id=失败的折腾>失败的折腾</h3><p>Uboot 编译后好，先尝试直接启动 Uboot，没问题</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>#!/bin/bash
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6></span>qemu-system-aarch64 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f1fa8c></span>  -machine virt<span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c></span>  -cpu cortex-a53 -smp <span style=color:#bd93f9>4</span> -m 2G <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#f1fa8c></span>  -bios ./u-boot-2023.10/u-boot.bin <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#f1fa8c></span>  -serial mon:stdio <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#f1fa8c></span>  -gdb tcp::1234 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#f1fa8c></span>  -nographic <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span><span style=color:#f1fa8c></span>  <span style=color:#8be9fd;font-style:italic>$1</span>
</span></span></code></pre></div><div class="notice warning"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#warning-notice"/></svg></span>Warning</p><p>启动参数不能带<code>virt,secure=on</code>，会导致同步异常 uboot 卡死。</p></div><div class="notice info"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#info-notice"/></svg></span>Info</p></div><p>接下来就是结合 Uboot 和 linux kernel，最终和真实开发一样的流程：
内核镜像、设备树、根文件系统放在 sd 卡中，当 Uboot 启动后将其加载到内存，并引导。</p><h4 id=制作-sd-卡>制作 Sd 卡</h4><p>在 uboot 的 menuconfig 中加入 mmc 的支持:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span> Symbol: MMC [=y]                                                                       │
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  │ Type  : bool                                                                           │
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  │ Prompt: MMC/SD/SDIO card support
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span> Symbol: CMD_MMC [=n]                                                                   │
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  │ Type  : bool                                                                           │
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>  │ Prompt: mmc
</span></span></code></pre></div><p>启动时会报错，该 model 不支持 if=sd,bus=0&mldr;.,</p><blockquote><p>&ldquo;-sd sd.img&rdquo; is shorthand for &ldquo;-drive if=sd,index=0,file=sd.img&rdquo;. Like
all -drive (except for if=none), it requests the board to create a
suitable device. Boards act on some requests, and ignore others.
mpc8544ds ignores if=sd.</p></blockquote><p>后续： virt 开发板不支持-sd 选项，但是 raspi3b 支持，</p><p>用<code>-hda</code>传入镜像可以，在 uboot 里用 <code>virtio ls</code> 命令可以看到，后面觉得算了
没必要去折腾这些，用<code>--kernel</code> 也还行。</p><h1 id=增加-perf>增加 perf</h1><p><strong>perf</strong>已经集成到了 Linux 主分支中，源码的位置在<code>tools/perf</code></p><p>使用 perf 的基础功能不需要修改内核配置文件，但是貌似有些功能比如说 function Trace 是需要的，
目前没有用到，所以之后再来补充吧。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd;font-style:italic>cd</span> tools/perf
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>make clean
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>make <span style=color:#8be9fd;font-style:italic>ARCH</span><span style=color:#ff79c6>=</span>arm64 <span style=color:#8be9fd;font-style:italic>CROSS_COMPILE</span><span style=color:#ff79c6>=</span>aarch64-linux-gnu- <span style=color:#8be9fd;font-style:italic>LDFLAGS</span><span style=color:#ff79c6>=</span>-static <span style=color:#8be9fd;font-style:italic>WERROR</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span></code></pre></div><div class="notice warning"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#warning-notice"/></svg></span>Warning</p><p>这里换了编译器，可能是之前用的编译器版本太新了，编译会出错。
目前编译成功的版本是：
<code>gcc-arm-8.3-2019.03-x86_64-aarch64-linux-gnu</code></p></div><p>编译成功后，在当前目录下会有静态编译的 perf 可执行程序，移动到 rootfs 中就能直接使用了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>~/linux-qemu/linux-4.12.1/tools/perf $ file perf
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>perf: ELF 64-bit LSB executable, ARM aarch64, version <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>(</span>GNU/Linux<span style=color:#ff79c6>)</span>, statically linked, <span style=color:#ff79c6>for</span> GNU/Linux 3.7.0, with debug_info, not stripped
</span></span></code></pre></div><h2 id=试用-kgdb-调试内核>试用 KGDB 调试内核</h2><h2 id=增加-strace>增加 strace</h2><p>下载源码：<a href=https://github.com/strace/strace/releases>Releases · strace/strace (github.com)</a></p><p>编译&&安装:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>mkdir build <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#8be9fd;font-style:italic>cd</span> build
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>../configure --host<span style=color:#ff79c6>=</span>aarch64-none-linux-gnu --prefix<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$HOME</span>/linux-qemu/strace-6.0/_install --enable-mpers<span style=color:#ff79c6>=</span>no
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4># 编译为静态链接方式</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>make <span style=color:#8be9fd;font-style:italic>LDFLAGS</span><span style=color:#ff79c6>+=</span><span style=color:#f1fa8c>&#39;-static -pthread&#39;</span> -j16
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#6272a4># 拷贝到 _install 目录</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>make install
</span></span></code></pre></div></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2024-01-04T19:28:12, Lastmod: 2024-01-17T16:29:05</p></main></div></body></html>