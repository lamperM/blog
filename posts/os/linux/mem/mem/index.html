<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/syntax_pastie.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title></title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title></div></header><p>在<code>free_initmem()</code> 之后，<code>totalram_pages()</code>就固定在一个值。这也是 Linux 可以支配的内存，这之外的内存称之为内存黑洞。</p><p>分析从 RAM 启动，到 free_initmem()，中间是怎么对内存进行处理的。</p><p>memblock 内存管理机制用于在 Linux 启动后管理内存，一直到 free_initmem()为止。之后 totalram_pages 就稳定在一个数值。</p><p>其中对不同类型 memblock 的分配释放主要有如下：</p><ol><li>其中 memblock_add()和 memblock_remove()是针对可用 memlbock 操作，即 <code>memblock.memory</code></li><li>memblock_reserve()和 memblock_free()是针对 reserved 类型 memblock 操作，即 <code>memblock.reserved</code></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=n>__init_memblock</span> <span class=nf>memblock_add_node</span><span class=p>(</span><span class=n>phys_addr_t</span> <span class=n>base</span><span class=p>,</span> <span class=n>phys_addr_t</span> <span class=n>size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				       <span class=kt>int</span> <span class=n>nid</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>memblock_add_range</span><span class=p>(</span><span class=o>&amp;</span><span class=n>memblock</span><span class=p>.</span><span class=n>memory</span><span class=p>,</span> <span class=n>base</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>nid</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>__init_memblock</span> <span class=nf>memblock_add</span><span class=p>(</span><span class=n>phys_addr_t</span> <span class=n>base</span><span class=p>,</span> <span class=n>phys_addr_t</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>memblock_add_range</span><span class=p>(</span><span class=o>&amp;</span><span class=n>memblock</span><span class=p>.</span><span class=n>memory</span><span class=p>,</span> <span class=n>base</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>MAX_NUMNODES</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>__init_memblock</span> <span class=nf>memblock_free</span><span class=p>(</span><span class=n>phys_addr_t</span> <span class=n>base</span><span class=p>,</span> <span class=n>phys_addr_t</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>kmemleak_free_part_phys</span><span class=p>(</span><span class=n>base</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>memblock_remove_range</span><span class=p>(</span><span class=o>&amp;</span><span class=n>memblock</span><span class=p>.</span><span class=n>reserved</span><span class=p>,</span> <span class=n>base</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>__init_memblock</span> <span class=nf>memblock_reserve</span><span class=p>(</span><span class=n>phys_addr_t</span> <span class=n>base</span><span class=p>,</span> <span class=n>phys_addr_t</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>memblock_add_range</span><span class=p>(</span><span class=o>&amp;</span><span class=n>memblock</span><span class=p>.</span><span class=n>reserved</span><span class=p>,</span> <span class=n>base</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>MAX_NUMNODES</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>可用的 memblock 有些什么东西，reserved 类型的 memblock 又有些什么东西</p><p>TODO：有环境的情况下，用打开调试选项试一下比看代码直观一些，另外还有包括<code>free -h</code>的含义这些。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* lowest address */</span>
</span></span><span class=line><span class=cl><span class=n>phys_addr_t</span> <span class=n>__init_memblock</span> <span class=nf>memblock_start_of_DRAM</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>memblock</span><span class=p>.</span><span class=n>memory</span><span class=p>.</span><span class=n>regions</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>base</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>phys_addr_t</span> <span class=n>__init_memblock</span> <span class=nf>memblock_end_of_DRAM</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>idx</span> <span class=o>=</span> <span class=n>memblock</span><span class=p>.</span><span class=n>memory</span><span class=p>.</span><span class=n>cnt</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=p>(</span><span class=n>memblock</span><span class=p>.</span><span class=n>memory</span><span class=p>.</span><span class=n>regions</span><span class=p>[</span><span class=n>idx</span><span class=p>].</span><span class=n>base</span> <span class=o>+</span> <span class=n>memblock</span><span class=p>.</span><span class=n>memory</span><span class=p>.</span><span class=n>regions</span><span class=p>[</span><span class=n>idx</span><span class=p>].</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=参考>参考</h2><p><a href=https://www.cnblogs.com/arnoldlu/p/10526814.html>Linux 内存都去哪了：(1)分析 memblock 在启动过程中对内存的影响 - ArnoldLu - 博客园</a></p></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 0001-01-01T00:00:00, Lastmod: 2024-11-20T21:14:21</p><script src=/js/copy-to-clipboard.js></script></main></div></body></html>