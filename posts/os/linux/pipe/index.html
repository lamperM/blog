<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>Linux 进程间通信: 管道</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>所有文章</a></div><div class="a-block nav-link-item"><a href=/tags>Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%ae%a1%e9%81%93%e7%9a%84%e5%88%9b%e5%bb%ba%e5%92%8c%e4%bd%bf%e7%94%a8 aria-label=管道的创建和使用>管道的创建和使用</a></li><li><a href=#popen-%e6%9b%b4%e7%ae%80%e5%8d%95%e7%9a%84-api aria-label="popen(): 更简单的 API"><code>popen()</code>: 更简单的 API</a></li><li><a href=#popen%e6%a0%b7%e4%be%8b aria-label=popen()样例><code>popen()</code>样例</a></li></ul></div></details></div></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>Linux 进程间通信: 管道</div></header><p>管道属于实现进程间通信的一种方式，正如其名，一个进程在一头读，另一个进程在一头写。</p><p><strong>管道被看做是打开的文件</strong>，但在已安装的文件系统中没有相应的实体，即并不是一个
真正的文件。</p><h2 id=管道的创建和使用>管道的创建和使用</h2><p>可以使用<code>pipe()</code>系统调用来创建一个管道(后面会介绍另一个方式)，其返回一对文件
描述符，一个用来写一个用来读。必须返回两个描述符的原因是： POSIX 只定义了半双工
的管道，所以读写需要两个端口。</p><blockquote><p>POSIX 另外要求使用一个描述符前需要关闭另一个描述符。 但 Linux 中则可以不关闭，
可以实现全双工，但为了可移植性， 一般还是将另一个先关闭。</p></blockquote><p>用<code>ls | more</code>组合命令来解释如何使用<code>pipe()</code>实现通信:</p><ol><li>shell 调用<code>pipe()</code>, 返回 fd3(对应读通道),fd4(对应写通道)</li><li>两次调用 <code>fork()</code> 创建两个子进程，由于属于不同的地址空间，
所以操作自己的文件描述符不会影响其他进程，但都指向同一个管道</li><li>父进程调用<code>close()</code>关闭这两个文件描述符</li></ol><p>第一个子进程执行<code>ls</code>程序，其操作如下，</p><ol><li>调用<code>dup2(fd4, stdout)</code>, 执行文件描述符的拷贝，从此<code>stdout</code>
就代表管道的写通道</li><li>由于<code>stdout</code>代表写通道，所以可将 fd3 和 fd4 均关闭</li><li><code>exec()</code>执行<code>ls</code>程序，默认情况下，其输出结果到 <code>stdout</code>，
当下即管道的写通道，即向管道中写了数据</li></ol><p>第二个子进程执行<code>more</code>程序，其操作如下：</p><ol><li>调用<code>dup2(fd3, stdin)</code>, 从此<code>stdin</code>代表管道的读通道</li><li>同样可以将 fd3 和 fd4 关闭</li><li><code>exec()</code>执行<code>more</code>程序，由于现在<code>stdin</code>就是管道的读通道,
上面的子进程向管道中写了数据，所以<code>stdin</code>现在有数据，<code>more</code>
可以正常输出</li></ol><h2 id=popen-更简单的-api><code>popen()</code>: 更简单的 API</h2><p>当管道的使用是单向的，即某个进程仅仅想知道另一个进程的执行输出，或者
某个进程想把数据灌入到另一个进程的输入。</p><p>此时 Linux C 库中的<code>popen()</code>和<code>pclose()</code>简化使用<code>pipe()</code>中
调用<code>dup2()</code>, <code>close()</code>这些繁琐的步骤。</p><p><code>popen()</code>接受两个参数: <strong>可执行文件的路径和使用方式 type</strong>, 返回
一个指向 <code>FILE</code> 的指针。</p><p><code>popen()</code>做的事包含:</p><ol><li><code>pipe()</code>创建一个管道</li><li>创建一个新进程，执行:<ol><li>如果使用方式是 r, 绑定管道的写通道到<code>stdout</code>, 否则绑定读通道
到<code>stdin</code>.</li><li>关闭<code>pipe()</code>返回的两个描述符</li><li><code>exec()</code>执行指定的可执行文件</li></ol></li><li>回到父进程，如果使用方式是 r, ·关闭管道的写通道。否则关闭读通道</li><li>返回管道剩下的文件描述符地址</li></ol><p>这样父子进程就能单向通信了，如何使用方式是 r, 父进程可用<code>popen()</code>
返回的 FILE 来读取可执行文件的输出；相反，父进程可向 FILE 中写数据
到可执行文件的输入。</p><p>因为返回的是 FILE 指针，所以通常配合<code>fprintf()</code>, <code>fscanf()</code>, <code>fgets()</code>
这类函数使用。</p><p><code>pclose()</code>等待<code>popen()</code>创建的子进程结束。</p><h2 id=popen样例><code>popen()</code>样例</h2><p>父进程读</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#00f>#include</span> <span style=color:#00f>&lt;stdio.h&gt;</span><span style=color:#00f>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#00f>#include</span> <span style=color:#00f>&lt;unistd.h&gt;</span><span style=color:#00f>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#00f></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#2b91af>int</span> main(<span style=color:#2b91af>void</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  FILE *fp = NULL;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#2b91af>char</span> s1[32], s2[32];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  fp = popen(<span style=color:#a31515>&#34;ls&#34;</span>, <span style=color:#a31515>&#34;r&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:green>// read the first two files and print their name
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:green></span>  fscanf(fp, <span style=color:#a31515>&#34;%s %s &#34;</span>, s1, s2);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  printf(<span style=color:#a31515>&#34;s1 = %s, s2 = %s</span><span style=color:#a31515>\n</span><span style=color:#a31515>&#34;</span>, s1, s2);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  <span style=color:green>// close the read side of pipe
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:green></span>  pclose(fp);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  <span style=color:#00f>return</span> 0;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>}
</span></span></code></pre></div><p>父进程写</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#00f>#include</span> <span style=color:#00f>&lt;stdio.h&gt;</span><span style=color:#00f>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#00f>#include</span> <span style=color:#00f>&lt;unistd.h&gt;</span><span style=color:#00f>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#00f></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#2b91af>int</span> main(<span style=color:#2b91af>void</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  FILE *fp = NULL;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#2b91af>char</span> s1[32], s2[32];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  fp = popen(<span style=color:#a31515>&#34;wc -l&#34;</span>, <span style=color:#a31515>&#34;w&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  fprintf(fp, <span style=color:#a31515>&#34;one</span><span style=color:#a31515>\n</span><span style=color:#a31515>two</span><span style=color:#a31515>\n</span><span style=color:#a31515>three</span><span style=color:#a31515>\n</span><span style=color:#a31515>&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  pclose(fp);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  <span style=color:#00f>return</span> 0;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>}
</span></span></code></pre></div></article></body></main></div></body></html>