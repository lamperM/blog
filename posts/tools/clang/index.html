<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title></title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#clang%e6%98%af%e4%b8%aa%e5%95%a5 aria-label=Clang是个啥>Clang是个啥</a><ul><li><a href=#clang%e4%b8%8ellvm aria-label=Clang与LLVM>Clang与LLVM</a></li><li><a href=#clang%e4%b8%8egcc aria-label=Clang与Gcc>Clang与Gcc</a></li></ul></li><li><a href=#clangd aria-label=Clangd>Clangd</a><ul><li><a href=#%e7%94%9f%e6%88%90-compile_commandsjson aria-label="生成 compile_commands.json">生成 <code>compile_commands.json</code></a></li><li><a href=#vscode%e9%85%8d%e7%bd%aeclangd%e8%a1%a5%e5%85%a8 aria-label=VSCode配置Clangd补全>VSCode配置Clangd补全</a></li></ul></li><li><a href=#vim%e9%85%8d%e7%bd%aeclangd%e8%a1%a5%e5%85%a8 aria-label=Vim配置Clangd补全>Vim配置Clangd补全</a></li><li><a href=#clangd%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6clangd aria-label="Clangd配置文件`.clangd.">Clangd配置文件`.clangd.</a></li><li><a href=#clang-format aria-label=Clang-format>Clang-format</a></li><li><a href=#reference aria-label=Reference>Reference</a></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title></div></header><h2 id=clang是个啥>Clang是个啥</h2><h3 id=clang与llvm>Clang与LLVM</h3><p>llvm有两种含义：llvm框架和llvm Core</p><ul><li>llvm框架定义了一个编译器的组成架构，此时Clang可以作为框架中针对C/C++语言的前端。
当然llvm框架也并不只是包含这一个前端，也可以有其他的前端。</li><li>llvm Core是除了前端之外的其他构成编译器的部分，包括中端优化和后端。</li></ul><h3 id=clang与gcc>Clang与Gcc</h3><ul><li>Clang是一个编译器前端，Clang+llvm Core=编译器，Gcc也是一个编译器</li><li>Clang的代码结构更好，扩展性强</li></ul><h2 id=clangd>Clangd</h2><p>clangd是llvm项目推出的C/C++语言服务器，通过LSP(Language Server Protocal)协议向编辑器如vscode/vim/emacs提供语法补全、错误检测、跳转、格式化等等功能。C++的LSP曾经是cquery, ccls, clangd三足鼎立。但是clangd支持clang-tidy实时检查的功能是另外两者不具备的，而且cquery和ccls都是单个开发者主导的项目，clangd背后则是有llvm的背书。</p><p>一般写C代码，在vscode中用<code>C/C++</code>这个插件来进行自动补全，这类插件在复杂工程中效果不太好因为<strong>它是基于代码进行分析</strong>，理论上不能准确的区别同名函数到底是调用谁的情况。而且在实践中也经常产生莫名其妙找不到定义的情况。</p><p>而Clangd则是<strong>支持基于编译的分析做代码补全</strong>，
通过解析一个调用数据库文件<code>compile_commands.json</code>
来提供错误检查和补全等功能。</p><h3 id=生成-compile_commandsjson>生成 <code>compile_commands.json</code></h3><p>一般采用make工具构建的工程，通过bear工具可以在编译中自动分析并生成compile_commands.json。</p><p>特别对于Linux kernel，有专门的工具<code>scripts/clang-tools/gen_compile_commands.py</code>，在编译后执行该脚本即可在根目录生成compile_commands.json。</p><h3 id=vscode配置clangd补全>VSCode配置Clangd补全</h3><ol><li>安装clangd插件</li><li>clangd插件与c/c++插件冲突，<strong>目前的方法时禁用C/C++插件</strong>。</li><li>配置clangd服务的路径，可以在User或者Workspace。</li><li>如果有其他参数需求，可以按需添加。</li></ol><style type=text/css>.notice{--root-color:#444;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#c33;--warning-content:#fee;--info-title:#fb7;--info-content:#fec;--note-title:#6be;--note-content:#e7f2fa;--tip-title:#5a5;--tip-content:#efe}@media(prefers-color-scheme:dark){.notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}}body.dark .notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--root-color);background:var(--root-background)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background)}.notice.warning .notice-title{background:var(--warning-title)}.notice.warning{background:var(--warning-content)}.notice.info .notice-title{background:var(--info-title)}.notice.info{background:var(--info-content)}.notice.note .notice-title{background:var(--note-title)}.notice.note{background:var(--note-content)}.notice.tip .notice-title{background:var(--tip-title)}.notice.tip{background:var(--tip-content)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div><svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg"><symbol id="tip-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379.0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628.0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628.0l-22.627 22.627c-6.248 6.248-6.248 16.379.0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/></symbol><symbol id="note-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="warning-notice" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet"><path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937.0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154.0l239.94 416.028zM288 354c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="info-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"/></symbol></svg></div><div class="notice note"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#note-notice"/></svg></span>Note</p><p>不生效的排查方法</p><p>clangd服务会输出一些日志，当你切换文件或者鼠标悬浮在代码上时会输出解析的日志，如果有Error可以在这里排查。比如<a href=https://blog.csdn.net/qq_37812160/article/details/135506142>vscode使用clangd报error: invalid AST错误-CSDN博客</a>。</p></div><h2 id=vim配置clangd补全>Vim配置Clangd补全</h2><p>我目前使用<code>coc-nvim</code>插件来调用Clangd进行补全。</p><h2 id=clangd配置文件clangd>Clangd配置文件`.clangd.</h2><p>Clangd支持的所有配置项：https://clangd.llvm.org/config.html</p><p>有两种方式对Clangd的配置进行设定：</p><ol><li>全局配置 <code>~/.config/clangd/config.yaml</code></li><li>工程内部 <code>.clangd</code> 仅在工程目录内生效</li></ol><p>以上两个都是YAML类型的文件，我目前使用到了忽略一些编译参数:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>CompileFlags</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>Remove</span>: [-march=armv8-a, -march=armv7-a] <span style=color:#6272a4># invalid target CPU values in clangd-15</span>
</span></span></code></pre></div><h2 id=clang-format>Clang-format</h2><p>代码格式化工具</p><h2 id=reference>Reference</h2><ol><li><a href=https://ahmadsamir.github.io/posts/12-clangd-config-tweaks.html>Clangd config</a></li><li></li></ol></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 0001-01-01T00:00:00, Lastmod: 2024-03-25T23:28:56</p></main></div></body></html>