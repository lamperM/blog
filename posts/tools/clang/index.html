<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title></title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item" href>BACK</div><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#clang%e6%98%af%e4%b8%aa%e5%95%a5 aria-label=Clang是个啥>Clang是个啥</a><ul><li><a href=#clang%e4%b8%8ellvm aria-label=Clang与LLVM>Clang与LLVM</a></li><li><a href=#clang%e4%b8%8egcc aria-label=Clang与Gcc>Clang与Gcc</a></li></ul></li><li><a href=#clangd aria-label=Clangd>Clangd</a><ul><li><a href=#%e7%94%9f%e6%88%90-compile_commandsjson aria-label="生成 compile_commands.json">生成 <code>compile_commands.json</code></a></li><li><a href=#vscode%e9%85%8d%e7%bd%aeclangd%e8%a1%a5%e5%85%a8 aria-label=VSCode配置Clangd补全>VSCode配置Clangd补全</a></li></ul></li><li><a href=#vim%e9%85%8d%e7%bd%aeclangd%e8%a1%a5%e5%85%a8 aria-label=Vim配置Clangd补全>Vim配置Clangd补全</a></li><li><a href=#clangd%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6clangd aria-label="Clangd配置文件`.clangd.">Clangd配置文件`.clangd.</a></li><li><a href=#clang-format aria-label=Clang-format>Clang-format</a></li><li><a href=#reference aria-label=Reference>Reference</a></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title></div></header><h2 id=clang是个啥>Clang是个啥</h2><h3 id=clang与llvm>Clang与LLVM</h3><p>llvm有两种含义：llvm框架和llvm Core</p><ul><li>llvm框架定义了一个编译器的组成架构，此时Clang可以作为框架中针对C/C++语言的前端。
当然llvm框架也并不只是包含这一个前端，也可以有其他的前端。</li><li>llvm Core是除了前端之外的其他构成编译器的部分，包括中端优化和后端。</li></ul><h3 id=clang与gcc>Clang与Gcc</h3><ul><li>Clang是一个编译器前端，Clang+llvm Core=编译器，Gcc也是一个编译器</li><li>Clang的代码结构更好，扩展性强</li></ul><h2 id=clangd>Clangd</h2><p>clangd是llvm项目推出的C/C++语言服务器，通过LSP(Language Server Protocal)协议向编辑器如vscode/vim/emacs提供语法补全、错误检测、跳转、格式化等等功能。C++的LSP曾经是cquery, ccls, clangd三足鼎立。但是clangd支持clang-tidy实时检查的功能是另外两者不具备的，而且cquery和ccls都是单个开发者主导的项目，clangd背后则是有llvm的背书。</p><p>一般写C代码，在vscode中用<code>C/C++</code>这个插件来进行自动补全，这类插件在复杂工程中效果不太好因为<strong>它是基于代码进行分析</strong>，理论上不能准确的区别同名函数到底是调用谁的情况。而且在实践中也经常产生莫名其妙找不到定义的情况。</p><p>而Clangd则是<strong>支持基于编译的分析做代码补全</strong>，
通过解析一个调用数据库文件<code>compile_commands.json</code>
来提供错误检查和补全等功能。</p><h3 id=生成-compile_commandsjson>生成 <code>compile_commands.json</code></h3><p>一般采用make工具构建的工程，通过bear工具可以在编译中自动分析并生成compile_commands.json。</p><p>特别对于Linux kernel，有专门的工具<code>scripts/clang-tools/gen_compile_commands.py</code>，在编译后执行该脚本即可在根目录生成compile_commands.json。</p><h3 id=vscode配置clangd补全>VSCode配置Clangd补全</h3><ol><li>安装clangd插件</li><li>clangd插件与c/c++插件冲突，<strong>目前的方法时禁用C/C++插件</strong>。</li><li>配置clangd服务的路径，可以在User或者Workspace。</li><li>如果有其他参数需求，可以按需添加。</li></ol><style type=text/css>.notice{--root-color:#444;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#c33;--warning-content:#fee;--info-title:#fb7;--info-content:#fec;--note-title:#6be;--note-content:#e7f2fa;--tip-title:#5a5;--tip-content:#efe}@media(prefers-color-scheme:dark){.notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}}body.dark .notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--root-color);background:var(--root-background)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background)}.notice.warning .notice-title{background:var(--warning-title)}.notice.warning{background:var(--warning-content)}.notice.info .notice-title{background:var(--info-title)}.notice.info{background:var(--info-content)}.notice.note .notice-title{background:var(--note-title)}.notice.note{background:var(--note-content)}.notice.tip .notice-title{background:var(--tip-title)}.notice.tip{background:var(--tip-content)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div class="notice note"><p class=notice-title><span class="icon-notice baseline"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 128 300 300"><path d="M150 128c82.813.0 150 67.188 150 150 0 82.813-67.188 150-150 150C67.187 428 0 360.812.0 278c0-82.813 67.188-150 150-150zm25 243.555v-37.11c0-3.515-2.734-6.445-6.055-6.445h-37.5c-3.515.0-6.445 2.93-6.445 6.445v37.11c0 3.515 2.93 6.445 6.445 6.445h37.5c3.32.0 6.055-2.93 6.055-6.445zm-.39-67.188 3.515-121.289c0-1.367-.586-2.734-1.953-3.516-1.172-.976-2.93-1.562-4.688-1.562h-42.968c-1.758.0-3.516.586-4.688 1.563-1.367.78-1.953 2.148-1.953 3.515l3.32 121.29c0 2.734 2.93 4.882 6.64 4.882h36.134c3.515.0 6.445-2.148 6.64-4.883z"/></svg></span><span></span></p><p>不生效的排查方法</p><p>clangd服务会输出一些日志，当你切换文件或者鼠标悬浮在代码上时会输出解析的日志，如果有Error可以在这里排查。比如<a href=https://blog.csdn.net/qq_37812160/article/details/135506142>vscode使用clangd报error: invalid AST错误-CSDN博客</a>。</p></div><h2 id=vim配置clangd补全>Vim配置Clangd补全</h2><p>我目前使用<code>coc-nvim</code>插件来调用Clangd进行补全。</p><h2 id=clangd配置文件clangd>Clangd配置文件`.clangd.</h2><p>Clangd支持的所有配置项：https://clangd.llvm.org/config.html</p><p>有两种方式对Clangd的配置进行设定：</p><ol><li>全局配置 <code>~/.config/clangd/config.yaml</code></li><li>工程内部 <code>.clangd</code> 仅在工程目录内生效</li></ol><p>以上两个都是YAML类型的文件，我目前使用到了忽略一些编译参数:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#b06;font-weight:700>CompileFlags</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#b06;font-weight:700>Remove</span>:<span style=color:#bbb> </span>[-march=armv8-a, -march=armv7-a]<span style=color:#bbb> </span><span style=color:#888># invalid target CPU values in clangd-15</span><span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=clang-format>Clang-format</h2><p>代码格式化工具</p><h2 id=reference>Reference</h2><ol><li><a href=https://ahmadsamir.github.io/posts/12-clangd-config-tweaks.html>Clangd config</a></li><li></li></ol></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 0001-01-01T00:00:00, Lastmod: 2024-03-25T23:28:56</p><script src=/js/clipboard.js></script></main></div></body></html>