<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/syntax_pastie.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><title>QEMU 工作原理</title></head><body><div id=app><div id=sideContainer class=side-container><div class=nav-link-list><div class="a-block nav-link-item"><a href=/posts>最近修改</a></div><div class="a-block nav-link-item"><a href=/categories>分类 Categories</a></div><div class="a-block nav-link-item"><a href=/tags>标签 Tags</a></div><div class="a-block nav-link-item"><a href=/index.xml>RSS Feed</a></div></div></div><div id=extraContainer class=extra-container><div class="a-block nav-link-item" href><div id=fastSearch><input id=searchInput placeholder="Press '/' to focus on me"><ul id=searchResults></ul></div></div><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#qemu-%e7%9a%84%e5%b7%a5%e4%bd%9c%e6%96%b9%e5%bc%8f aria-label="Qemu 的工作方式">Qemu 的工作方式</a></li><li><a href=#%e6%8c%87%e4%bb%a4%e7%bf%bb%e8%af%91 aria-label=指令翻译>指令翻译</a></li><li><a href=#qemu-%e5%85%a8%e7%b3%bb%e7%bb%9f%e6%a8%a1%e6%8b%9f%e5%90%af%e5%8a%a8%e5%86%85%e6%a0%b8 aria-label="Qemu 全系统模拟启动内核">Qemu 全系统模拟启动内核</a></li></ul></div></details></div></div></div><script src=/js/fuse.js></script>
<script src=/js/fastsearch.js></script><main class=container><article><header><div class=post-title>QEMU 工作原理</div></header><h2 id=qemu-的工作方式>Qemu 的工作方式</h2><p>Qemu有两种工作方式：全系统模拟（Full-system emulation）和用户模拟（User-mode emulation）。</p><p>用户模拟仅仅对目标格式的Elf文件进行指令翻译并执行，
在遇到需要使用系统资源的命令（通过系统调用）时，
就转换成实际host的系统调用来完成，将执行完的结果返回。
Elf就是一个用户态的应用，不能直接操作硬件。
总之，用户模式下Qemu仅仅实现了讲Guest指令翻译为Host指令并执行，
不模拟资源。</p><p>全系统模拟的方式下，Qemu在用户态模拟了完整的一套Guest硬件资源，
包括Cpu、内存、外设等，此时Qemu更像是一个虚拟机管理器。
Guest Elf可以直接对硬件进行操作。</p><h2 id=指令翻译>指令翻译</h2><p>在 host 上运行 guest 架构代码的能力由 QEMU TCG 模块提供。</p><p>TCG 做指令翻译的思路是 <strong>“边翻译边执行”</strong>， 并且将翻译工作分为前后端，中间会有一层中间指令，
这样能够方便添加对新指令的支持。这个有点类似于现代编译器，也是由类似间结果的流程，称为 <a href=https://blog.csdn.net/raojun/article/details/103629894>IR</a>。</p><p>TCG 执行一次翻译的单位是 Translation Block，以分支跳转、页边界为划分条件。</p><h2 id=qemu-全系统模拟启动内核>Qemu 全系统模拟启动内核</h2><p>&ndash;kernel选项后面接一个Elf格式的系统镜像，Qemu内部用seaBios来实现引导Elf，
所以我们可以不关心如何引导Elf的问题。</p></article></body><hr width=100% id=EOF><p style=color:#777>创建于: 2023-09-08T16:21:27, Lastmod: 2024-01-03T23:45:04</p></main></div></body></html>